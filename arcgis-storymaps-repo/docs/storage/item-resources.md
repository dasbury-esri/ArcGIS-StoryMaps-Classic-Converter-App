# Item Resources

<!-- omit in toc -->
## Table of Contents

- [Overview](#overview)
- [Types of Resources](#types-of-resources)
  - [Published Resources](#published-resources)
  - [Draft Resources](#draft-resources)
  - [Versioned Resources](#versioned-resources)
  - [Media Resources](#media-resources)
- [Resource Properties](#resource-properties)
- [Edit Tracking](#edit-tracking)
- [Publish Process](#publish-process)

## Overview

All story content, excluding item details, is stored as item resources on the item. These resources include published and draft story data, media uploads (images, videos), express map items, express images editor data, thematic map data, and SEO meta data. Resources have two access levels: private and inherit. Private resources can only be accessed by story owners, administrators, and those with edit access. Inherited item resources can be accessed by anyone with "view" access to the story, following ArcGIS Online's sharing model.

Resources required by a published story are automatically set to "inherit" upon publication. Other resources are set to "private" to ensure data security.

To optimize author storage, item resources that are no longer referenced by the published story or draft story will be removed under the following conditions:

- At the time of publish
- At the time of draft story save, but only if the resource was added more than 24 hours ago (to account for multi-author editing) and it is not referenced in the author's undo/redo stack.

## Types of Resources

### Published Resources

These resources are exclusively used in the published story and are automatically generated upon publication.

- `published_data.json`: The JSON file that contains the final story data is used to display the published story in the viewer.
  - When fetching published data, we should prefer fetching the `published_data.json` instead of the [item data](https://developers.arcgis.com/rest/users-groups-and-items/item-data.htm) endpoint which will increment the item's view count. A special call is made to the item data endpoint when we explicitly want to increase the view count.
  - When publishing, this must be the final item resource uploaded to the story so that the Distributed Collaboration Workflow can correctly detect when the story items have finished publishing.
- `published_data_{{LANGUAGE}}.json` (INTERNAL SMX ONLY): Used to store copies of the published story data, but the text has been automatically translated. E.g. `published_data_es.json`, `published_data_zh-cn.json`.
- `oembed.json`: The [OEmbed](https://oembed.com/) data used as SEO meta tag on the story viewer.
- `oembed.xml`: The same as above but in XML format.

### Draft Resources

These resources are exclusively available in the draft story and are never accessible to viewers.

- `draft.json`: The original draft data is added when the story is created. After the first save, it will be deleted and replaced with the timestamped version below.
- `draft_{{TIMESTAMP}}.json`: An author saved version of the story data. With each save, the previous draft resource is deleted and replaced with a newly timestamped draft resource. The replacement prevents data-loss with ArcGIS's REST API eventual consistency architecture and provide some support for multi-author workflows.

### Versioned Resources

These resources track additional story content beyond the main `draft_{{TIMESTAMP}}.json`/`published_data.json`. Each resource type has both a `draft` and `published` version based on the story's state.

In the story data, all versioned data are referenced just by the resources name (e.g. `expressmap_{{TIMESTAMP}}.json`). However, all item resource filenames are prepended with either `pub_` (published) or `draft_` (draft) respective to their version (e.g. `pub_expressmap_{{TIMESTAMP}}.json` vs `draft_expressmap_{{TIMESTAMP}}.json`).

- `expressmap_{{TIMESTAMP}}.json`: Express Map data
- `expressimage_{{TIMESTAMP}}.json`: Express Image, editor data.
- `thematicmap_dataset_{{TIMESTAMP}}.json`: Thematic Map Data

### Media Resources

Media resources such as images and videos remain unchanged between the `draft` and `published` versions of the story. The only difference is the access property, which is adjusted depending on the version they are included in.

Resource name typically is `{{UNIQUE_ID}}.{{FILE_EXTENSION}}`, where `UNIQUE_ID` is a 21-char URL friendly ID. E.g. `cWCUCt48eGm-ZTAlWDo_I`. When media requires conversion to the correct mime type by the backend server, the server will use a `UUID` for the `UNIQUE_ID`. Some legacy stories may also use `{{TIMESTAMP}}.{{FILE_EXTENSION}}`.

- Images: `{{UNIQUE_ID}}.jpeg|jpg|gif|svg|png`.
- Videos: `{{UNIQUE_ID}}.mp4`
- Audio: `{{UNIQUE_ID}}.mp3|wav`
- Files: `{{UNIQUE_ID}}.pdf`
- GeoData: `{{UNIQUE_ID}}.json` (Used as map layer in Activity Map). UUID generated by backend server API
- JSON: `{{UNIQUE_ID}}.json` (Supporting data that is not editable by author)

## Resource Properties

All item resources stored in ArcGIS Online support adding additional properties via a stringified JSON object. In StoryMaps, we use these to add additional meta data to each resource to be used in the future.

[Available properties](https://devtopia.esri.com/WebGIS/arcgis-storymaps/blob/450ab0c0e8a2d05302f0751de94701dce865b81a/packages/storymaps-utils/src/story/item/resources/index.ts#L20)

| Property | Description |
|---|---|
| editInfo | Properties use to track who last added or modified the resource. Primarily used for multi-author [edit tracking](#edit-tracking). *This should be added to all resources.* |
| geometry | Location of the media resource, typically extracted from original's file EXIF data. |
| attribution | Resource attribution, necessary for map screenshots |

## Edit Tracking

StoryMaps support a collaborative workflow for multiple authors. When an author opens a story version in the editor, they will be warned if another author has made changes and saved their version after the first author loaded it. Here's an example scenario:

1. Author 1 opens story version 1 in the editor.
2. Simultaneously, Author 2 also opens story version 1 in the editor.
3. Author 1 makes a change in the editor, creating story version 2.
4. Author 2 attempts to make a change in the editor, creating story version 3, but it doesn't include the changes from story version 2.
5. The story editor will warn Author 2 that they will overwrite Author 1's work and give them the option to discard their own changes instead.

Before replacing or updating any item resource, we compare the `editInfo` stored in the client's version of the item resource properties with the latest `editInfo` stored on the server (REST API item resources endpoint). If there is a mismatch, we display a warning to the author who is attempting to make the change.

## Publish Process

At the time a story is published, unpublished, or changes are discarded, we have a [simple utility](https://devtopia.esri.com/WebGIS/arcgis-storymaps/blob/450ab0c0e8a2d05302f0751de94701dce865b81a/packages/storymaps-platform-common/src/story/utils/parse-item-resources/index.ts#L18) to parse all the item resources in the published version of the story as well as the draft version of the story. At that time we perform the following tasks:

1. Update the `access` property to allow readers to view all published media resources in the [media resources](#media-resources).
2. Copy [versioned resources](#versioned-resources) to create a published or discarded changes draft version, or delete the published version when unpublishing.
3. Create [published resources](#published-resources)

---

[StoryMaps Documentation (Home)](../README.md)
