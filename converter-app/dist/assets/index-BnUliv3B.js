import{U as st,r as z,j as g,C as Mt,a as lt,b as dt,c as pt,d as kt,e as Lt,f as Rt,g as $t,h as ut,A as Et,i as Ft,k as Dt}from"./vendor-Hq5svIfp.js";import Bt from"@arcgis/core/WebMap";import Ot from"@arcgis/core/layers/CSVLayer";import Pt from"@arcgis/core/identity/IdentityManager";import Wt from"@arcgis/core/config";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const d of n)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(n){const d={};return n.integrity&&(d.integrity=n.integrity),n.referrerPolicy&&(d.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?d.credentials="include":n.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function i(n){if(n.ep)return;n.ep=!0;const d=s(n);fetch(n.href,d)}})();const mt="wJK4zhJHaHyFzyQ2",ft="https://regal-sable-0a6dde.netlify.app/",Xe="arcgis_session",it="arcgis_user_info";function Ut(v){try{const t=v.serialize();sessionStorage.setItem(Xe,t)}catch(t){console.warn("Could not serialize session:",t)}}function _t(){const v=sessionStorage.getItem(Xe);if(v)try{return st.deserialize(v)}catch{sessionStorage.removeItem(Xe)}return null}function Qe(v){try{sessionStorage.setItem(it,JSON.stringify(v))}catch(t){console.warn("Could not persist userInfo",t)}}function zt(){const v=sessionStorage.getItem(it);if(!v)return null;try{return JSON.parse(v)}catch{return sessionStorage.removeItem(it),null}}function Jt(){const v=window.location.hash.substring(1),t=new URLSearchParams(v),s=t.get("access_token")||t.get("token"),i=t.get("expires_in");return{token:s,expires:i?Date.now()+parseInt(i,10)*1e3:null}}async function ht(v){const s=await(await fetch(`https://www.arcgis.com/sharing/rest/community/self?f=json&token=${v}`)).json();return{username:s.username,role:s.role,userLicenseTypeId:s.userLicenseTypeId}}const At=z.createContext({session:null,token:null,signIn:()=>{},signOut:()=>{},loading:!1,userInfo:null,setUserInfo:()=>{}}),Vt=({children:v})=>{const[t,s]=z.useState(_t()),[i,n]=z.useState(!0),[d,c]=z.useState(zt()),[m]=z.useState(()=>new URLSearchParams(window.location.search).get("refactor")==="1");z.useEffect(()=>{const{token:a,expires:p}=Jt();if(!a){setTimeout(()=>n(!1),0);return}const f=new st({clientId:mt,redirectUri:ft,token:a,tokenExpires:p?new Date(p):new Date(Date.now()+1e3*60*60*24*14),portal:"https://www.arcgis.com/sharing/rest"});s(f),Ut(f);try{if(window.location.hash&&/access_token=/.test(window.location.hash)){const h=window.location.pathname+window.location.search;window.history.replaceState({},"",h)}}catch{}ht(a).then(h=>{const w=f.portal.replace(/\/$/,""),l=`${w}/community/users/${h.username}?f=json&token=${a}`,u=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${a}`;return Promise.all([fetch(l).then(x=>x.ok?x.json():Promise.reject(x.status)).catch(()=>null),fetch(u).then(x=>x.ok?x.json():Promise.reject(x.status)).catch(()=>null)]).then(([x,r])=>{const o=x?.thumbnail?`${w}/community/users/${h.username}/info/${x.thumbnail}?token=${a}`:void 0;let y;const j=r?.urlKey,A=r?.customBaseUrl;if(j&&A)y=`https://${j}.${A}`;else if(r?.portalHostname){const b=String(r.portalHostname);y=/^https?:/i.test(b)?b:`https://${b}`}const N={username:h.username,role:h.role,userType:h.userLicenseTypeId,fullName:x?.fullName||h.username,thumbnailUrl:o,orgUrl:y};c(N),Qe(N)}).catch(()=>{const x={username:h.username,role:h.role,userType:h.userLicenseTypeId};c(x),Qe(x)})}).catch(()=>c(null))},[m]),z.useEffect(()=>{if(t&&!d&&!i){const a=t.token;ht(a).then(p=>{const f=t.portal.replace(/\/$/,""),h=`${f}/community/users/${p.username}?f=json&token=${a}`,w=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${a}`;return Promise.all([fetch(h).then(l=>l.ok?l.json():Promise.reject(l.status)).catch(()=>null),fetch(w).then(l=>l.ok?l.json():Promise.reject(l.status)).catch(()=>null)]).then(([l,u])=>{const x=l?.thumbnail?`${f}/community/users/${p.username}/info/${l.thumbnail}?token=${a}`:void 0;let r;const o=u?.urlKey,y=u?.customBaseUrl;if(o&&y)r=`https://${o}.${y}`;else if(u?.portalHostname){const A=String(u.portalHostname);r=/^https?:/i.test(A)?A:`https://${A}`}const j={username:p.username,role:p.role,userType:p.userLicenseTypeId,fullName:l?.fullName||p.username,thumbnailUrl:x,orgUrl:r};c(j),Qe(j)})}).catch(()=>{})}},[t,d,i]),z.useEffect(()=>{t&&console.log("Session token (updated):",t.token)},[t]);const S=()=>{st.beginOAuth2({clientId:mt,redirectUri:ft,responseType:"token",popup:!1})},C=()=>{t&&(s(null),sessionStorage.removeItem(Xe))};return g.jsx(At.Provider,{value:{session:t,token:t?.token??null,signIn:S,signOut:C,loading:i,userInfo:d,setUserInfo:c},children:v})},ze=()=>z.useContext(At),Ht="0.4.6";function Gt(){const{userInfo:v,token:t,signIn:s,signOut:i}=ze(),[n,d]=z.useState(!1),c=z.useRef(null);z.useEffect(()=>{function f(w){n&&c.current&&!c.current.contains(w.target)&&d(!1)}function h(w){w.key==="Escape"&&d(!1)}return document.addEventListener("mousedown",f),document.addEventListener("keydown",h),()=>{document.removeEventListener("mousedown",f),document.removeEventListener("keydown",h)}},[n]);const m=!!t&&!!v,S=v?.username?.charAt(0).toUpperCase()||"?",C=v?.username?`https://www.arcgis.com/home/user.html?user=${v.username}`:void 0,a=v?.thumbnailUrl||null,p=v?.fullName||v?.username||"";return g.jsx("header",{className:"top-nav",children:g.jsxs("div",{className:"top-nav-inner",children:[g.jsxs("div",{className:"top-nav-titles",children:[g.jsx("div",{className:"top-nav-title",children:"Classic StoryMap Converter"}),g.jsxs("div",{className:"top-nav-subtitle",children:["Alpha | v",Ht]})]}),g.jsx("nav",{className:"top-nav-list","aria-label":"Main navigation"}),g.jsxs("div",{className:"top-nav-actions",children:[!m&&g.jsx("button",{className:"account-btn",onClick:s,"data-testid":"sign-in-btn",children:"Sign In"}),m&&g.jsxs("div",{className:"account-control",ref:c,children:[g.jsxs("button",{type:"button",className:"account-trigger","aria-haspopup":"true","aria-label":"Account menu",onClick:()=>d(f=>!f),children:[g.jsx("svg",{className:"account-trigger-icon",width:"18",height:"18",viewBox:"0 0 24 24","aria-hidden":"true",children:g.jsx("path",{fill:"currentColor",d:"M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v2h20v-2c0-3.3-6.7-5-10-5z"})}),g.jsx("svg",{className:"account-caret",width:"12",height:"12",viewBox:"0 0 24 24","aria-hidden":"true",children:g.jsx("path",{fill:"currentColor",d:"M7 10l5 5 5-5z"})})]}),n&&g.jsxs("div",{className:"account-menu",role:"group","aria-label":"Account menu",children:[g.jsxs("div",{className:"account-menu-header",children:[a?g.jsx("img",{src:a,alt:"","aria-hidden":"true",className:"account-menu-avatar"}):g.jsx("span",{className:"account-menu-avatar fallback","aria-hidden":"true",children:S}),g.jsxs("div",{className:"account-menu-names",children:[g.jsx("div",{className:"account-full-name",children:p||v?.username||"Loading…"}),g.jsx("div",{className:"account-username-sub",children:v?.username})]})]}),g.jsx("div",{className:"account-menu-divider"}),C&&g.jsx("a",{href:C,target:"_blank",rel:"noopener",className:"account-menu-item",children:"View Profile"}),g.jsx("button",{className:"account-menu-item",onClick:()=>{d(!1),i()},children:"Sign Out"})]})]})]})]})})}function qt({open:v,onCancel:t,onContinue:s}){const[i,n]=z.useState(""),[d,c]=z.useState(""),[m,S]=z.useState(!1),C=z.useRef(null);z.useEffect(()=>{v&&setTimeout(()=>{S(!1),C.current?.focus()},0)},[v,S]);const a=f=>{if(!f)return!1;try{const h=new URL(f);return!!h.protocol&&!!h.host}catch{return!1}},p=()=>{const f=a(i);S(!f),f&&s(i.trim(),d.trim()||void 0)};return g.jsxs(Mt,{open:v,heading:"Sign in to ArcGIS Enterprise",onCalciteDialogClose:t,children:[g.jsxs("div",{children:[g.jsxs(lt,{children:["URL",g.jsx(dt,{ref:C,required:!0,id:"enterprise_portal_url",name:"enterprise_portal_url",placeholder:"e.g. https://myportal.mydomain.com/portal",type:"text",value:i,onCalciteInputChange:f=>{const h=f?.target?.value??"";n(h)}}),g.jsx(pt,{status:m?"invalid":void 0,children:"Enter a valid organization url"})]}),g.jsxs(kt,{layout:"inline",children:[g.jsx(Lt,{slot:"tab-nav",children:g.jsx(Rt,{children:"OAuth Login"})}),g.jsx($t,{style:{width:"100%",marginTop:"1rem"},children:g.jsxs(lt,{children:["App ID",g.jsx(dt,{id:"enterprise_client_id",name:"app_client_id",placeholder:"e.g. aBcDeFgHi1j2K3L4",type:"text",value:d,onCalciteInputChange:f=>{const h=f?.target?.value??"";c(h)}}),g.jsx(pt,{status:"invalid",children:"Enter a valid registered App ID"})]})})]}),g.jsxs("details",{className:"enterprise-details",children:[g.jsx("summary",{children:"More Details"}),g.jsxs("p",{className:"enterprise-details-text",children:["In order to log in to a Portal for ArcGIS instance using a SAML-based Identity Provider, you will need to Register the Classic StoryMap Converter as an application in your Portal, and generate an AppID that can identify this app as an allowed client of the Portal. To do so, follow the instructions "," ",g.jsx("a",{href:"https://enterprise.arcgis.com/en/portal/latest/use/add-app-url.htm#REG_APP",target:"_blank",rel:"noopener",children:"here"}),", using ",g.jsx("strong",{children:"Other Application"})," as the ",g.jsx("em",{children:"Type of App"})," and",g.jsx("code",{className:"enterprise-details-code",children:"https://url-for-this-app.com/"}),"as the Redirect URI."]})]})]}),g.jsxs("div",{slot:"footer",children:[g.jsx(ut,{color:"blue",onClick:p,children:"Continue"}),g.jsx(ut,{appearance:"outline",color:"blue",onClick:t,children:"Cancel"})]})]})}const Kt="/assets/storymap-map-tour-CbGOcXZK.png",Yt="/assets/storymap-map-journal-B6_zTpqe.png",Xt="/assets/storymap-series-tabbed-I93IZkLj.png",Zt="/assets/storymap-cascade-Dxb7EL3J.png",Qt="/assets/storymap-shortlist-C-e80pOE.png",es="/assets/storymap-crowdsource-CiU2l24Z.png",ts={mapTour:!0,mapJournal:!0,mapSeries:!1,cascade:!1,shortlist:!1,crowdsource:!1,swipe:!0,basic:!1};function ss(v){const t=(v||"").toLowerCase(),s=t==="map journal"||t==="mapjournal"?"mapJournal":t==="map tour"||t==="maptour"?"mapTour":t==="map series"||t==="series"?"mapSeries":t==="cascade"?"cascade":t==="shortlist"?"shortlist":t==="crowdsource"?"crowdsource":t==="swipe"?"swipe":t==="basic"?"basic":"";return!!(s&&ts[s])}const is="/assets/storymap-swipe-DCnpLp2Y.png",ns="/assets/storymap-basic-DyApzf39.png",rs=[{key:"mapTour",title:"Map Tour",description:"Presented a sequential, place-based narrative with geotagged photos linked to an interactive map.",image:Kt,status:"active",alt:"Map Tour Thumbnail"},{key:"mapJournal",title:"Map Journal",description:"Presented a compelling map-based narrative presented as a set of journal entries.",image:Yt,status:"active",alt:"Map Journal Thumbnail"},{key:"mapSeries",title:"Map Series",description:"Presented a series of maps via a set of tabs, bullets or expanding side panel.",image:Xt,status:"disabled",alt:"Map Series - Tabbed Thumbnail"},{key:"cascade",title:"Cascade",description:"Combined text with maps, images, and multimedia in an engaging, full-screen scrolling experience.",image:Zt,status:"disabled",alt:"Cascade Thumbnail"},{key:"shortlist",title:"Shortlist",description:"Presented a set of places organized into a set of tabs based on themes.",image:Qt,status:"disabled",alt:"Shortlist Thumbnail"},{key:"crowdsource",title:"Crowdsource",description:"Displayed crowdsourced photos with captions. The conversion will be view-only.",image:es,status:"disabled",alt:"Crowdsource Thumbnail"},{key:"swipe",title:"Swipe",description:"Displayed two layers or two maps side by side for comparison.",image:is,status:"active",alt:"Swipe Thumbnail"},{key:"basic",title:"Basic",description:"Presented a map via a minimalist interface. Converted to an ArcGIS Instant App.",image:ns,status:"disabled",alt:"Story Map Basic Thumbnail"}],os=()=>{const{signIn:v}=ze(),[t,s]=z.useState(!1);return g.jsxs(g.Fragment,{children:[g.jsxs("div",{id:"splashContainer",className:"splash-container",children:[g.jsxs("div",{className:"jumbotron",children:[g.jsx("h2",{children:"Classic StoryMap Converter"}),g.jsx("p",{className:"lead",children:"Convert Classic Esri Story Maps to ArcGIS StoryMaps"}),g.jsx("div",{className:"loginButtons",children:g.jsxs("p",{children:[g.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-success login-btn",onClick:v,children:"Log in to ArcGIS Online"}),g.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-default",onClick:()=>s(!0),children:"Log in to Portal for ArcGIS"})]})})]}),g.jsx("div",{className:"row marketing marketing-row",children:rs.map(i=>{const n=i.status!=="active";return g.jsxs("div",{className:`marketing-col${n?" disabled":""}`,"data-disabled":n?"true":"false",children:[g.jsx("h4",{children:i.title}),g.jsxs("div",{className:"marketing-img-container",children:[g.jsx("img",{src:i.image,alt:i.alt,className:"marketing-img"}),n&&g.jsx("div",{className:"disabled-overlay",children:"Coming Soon"})]}),g.jsx("p",{children:i.description})]},i.key)})})]}),g.jsx(qt,{open:t,onCancel:()=>s(!1),onContinue:(i,n)=>{s(!1),console.info("[EnterpriseSignInModal] continue",{url:i,appId:n})}})]})},De=new Map,nt=new Set;function jt(){const v=De.size;for(const t of Array.from(nt))try{t(v)}catch{}}async function ke(v,t,s){const i=Date.now(),n=De.get(v);if(n){if(!n.expiresAt||n.expiresAt>i)return n.data;De.delete(v)}const d=await fetch(v,t);if(!d.ok)throw new Error(`Fetch failed ${d.status}: ${v}`);const c=await d.json(),m=i+s;return De.set(v,{data:c,expiresAt:m}),jt(),c}function as(v){De.clear(),jt()}function yt(){return De.size}function cs(v){nt.add(v)}function ls(v){nt.delete(v)}async function gt(v){const t=await fetch(v);if(!t.ok)throw new Error(`Fetch failed: ${t.status} ${t.statusText}`);return t.json()}async function ds(v,t){const s=[],i=[],n=Array.from(new Set(v.filter(c=>/^[a-f0-9]{32}$/i.test(c))));for(const c of n)try{const m=`https://www.arcgis.com/sharing/rest/content/items/${c}`,S=`${m}/data?f=json${t?`&token=${encodeURIComponent(t)}`:""}`,C=`${m}?f=json${t?`&token=${encodeURIComponent(t)}`:""}`,[a,p]=await Promise.all([gt(S).catch(()=>null),gt(C).catch(()=>null)]);if(!p){s.push({itemId:c,level:"error",message:"Webmap item not accessible (404 or permission). Please verify the item exists and you have access."});continue}const f=p?.title||p?.name||"",h=[],w=a&&(a.version||a.itemVersion)||p&&(p.itemVersion||p.version);if(w&&typeof w=="string"){const o=parseFloat(w);if(!Number.isNaN(o)&&o<2){const y=`https://www.arcgis.com/home/webmap/viewer.html?webmap=${c}`;s.push({itemId:c,level:"warning",message:`Webmap version ${w} < 2.0. Open in <a href="${y}" target="_blank" rel="noopener noreferrer">Classic Map Viewer</a> and save to upgrade.`})}}const l=a?.operationalLayers||[],u=a?.baseMap?.baseMapLayers||[],x=[];for(const o of l)o?.url&&x.push({url:o.url,title:o.title,layerItemId:o.itemId,layerTitle:o.title});for(const o of u)o?.url&&x.push({url:o.url,title:o.title});const r=o=>{try{const y=new URL(o),j=y.hostname.toLowerCase(),A=y.pathname.toLowerCase();if(j.endsWith("services.arcgisonline.com"))return/(mapserver|featureserver)/i.test(A)}catch{}return!1};for(const{url:o,title:y,layerItemId:j,layerTitle:A}of x){/^http:\/\//i.test(o)&&(h.push({url:o,error:"HTTP URL (use HTTPS)",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:o,ok:!1,errorCategory:"mixed-content",errorMessage:"HTTP URL (use HTTPS)"}),typeof window<"u"&&window.location?.protocol==="https:"&&(h.push({url:o,error:"Mixed content risk on HTTPS",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:o,ok:!1,errorCategory:"mixed-content",errorMessage:"Mixed content risk on HTTPS"})));const N=typeof window<"u"&&window.location?.hostname?/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname):!1,b=o.split("?")[0],k=`${b}${b.includes("?")?"":"?"}${b.includes("?")?"&":""}f=pjson`,E=/(FeatureServer|MapServer)\/\d+$/i.test(b)?b.replace(/\/(FeatureServer|MapServer)\/\d+$/i,"/$1"):b,J=`${E}${E.includes("?")?"":"?"}${E.includes("?")?"&":""}f=pjson`,M=O=>`/.netlify/functions/proxy-feature?url=${encodeURIComponent(O)}`,I=N?M(k):k,W=N?M(J):J,G=async O=>{for(let _=0;_<2;_++)try{const B=await fetch(O,{method:"GET"});if(!B.ok)return{ok:!1,resp:B,json:null};const de=B.headers.get("content-type")||"",je=/application\/(?:json|pjson)/i.test(de)?await B.clone().json().catch(()=>null):null;return{ok:!0,resp:B,json:je}}catch{if(_===1)return{ok:!1,resp:void 0,json:null};await new Promise(B=>setTimeout(B,150))}return{ok:!1,resp:void 0,json:null}},$=await G(I),V=await G(W),P=!!$.resp&&$.resp.ok,we=!!V.resp&&V.resp.ok,L=P&&!!$.json&&!$.json?.error,R=we&&!!V.json&&!V.json?.error;if($.ok&&$.json){const O=$.json?.error?.message||$.json?.message||"",_=/token/i.test(O)||$.json?.error?.code===499,B=/permission|privilege|authorized|do not have permissions|not permitted/i.test(O)||$.json?.error?.code===403;_&&h.push({url:o,status:$.resp?.status,error:"Token required",title:y,layerItemId:j,layerTitle:A}),B&&h.push({url:o,status:$.resp?.status,error:"Permissions denied or item private",title:y,layerItemId:j,layerTitle:A});const de=typeof $.json?.type=="string"||typeof $.json?.geometryType=="string"||Array.isArray($.json?.fields)||Array.isArray($.json?.layers),pe=!!$.json?.error;!de&&!pe&&!R&&h.push({url:o,status:$.resp?.status,error:"Invalid layer definition",title:y,layerItemId:j,layerTitle:A}),pe&&h.push({url:o,status:$.resp?.status,error:"Layer error JSON",title:y,layerItemId:j,layerTitle:A});const je=$.resp?.headers?.get("content-type")||"";/application\/(?:json|pjson)/i.test(je)||(h.push({url:o,status:$.resp?.status,error:"Non-JSON response",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:o,status:$.resp?.status,ok:!1,errorCategory:"non-json",errorMessage:"Non-JSON response"})),$.json||(h.push({url:o,status:$.resp?.status,error:"JSON parse failed",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:o,status:$.resp?.status,ok:!1,errorCategory:"json-error",errorMessage:"JSON parse failed"}))}if(!L&&!r(b)){const O=$.resp?.status,_=$.json?.error?$.json.error.message||"Layer error JSON":void 0;h.push({url:o,status:O,error:_||"Layer endpoint not healthy",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:o,status:O,ok:!1,errorCategory:_?"json-error":"other",errorMessage:_||"Layer endpoint not healthy"})}if(V.ok&&V.json?.error){const O=V.json?.error?.message||V.json?.message||"",_=/permission|privilege|authorized|do not have permissions|not permitted/i.test(O)||V.json?.error?.code===403;h.push({url:E,status:V.resp?.status,error:_?"Service permissions denied or item private":"Service error JSON",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:E,status:V.resp?.status,ok:!1,errorCategory:_?"permission-denied":"json-error",errorMessage:_?"Service permissions denied or item private":"Service error JSON"})}if(!P&&!r(b)&&(h.push({url:o,status:$.resp?.status,error:"Layer HTTP failure",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:o,status:$.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Layer HTTP failure"})),!we&&!r(E)&&(h.push({url:E,status:V.resp?.status,error:"Service HTTP failure",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:E,status:V.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Service HTTP failure"})),V.ok&&V.json&&!V.json.error){const O=V.json,_=typeof O.currentVersion=="number"||typeof O.currentVersion=="string",B=typeof O.capabilities=="string"||Array.isArray(O.capabilities);(!_||!B)&&(h.push({url:E,status:V.resp?.status,error:"Service missing capabilities/version",title:y,layerItemId:j,layerTitle:A}),i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:E,status:V.resp?.status,ok:!1,errorCategory:"other",errorMessage:"Service missing capabilities/version"}))}L&&i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:o,status:$.resp?.status,ok:!0,errorCategory:"ok"}),R&&i.push({webmapId:c,webmapTitle:f,layerTitle:A,layerItemId:j,url:E,status:V.resp?.status,ok:!0,errorCategory:"ok"})}for(const o of l)if(o?.itemId&&/^[a-f0-9]{32}$/i.test(o.itemId)){const y=`https://www.arcgis.com/sharing/rest/content/items/${o.itemId}?f=json${t?`&token=${encodeURIComponent(t)}`:""}`;try{const j=await fetch(y);if(j.ok){const A=await j.json();if(A.error){const N=A.error?.code,b=A.error?.message||"",k=N===403||/permission|privilege|authorized|not permitted/i.test(b);h.push({url:y,status:j.status,error:k?"Layer item private or permission denied":"Layer item error JSON",title:o.title,layerItemId:o.itemId,layerTitle:o.title})}}else{const A=j.status,N=A===404?"Layer item deleted":A===403?"Layer item private or permission denied":"Layer item not accessible";h.push({url:y,status:A,error:N,title:o.title,layerItemId:o.itemId,layerTitle:o.title})}}catch{h.push({url:y,error:"Layer item unreachable",title:o.title,layerItemId:o.itemId,layerTitle:o.title})}}h.length&&s.push({itemId:c,level:"warning",message:`Webmap ${f?'"'+f+'" ':""}has ${h.length} failing endpoint(s).`,details:{webmapTitle:f,failures:h}})}catch{s.push({itemId:c,level:"warning",message:"Failed to validate webmap. Proceeding, but please check the item manually."})}const d={};for(const c of i){const m=c.errorCategory||(c.ok?"ok":"other");d[m]=(d[m]||0)+1}return{warnings:s,endpointChecks:i,endpointCategorySummary:d}}function Be(v){const t=u=>!!u&&typeof u=="object";if(!t(v))return"unknown";const s=v.values||{},i=(u,x)=>t(u)?u[x]??void 0:void 0,n=i(s,"settings")??{},d=i(s,"story"),c=d&&Array.isArray(d.sections)?d.sections:void 0;if(c&&c.length)return"Map Journal";let m;const S=i(s,"templateName");typeof S=="string"&&S.trim()&&(m=S);const C=i(s,"template");typeof C=="string"&&C.trim()&&(m=C);const a=i(s,"template"),p=a&&typeof a.name=="string"?a.name:void 0;if(p&&(m=p),m&&/\bswipe\b/i.test(m))return"Swipe";if(m)return ps(m);if(!m&&n&&t(n)&&t(n.components))return"Crowdsource";const f=i(s,"series");if(Array.isArray(f))return"Map Series";const h=i(s,"tabs")??i(s,"tabs");if(Array.isArray(h)||h)return"Shortlist";const w=i(s,"order");if(Array.isArray(w))return"Map Tour";if(i(s,"dataModel")||i(s,"layers")||i(s,"webmaps"))return"Swipe";const l=i(s,"components");return l&&t(l)&&l.contribute?"Crowdsource":c?c.some(u=>t(u)&&u.type==="sequence")?"Cascade":"Map Journal":"Basic"}function ps(v){const t=v.toLowerCase();return t.includes("journal")?"Map Journal":t.includes("tour")?"Map Tour":t.includes("series")?"Map Series":t.includes("cascade")?"Cascade":t.includes("shortlist")?"Shortlist":t.includes("swipe")?"Swipe":t.includes("crowdsource")?"Crowdsource":t.includes("basic")?"Basic":v}function Ye(){throw new Error("execSync is not available in the browser environment")}function et(){throw new Error("execFileSync is not available in the browser environment")}const us={};class rt{constructor(t){this.classicJson=t.classicJson,this.themeId=t.themeId,this.progress=t.progress,this.storyId=t.storyId,this.username=t.username,this.token=t.token,this.uploader=t.uploader,this.inlineUpload=t.inlineUpload}emit(t){this.progress({stage:"convert",message:t})}convert(){this.emit("Beginning conversion"),this.extractStructure(),this.convertContent(),this.applyTheme();const t=this.collectMedia();return{storymapJson:this.getStoryMapJson(),mediaUrls:t}}}function he(v){const t=Math.abs(v.ymax-v.ymin);return t<=500?{scale:500,zoom:20}:t<=1e3?{scale:1e3,zoom:19}:t<=5e3?{scale:5e3,zoom:17}:t<=1e4?{scale:1e4,zoom:16}:t<=5e4?{scale:5e4,zoom:14}:t<=1e5?{scale:1e5,zoom:13}:t<=5e5?{scale:5e5,zoom:11}:t<=1e6?{scale:1e6,zoom:10}:t<=5e6?{scale:5e6,zoom:8}:t<=1e7?{scale:1e7,zoom:7}:{scale:25e6,zoom:6}}const bt={variables:{headerFooterBackgroundColor:"#ffffff",backgroundColor:"#ffffff",titleFontId:"avenirNext",titleColor:"#002625",titleColorDark:"#002625",titleColorLight:"#ffffff",bodyFontId:"notoSerif",bodyColor:"#304e4e",bodyColorDark:"#002625",bodyColorLight:"#ffffff",bodyMutedColor:"#3d6665",themeColor1:"#087f9b",themeColor2:"#fc3b36",themeColor3:"#126057",borderRadius:0,shape:"hexagon",colorRamps:["seq-single-blues","seq-multi-ylgn","seq-orange-red-light","seq-yellow-darkblue-bright-reversed"],basemapPrimary:"humanGeographyLight",basemapAlt:"lightGrayCanvas",basemapImagery:"worldImagery"}},wt={variables:{headerFooterBackgroundColor:"#000000",backgroundColor:"#0e1116",titleFontId:"charterBT",titleColor:"#f3f3f3",titleColorDark:"#0E1116",titleColorLight:"#f3f3f3",bodyFontId:"arial",bodyColor:"#e6f2f2",bodyColorDark:"#0E1116",bodyColorLight:"#E6F2F2",bodyMutedColor:"#809e9d",themeColor1:"#ea5b41",themeColor2:"#4d6aff",themeColor3:"#0ec2db",borderRadius:9999,colorRamps:["seq-blue-bright-5","seq-yellow-bright-3","seq-green-bright-3","seq-red-bright-4"],basemapPrimary:"darkGrayCanvas",basemapAlt:"humanGeographyDark",basemapImagery:"worldImagery"}};function vt(v,t){if(!v||!v.includes("font-family"))return t;let s=v;const i=/font-family:\s*'([^']+)'/.exec(v)||/font-family:\s*"([^"]+)"/.exec(v);if(i)s=i[1];else{const c=/font-family:\s*([^;]+);?/.exec(v);c&&(s=c[1].split(",")[0].trim().replace(/["']/g,""))}const n=s.toLowerCase().replace(/\s+/g,"");return{open_sansregular:"openSans",opensans:"openSans",roboto:"roboto",noto:"notoSerif",notoserif:"notoSerif",lato:"lato",sourcesanspro:"sourceSansPro",avenirnext:"avenirNext",charterbt:"charterBT",arial:"arial"}[n]||t}function ms(v){const t=v.values||{},i=(t.settings||{}).theme||{},n=i.colors||{},d=i.fonts||{},c=(t.title||"").trim()+" (Theme)",S=(n.themeMajor||"").toLowerCase()==="black"?"obsidian":"summit",a={...(S==="obsidian"?wt:bt).variables},p=S==="obsidian"?wt.variables:bt.variables;for(const[y,j]of Object.entries(p))y in a||(a[y]=j);const f=[];let h;n.panel&&(a.backgroundColor=n.panel,f.push("backgroundColor")),n.dotNav&&(a.headerFooterBackgroundColor=n.dotNav,f.push("headerFooterBackgroundColor")),n.text&&(a.bodyColor=n.text,f.push("bodyColor"),h="text"),!a.bodyColorDark&&p.bodyColorDark&&(a.bodyColorDark=p.bodyColorDark),!a.bodyColorLight&&p.bodyColorLight&&(a.bodyColorLight=p.bodyColorLight),!a.titleColorDark&&p.titleColorDark&&(a.titleColorDark=p.titleColorDark),!a.titleColorLight&&p.titleColorLight&&(a.titleColorLight=p.titleColorLight),n.textLink&&(a.themeColor1=n.textLink,f.push("themeColor1")),!n.text&&n.textLink&&(a.bodyColor=n.textLink,f.push("bodyColor"),h="textLink"),n.softText&&(a.bodyMutedColor=n.softText,f.push("bodyMutedColor")),!a.colorRamps&&p.colorRamps&&(a.colorRamps=p.colorRamps),!a.basemapPrimary&&p.basemapPrimary&&(a.basemapPrimary=p.basemapPrimary),!a.basemapAlt&&p.basemapAlt&&(a.basemapAlt=p.basemapAlt),!a.basemapImagery&&p.basemapImagery&&(a.basemapImagery=p.basemapImagery),S==="summit"&&!a.shape&&p.shape&&(a.shape=p.shape);const w=d.sectionTitle?.value,l=d.sectionContent?.value,u=vt(w,a.titleFontId),x=vt(l,a.bodyFontId);u&&u!==a.titleFontId&&(a.titleFontId=u,f.push("titleFontId")),x&&x!==a.bodyFontId&&(a.bodyFontId=x,f.push("bodyFontId"));const r={title:c,baseThemeId:S,isFromOrgTheme:!1,variables:a,resources:{}},o={baseThemeId:S,colorMappings:{panelToBackgroundColor:n.panel,dotNavToHeaderFooterBackgroundColor:n.dotNav,textToBodyColor:n.text,textLinkToBodyColor:n.text?void 0:n.textLink,textLinkToThemeColor1:n.textLink,softTextToBodyMutedColor:n.softText,chosenBodyColorSource:h},fontMappings:{classicTitleFontValue:w,mappedTitleFontId:u,classicBodyFontValue:l,mappedBodyFontId:x},variableOverridesApplied:f};return{theme:r,decisions:o}}const fs="arcgis-storymaps-classic-converter",hs="0.4.6",ys="module",gs={dev:"vite",build:"vite build",typecheck:"tsc -b",lint:"eslint .",preview:"vite preview","netlify:dev":"netlify dev"},bs={"@esri/arcgis-rest-auth":"^3.8.0","@esri/calcite-components":"^3.3.3","@esri/calcite-components-react":"^3.3.3","@arcgis/core":"^4.30.6","@netlify/functions":"^5.1.0",react:"^19.2.0","react-dom":"^19.2.0",tsx:"^4.20.6"},ws={"@eslint/js":"^9.39.1","@netlify/vite-plugin":"^2.7.14","@types/node":"^24.10.0","@types/react":"^19.2.2","@types/react-dom":"^19.2.2","@vitejs/plugin-react":"^5.1.0",eslint:"^9.39.1","eslint-plugin-react-hooks":"^7.0.1","eslint-plugin-react-refresh":"^0.4.24",globals:"^16.5.0","image-size":"^2.0.2","ts-node":"^10.9.2",typescript:"~5.9.3","typescript-eslint":"^8.46.3",vite:"^7.2.2"},vs={name:fs,private:!0,version:hs,type:ys,scripts:gs,dependencies:bs,devDependencies:ws};function xt(){try{const v=vs?.version;if(typeof v=="string"&&v.length)return v}catch{}try{const v=typeof import.meta<"u"?import.meta:void 0,t=v?.env?.VITE_APP_VERSION||v?.env?.APP_VERSION||"";if(typeof t=="string"&&t.length)return t}catch{}try{const v=typeof process<"u"?process:void 0,t=v?.env?.npm_package_version||v?.env?.APP_VERSION||"";if(typeof t=="string"&&t.length)return t}catch{}return"0.0.0"}class ot{constructor(t){this.themeResourceId=this.generateResourceId(),this.json={root:"",nodes:{},resources:{[this.themeResourceId]:{type:"story-theme",data:{themeId:t,themeBaseVariableOverrides:{}}}},actions:[]}}createStoryRoot(){const t=this.generateNodeId();return this.json.root=t,this.json.nodes[t]={type:"story",data:{storyTheme:this.themeResourceId},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[]},t}addNode(t,s,i,n){const d=this.generateNodeId(),c={type:t};return s&&(c.data=s),i&&(c.config=i),n&&(c.children=n),this.json.nodes[d]=c,d}applyTheme(t){const s=this.json.resources[this.themeResourceId];s&&s.type==="story-theme"&&(s.data.themeId=t.themeId,t.variableOverrides&&Object.keys(t.variableOverrides).length&&(s.data.themeBaseVariableOverrides=t.variableOverrides))}addImageResource(t,s,i){const n=this.generateResourceId();return this.json.resources[n]={type:"image",data:{src:t,provider:"uri",width:s,height:i}},n}finalizeImageResourceAsItem(t,s,i,n){const d=this.json.resources[t];!d||d.type!=="image"||(delete d.data.src,d.data.resourceId=s,d.data.provider="item-resource",i&&(d.data.width=i),n&&(d.data.height=n))}addVideoResource(t,s="uri",i){const n=i??this.generateResourceId();return this.json.resources[n]={type:"video",data:{src:t,provider:s}},n}addTextBlock(t,s,i){const n=this.generateNodeId(),c={type:"text",data:{text:s,type:i==="bullet-list"?"paragraph":i}};return this.json.nodes[n]=c,this.appendChild(t,n),n}addImageNode(t,s,i,n,d="standard"){const c=this.generateNodeId(),m={type:"image",data:{image:s,caption:i,alt:n},config:{size:d}};return this.json.nodes[c]=m,this.appendChild(t,c),c}addRichTextToRoot(t,s="paragraph",i="wide"){if(!this.json.root)return this.createRichTextNode(t,s,i);const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:t,type:s,preserveHtml:!0,textAlignment:"start"},config:{size:i}},this.appendChild(this.json.root,n),n}addVideoNode(t,s){const i=this.generateNodeId(),n={type:"video",data:{src:s.src,resourceId:s.resourceId,provider:s.provider,caption:s.caption,alt:s.alt}};return this.json.nodes[i]=n,this.appendChild(t,i),i}addWebMapResource(t,s="Web Map",i,n="minimal"){const d=`r-${t}`,c={type:n,itemId:t,itemType:s};if(!this.json.resources[d])this.json.resources[d]={type:"webmap",data:c};else{const m=this.json.resources[d];m&&m.type==="webmap"&&(m.data=m.data||{},m.data.type=n,m.data.itemId=t,m.data.itemType=s,m.data.initialState&&delete m.data.initialState,this.json.resources[d]=m)}return i&&this.updateWebMapInitialState(d,i),d}addWebMapNode(t,s,i){const n=this.generateNodeId(),d={type:"webmap",data:{map:s,caption:i}};return this.json.nodes[n]=d,this.appendChild(t,n),n}updateWebMapInitialState(t,s){const i=this.json.resources[t];if(!i||i.type!=="webmap")return;i.data=i.data||{};const n={...i.data,...s};delete n.initialState,i.data=n,this.json.resources[t]=i}updateWebMapData(t,s){const i=this.json.resources[t];!i||i.type!=="webmap"||(i.data=i.data||{},i.data={...i.data,...s},i.data.initialState&&delete i.data.initialState,this.json.resources[t]=i)}addCoverNode(t,s,i){const n=this.generateNodeId();return this.json.nodes[n]={type:"storycover",data:{type:"minimal",title:t,summary:s||"",byline:i||"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},this.json.root&&this.json.nodes[this.json.root]&&this.appendChild(this.json.root,n),n}addNavigationHidden(){const t=this.generateNodeId();return this.json.nodes[t]={type:"navigation",data:{links:[]},config:{isHidden:!0}},this.json.root&&this.appendChild(this.json.root,t),t}addCreditsNode(){const t=this.generateNodeId(),s=this.generateNodeId();this.json.nodes[s]={type:"attribution",data:{content:"",attribution:""}};const i=this.generateNodeId();this.json.nodes[i]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}};const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}},this.json.nodes[t]={type:"credits",children:[i,n,s]},this.json.root&&this.appendChild(this.json.root,t),t}addSidecar(t="docked-panel",s="end",i="medium"){const n=this.generateNodeId(),d=this.generateNodeId(),c=this.generateNodeId();this.json.nodes[n]={type:"immersive",data:{type:"sidecar",subtype:t,narrativePanelPosition:s,narrativePanelSize:i},children:[d]},this.json.nodes[d]={type:"immersive-slide",data:{transition:"fade"},children:[c]},this.json.nodes[c]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[]};const m=this.json.nodes[this.json.root];if(m?.children){const S=m.children.findIndex(C=>this.json.nodes[C]?.type==="credits");S>-1?m.children.splice(S,0,n):m.children.push(n)}return{immersiveId:n,slideId:d,narrativeId:c}}addSection(t,s,i){const n=this.generateNodeId();if(this.json.nodes[n]={type:"slide",children:[]},this.appendChild(t,n),s&&this.addTextBlock(n,s,"h2"),i){const d=i.replace(/<[^>]+>/g,"").trim();d&&this.addTextBlock(n,d,"paragraph")}return n}appendChild(t,s){const i=this.json.nodes[t];i&&(i.children||(i.children=[]),i.children.push(s))}getJson(){for(const d of Object.values(this.json.nodes))d&&(d.type==="webmap"?(d.config?"size"in d.config||(d.config.size="standard"):d.config={size:"standard"},d.data&&"scale"in d.data&&delete d.data.scale):d.type==="text"&&d.data&&!("textAlignment"in d.data)&&(d.data.textAlignment="start"));if(this.json.root){const d=this.json.nodes[this.json.root];d?.type==="story"&&d.data&&"metaSettings"in d.data&&delete d.data.metaSettings}const t={};for(const[d,c]of Object.entries(this.json.nodes))d!==this.json.root&&(t[d]=c);this.json.root&&(t[this.json.root]=this.json.nodes[this.json.root]);const{root:s,resources:i,actions:n}=this.json;return{root:s,nodes:t,resources:i,actions:n}}updateNodeData(t,s){const i=this.json.nodes[t];i&&(i.data||(i.data={}),s(i.data,i))}updateNode(t,s){const i=this.json.nodes[t];i&&s(i)}removeNode(t){const s=this.json.nodes;if(!(!s||!s[t])){for(const i of Object.values(s))if(i?.children&&Array.isArray(i.children)){const n=i.children.indexOf(t);n>-1&&i.children.splice(n,1)}delete s[t]}}setStoryMeta(t,s,i){if(!this.json.root)return;const n=this.json.nodes[this.json.root];!n||n.type!=="story"||(n.data||(n.data={}),n.data.metaSettings={title:t,description:s||"",imageResourceId:i})}addConverterMetadata(t,s){let i="";try{const S=typeof import.meta<"u"?import.meta:void 0;S&&S.env&&typeof S.env.SUPPRESS_CONVERTER_METADATA<"u"&&(i=String(S.env.SUPPRESS_CONVERTER_METADATA))}catch{}if(!i)try{const S=typeof process<"u"?process:void 0;S&&S.env&&typeof S.env.SUPPRESS_CONVERTER_METADATA<"u"&&(i=String(S.env.SUPPRESS_CONVERTER_METADATA))}catch{}try{const S=typeof globalThis<"u"?globalThis:void 0;!i&&S&&typeof S.__SUPPRESS_CONVERTER_METADATA<"u"&&(i=String(S.__SUPPRESS_CONVERTER_METADATA))}catch{}if(String(i||"").toLowerCase()==="true")return;const d=Object.entries(this.json.resources).find(([,S])=>S?.type==="converter-metadata");if(d){const[S,C]=d,a=C.data;a.typeConvertedTo||(a.typeConvertedTo="storymap"),a.converterVersion||(a.converterVersion=xt()),t&&(a.classicType=t);const p=s.classicMetadata||{},f=a.classicMetadata=a.classicMetadata||{};if(p&&typeof p.classicTheme<"u"&&(f.classicTheme=p.classicTheme),p&&typeof p.mappingDecisions<"u"){const w=p.mappingDecisions,l=f.mappingDecisions=f.mappingDecisions||{};for(const[u,x]of Object.entries(w))l[u]=x}for(const[w,l]of Object.entries(s))w!=="classicMetadata"&&(a[w]=l);const h=p?.templateVersion;h&&!a.classicTemplateVersion&&(a.classicTemplateVersion=h),delete this.json.resources[S],this.json.resources[S]=C,this.json.resources[S]=C;return}const c=this.generateResourceId(),m={type:"converter-metadata",data:{typeConvertedTo:"storymap",converterVersion:xt(),classicType:t,...s}};try{const C=(s.classicMetadata||{})?.templateVersion;C&&(m.data.classicTemplateVersion=C)}catch{}this.json.resources[c]=m}generateNodeId(){return`n-${Math.random().toString(36).slice(2,8)}`}generateResourceId(){return`r-${Math.random().toString(36).slice(2,8)}`}createTextNode(t,s,i="wide"){const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:t,type:s,textAlignment:"start"},config:{size:i}},n}createRichTextNode(t,s,i="wide"){const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:t,type:s,preserveHtml:!0,textAlignment:"start"},config:{size:i}},n}createImageNode(t,s,i,n="wide"){const d=this.generateNodeId();return this.json.nodes[d]={type:"image",data:{image:t,caption:s,alt:i},config:{size:n}},d}createWebMapNode(t,s){const i=this.generateNodeId();return this.json.nodes[i]={type:"webmap",data:{map:t,caption:s},config:{size:"standard"}},i}createVideoNode(t,s,i){const n=this.generateNodeId();return this.json.nodes[n]={type:"video",data:{video:t,caption:s,alt:i}},n}createVideoEmbedNode(t,s,i,n,d,c,m,S="16:9"){const C=this.generateNodeId();let a=t;return s==="youtube"&&i?a=`https://www.youtube.com/embed/${i}`:s==="vimeo"&&i&&(a=`https://player.vimeo.com/video/${i}`),this.json.nodes[C]={type:"embed",data:{url:t,embedSrc:a,embedType:"video",provider:s,videoId:i,title:d||void 0,description:c||void 0,caption:n||void 0,alt:m||"",isEmbedSupported:!0,display:"inline",aspectRatio:S}},C}createEmbedNode(t,s,i,n,d){const c=this.generateNodeId();return this.json.nodes[c]={type:"embed",data:{url:t,embedType:"link",title:i,description:n,caption:s,alt:d||"",isEmbedSupported:!0,display:"inline",embedSrc:t}},c}createSwipeNode(t,s,i="extent",n){const d=this.generateNodeId();return this.json.nodes[d]={type:"swipe",data:{contents:{0:t,1:s},viewPlacement:i,caption:n},config:{size:"full"}},d}addSlideToSidecar(t,s,i){const n=this.json.nodes[t];if(!n||n.type!=="immersive")throw new Error("addSlideToSidecar: invalid sidecarId");const d=this.generateNodeId();this.json.nodes[d]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[...s]};const c=this.generateNodeId(),m=i?[d,i]:[d];return this.json.nodes[c]={type:"immersive-slide",data:{transition:"fade"},children:m},n.children||(n.children=[]),n.children.push(c),{slideId:c,narrativeId:d}}createActionButtonNode(t,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"action-button",data:{text:t},config:{size:s}},i}addActionButton(t,s,i="wide"){const n=this.generateNodeId();return this.json.nodes[n]={type:"action-button",data:{text:s},config:{size:i}},this.appendChild(t,n),n}createButtonNode(t,s="wide",i){const n=this.generateNodeId();return this.json.nodes[n]={type:"button",data:{text:t,link:i},config:{size:s}},n}setButtonLink(t,s){const i=this.json.nodes[t];i&&i.type==="button"&&(i.data||(i.data={}),i.data.link=s)}addChild(t,s){this.appendChild(t,s)}getStoryRootId(){return this.json.root}newNodeId(){return this.generateNodeId()}createTourMapNode(t,s,i="2d"){const n=this.generateNodeId(),d={type:"name",value:"worldImagery"};if(s){const c=this.addWebMapResource(s,"Web Map",{},"minimal");d.type="resource",d.value=c}return this.json.nodes[n]={type:"tour-map",data:{geometries:t,mode:i,basemap:d}},n}createCarouselNode(t){const s=this.generateNodeId();return this.json.nodes[s]={type:"carousel",children:t.slice(0,5)},s}createTourNode(t,s,i,n="start",d="large",c="guided-tour",m="map-focused"){const S=this.generateNodeId();return this.json.nodes[S]={type:"tour",data:{type:c,subtype:m,narrativePanelPosition:n,map:s,places:t,narrativePanelSize:d,accentColor:i}},S}registerReplaceMediaAction(t,s,i){typeof i=="string"&&this.json.nodes[i]&&(this.json.actions||(this.json.actions=[]),this.json.actions.push({origin:t,trigger:"ActionButton_Apply",target:s,event:"ImmersiveSlide_ReplaceMedia",data:{media:i}}))}}function xs(v){let t=v||"";const s=[];return t=t.replace(/style\s*=\s*"([^"]*)"/gi,(i,n)=>(s.push(String(n)),"")),t=t.replace(/style\s*=\s*'([^']*)'/gi,(i,n)=>(s.push(String(n)),"")),t=t.replace(/<\s*script[^>]*>[\s\S]*?<\s*\/\s*script\s*>/gi,"").replace(/<\s*style[^>]*>[\s\S]*?<\s*\/\s*style\s*>/gi,""),t=t.replace(/<\s*b\s*>/gi,"<strong>").replace(/<\s*\/\s*b\s*>/gi,"</strong>").replace(/<\s*i\s*>/gi,"<em>").replace(/<\s*\/\s*i\s*>/gi,"</em>"),t=t.replace(/<\s*a\s+([^>]+)>/gi,(i,n)=>{const d=/href\s*=\s*("[^"]*"|'[^']*'|[^\s>]+)/i.exec(n||""),c=d?d[1].replace(/^['"]|['"]$/g,""):"";return c?`<a href="${c}">`:"<a>"}),t=t.replace(/<\s*(strong|em|a)\s+[^>]*>/gi,(i,n)=>`<${String(n).toLowerCase()}>`),t=t.replace(/<\s*(?!strong\b|em\b|a\b)\/?\s*([a-z0-9-]+)([^>]*)>/gi,i=>""),t=t.replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),t=t.replace(/(?:\r?\n|\r){2,}/g,`
`),{sanitizedHtml:t,inlineStyles:s}}class ve extends rt{constructor(t){super(t),this.model="TWO_WEBMAPS",this.layout="swipe",this.builder=new ot(t.themeId);const s=t.classicItemId;s&&(this.options={classicItemId:s})}extractStructure(){const t=this.classicJson.values;(t.dataModel||"").toUpperCase()==="TWO_LAYERS"?this.model="TWO_LAYERS":this.model="TWO_WEBMAPS",(t.layout||"").toLowerCase().includes("spyglass")?this.layout="spyglass":this.layout="swipe",this.emit(`Swipe model=${this.model} layout=${this.layout}`)}async convert(){this.emit("Beginning conversion"),this.extractStructure(),await this.convertContent(),this.applyTheme();const t=this.collectMedia();return{storymapJson:this.getStoryMapJson(),media:t}}async convertContent(){this.emit("SwipeConverter.convertContent used");const t=this.classicJson.values;this.builder.createStoryRoot();let s,i,n=t.title||"";this.emit(`[CoverTitle] initial from classic values.title='${(t.title||"").trim()}'`);const d=(n||"").trim().toLowerCase()==="swipe"||(n||"").trim().toLowerCase()==="spyglass";if(!n||d){const w=this.options?.classicItemId;if(this.emit(`[CoverTitle] genericOrEmpty=${!n||d}, classicItemId='${w||""}'`),w){const l=`https://www.arcgis.com/sharing/rest/content/items/${w}?f=json`;try{const u=this.token?`${l}&token=${encodeURIComponent(this.token)}`:l,x=await ke(u,void 0,600*1e3),r=x&&typeof x.title=="string"?x.title.trim():"";this.emit(`[CoverTitle] fetched AGO item.title='${r}'`),r&&(n=r)}catch{}}else{const l=this.fetchItemTitleFallback()||"";this.emit(`[CoverTitle] Node-only fallback title='${l}'`),n=l}}n||(this.emit(`[CoverTitle] falling back to values.name='${(t.name||"").trim()}' or default 'Swipe'`),n=t.name||"Swipe"),this.emit(`[CoverTitle] final coverTitle='${n}'`),this.builder.addCoverNode(n,t.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode();try{const w=t.sidePanelDescription,u=(typeof w=="string"?w:w?String(w):"").trim();if(u){const x=/<[^>]+>/.test(u);if(this.emit(`[SwipeConverter] sidePanelDescription detected; looksHtml=${x}`),x){const{sanitizedHtml:r,inlineStyles:o}=xs(u);if(o.length)try{this.builder.addConverterMetadata("Swipe",{classicMetadata:{mappingDecisions:{customCss:{combined:o.join(`
`)}}}})}catch{}this.builder.addRichTextToRoot(r,"paragraph","wide")}else{const r=this.builder.json.root;r?this.builder.addTextBlock(r,u,"paragraph"):this.builder.createTextNode(u,"paragraph","wide")}}}catch{}let c,m;if(this.model==="TWO_WEBMAPS"){const w=[];if(Array.isArray(t.webmaps))for(const b of t.webmaps)typeof b=="string"?w.push(b):b&&typeof b=="object"&&"id"in b&&w.push(String(b.id));else t.webmap&&w.push(String(t.webmap));const[l,u]=w,x=typeof window<"u",r=l?x?await ve.fetchWebMapInfo(l,this.token):ve.fetchWebMapInfoSync(l,this.token):void 0,o=u?x?await ve.fetchWebMapInfo(u,this.token):ve.fetchWebMapInfoSync(u,this.token):void 0,y={},j={};if(r?.extent){y.extent=r.extent;const b=he(r.extent);if(b&&(y.viewpoint={targetGeometry:r.center??r.extent,scale:b.scale}),c&&m){const k=r?.center||{x:(r.extent.xmin+r.extent.xmax)/2,y:(r.extent.ymin+r.extent.ymax)/2,spatialReference:r.extent.spatialReference||{wkid:102100}};y.center=k}}if(Array.isArray(r?.operationalLayers))y.mapLayers=r.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility}));else if(l){const b=`https://www.arcgis.com/sharing/rest/content/items/${l}/data?f=json`,k=this.token?`${b}&token=${encodeURIComponent(this.token)}`:b;ke(k,void 0,600*1e3).then(E=>{const J=Array.isArray(E?.operationalLayers)?E.operationalLayers:[];J.length&&(y.mapLayers=J.map(M=>({...M})))}).catch(()=>{})}if(o?.extent){j.extent=o.extent;const b=he(o.extent);if(b&&(j.viewpoint={targetGeometry:o.center??o.extent,scale:b.scale}),!("center"in j)){const k=o?.center||{x:(o.extent.xmin+o.extent.xmax)/2,y:(o.extent.ymin+o.extent.ymax)/2,spatialReference:o.extent.spatialReference||{wkid:102100}};j.center=k}}if(Array.isArray(o?.operationalLayers))j.mapLayers=o.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility}));else if(u){const b=M=>{for(let I=M.length-1;I>=0;I--)if(M[I].visible)return M[I].title};let k=b(leftLayers);if(b(rightLayers),!k&&Array.isArray(baseData?.baseMap?.baseMapLayers)){const M=baseData.baseMap.baseMapLayers;for(let I=M.length-1;I>=0;I--)if(M[I].visibility){k=M[I].title||k;break}}const E=`https://www.arcgis.com/sharing/rest/content/items/${u}/data?f=json`,J=this.token?`${E}&token=${encodeURIComponent(this.token)}`:E;ke(J,void 0,600*1e3).then(M=>{const I=Array.isArray(M?.operationalLayers)?M.operationalLayers:[];I.length&&(j.mapLayers=I.map(W=>({...W})))}).catch(()=>{})}const A=l?this.builder.addWebMapResource(l,"Web Map",y,"default"):void 0,N=u?this.builder.addWebMapResource(u,"Web Map",j,"default"):void 0;if(A&&r){const b=r.extent?he(r.extent):void 0;this.builder.updateWebMapData(A,{extent:r.extent,center:r.center,zoom:b?.zoom,viewpoint:y.viewpoint,mapLayers:y.mapLayers??[],itemId:l,itemType:"Web Map",type:"default"});try{const k=this.builder.getJson().resources[A]?.data||{};console.info("[SwipeConverter] resA",A,"extent",k.extent,"viewpoint",k.viewpoint,"center",k.center,"zoom",k.zoom)}catch{}}if(N&&o){const b=o.extent?he(o.extent):void 0;this.builder.updateWebMapData(N,{extent:o.extent,center:o.center,zoom:b?.zoom,viewpoint:j.viewpoint,mapLayers:j.mapLayers??[],itemId:u,itemType:"Web Map",type:"default"});try{const k=this.builder.getJson().resources[N]?.data||{};console.info("[SwipeConverter] resB",N,"extent",k.extent,"viewpoint",k.viewpoint,"center",k.center,"zoom",k.zoom)}catch{}}if(A&&(c=this.builder.createWebMapNode(A,void 0)),N&&(m=this.builder.createWebMapNode(N,void 0)),N){const b=o?.center||(o?.extent?{x:(o.extent.xmin+o.extent.xmax)/2,y:(o.extent.ymin+o.extent.ymax)/2,spatialReference:o.extent.spatialReference||{wkid:102100}}:void 0);this.builder.updateWebMapData(N,{center:b})}if(A){const b=o?.center||(o?.extent?{x:(o.extent.xmin+o.extent.xmax)/2,y:(o.extent.ymin+o.extent.ymax)/2,spatialReference:o.extent.spatialReference||{wkid:102100}}:void 0);this.builder.updateWebMapData(A,{center:b})}if(c&&(o?.extent||r?.extent)&&this.builder.updateNodeData(c,b=>{b.extent=o?.extent||r?.extent;const k=he(r.extent),E=(o?.center??o?.extent)||(r.center??r.extent);k&&(b.viewpoint={targetGeometry:E,scale:k.scale});const J=Array.isArray(r.operationalLayers)&&r.operationalLayers.some(M=>M.timeAnimation===!0);b.timeSlider=!!J,Array.isArray(r.operationalLayers)&&r.operationalLayers.length&&(b.mapLayers=r.operationalLayers.map(M=>({id:M.id,title:M.title||M.id,visible:!!M.visibility})),b.viewPlacement="extent");try{console.info("[SwipeConverter] node",c,"extent",b.extent,"viewpoint",b.viewpoint)}catch{}}),m&&o?.extent&&this.builder.updateNodeData(m,b=>{b.extent=o.extent;const k=he(o.extent);k&&(b.viewpoint={targetGeometry:o.center??o.extent,scale:k.scale});const E=Array.isArray(o.operationalLayers)&&o.operationalLayers.some(J=>J.timeAnimation===!0);b.timeSlider=!!E,Array.isArray(o.operationalLayers)&&o.operationalLayers.length&&(b.mapLayers=o.operationalLayers.map(J=>({id:J.id,title:J.title||J.id,visible:!!J.visibility})),b.viewPlacement="extent");try{console.info("[SwipeConverter] node",m,"extent",b.extent,"viewpoint",b.viewpoint)}catch{}}),c&&m){const b=async W=>{if(W)try{const G=`https://www.arcgis.com/sharing/rest/content/items/${W}?f=json`,$=this.token?`${G}&token=${encodeURIComponent(this.token)}`:G,V=await ke($,void 0,600*1e3),P=V&&typeof V.title=="string"?V.title:void 0;return P&&P.trim().length?P.trim():void 0}catch{return}},k=await b(l),E=await b(u),J=k&&E?`Left: ${k} — Right: ${E}`:void 0,M=this.builder.createSwipeNode(c,m,"extent",J),I=this.builder.getStoryRootId();I&&this.builder.addChild(I,M),s=M,s=M}}else{const w=String(t.webmap||"");try{const l=Array.isArray(t.layers)?t.layers:[];console.info("[SwipeConverter] classic values.layers (top-level)",l)}catch{}if(w){const l=ve.fetchWebMapInfoSync(w,this.token),u=`https://www.arcgis.com/sharing/rest/content/items/${w}/data?f=json`,x=await ke(this.token?`${u}&token=${encodeURIComponent(this.token)}`:u,void 0,600*1e3).catch(()=>{}),r={},o=x?.initialState?.view?.extent||x?.mapOptions?.extent||x?.extent||x?.mapOptions?.mapExtent,y=x?.initialState?.view?.center||x?.mapOptions?.center||x?.center,j=l?.extent||o,A=l?.center||y;if(j){r.extent=j;const I=he(j);I&&(r.viewpoint={targetGeometry:A??j,scale:I.scale},r.zoom=I.zoom)}const N=this.builder.addWebMapResource(w,"Web Map",r,"default"),b=this.builder.addWebMapResource(w,"Web Map",r,"default");N&&r&&this.builder.updateWebMapInitialState(N,r),b&&r&&this.builder.updateWebMapInitialState(b,r),x&&N&&this.builder.updateWebMapData(N,{...x,itemId:w,itemType:"Web Map",type:"default"}),x&&b&&this.builder.updateWebMapData(b,{...x,itemId:w,itemType:"Web Map",type:"default"}),N&&this.builder.updateWebMapData(N,{extent:r.extent,center:l?.center,viewpoint:r.viewpoint,zoom:r.zoom}),b&&this.builder.updateWebMapData(b,{extent:r.extent,center:l?.center,viewpoint:r.viewpoint,zoom:r.zoom}),c=this.builder.createWebMapNode(N,void 0),m=this.builder.createWebMapNode(b,void 0);const E=(Array.isArray(t.layers)?t.layers:[]).map(I=>{if(I&&typeof I=="object"&&"id"in I){const W=I;return{id:W.id,title:W.title||W.id}}return{id:String(I),title:String(I)}}).filter(I=>I.id);try{console.info("[SwipeConverter] parsed classicLayers (top-level)",E)}catch{}const M=(Array.isArray(x?.operationalLayers)?x.operationalLayers:l?.operationalLayers||[]).map(I=>({id:I.id,title:I.title||I.id,visible:!!I.visibility}));try{console.info("[SwipeConverter][TWO_LAYERS] sourceLayers",M.map(I=>({id:I.id,title:I.title,vis:I.visible})))}catch{}if(c&&m){const I=new Set,W=new Set;for(const L of E){const R=(L.id||"").trim(),O=(L.title||L.id||"").trim();I.add(R),I.add(O),W.add(R),W.add(O)}let G=M.map(L=>{const R=(L.id||"").trim(),O=(L.title||"").trim(),_=I.has(R)||I.has(O);return{id:L.id,title:L.title,visible:_?!1:L.visible}}),$=M.map(L=>{const R=(L.id||"").trim(),O=(L.title||"").trim(),_=W.has(R)||W.has(O);return{id:L.id,title:L.title,visible:_?!0:L.visible}});for(const L of E){const R=(L.id||"").trim(),O=(L.title||L.id||"").trim();M.some(B=>{const de=(B.id||"").trim(),pe=(B.title||"").trim();return de===R||pe===O})||(G=[{id:L.id,title:L.title||L.id,visible:!1},...G],$=[{id:L.id,title:L.title||L.id,visible:!0},...$])}try{const L=G.map(O=>({id:O.id,title:O.title,vis:O.visible})),R=$.map(O=>({id:O.id,title:O.title,vis:O.visible}));console.info("[SwipeConverter][TWO_LAYERS] leftLayers after toggles",L),console.info("[SwipeConverter][TWO_LAYERS] rightLayers after toggles",R)}catch{}this.builder.updateNodeData(c,L=>{L.mapLayers=G,r.extent&&(L.extent=r.extent),r.viewpoint&&(L.viewpoint=r.viewpoint)}),this.builder.updateNodeData(m,L=>{L.mapLayers=$,r.extent&&(L.extent=r.extent),r.viewpoint&&(L.viewpoint=r.viewpoint)}),N&&this.builder.updateWebMapInitialState(N,{mapLayers:G}),b&&this.builder.updateWebMapInitialState(b,{mapLayers:$});const V=L=>{for(let R=L.length-1;R>=0;R--)if(L[R].visible)return L[R].title};let P=V(G.map(L=>({title:L.title,visible:L.visible})));const we=V($.map(L=>({title:L.title,visible:L.visible})));if(!P&&Array.isArray(x?.baseMap?.baseMapLayers)){const L=x.baseMap.baseMapLayers;for(let R=L.length-1;R>=0;R--)if(L[R].visibility){P=L[R].title||P;break}}i=P&&we?`Left: ${P} — Right: ${we}`:void 0}}}const S=(this.layout==="spyglass","extent");if(c&&m&&!s){const w=this.builder.createSwipeNode(c,m,S,i);t.legend&&this.builder.updateNodeData(w,u=>{u.legendPinned=!0,u.legend=[c]});const l=this.builder.getStoryRootId();l&&this.builder.addChild(l,w)}const C=Be(this.classicJson),a=t,p=this.classicJson.version||t.version||t.templateVersion,f=a.templateCreation,h=a.templateLastEdit;this.builder.addConverterMetadata(C||"Swipe",{classicMetadata:{classicTheme:{layout:this.layout,model:this.model},templateVersion:p},classicTemplateCreation:f,classicTemplateLastEdit:h}),this.emit("Built swipe block")}sanitizeSidePanelHtml(t){}applyTheme(){}collectMedia(){return[]}getStoryMapJson(){return this.builder.getJson()}static async convert(t){return new ve(t).convert()}static async buildInlineSwipeBlock(t,s,i="swipe",n){t.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlock"});try{t.emit?.("SwipeConverter.buildInlineSwipeBlock used")}catch{}const d=String(s.dataModel||"").toUpperCase();let c,m;if(d==="TWO_WEBMAPS"){const C=[];if(Array.isArray(s.webmaps))for(const o of s.webmaps)typeof o=="string"?C.push(o):o&&typeof o=="object"&&"id"in o&&C.push(String(o.id));else s.webmap&&C.push(String(s.webmap));const[a,p]=C,f={},h={},w=typeof window<"u",l=a?w?await ve.fetchWebMapInfo(a,n):ve.fetchWebMapInfoSync(a,n):void 0,u=p?w?await ve.fetchWebMapInfo(p,n):ve.fetchWebMapInfoSync(p,n):void 0;if(l?.extent){f.extent=l.extent;const o=he(l.extent);o&&(f.viewpoint={targetGeometry:l.center??l.extent,scale:o.scale})}if(Array.isArray(l?.operationalLayers)&&(f.mapLayers=l.operationalLayers.map(o=>({id:o.id,title:o.title||o.id,visible:!!o.visibility}))),u?.extent){h.extent=u.extent;const o=he(u.extent);o&&(h.viewpoint={targetGeometry:u.center??u.extent,scale:o.scale})}Array.isArray(u?.operationalLayers)&&(h.mapLayers=u.operationalLayers.map(o=>({id:o.id,title:o.title||o.id,visible:!!o.visibility})));const x=a?t.addWebMapResource(a,"Web Map",f,"default"):void 0,r=p?t.addWebMapResource(p,"Web Map",h,"default"):void 0;if(x&&f&&t.updateWebMapInitialState(x,f),r&&h&&t.updateWebMapInitialState(r,h),x){const o=l?.extent||u?.extent,y=o?he(o):void 0,A=u?.center||(u?.extent?{x:(u.extent.xmin+u.extent.xmax)/2,y:(u.extent.ymin+u.extent.ymax)/2,spatialReference:u.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(x,{extent:o,center:A,zoom:y?.zoom,viewpoint:f.viewpoint,mapLayers:f.mapLayers??[],itemId:a,itemType:"Web Map",type:"default"})}if(r){const o=u?.extent?he(u.extent):void 0,j=u?.center||(u?.extent?{x:(u.extent.xmin+u.extent.xmax)/2,y:(u.extent.ymin+u.extent.ymax)/2,spatialReference:u.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(r,{extent:u?.extent,center:j,zoom:o?.zoom,viewpoint:h.viewpoint,mapLayers:h.mapLayers??[],itemId:p,itemType:"Web Map",type:"default"})}if(x&&(c=t.createWebMapNode(x,void 0)),r&&(m=t.createWebMapNode(r,void 0)),x){const o=l?.extent||u?.extent,j=u?.center||(u?.extent?{x:(u.extent.xmin+u.extent.xmax)/2,y:(u.extent.ymin+u.extent.ymax)/2,spatialReference:u.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(x,{extent:o,center:j})}c&&(u?.extent||l?.extent)&&t.updateNodeData(c,o=>{const y=u?.extent||l?.extent;o.extent=y;const j=he(y),N=(u?.center||(u?.extent?{x:(u.extent.xmin+u.extent.xmax)/2,y:(u.extent.ymin+u.extent.ymax)/2,spatialReference:u.extent.spatialReference||{wkid:102100}}:void 0))??y;j&&(o.viewpoint={targetGeometry:N,scale:j.scale});const b=Array.isArray(l.operationalLayers)&&l.operationalLayers.some(k=>k.timeAnimation===!0);o.timeSlider=!!b,Array.isArray(l.operationalLayers)&&l.operationalLayers.length&&(o.mapLayers=l.operationalLayers.map(k=>({id:k.id,title:k.title||k.id,visible:!!k.visibility})),o.viewPlacement="extent")}),m&&u?.extent&&t.updateNodeData(m,o=>{o.extent=u.extent;const y=he(u.extent),j=u.center||{x:(u.extent.xmin+u.extent.xmax)/2,y:(u.extent.ymin+u.extent.ymax)/2,spatialReference:u.extent.spatialReference||{wkid:102100}};y&&(o.viewpoint={targetGeometry:j??u.extent,scale:y.scale});const A=Array.isArray(u.operationalLayers)&&u.operationalLayers.some(N=>N.timeAnimation===!0);o.timeSlider=!!A,Array.isArray(u.operationalLayers)&&u.operationalLayers.length&&(o.mapLayers=u.operationalLayers.map(N=>({id:N.id,title:N.title||N.id,visible:!!N.visibility})),o.viewPlacement="extent")})}else{const C=String(s.webmap||"");try{const y=Array.isArray(s.layers)?s.layers:[];console.info("[SwipeConverter] classic values.layers (inline)",y)}catch{}const a=C?ve.fetchWebMapInfoSync(C,n):void 0,p=C?`https://www.arcgis.com/sharing/rest/content/items/${C}/data?f=json`:void 0,f=p?await ke(n?`${p}&token=${encodeURIComponent(n)}`:p,void 0,600*1e3).catch(()=>{}):void 0,h={},w=f?.initialState?.view?.extent||f?.mapOptions?.extent||f?.extent||f?.mapOptions?.mapExtent,l=f?.initialState?.view?.center||f?.mapOptions?.center||f?.center,u=a?.extent||w,x=a?.center||l;if(u){h.extent=u;const y=he(u);y&&(h.viewpoint={targetGeometry:x??u,scale:y.scale},h.zoom=y.zoom)}const r=C?t.addWebMapResource(C,"Web Map",h,"default"):void 0,o=C?t.addWebMapResource(C,"Web Map",h,"default"):void 0;if(r&&h&&t.updateWebMapInitialState(r,h),o&&h&&t.updateWebMapInitialState(o,h),f&&r&&t.updateWebMapData(r,{...f,itemId:C,itemType:"Web Map",type:"default"}),f&&o&&t.updateWebMapData(o,{...f,itemId:C,itemType:"Web Map",type:"default"}),r&&t.updateWebMapData(r,{extent:h.extent,center:a?.center,viewpoint:h.viewpoint,zoom:h.zoom}),o&&t.updateWebMapData(o,{extent:h.extent,center:a?.center,viewpoint:h.viewpoint,zoom:h.zoom}),r&&o){c=t.createWebMapNode(r,void 0),m=t.createWebMapNode(o,void 0);const j=(Array.isArray(s.layers)?s.layers:[]).map(I=>{if(I&&typeof I=="object"&&"id"in I){const W=I;return{id:W.id,title:W.title||W.id}}return{id:String(I),title:String(I)}}).filter(I=>I.id);try{console.info("[SwipeConverter] parsed classicLayers (inline)",j)}catch{}const A=Array.isArray(f?.operationalLayers)?f.operationalLayers:a?.operationalLayers||[],N=I=>(I||"").replace(/_\d+$/,""),b=A.map(I=>({id:I.id,title:I.title||I.id,visible:!!I.visibility}));try{console.info("[SwipeConverter][INLINE TWO_LAYERS] sourceLayers",b.map(I=>({id:I.id,title:I.title,vis:I.visible})))}catch{}const k=new Set,E=new Set;for(const I of j)k.add(N(I.id)),k.add(N(I.title||I.id)),E.add(N(I.id)),E.add(N(I.title||I.id));let J=b.map(I=>{const W=N(I.id),G=N(I.title),$=k.has(W)||k.has(G);return{id:I.id,title:I.title,visible:$?!1:I.visible}}),M=b.map(I=>{const W=N(I.id),G=N(I.title),$=E.has(W)||E.has(G);return{id:I.id,title:I.title,visible:$?!0:I.visible}});for(const I of j){const W=N(I.id),G=N(I.title||I.id);b.some(V=>N(V.id)===W||N(V.title)===G)||(J=[{id:I.id,title:I.title||I.id,visible:!1},...J],M=[{id:I.id,title:I.title||I.id,visible:!0},...M])}try{const I=J.map(G=>({id:G.id,title:G.title,vis:G.visible})),W=M.map(G=>({id:G.id,title:G.title,vis:G.visible}));console.info("[SwipeConverter][INLINE TWO_LAYERS] leftLayers after toggles",I),console.info("[SwipeConverter][INLINE TWO_LAYERS] rightLayers after toggles",W)}catch{}t.updateNodeData(c,I=>{I.mapLayers=J,h.extent&&(I.extent=h.extent),h.viewpoint&&(I.viewpoint=h.viewpoint)}),t.updateNodeData(m,I=>{I.mapLayers=M,h.extent&&(I.extent=h.extent),h.viewpoint&&(I.viewpoint=h.viewpoint)})}}const S="extent";if(!c||!m)throw new Error("SwipeConverter.buildInlineSwipeBlock: missing content nodes");return t.createSwipeNode(c,m,S)}static buildInlineSwipeBlockSync(t,s,i="swipe",n){try{t.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlockSync"})}catch{}const d=String(s.dataModel||"").toUpperCase();let c,m;if(d==="TWO_WEBMAPS"){const C=[];if(Array.isArray(s.webmaps))for(const r of s.webmaps)typeof r=="string"?C.push(r):r&&typeof r=="object"&&"id"in r&&C.push(String(r.id));else s.webmap&&C.push(String(s.webmap));const[a,p]=C,f={},h={},w=a?ve.fetchWebMapInfoSync(a,n):void 0,l=p?ve.fetchWebMapInfoSync(p,n):void 0;if(w?.extent){f.extent=w.extent;const r=he(w.extent);r&&(f.viewpoint={targetGeometry:w.center??w.extent,scale:r.scale})}if(Array.isArray(w?.operationalLayers)&&(f.mapLayers=w.operationalLayers.map(r=>({id:r.id,title:r.title||r.id,visible:!!r.visibility}))),l?.extent){h.extent=l.extent;const r=he(l.extent);r&&(h.viewpoint={targetGeometry:l.center??l.extent,scale:r.scale})}Array.isArray(l?.operationalLayers)&&(h.mapLayers=l.operationalLayers.map(r=>({id:r.id,title:r.title||r.id,visible:!!r.visibility})));const u=a?t.addWebMapResource(a,"Web Map",f,"default"):void 0,x=p?t.addWebMapResource(p,"Web Map",h,"default"):void 0;if(u&&f&&t.updateWebMapInitialState(u,f),x&&h&&t.updateWebMapInitialState(x,h),u){const r=w?.extent||l?.extent,o=r?he(r):void 0,y=l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(u,{extent:r,center:y,zoom:o?.zoom,viewpoint:f.viewpoint,mapLayers:f.mapLayers??[],itemId:a,itemType:"Web Map",type:"default"})}if(x){const r=l?.extent?he(l.extent):void 0,o=l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(x,{extent:l?.extent,center:o,zoom:r?.zoom,viewpoint:h.viewpoint,mapLayers:h.mapLayers??[],itemId:p,itemType:"Web Map",type:"default"})}if(u&&(c=t.createWebMapNode(u,void 0)),x&&(m=t.createWebMapNode(x,void 0)),u){const r=w?.extent||l?.extent,o=l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(u,{extent:r,center:o})}c&&(l?.extent||w?.extent)&&t.updateNodeData(c,r=>{const o=l?.extent||w?.extent;r.extent=o;const y=he(o),A=(l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0))??o;y&&(r.viewpoint={targetGeometry:A,scale:y.scale});const N=Array.isArray(w?.operationalLayers)&&w.operationalLayers.some(b=>b.timeAnimation===!0);r.timeSlider=!!N,Array.isArray(w?.operationalLayers)&&w.operationalLayers.length&&(r.mapLayers=w.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility})),r.viewPlacement="extent")}),m&&l?.extent&&t.updateNodeData(m,r=>{r.extent=l.extent;const o=he(l.extent),y=l.center||{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}};o&&(r.viewpoint={targetGeometry:y??l.extent,scale:o.scale});const j=Array.isArray(l.operationalLayers)&&l.operationalLayers.some(A=>A.timeAnimation===!0);r.timeSlider=!!j,Array.isArray(l.operationalLayers)&&l.operationalLayers.length&&(r.mapLayers=l.operationalLayers.map(A=>({id:A.id,title:A.title||A.id,visible:!!A.visibility})),r.viewPlacement="extent")})}else{const C=String(s.webmap||""),a=C?ve.fetchWebMapInfoSync(C,n):void 0,p={},f=a?.extent,h=a?.center;if(f){p.extent=f;const u=he(f);u&&(p.viewpoint={targetGeometry:h??f,scale:u.scale},p.zoom=u.zoom)}const w=C?t.addWebMapResource(C,"Web Map",p,"default"):void 0,l=C?t.addWebMapResource(C,"Web Map",p,"default"):void 0;if(w&&p&&t.updateWebMapInitialState(w,p),l&&p&&t.updateWebMapInitialState(l,p),w&&t.updateWebMapData(w,{extent:p.extent,center:a?.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:C,itemType:"Web Map",type:"default"}),l&&t.updateWebMapData(l,{extent:p.extent,center:a?.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:C,itemType:"Web Map",type:"default"}),w&&l){c=t.createWebMapNode(w,void 0),m=t.createWebMapNode(l,void 0);const x=(Array.isArray(s.layers)?s.layers:[]).map(b=>{if(b&&typeof b=="object"&&"id"in b){const k=b;return{id:k.id,title:k.title||k.id}}return{id:String(b),title:String(b)}}).filter(b=>b.id),r=Array.isArray(a?.operationalLayers)?a.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility})):[],o=new Set,y=new Set,j=b=>(b||"").replace(/_\d+$/,"");for(const b of x)o.add(j(b.id)),o.add(j(b.title||b.id)),y.add(j(b.id)),y.add(j(b.title||b.id));const A=r.map(b=>{const k=j(b.id),E=j(b.title),J=o.has(k)||o.has(E);return{id:b.id,title:b.title,visible:J?!1:b.visible}}),N=r.map(b=>{const k=j(b.id),E=j(b.title),J=y.has(k)||y.has(E);return{id:b.id,title:b.title,visible:J?!0:b.visible}});t.updateNodeData(c,b=>{b.mapLayers=A,p.extent&&(b.extent=p.extent),p.viewpoint&&(b.viewpoint=p.viewpoint)}),t.updateNodeData(m,b=>{b.mapLayers=N,p.extent&&(b.extent=p.extent),p.viewpoint&&(b.viewpoint=p.viewpoint)})}}const S="extent";if(!c||!m)throw new Error("SwipeConverter.buildInlineSwipeBlockSync: missing content nodes");return t.createSwipeNode(c,m,S)}static buildInlineSwipeBlockBrowserSync(t,s,i="swipe",n){try{t.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlockBrowserSync"})}catch{}const d=String(s.dataModel||"").toUpperCase();let c,m;const S=a=>{try{if(typeof window>"u")return;const p=`https://www.arcgis.com/sharing/rest/content/items/${a}/data?f=json${n?`&token=${encodeURIComponent(n)}`:""}`,f=new XMLHttpRequest;if(f.open("GET",p,!1),f.send(null),f.status>=200&&f.status<300&&f.responseText){const h=JSON.parse(f.responseText),w=y=>y?.initialState?.view?.extent||y?.mapOptions?.extent||y?.extent||y?.mapOptions?.mapExtent||void 0,l=y=>y?.initialState?.view?.center||y?.mapOptions?.center||y?.center||void 0,u=w(h),x=l(h);let r,o;if(u){const y=he(u);y&&(r={targetGeometry:x??u,scale:y.scale},o=y.zoom)}return{extent:u,center:x,zoom:o,viewpoint:r}}}catch{}};if(d==="TWO_WEBMAPS"){const a=[];if(Array.isArray(s.webmaps))for(const r of s.webmaps)typeof r=="string"?a.push(r):r&&typeof r=="object"&&"id"in r&&a.push(String(r.id));else s.webmap&&a.push(String(s.webmap));const[p,f]=a,h=p?S(p):void 0,w=f?S(f):void 0,l=p?t.addWebMapResource(p,"Web Map",h?{extent:h.extent,center:h.center,viewpoint:h.viewpoint,zoom:h.zoom,itemId:p,itemType:"Web Map",type:"default"}:{},"default"):void 0,u=f?t.addWebMapResource(f,"Web Map",w?{extent:w.extent,center:w.center,viewpoint:w.viewpoint,zoom:w.zoom,itemId:f,itemType:"Web Map",type:"default"}:{},"default"):void 0;l&&h&&t.updateWebMapData(l,{extent:h.extent,center:h.center,viewpoint:h.viewpoint,zoom:h.zoom,itemId:p,itemType:"Web Map",type:"default"}),u&&w&&t.updateWebMapData(u,{extent:w.extent,center:w.center,viewpoint:w.viewpoint,zoom:w.zoom,itemId:f,itemType:"Web Map",type:"default"}),l&&(c=t.createWebMapNode(l,void 0)),u&&(m=t.createWebMapNode(u,void 0));const x=r=>{!r||!w||t.updateNodeData(r,o=>{const y=!!o.extent,j=!!o.viewpoint;!y&&w.extent&&(o.extent=w.extent),!j&&w.viewpoint&&(o.viewpoint=w.viewpoint),o.viewPlacement||(o.viewPlacement="extent")})};x(c),x(m)}else{const a=String(s.webmap||""),p=a?S(a):void 0,f=a?t.addWebMapResource(a,"Web Map",p?{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:a,itemType:"Web Map",type:"default"}:{},"default"):void 0,h=a?t.addWebMapResource(a,"Web Map",p?{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:a,itemType:"Web Map",type:"default"}:{},"default"):void 0;if(f&&p&&t.updateWebMapData(f,{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:a,itemType:"Web Map",type:"default"}),h&&p&&t.updateWebMapData(h,{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:a,itemType:"Web Map",type:"default"}),f&&h){c=t.createWebMapNode(f,void 0),m=t.createWebMapNode(h,void 0);const l=(Array.isArray(s.layers)?s.layers:[]).map(r=>{if(r&&typeof r=="object"&&"id"in r){const o=r;return{id:o.id,title:o.title||o.id}}return{id:String(r),title:String(r)}}).filter(r=>r.id),u=l.map(r=>({id:r.id,title:r.title||r.id,visible:!1})),x=l.map(r=>({id:r.id,title:r.title||r.id,visible:!0}));if(t.updateNodeData(c,r=>{r.mapLayers=u}),t.updateNodeData(m,r=>{r.mapLayers=x}),p){const r=o=>{o&&t.updateNodeData(o,y=>{const j=!!y.extent,A=!!y.viewpoint;!j&&p.extent&&(y.extent=p.extent),!A&&p.viewpoint&&(y.viewpoint=p.viewpoint),y.viewPlacement||(y.viewPlacement="extent")})};r(c),r(m)}}}const C="extent";if(!c||!m)throw new Error("SwipeConverter.buildInlineSwipeBlockBrowserSync: missing content nodes");return t.createSwipeNode(c,m,C)}static fetchWebMapInfoSync(t,s){try{const i=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,n=s?`${i}&token=${encodeURIComponent(s)}`:i,d=Ye(`curl -sL '${n}'`,{encoding:"utf-8"}),c=JSON.parse(d),m=u=>u?.initialState?.view?.extent||u?.mapOptions?.extent||u?.extent||u?.mapOptions?.mapExtent||void 0,S=u=>u?.initialState?.view?.center||u?.mapOptions?.center||u?.center||void 0;let C=m(c),a=S(c);if(!C||typeof C!="object"&&!Array.isArray(C)){const u=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,x=Ye(`curl -sL '${u}'`,{encoding:"utf-8"}),r=JSON.parse(x);if(Array.isArray(r.extent)&&r.extent.length===2&&Array.isArray(r.extent[0])&&Array.isArray(r.extent[1])){const[[o,y],[j,A]]=r.extent;C={xmin:o,ymin:y,xmax:j,ymax:A,spatialReference:{wkid:4326}}}if(!a&&Array.isArray(r.center)&&r.center.length>=2){const[o,y]=r.center;a={x:o,y,spatialReference:{wkid:4326}}}}const p=u=>u*2003750834e-2/180,f=u=>Math.log(Math.tan((90+u)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;let h;C&&C.spatialReference&&(C.spatialReference.wkid===4326||C.spatialReference.latestWkid===4326)?h={xmin:p(C.xmin),ymin:f(C.ymin),xmax:p(C.xmax),ymax:f(C.ymax),spatialReference:{wkid:102100}}:C&&typeof C=="object"&&"xmin"in C&&(h=C);let w;a&&a.spatialReference&&a.spatialReference.wkid===4326?w={x:p(a.x),y:f(a.y),spatialReference:{wkid:102100}}:a&&a.spatialReference&&(a.spatialReference.wkid===102100||a.spatialReference.latestWkid===3857)&&(w=a);const l=Array.isArray(c.operationalLayers)?c.operationalLayers.filter(u=>u&&u.id).map(u=>({id:u.id,title:u.title,visibility:u.visibility})):[];return{extent:h,center:w,operationalLayers:l}}catch{return}}static async fetchWebMapInfo(t,s){try{const i=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,n=s?`${i}&token=${encodeURIComponent(s)}`:i,d=await ke(n,void 0,600*1e3),c=l=>l?.initialState?.view?.extent||l?.mapOptions?.extent||l?.extent||l?.mapOptions?.mapExtent||void 0,m=l=>l?.initialState?.view?.center||l?.mapOptions?.center||l?.center||void 0;let S=c(d),C=m(d);if(!S||typeof S!="object"&&!Array.isArray(S)){const l=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,u=await ke(l,void 0,600*1e3);if(Array.isArray(u.extent)&&u.extent.length===2&&Array.isArray(u.extent[0])&&Array.isArray(u.extent[1])){const[[x,r],[o,y]]=u.extent;S={xmin:x,ymin:r,xmax:o,ymax:y,spatialReference:{wkid:4326}}}if(!C&&Array.isArray(u.center)&&u.center.length>=2){const[x,r]=u.center;C={x,y:r,spatialReference:{wkid:4326}}}}const a=l=>l*2003750834e-2/180,p=l=>Math.log(Math.tan((90+l)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;let f;S&&S.spatialReference&&(S.spatialReference.wkid===4326||S.spatialReference.latestWkid===4326)?f={xmin:a(S.xmin),ymin:p(S.ymin),xmax:a(S.xmax),ymax:p(S.ymax),spatialReference:{wkid:102100}}:S&&typeof S=="object"&&"xmin"in S&&(f=S);let h;C&&C.spatialReference&&C.spatialReference.wkid===4326?h={x:a(C.x),y:p(C.y),spatialReference:{wkid:102100}}:C&&C.spatialReference&&(C.spatialReference.wkid===102100||C.spatialReference.latestWkid===3857)&&(h=C);const w=Array.isArray(d?.operationalLayers)?d.operationalLayers.filter(l=>l&&l.id).map(l=>({id:l.id,title:l.title,visibility:l.visibility})):[];return{extent:f,center:h,operationalLayers:w}}catch{return}}fetchItemTitleFallback(){try{const t=this.options.classicItemId;if(!t)return;const s=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,i=Ye(`curl -sL '${s}'`,{encoding:"utf-8"}),n=JSON.parse(i);if(n&&typeof n.title=="string"&&n.title.trim().length)return n.title.trim()}catch{}}}var qe={};class at extends rt{constructor(t){super(t),this.sections=[],this.imageResourceMap=new Map,this.media=new Set,this.styleBlocks=[],this.videoEmbedCount=0,this.debugLogs=[],this.BUTTON_CLASS_REGEX=/^btn-(green|orange|purple|yellow|red)$/i,this.CSS_COLOR_MAP={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgreen:"#006400",darkgrey:"#A9A9A9",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",green:"#008000",greenyellow:"#ADFF2F",grey:"#808080",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgreen:"#90EE90",lightgrey:"#D3D3D3",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},this.builder=new ot(t.themeId)}shouldSuppressMetadata(){let t="";const i=(typeof import.meta<"u"?import.meta:void 0)?.env;if(i&&typeof i.SUPPRESS_CONVERTER_METADATA<"u"&&(t=String(i.SUPPRESS_CONVERTER_METADATA)),!t&&typeof globalThis<"u"){const n=globalThis;typeof n.__SUPPRESS_CONVERTER_METADATA<"u"&&(t=String(n.__SUPPRESS_CONVERTER_METADATA))}if(!t&&typeof process<"u"){const n=qe;n&&typeof n.SUPPRESS_CONVERTER_METADATA<"u"&&(t=String(n.SUPPRESS_CONVERTER_METADATA))}return String(t||"").toLowerCase()==="true"}logDebug(t,s){try{const i=s?`${t} ${JSON.stringify(s)}`:t;this.debugLogs.push(i),typeof console<"u"&&console.debug&&console.debug("[MapJournalConverter]",t,s??"")}catch{}}logWarn(t,s){try{const i=s?`${t} ${JSON.stringify(s)}`:t;this.debugLogs.push(i),typeof console<"u"&&console.warn&&console.warn("[MapJournalConverter]",t,s??"")}catch{}}flushDebugLogs(t){if(this.debugLogs.length)try{this.shouldSuppressMetadata()||this.builder.addConverterMetadata("MapJournal",{path:t,classicMetadata:{logs:this.debugLogs.slice()}}),this.debugLogs.length=0}catch{}}extractStructure(){const t=this.classicJson.values,s=t.story&&Array.isArray(t.story.sections)?t.story.sections:[],i=Array.isArray(t.sections)?t.sections:[];this.sections=s.length?s:i,this.emit(`Extracted ${this.sections.length} section(s)`)}convertContent(){try{const M=this.classicJson.values,I=M?.story?.map?.itemId||M?.map?.itemId||M?.webmap||qe.WEBMAP_ID,W=this.token||qe.ARCGIS_TOKEN;if(I&&W){const G=`https://www.arcgis.com/sharing/rest/content/items/${I}/data?f=json&token=${encodeURIComponent(W)}`;fetch(G).then($=>$.ok?$.json():Promise.reject(new Error(`HTTP ${$.status}`))).then($=>{if((Array.isArray($?.operationalLayers)?$.operationalLayers:[]).some(we=>{if(String(we?.layerType||we?.type||"").toLowerCase()==="mapnotes")return!0;const R=we?.featureCollection,O=R?.layers?.[0]?.featureSet?.features||[],_=Array.isArray(O)&&O.some(de=>String(de?.symbol?.type).toLowerCase()==="esripms"),B=String(we?.title||"").toLowerCase();return!!R&&(_||B.includes("map notes"))}))if(this.emit(`Webmap ${I} contains Map Notes. Converting to CSV and saving to webmap...`),typeof window<"u")fetch("/.netlify/functions/convert-mapnotes-to-csv",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webmapId:I,token:W})}).then(R=>R.ok?R.json():R.text().then(O=>Promise.reject(new Error(O)))).then(R=>{R.changed?this.emit("CSV item created and minimal layer appended via Netlify function."):this.emit("Netlify function reported no changes (no Map Notes found).")}).catch(R=>{const O=typeof R=="object"&&R&&"message"in R?String(R.message):String(R);this.emit(`CSV conversion function failed: ${O}. Continuing conversion.`)});else{const L=us.resolve("converter-app/scripts/mapnotes-to-csv-item-and-add-to-webmap.ts");try{et("npx",["tsx",L],{stdio:"inherit",env:{...qe,WEBMAP_ID:I,ARCGIS_TOKEN:W}}),this.emit("Map Notes → CSV conversion completed. Proceeding with content conversion.")}catch(R){const O=typeof R=="object"&&R&&"message"in R?String(R.message):String(R);this.emit(`CSV conversion execution failed: ${O}. Continuing conversion.`)}}else this.emit(`Webmap ${I} has no Map Notes; skipping CSV conversion.`)}).catch(()=>{this.emit(`Failed to fetch webmap ${I} for Map Notes detection; skipping CSV conversion.`)})}}catch(M){const I=typeof M=="object"&&M&&"message"in M?String(M.message):String(M);this.emit(`Map Notes → CSV pre-step failed: ${I}. Continuing conversion.`)}this.builder.createStoryRoot();const t=this.classicJson.values;this.emit("Created story root node"),this.builder.addCoverNode(t.title||"Untitled Story",t.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode(),this.emit("Added cover/navigation/credits scaffold");const s=(t.description||t.subtitle||"")+"";this.builder.setStoryMeta(t.title||"Untitled Story",s.trim()||void 0,void 0);const n=t,d=n.settings?.layout?.id||"side",c=n.settings?.layoutOptions?.layoutCfg||{},m=c.size||"medium",S=c.position||"right",C=!!n.settings?.theme&&Object.keys(n.settings.theme||{}).length>0,a=d==="float"?"floating-panel":"docked-panel";let p="medium";(m==="small"||m==="medium"||m==="large")&&(p=m);const f=S==="left"?"start":"end",{immersiveId:h,slideId:w,narrativeId:l}=this.builder.addSidecar(a,f,p);if(this.builder.removeNode(w),this.builder.removeNode(l),this.builder.updateNode(h,M=>{M.children=[]}),t.description){const M=[this.builder.createTextNode(String(t.description),"paragraph")];this.builder.addSlideToSidecar(h,M,void 0)}const u=[],x=[],r=[];for(const M of this.sections){const I=[],W=[];let G;M.title&&(G=this.builder.createTextNode(M.title,"h3"),I.push(G)),u.push(G||"");const $=(M.content||M.description||"")+"";if($.trim())if(typeof globalThis.DOMParser<"u")try{const L=new DOMParser().parseFromString($,"text/html");for(const R of Array.from(L.body.children))this.handleElementOrdered(R,I,W,x,r)}catch{this.parseOrderedFallback($,I,W,x,r)}else this.parseOrderedFallback($,I,W,x,r);let V;const P=M.media;if(P?.image?.url){const L=this.builder.addImageResource(P.image.url);V=this.builder.createImageNode(L,P.image.caption,P.image.altText,"wide"),this.media.add(P.image.url)}else if(P?.webmap?.id){const L=P.webmap.itemType==="Web Scene"?"Web Scene":"Web Map",R=P.webmap,O=P.webmap.extent?this.normalizeExtent(P.webmap.extent):void 0;let _,B;if(O){const Y=he(O);Y&&(_={targetGeometry:O,scale:Y.scale},B=Y.zoom)}const de={extent:O,mapLayers:Array.isArray(P.webmap.layers)?P.webmap.layers.map(Y=>({id:Y.id,title:Y.title||Y.id,visible:Y.visibility})):void 0,overview:R.overview?{enable:!!R.overview.enable,openByDefault:!!R.overview.openByDefault}:void 0,legend:R.legend?{enable:!!R.legend.enable,openByDefault:!!R.legend.openByDefault}:void 0,geocoder:R.geocoder?{enable:!!R.geocoder.enable}:void 0,popup:R.popup||void 0,viewpoint:_,zoom:B},pe=this.builder.addWebMapResource(P.webmap.id,L,de,"default"),je=O?{x:(O.xmin+O.xmax)/2,y:(O.ymin+O.ymax)/2,spatialReference:O.spatialReference}:void 0;let te;try{const ye=this.classicJson?.values?.webmap,se=this.classicJson.webmapJson,Se=se&&Array.isArray(se.operationalLayers)?se.operationalLayers:[];if(Se.length&&(ye===P.webmap.id||ye==null))te=Se.map(ue=>({id:ue.id,title:ue.title||ue.id,visible:!!ue.visibility}));else try{const ue=`https://www.arcgis.com/sharing/rest/content/items/${P.webmap.id}/data?f=json`,Te=this.token?`${ue}&token=${encodeURIComponent(this.token)}`:ue;if(!(typeof window<"u"))try{const ge=et("curl",["-sL",Te],{encoding:"utf-8"}),be=JSON.parse(ge),ce=Array.isArray(be?.operationalLayers)?be.operationalLayers:[];ce.length&&(te=ce.map(T=>({...T})))}catch{}ke(Te,void 0,600*1e3).then(ge=>{const be=Array.isArray(ge?.operationalLayers)?ge.operationalLayers:[];if(be.length){this.builder.updateWebMapData(pe,{mapLayers:be.map(T=>({id:T.id,title:T.title||T.id,visible:!!T.visibility}))});const ce=new Map;if(P.webmap&&Array.isArray(P.webmap.layers))for(const T of P.webmap.layers)ce.set(T.id,!!T.visibility);V&&ce.size>0&&this.builder.updateNodeData(V,T=>{T.mapLayers=be.map(D=>{const X=String(D.id||""),Q=ce.has(X)?ce.get(X):!!D.visibility;return{id:X,title:D.title||X,visible:Q}})})}}).catch(()=>{})}catch{}}catch{}this.builder.updateWebMapData(pe,{extent:O,center:je,mapLayers:te??(Array.isArray(P.webmap.layers)?P.webmap.layers.map(Y=>({id:Y.id,title:Y.title||Y.id,visible:!!Y.visibility})):void 0),viewpoint:_,zoom:B}),V=this.builder.createWebMapNode(pe,M.title?`${L==="Web Scene"?"Scene":"Map"}: ${M.title}`:void 0),this.media.add(P.webmap.id),V&&this.builder.updateNodeData(V,Y=>{if(O&&(Y.extent=O),Array.isArray(te)&&te.length){const ye=new Map;if(P.webmap&&Array.isArray(P.webmap.layers))for(const se of P.webmap.layers)ye.set(se.id,!!se.visibility);ye.size>0&&(Y.mapLayers=te.map(se=>{const Se=String(se.id||""),ue=ye.has(Se)?ye.get(Se):!!se.visible;return{id:Se,title:se.title||Se,visible:ue}}))}else P.webmap&&Array.isArray(P.webmap.layers)&&(Y.mapLayers=P.webmap.layers.map(ye=>({id:ye.id,title:ye.title||ye.id,visible:!!ye.visibility})));_&&(Y.viewpoint=_),typeof B=="number"&&(Y.zoom=B),R.overview&&R.overview.enable&&(Y.overview={openByDefault:!!R.overview.openByDefault}),R.legend&&R.legend.enable&&(Y.legend={openByDefault:!!R.legend.openByDefault})})}else if(P?.video?.url){const L=this.detectVideoProvider(P.video.url);if(L.provider!=="unknown")V=this.builder.createVideoEmbedNode(P.video.url,L.provider,L.id,P.video.caption,P.video.caption,void 0,P.video.altText),this.videoEmbedCount++;else{const R=this.builder.addVideoResource(P.video.url,"uri");V=this.builder.createVideoNode(R,P.video.caption,P.video.altText),this.media.add(P.video.url)}}else if(P?.webpage?.url){const L=this.tryBuildSwipeNodeFromUrl(P.webpage.url);L?V=L:V=this.builder.createEmbedNode(P.webpage.url,P.webpage.caption,P.webpage.title,P.webpage.description,P.webpage.altText)}const{slideId:we}=this.builder.addSlideToSidecar(h,I,V);if(Array.isArray(M.contentActions)&&M.contentActions.length){const L=new Map(M.contentActions.map(R=>[R.id,R]));for(const R of W){const O=L.get(R.actionId);if(!O||O.type!=="media"||!O.media)continue;let _;const B=O.media;if(B.webmap?.id){const de=B.webmap.itemType==="Web Scene"?"Web Scene":"Web Map";let pe,je;const te=B.webmap.extent?this.normalizeExtent(B.webmap.extent):void 0,Y=B.webmap;if(te){const oe=he(te);oe&&(pe={targetGeometry:te,scale:oe.scale},je=oe.zoom)}const ye={extent:te,mapLayers:Array.isArray(B.webmap.layers)?B.webmap.layers.map(oe=>({id:oe.id,title:oe.title||oe.id,visible:oe.visibility})):void 0,overview:Y.overview?{enable:!!Y.overview.enable,openByDefault:!!Y.overview.openByDefault}:void 0,legend:Y.legend?{enable:!!Y.legend.enable,openByDefault:!!Y.legend.openByDefault}:void 0,viewpoint:pe,zoom:je},se=this.builder.addWebMapResource(B.webmap.id,de,ye,"default"),Se=te?{x:(te.xmin+te.xmax)/2,y:(te.ymin+te.ymax)/2,spatialReference:te.spatialReference}:void 0;let ue;try{const oe=this.classicJson.webmapJson,ge=oe&&Array.isArray(oe.operationalLayers)?oe.operationalLayers:[],ce=this.classicJson?.values?.webmap;if(ge.length&&(ce===B.webmap.id||ce==null))ue=ge.map(T=>({...T}));else{const T=`https://www.arcgis.com/sharing/rest/content/items/${B.webmap.id}/data?f=json`,D=this.token?`${T}&token=${encodeURIComponent(this.token)}`:T;if(!(typeof window<"u"))try{const Q=et("curl",["-sL",D],{encoding:"utf-8"}),q=JSON.parse(Q),ie=Array.isArray(q?.operationalLayers)?q.operationalLayers:[];ie.length&&(ue=ie.map(ae=>({...ae})))}catch{}ke(D,void 0,600*1e3).then(Q=>{const q=Array.isArray(Q?.operationalLayers)?Q.operationalLayers:[];q.length&&(ue=q.map(ie=>({...ie})))}).catch(()=>{})}}catch{}this.builder.updateWebMapData(se,{extent:te,center:Se,mapLayers:ue??(Array.isArray(B.webmap.layers)?B.webmap.layers.map(oe=>({id:oe.id,title:oe.title||oe.id,visible:oe.visibility})):void 0),viewpoint:pe,zoom:je});try{const oe=`https://www.arcgis.com/sharing/rest/content/items/${B.webmap.id}/data?f=json`,ge=this.token?`${oe}&token=${encodeURIComponent(this.token)}`:oe;ke(ge,void 0,600*1e3).then(be=>{const ce=Array.isArray(be?.operationalLayers)?be.operationalLayers:[];if(ce.length){this.builder.updateWebMapData(se,{mapLayers:ce.map(D=>({...D}))});const T=new Map;if(B.webmap&&Array.isArray(B.webmap.layers))for(const D of B.webmap.layers)T.set(D.id,!!D.visibility);_&&this.builder.updateNodeData(_,D=>{D.mapLayers=ce.map(X=>{const Q=String(X.id||""),q=T.has(Q)?T.get(Q):!1;return{...X,visible:q}})})}}).catch(()=>{})}catch{}_=this.builder.createWebMapNode(se,R.text.includes("Map")||R.text.includes("Scene")?R.text:void 0);const Te=this.builder.getJson();if(_){const oe=Te.nodes[_],ge=oe&&"data"in oe?oe.data:void 0;if(oe&&ge){if(Array.isArray(B.webmap.layers)){const be=new Map;for(const ce of B.webmap.layers)be.set(ce.id,!!ce.visibility);Array.isArray(ue)&&ue.length?ge.mapLayers=ue.map(ce=>{const T=String(ce.id||""),D=be.has(T)?be.get(T):!1;return{...ce,visible:D}}):ge.mapLayers=B.webmap.layers.map(ce=>({id:ce.id,title:ce.title||ce.id,visible:ce.visibility}))}te&&(ge.extent=te),pe&&(ge.viewpoint=pe),typeof je=="number"&&(ge.zoom=je),Y.overview&&Y.overview.enable&&(ge.overview={openByDefault:!!Y.overview.openByDefault}),Y.legend&&Y.legend.enable&&(ge.legend={openByDefault:!!Y.legend.openByDefault})}}this.media.add(B.webmap.id)}else if(B.image?.url){const de=this.builder.addImageResource(B.image.url);_=this.builder.createImageNode(de,B.image.caption,B.image.altText,"standard"),this.media.add(B.image.url)}else if(B.video?.url){const de=this.detectVideoProvider(B.video.url);if(de.provider!=="unknown")_=this.builder.createVideoEmbedNode(B.video.url,de.provider,de.id,B.video.caption,B.video.caption,void 0,B.video.altText),this.videoEmbedCount++;else{const pe=this.builder.addVideoResource(B.video.url,"uri");_=this.builder.createVideoNode(pe,B.video.caption,B.video.altText),this.media.add(B.video.url)}}else if(B.webpage?.url){const de=this.tryBuildSwipeNodeFromUrl(B.webpage.url);de?_=de:_=this.builder.createEmbedNode(B.webpage.url,B.webpage.caption,B.webpage.title,B.webpage.description,B.webpage.altText)}if(_){this.builder.updateNode(R.buttonNodeId,te=>{const Y=te;Y.dependents||(Y.dependents={}),Y.dependents.actionMedia=_;const se=this.builder.getJson().nodes[_];if(se?.type==="swipe"&&se.data&&se.data.contents){const Se=se.data.contents,ue=Se[0],Te=Se[1];ue&&(Y.dependents.actionMedia_content_0=ue),Te&&(Y.dependents.actionMedia_content_1=Te)}});const pe=this.builder.getJson().nodes[we],je=pe&&"children"in pe?pe.children:void 0;Array.isArray(je)&&(je.includes(_)||this.builder.addChild(we,_));try{const te=this.builder.getJson(),Y=te.nodes[_],ye=te.nodes[V];if(Y?.type==="swipe"&&ye&&ye.data){const se=Y.data?.contents||{},Se=se[0],ue=se[1],Te=Se?te.nodes[Se]:void 0,oe=ue?te.nodes[ue]:void 0,ge=ye.data||{},be=ge.extent;let T=ge.viewpoint;if(!T&&be){const X=he(be);X&&(T={targetGeometry:be,scale:X.scale})}const D=X=>{X&&this.builder.updateNodeData(X,Q=>{const q=!!Q.extent,ie=!!Q.viewpoint;!q&&be&&(Q.extent=be),!ie&&T&&(Q.viewpoint=T),Q.viewPlacement||(Q.viewPlacement="extent")})};D(Se),D(ue)}}catch{}this.builder.registerReplaceMediaAction(R.buttonNodeId,we,_)}}}}const o=new Map;this.sections.forEach(M=>{(M.contentActions||[]).forEach(I=>{I.type==="navigate"&&typeof I.index=="number"&&o.set(I.id,I.index)})});for(const M of x){const I=o.get(M.actionId);if(typeof I=="number"){const W=u[I];W&&this.builder.setButtonLink(M.buttonNodeId,`#ref-${W}`)}}const y=this.builder.getJson();for(const M of r){const I=o.get(M.actionId);if(typeof I!="number")continue;const W=u[I];if(!W)continue;const G=y.nodes[M.richNodeId];if(G?.type==="text"&&G.data){const $=G.data;if(!$.preserveHtml)continue;const V=$.text,P=new RegExp(`<a([^>]*data-storymaps=["']${M.actionId}["'][^>]*)>`,"i"),we=V.replace(P,(L,R)=>/href=/.test(R)?L:`<a${R} href="#ref-${W}" target="_self">`);$.text=we}}const j=n.settings?.theme||null;if(!C&&d==="float"){const M=this.builder.getJson();for(const $ of Object.values(M.nodes))if($&&$.type==="immersive-narrative-panel"){const V=$.data||{};V.position="end",V.size="medium",$.data=V}const I={baseThemeId:"obsidian",forcedByMissingClassicTheme:!0,variableOverridesApplied:[],layoutMapping:{classicLayoutId:d,classicSize:m,classicPosition:S,mappedSubtype:a,mappedNarrativePanelSize:"medium",mappedNarrativePanelPosition:"end"}};this.builder.applyTheme({themeId:"obsidian",variableOverrides:{}}),I.videoEmbeds=this.videoEmbedCount;const W=Be(this.classicJson),G=this.classicJson.values||{};this.builder.addConverterMetadata(W||"MapJournal",{classicMetadata:{classicTheme:j,mappingDecisions:I,templateVersion:this.classicJson.version||this.classicJson.values?.version||this.classicJson.values?.templateVersion},classicTemplateCreation:G.templateCreation,classicTemplateLastEdit:G.templateLastEdit}),this.emit("Applied fallback obsidian theme (no classic theme present; float layout)");return}const{theme:A,decisions:N}=ms(this.classicJson);N.layoutMapping={classicLayoutId:d,classicSize:m,classicPosition:S,mappedSubtype:a,mappedNarrativePanelSize:p,mappedNarrativePanelPosition:f};const b={};if(Array.isArray(N.variableOverridesApplied))for(const M of N.variableOverridesApplied)A.variables&&M in A.variables&&(b[M]=String(A.variables[M]));if(this.styleBlocks.length)try{const M=this.styleBlocks.join(`

`);let I=M.split("").map($=>$.charCodeAt(0)<32?" ":$).join("");I=I.replace(/\r/g,"").replace(/\t/g," "),I=I.replace(/\n{3,}/g,`

`);const W=M.length,G=I.length>6e3?I.slice(0,6e3)+`
/*__CSS_TRUNCATED__*/`:I;N.customCss={blockCount:this.styleBlocks.length,approxBytes:W,combined:G}}catch{}if(this.builder.applyTheme({themeId:N.baseThemeId,variableOverrides:b}),N.videoEmbeds=this.videoEmbedCount,!this.shouldSuppressMetadata()){const M=Be(this.classicJson),I=this.classicJson.values||{};this.builder.addConverterMetadata(M||"MapJournal",{classicMetadata:{classicTheme:j,mappingDecisions:N,templateVersion:this.classicJson.version||this.classicJson.values?.version||this.classicJson.values?.templateVersion},classicTemplateCreation:I.templateCreation,classicTemplateLastEdit:I.templateLastEdit})}const k=this.builder.getJson().nodes[h],E=k&&"children"in k?k.children:void 0,J=Array.isArray(E)?E.length:0;this.emit(`Built single sidecar with ${J} slide(s); theme overrides applied (${Object.keys(b).length})`)}applyTheme(){this.emit("applyTheme skipped (handled in convertContent)")}collectMedia(){return this.emit(`Collected ${this.media.size} media URL(s)`),Array.from(this.media)}getStoryMapJson(){return this.builder.getJson()}static convert(t){return new at(t).convert()}normalizeExtent(t){if(!t)return t;const s=t.spatialReference?.wkid||t.spatialReference?.latestWkid||t.spatialReference?.wkt;if(!(s===4326||s==="WGS84"||s==="WGS 84")||[t.xmin,t.ymin,t.xmax,t.ymax].some(c=>typeof c!="number"||!isFinite(c)))return t;const n=c=>c*2003750834e-2/180,d=c=>Math.log(Math.tan((90+c)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;return{xmin:n(t.xmin),ymin:d(t.ymin),xmax:n(t.xmax),ymax:d(t.ymax),spatialReference:{wkid:102100,latestWkid:3857}}}extractImageEntries(t){const s=[],i=/<figure[^>]*>([\s\S]*?)<\/figure>/gi;let n;for(;(n=i.exec(t))!==null;){const m=n[1],S=/<img[^>]*>/i.exec(m)?.[0];if(!S)continue;const C=/src=["']([^"'>]+)["']/i.exec(S);if(!C)continue;const a=/alt=["']([^"'>]*)["']/i.exec(S),p=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(m),f=p?this.stripHtml(p[1]).trim():void 0,h=C[1];s.some(w=>w.src===h)||s.push({src:h,alt:a?a[1]:void 0,caption:f})}const d=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let c;for(;(c=d.exec(t))!==null;){const m=c[0],S=c[1];if(!s.some(C=>C.src===S)){const C=/alt=["']([^"'>]*)["']/i.exec(m);s.push({src:S,alt:C?C[1]:void 0})}}return s}stripHtml(t){return t.replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/\s+/g," ").trim()}normalizeButtonLabel(t){return String(t??"").replace(/\u00A0|&nbsp;/g," ").replace(/^[>›»\s]+/,"").trim()}extractParagraphBlocks(t){const s=[],i=/<p[^>]*>([\s\S]*?)<\/p>/gi;let n;for(;(n=i.exec(t))!==null;){const d=n[1],c=this.stripHtml(d);c&&s.push(c)}if(!s.length){const d=this.stripHtml(t);d&&s.push(d)}return s}extractActionAnchorLabel(t,s){const n=new RegExp(`<a[^>]*data-storymaps=["']${s}["'][^>]*>([\\s\\S]*?)</a>`,"i").exec(t);if(n)return this.stripHtml(n[1])}isNonEmptyHtmlSegment(t){if(!t)return!1;const s=/data-storymaps=/i.test(t),i=t.replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/gi," ").replace(/\u00A0/g," ").trim();return s||i.length>0}colorToHex(t){if(!t)return;if(t=t.trim(),t=t.replace(/!important$/i,"").trim(),/^#([0-9a-f]{3})$/i.test(t)){const d=t[1],c=t[2],m=t[3];return`#${d}${d}${c}${c}${m}${m}`.toUpperCase()}if(/^#([0-9a-f]{6})$/i.test(t))return t.toUpperCase();const s=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i.exec(t);if(s){const[d,c,m]=s.slice(1,4).map(S=>Math.max(0,Math.min(255,parseInt(S,10))));return`#${d.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`.toUpperCase()}const i=/rgb-?(\d+)-?(\d+)-?(\d+)/i.exec(t);if(i){const[d,c,m]=i.slice(1,4).map(S=>Math.max(0,Math.min(255,parseInt(S,10))));return`#${d.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`.toUpperCase()}const n=t.toLowerCase();if(this.CSS_COLOR_MAP[n])return this.CSS_COLOR_MAP[n].toUpperCase()}processHtmlColorsPreserveHtml(t){if(!t||!/<[^>]+style=/i.test(t))return t;try{const i=new DOMParser().parseFromString(`<wrapper>${t}</wrapper>`,"text/html").querySelector("wrapper");if(!i)return t;for(const n of Array.from(i.querySelectorAll("[style]"))){const d=n.getAttribute("style")||"",c=/color\s*:\s*([^;]+)(;?)/i.exec(d);if(!c)continue;const m=c[1].trim(),S=this.colorToHex(m);if(!S)continue;const C=`sm-text-color-${S.substring(1)}`;let a=d.replace(c[0],"").trim();a=a.replace(/;;+/g,";"),a=a.replace(/^;|;$/g,"").trim(),a?n.setAttribute("style",a):n.removeAttribute("style");const p=n.getAttribute("class");p?n.setAttribute("class",p+" "+C):n.setAttribute("class",C)}return i.innerHTML}catch{return t.replace(/(<[^>]+style=["'][^"'>]*color\s*:[^"'>]+["'][^>]*>)/gi,s=>{const i=/style=["']([^"'>]+)["']/i.exec(s);if(!i)return s;let n=i[1];const d=/color\s*:\s*([^;]+)(;?)/i.exec(n);if(!d)return s;const c=d[1].trim(),m=this.colorToHex(c);if(!m)return s;const S=`sm-text-color-${m.substring(1)}`;n=n.replace(d[0],"").trim(),n=n.replace(/;;+/g,";").replace(/^;|;$/g,"").trim();let C=s.replace(i[0],n?`style="${n}"`:"");return/class=["']/i.test(C)?C=C.replace(/class=["']([^"'>]+)["']/i,(a,p)=>`class="${p} ${S}"`):C=C.replace(/<([^\s>]+)/,(a,p)=>`<${p} class="${S}"`),C})}}handleElementOrdered(t,s,i,n,d){if(t.tagName==="STYLE"){const m=t.textContent||"";m.trim()&&this.styleBlocks.push(m.trim());return}if(t.tagName==="FIGURE"){const m=t.querySelector("img");if(m?.src){const S=this.builder.addImageResource(m.src);s.push(this.builder.createImageNode(S,t.querySelector("figcaption")?.textContent?.trim()||void 0,m.alt||void 0,"standard")),this.media.add(m.src)}return}if(t.tagName==="IMG"){if(t.getAttribute("src")){const m=t.getAttribute("src"),S=this.builder.addImageResource(m);s.push(this.builder.createImageNode(S,void 0,t.getAttribute("alt")||void 0,"standard")),this.media.add(m)}return}if(t.tagName==="P"||t.tagName==="DIV"){const m=new DOMParser().parseFromString(`<wrapper>${t.innerHTML}</wrapper>`,"text/html"),S=m.querySelector("wrapper");for(const p of Array.from(S.querySelectorAll("img[src]"))){const f=p.getAttribute("src"),h=p.getAttribute("alt")||void 0,w=this.builder.addImageResource(f),l=this.builder.createImageNode(w,void 0,h,"standard");this.media.add(f),p.replaceWith(m.createTextNode(`%%IMG:${l}%%`))}for(const p of Array.from(S.querySelectorAll("a[data-storymaps]"))){const f=p.getAttribute("data-storymaps"),h=p.getAttribute("data-storymaps-type")||"",w=(p.textContent||"View").trim(),l=this.normalizeButtonLabel(w),r=(p.getAttribute("class")||"").split(/\s+/).filter(Boolean).some(o=>this.BUTTON_CLASS_REGEX.test(o));if(h==="media"){const o=this.builder.createActionButtonNode(l,"wide");i.push({actionId:f,text:l,buttonNodeId:o}),p.replaceWith(m.createTextNode(`%%ACTION_BTN:${o}%%`))}else if(h==="navigate")if(r){const o=this.builder.createButtonNode(l,"wide");n.push({actionId:f,buttonNodeId:o}),p.replaceWith(m.createTextNode(`%%NAV_BTN:${o}%%`))}else d.push({actionId:f,richNodeId:""})}const a=S.innerHTML.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%)/);for(const p of a)if(p)if(/^%%IMG:/.test(p)){const f=p.replace(/^%%IMG:/,"").replace(/%%$/,"");s.push(f)}else if(/^%%ACTION_BTN:/.test(p)){const f=p.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,"");s.push(f)}else if(/^%%NAV_BTN:/.test(p)){const f=p.replace(/^%%NAV_BTN:/,"").replace(/%%$/,"");s.push(f)}else{if(!this.isNonEmptyHtmlSegment(p))continue;const f=this.processHtmlColorsPreserveHtml(p).replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),h=f.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(h&&h.length>1)for(const l of h){const u=l.replace(/^<p[^>]*>|<\/p>$/gi,"").trim().replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");if(!u.replace(/&nbsp;|\s+/g,"").trim())continue;const r=this.builder.createRichTextNode(u,"paragraph");if(l.includes("data-storymaps"))for(const o of d)!o.richNodeId&&l.includes(`data-storymaps="${o.actionId}"`)&&(o.richNodeId=r);s.push(r)}else{let l=f;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(f.trim())&&(l=f.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim()),l=l.replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");const x=this.builder.createRichTextNode(l,"paragraph");if(f.includes("data-storymaps"))for(const r of d)!r.richNodeId&&f.includes(`data-storymaps="${r.actionId}"`)&&(r.richNodeId=x);s.push(x)}}return}if(t.tagName==="IFRAME"){const m=t.getAttribute("src");if(m){const S=this.parseSwipeAppId(m);if(S&&typeof window>"u"){const a=this.fetchClassicSwipeDataSync(S);if(a&&a.values){const p=this.parseSwipeLayoutFromUrl(m)||(String(a.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const f=typeof window<"u",h=!!a.values;this.logDebug("iframe (DOM) -> attempting inline swipe build",{appId:S,layout:p,env:f?"browser":"node",hasValues:h});const w=ve.buildInlineSwipeBlockSync(this.builder,a.values,p,this.token);s.push(w),this.logDebug("iframe (DOM) -> inline swipe built",{swipeNodeId:w}),this.flushDebugLogs("embedded-swipe");return}catch(f){this.logWarn("iframe (DOM) -> inline swipe build failed, using embed",{appId:S,error:f?.message}),this.flushDebugLogs("embedded-swipe")}}}const C=this.detectVideoProvider(m);C.provider!=="unknown"?(s.push(this.builder.createVideoEmbedNode(m,C.provider,C.id)),this.videoEmbedCount++,this.logDebug("iframe (DOM) -> video embed",C),this.flushDebugLogs("embedded-swipe")):(s.push(this.builder.createEmbedNode(m)),this.logDebug("iframe (DOM) -> link embed",{src:m}),this.flushDebugLogs("embedded-swipe"))}return}const c=t.textContent?.trim();c&&s.push(this.builder.createTextNode(c,"paragraph"))}parseOrderedFallback(t,s,i,n,d){const c=/<style[^>]*>([\s\S]*?)<\/style>/gi;let m;for(;(m=c.exec(t))!==null;){const a=m[1].trim();a&&this.styleBlocks.push(a)}const S=/(<figure[\s\S]*?<\/figure>)|(<img[^>]*>)|(<p[\s\S]*?<\/p>)|(<div[\s\S]*?<\/div>)|(<iframe[\s\S]*?<\/iframe>)/gi;let C;for(;(C=S.exec(t))!==null;){const a=C[0],p=a.slice(0,10).toLowerCase();if(p.startsWith("<style")){const h=a.replace(/^<style[^>]*>|<\/style>$/gi,"").trim();h&&this.styleBlocks.push(h);continue}if(p.startsWith("<figure")){const h=/<img[^>]*>/i.exec(a)?.[0];if(h){const w=/src=["']([^"'>]+)["']/i.exec(h)?.[1];if(w){const l=/alt=["']([^"'>]*)["']/i.exec(h)?.[1],u=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(a)?.[1],x=this.builder.addImageResource(w);s.push(this.builder.createImageNode(x,u?this.stripHtml(u).trim():void 0,l,"standard")),this.media.add(w)}}continue}if(p.startsWith("<iframe")){const h=/src=["']([^"'>]+)["'][^>]*>/i.exec(a)?.[1];if(h){const w=this.parseSwipeAppId(h);if(w&&typeof window>"u"){const u=this.fetchClassicSwipeDataSync(w);if(u&&u.values){const x=this.parseSwipeLayoutFromUrl(h)||(String(u.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const r=typeof window<"u",o=!!u.values;this.logDebug("iframe (regex) -> attempting inline swipe build",{appId:w,layout:x,env:r?"browser":"node",hasValues:o});const y=ve.buildInlineSwipeBlockSync(this.builder,u.values,x,this.token);s.push(y);continue}catch(r){this.logWarn("iframe (regex) -> inline swipe build failed",{appId:w,error:r?.message})}}}const l=this.detectVideoProvider(h);l.provider!=="unknown"?(s.push(this.builder.createVideoEmbedNode(h,l.provider,l.id)),this.videoEmbedCount++):s.push(this.builder.createEmbedNode(h))}continue}if(p.startsWith("<p")||p.startsWith("<div")){const h=a.replace(/^<p[^>]*>|^<div[^>]*>|<\/p>$|<\/div>$/gi,"");let w=h;const l=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let u;for(;(u=l.exec(h))!==null;){const A=u[0],N=u[1],b=/alt=["']([^"'>]*)["']/i.exec(A)?.[1],k=this.builder.addImageResource(N),E=this.builder.createImageNode(k,void 0,b,"standard");this.media.add(N),w=w.replace(A,`%%IMG:${E}%%`)}const x=/<a[^>]*data-storymaps=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/a>/gi;let r;for(;(r=x.exec(h))!==null;){const A=r[0],N=r[1],b=/data-storymaps-type=["']([^"'>]+)["']/i.exec(A)?.[1]||"",k=A.replace(/<a[^>]*>|<\/a>/gi,""),E=this.stripHtml(k).trim()||"View",J=this.normalizeButtonLabel(E),I=(/class=["']([^"'>]+)["']/i.exec(A)?.[1]||"").split(/\s+/).some(W=>this.BUTTON_CLASS_REGEX.test(W));if(b==="media"){const W=this.builder.createActionButtonNode(J,"wide");i.push({actionId:N,text:J,buttonNodeId:W}),w=w.replace(A,`%%ACTION_BTN:${W}%%`)}else if(b==="navigate")if(I){const W=this.builder.createButtonNode(J,"wide");n.push({actionId:N,buttonNodeId:W}),w=w.replace(A,`%%NAV_BTN:${W}%%`)}else d.push({actionId:N,richNodeId:""})}const o=/<iframe[^>]*src=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/iframe>/gi;let y;for(;(y=o.exec(h))!==null;){const A=y[0],N=y[1];let b;const k=this.parseSwipeAppId(N);if(k&&typeof window>"u"){const E=this.fetchClassicSwipeDataSync(k);if(E&&E.values){const J=this.parseSwipeLayoutFromUrl(N)||(String(E.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{this.logDebug("iframe (regex) -> attempting inline swipe build",{appId:k,layout:J}),b=ve.buildInlineSwipeBlockSync(this.builder,E.values,J,this.token),this.logDebug("iframe (regex) -> inline swipe built",{replacementId:b}),this.flushDebugLogs("embedded-swipe")}catch{this.logWarn("iframe (regex) -> inline swipe build failed, will fallback",{appId:k}),this.flushDebugLogs("embedded-swipe")}}}if(!b){const E=this.detectVideoProvider(N);E.provider!=="unknown"?(b=this.builder.createVideoEmbedNode(N,E.provider,E.id),this.videoEmbedCount++,this.logDebug("iframe (regex) -> video embed fallback",E),this.flushDebugLogs("embedded-swipe")):(b=this.builder.createEmbedNode(N),this.logDebug("iframe (regex) -> link embed fallback",{src:N}),this.flushDebugLogs("embedded-swipe"))}w=w.replace(A,`%%IFRAME_NODE:${b}%%`)}const j=w.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%|%%IFRAME_NODE:[^%]+%%)/);for(const A of j)if(A)if(/^%%IMG:/.test(A))s.push(A.replace(/^%%IMG:/,"").replace(/%%$/,""));else if(/^%%ACTION_BTN:/.test(A))s.push(A.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,""));else if(/^%%NAV_BTN:/.test(A))s.push(A.replace(/^%%NAV_BTN:/,"").replace(/%%$/,""));else if(/^%%IFRAME_NODE:/.test(A))s.push(A.replace(/^%%IFRAME_NODE:/,"").replace(/%%$/,""));else{if(!this.isNonEmptyHtmlSegment(A))continue;const N=this.processHtmlColorsPreserveHtml(A).replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),b=N.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(b&&b.length>1)for(const E of b){const J=E.replace(/^<p[^>]*>|<\/p>$/gi,"").trim().replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");if(!J.replace(/&nbsp;|\s+/g,"").trim())continue;const I=this.builder.createRichTextNode(J,"paragraph");if(E.includes("data-storymaps"))for(const W of d)!W.richNodeId&&E.includes(`data-storymaps="${W.actionId}"`)&&(W.richNodeId=I);s.push(I)}else{let E=N;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(N.trim())&&(E=N.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim()),E=E.replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");const M=this.builder.createRichTextNode(E,"paragraph");if(N.includes("data-storymaps"))for(const I of d)!I.richNodeId&&N.includes(`data-storymaps="${I.actionId}"`)&&(I.richNodeId=M);s.push(M)}}continue}const f=this.stripHtml(a).trim();f&&s.push(this.builder.createTextNode(f,"paragraph"))}}detectVideoProvider(t){if(!t)return{provider:"unknown"};const s=/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([A-Za-z0-9_-]{6,})(?:[&#?].*)?$/i.exec(t);if(s)return{provider:"youtube",id:s[1]};const i=/(?:vimeo\.com\/(?:video\/)?)(\d+)(?:[&#?].*)?$/i.exec(t);return i?{provider:"vimeo",id:i[1]}:{provider:"unknown"}}parseSwipeAppId(t){try{const s=new URL(t,"https://example.com");return s.searchParams.get("appid")||s.searchParams.get("appId")||void 0}catch{return/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(t)?.[1]}}parseSwipeLayoutFromUrl(t){try{const i=(new URL(t,"https://example.com").searchParams.get("layout")||"").toLowerCase();return i.includes("spyglass")?"spyglass":i.includes("swipe")?"swipe":void 0}catch{return}}fetchClassicSwipeDataSync(t){try{const s=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,i=this.token?`${s}&token=${encodeURIComponent(this.token)}`:s,n=Ye(`curl -sL '${i}'`,{encoding:"utf-8"});return JSON.parse(n)}catch{return}}fetchClassicSwipeDataProvided(t){try{const s=this.classicJson,i=this.classicJson.values,n=s.__embeddedSwipes||i?.__embeddedSwipes||void 0,d=n?n[t]:void 0;if(d&&typeof d=="object")return d}catch{}}tryBuildSwipeNodeFromUrl(t){const s=this.parseSwipeAppId(t);if(!s)return;const i=typeof window<"u",n=i?this.fetchClassicSwipeDataProvided(s):this.fetchClassicSwipeDataSync(s);if(i&&(!n||!n.values))try{const m=`https://www.arcgis.com/sharing/rest/content/items/${s}/data?f=json`,S=this.token?`${m}&token=${encodeURIComponent(this.token)}`:m;ke(S,void 0,600*1e3)}catch{}if(!n||!n.values)return;const c=this.parseSwipeLayoutFromUrl(t)||(String(n.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{this.logDebug("tryBuildSwipeNodeFromUrl: attempting inline swipe build from",{url:t});const m=typeof window<"u"?ve.buildInlineSwipeBlockBrowserSync(this.builder,n.values,c,this.token):ve.buildInlineSwipeBlockSync(this.builder,n.values,c,this.token);try{const S=this.builder.getJson(),C=S.nodes[m];if(C&&C.type==="swipe"){let a=C.data?.contents||{};const p=[];for(const w of["0","1"]){const l=a[w];(!l||!S.nodes[l])&&p.push(w)}if(p.length){const w=n.values,l=String(w.dataModel||"").toUpperCase(),u={...a};if(l==="TWO_LAYERS"){const x=String(w.webmap||"");if(x){const r=this.builder.addWebMapResource(x,"Web Map",{},"default"),o=Array.isArray(w.layers)?w.layers:[],y=this.builder.createWebMapNode(r,void 0),j=this.builder.createWebMapNode(r,void 0);if(o.length>=2){const A=o[0],N=o[1];this.builder.updateNodeData(y,b=>{b.mapLayers=[{id:A.id,title:A.title||A.id,visible:!0},{id:N.id,title:N.title||N.id,visible:!1}]}),this.builder.updateNodeData(j,b=>{b.mapLayers=[{id:A.id,title:A.title||A.id,visible:!1},{id:N.id,title:N.title||N.id,visible:!0}]})}u[0]=y,u[1]=j}}else{const x=[];if(Array.isArray(w.webmaps))for(const y of w.webmaps)typeof y=="string"?x.push(y):y&&typeof y=="object"&&"id"in y&&x.push(String(y.id));else w.webmap&&x.push(String(w.webmap));const[r,o]=x;if(r){const y=this.builder.addWebMapResource(r,"Web Map",{},"default");u[0]=this.builder.createWebMapNode(y,void 0)}if(o){const y=this.builder.addWebMapResource(o,"Web Map",{},"default");u[1]=this.builder.createWebMapNode(y,void 0)}}this.builder.updateNode(m,x=>{const r=x.data||{};r.contents=u,x.data=r}),a=u,this.logDebug("swipe contents rebuilt due to missing keys",{missingKeys:p})}const f=a[0],h=a[1];if(!f||!h||!S.nodes[f]||!S.nodes[h]){try{this.builder.removeNode(m)}catch{}this.logWarn("dropping inline swipe; invalid contents",{c0:f,c1:h}),this.flushDebugLogs("embedded-swipe");return}this.logDebug("inline swipe built successfully",{swipeNodeId:m,contents:a})}}catch{}try{const S=this.options?.classicItemId,C={};S&&(C.classicItemId=S),this.builder.addConverterMetadata("MapJournal",{classicMetadata:{},...C})}catch{}return this.flushDebugLogs("embedded-swipe"),m}catch(m){this.logWarn("inline swipe build failed; will use embed",{url:t,error:m?.message}),this.flushDebugLogs("embedded-swipe");return}}}const Ss=["name","Name","NAME","title","Title","TITLE"],Is=["description","Description","DESCRIPTION","desc","Desc","DESC","desc1","Desc1","DESC1","caption","Caption","CAPTION","FULL_Caption"],Cs=["pic_url","Pic_url","PIC_URL","url","Url","URL"],As=["thumb_url","Thumb_url","THUMB_URL"],js=["long","Long","LONG","LON","longitude","Longitude","LONGITUDE","x"],Ns=["lat","Lat","LAT","latitude","Latitude","LATITUDE","y"];class Ze extends rt{constructor(t){super(t),this.uploaded={},this.mediaUrls=new Set,this.places=[],this.geometries={},this.builder=new ot(t.themeId)}extractStructure(){this.emit("MapTour: extractStructure (no sections list)")}async convertContent(){const t=this.classicJson.values||{},s=t.title||"Untitled Story",i=t.subtitle||"",n=this.themeId==="auto"?ks(t,"summit"):this.themeId;this.builder.createStoryRoot(),this.builder.addCoverNode(s,i),this.builder.addNavigationHidden(),this.builder.addCreditsNode(),this.builder.applyTheme({themeId:n});const d=Array.isArray(this.classicJson._mapTourFeatures)?this.classicJson._mapTourFeatures:[];let c=Array.isArray(t.places)&&t.places.length?t.places:St(d);const m=this.classicJson;if(!c.length&&m.webmapJson){const o=Rs(m.webmapJson,t.sourceLayer);o.length&&(c=St(o))}const S=Array.isArray(t.order)&&t.order.length?t.order:c.map(o=>({id:o.id,visible:o.visible!==!1})),C={};c.forEach(o=>{o.id!==void 0&&(C[o.id]=o)});const a=S.map(o=>C[o.id]).filter(Boolean).map(o=>({...o,visible:S.find(y=>y.id===o.id)?.visible!==!1}));let p;for(let o=0;o<a.length;o++){const y=a[o],j=String(y.id??o),A=Fe(y,Cs),N=Fe(y,As);if(A){this.mediaUrls.add(A);const b=this.builder.addImageResource(A);this.uploaded[j]={...this.uploaded[j]||{},imageUrl:A,imageResId:b},this.inlineUpload&&this.uploader&&this.storyId&&this.username&&this.token&&this.tryInlineUpload(A,b).catch(()=>{})}if(N){this.mediaUrls.add(N);const b=this.builder.addImageResource(N);this.uploaded[j]={...this.uploaded[j]||{},thumbUrl:N,thumbResId:b},this.inlineUpload&&this.uploader&&this.storyId&&this.username&&this.token&&this.tryInlineUpload(N,b).catch(()=>{})}}for(let o=0;o<a.length;o++){const y=a[o],j=String(y.id??o),A=Fe(y,Ss)||`Place ${o+1}`,N=Fe(y,Is)||"",b=this.uploaded[j]?.imageResId,k=this.uploaded[j]?.thumbResId;o===0&&t.firstRecordAsIntro&&b&&(p=b);const E=[];b&&E.push(this.builder.createImageNode(b,void 0,void 0,"standard")),k&&E.push(this.builder.createImageNode(k,void 0,void 0,"standard"));const J=E.length?this.builder.createCarouselNode(E):void 0,M=this.builder.createTextNode(A,"h3","wide"),I=this.builder.createTextNode(N,"paragraph","wide"),W=this.builder.newNodeId();let G=Ts(y);!G&&y.geometry&&typeof y.geometry.x=="number"&&typeof y.geometry.y=="number"&&(G=Ms(y.geometry.x,y.geometry.y)),G&&(this.geometries[W]={id:W,type:"POINT_NUMBERED_TOUR",nodes:[{long:G.long,lat:G.lat}],viewpoint:{},scale:4514}),this.places.push({id:this.builder.newNodeId(),featureId:W,contents:[I],media:J,title:M,config:y.visible===!1?{isHidden:!0}:void 0})}const f=this.builder.createTourMapNode(this.geometries,t.webmap),h="#f9f794",w={"three-panel":{tourType:"guided-tour",subtype:"media-focused"},"side-panel":{tourType:"guided-tour",subtype:"media-focused"},integrated:{tourType:"guided-tour",subtype:"map-focused"}};let l,u;if(this.places.length>15)l="explorer",u="grid";else{const o=w[t.layout||"integrated"]||w.integrated;l=o.tourType,u=o.subtype}const x=t.placardPosition==="end"?"end":"start",r=this.builder.createTourNode(this.places,f,h,x,"large",l,u);this.builder.addChild(this.builder.getStoryRootId(),f),this.builder.addChild(this.builder.getStoryRootId(),r),p&&this.builder.setStoryMeta(s,i,p),this.inlineUpload&&(!this.storyId||!this.token||!this.uploader)&&this.emit("MapTour inlineUpload requested but missing storyId/token/uploader – falling back to URI resources"),this.emit(`MapTour: built ${this.places.length} place(s); layout=${t.layout||"integrated"} mapped to ${l}/${u}`)}applyTheme(){this.emit("MapTour: applyTheme (no overrides)")}collectMedia(){return Array.from(this.mediaUrls)}getStoryMapJson(){return this.builder.getJson()}static convert(t){const s=Be(t.classicJson);if(!/tour/i.test(s))throw new Error("MapTourConverter invoked for non Map Tour template");return new Ze(t).convert()}async tryInlineUpload(t,s){if(!(!this.uploader||!this.storyId||!this.username||!this.token))try{const i=await this.uploader(t,this.storyId,this.username,this.token);i.transferred&&i.resourceName?(this.builder.finalizeImageResourceAsItem(s,i.resourceName),this.emit(`Inline upload success for ${t}`)):this.emit(`Inline upload skipped/not transferred for ${t}`)}catch(i){this.emit(`Inline upload error for ${t}: ${i.message}`)}}static async convertInline(t){return new Ze({...t,inlineUpload:!0}).convert()}}function Fe(v,t){for(const s of t){const i=v&&v[s];if(i!=null&&String(i).trim())return String(i).trim()}}function Ts(v){const t=v||{},s=Fe(t,js),i=Fe(t,Ns),n=Number(s),d=Number(i);if(!isNaN(n)&&!isNaN(d)&&Math.abs(n)<=180&&Math.abs(d)<=90)return{long:n,lat:d}}function Ms(v,t){if(Math.abs(v)<=180&&Math.abs(t)<=90)return{long:v,lat:t};const s=6378137,i=v/s*180/Math.PI;let n=t/s*180/Math.PI;if(n=180/Math.PI*(2*Math.atan(Math.exp(n*Math.PI/180))-Math.PI/2),!isNaN(i)&&!isNaN(n)&&Math.abs(i)<=180&&Math.abs(n)<=90)return{long:i,lat:n}}function ks(v,t){try{const s=v.settings?.theme?.colors?.themeMajor;return s==="dark"?"obsidian":s==="light"?"summit":t}catch{return t}}function Ls(v){const t=["__OBJECTID","objectid","id","ID","FID","fid","ObjectID","Object_Id","OBJECTID","OBJECTID_1"];for(const s of t){const i=v[s];if(i!=null&&String(i).trim())return typeof i=="number"?i:String(i).trim()}}function St(v){if(!Array.isArray(v)||!v.length)return[];const t=[];for(const s of v){const i=s.attributes||{},n=Ls(i);n!==void 0&&t.push({id:n,...i,geometry:s.geometry})}return t}function Rs(v,t){try{const s=v,i=Array.isArray(s.operationalLayers)?s.operationalLayers:[],n=c=>{const m=String(c?.id||""),S=String(c?.title||"").toLowerCase(),C=/map\s*tour|maptour/.test(S),a=/^maptour-layer/i.test(m);return(t?m===t||m.includes(t)||t.includes(m):!1)||a||C},d=i.filter(n);for(const c of d){const m=c.featureCollection?.layers||[];for(const S of m){const C=S.featureSet?.features;if(Array.isArray(C))return C}}}catch{}return[]}class $s{static async transferBatch(t){const{urls:s,storyId:i,username:n,token:d,progress:c,uploader:m,isCancelled:S}=t,C={};for(let a=0;a<s.length;a++){if(S&&S())throw new Error("Conversion cancelled by user intervention");const p=s[a];c({stage:"media",message:`Transferring media ${a+1}/${s.length}`,current:a+1,total:s.length});try{if(S&&S())throw new Error("Conversion cancelled by user intervention");const f=await m(p,i,n,d);f.transferred&&(C[f.originalUrl]=f.resourceName)}catch{}}if(S&&S())throw new Error("Conversion cancelled by user intervention");return C}}class Es{static apply(t,s){for(const[i,n]of Object.entries(t.resources))if(n.type==="image"){const d=n,c=d.data&&typeof d.data=="object"?d.data.src:void 0;if(c&&s[c]){const m=d.data||{};m.resourceId=s[String(c)],delete m.src,m.provider="item-resource",d.data=m}}for(const i of Object.values(t.nodes))if(i.type==="image"){const n=i,d=n.data&&typeof n.data=="object"?n.data.src:void 0;if(typeof d=="string"){const c=d,m=Object.entries(t.resources).find(([S,C])=>C.type==="image"&&typeof C.data.src=="string"&&C.data.src===c)?.[0];if(m){const S=n.data||{};S.image=m,delete S.src,delete S.resourceId,delete S.provider,n.data=S}}}return t}static rewriteImageUrlsToProxy(t,s){for(const i of Object.values(t.resources))if(i.type==="image"){const n=i,d=n.data||{},c=d.src,m=d.resourceId;typeof c=="string"&&!m&&(d.src=`${s}?url=${encodeURIComponent(c)}`),n.data=d}for(const i of Object.values(t.nodes))if(i.type==="image"){const n=i,d=n.data||{},c=d.src,m=d.image;typeof c=="string"&&!m&&(d.src=`${s}?url=${encodeURIComponent(c)}`),n.data=d}return t}}const Oe="https://www.arcgis.com/sharing/rest";async function tt(v,t){const s=`${Oe}/content/items/${v}/data?f=json&token=${t}`,i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch item data: ${i.statusText}`);return i.json()}async function _e(v,t){const s=`${Oe}/content/items/${v}?f=json&token=${t}`,i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch item details: ${i.statusText}`);return i.json()}async function Fs(v,t,s,i){const n=`${Oe}/content/users/${t}/items/${v}/removeResources`,d=new URLSearchParams;d.append("resource",s),d.append("f","json"),d.append("token",i);const c=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()});if(!c.ok)throw new Error(`Failed to remove resource: ${c.statusText}`);return c.json()}async function Nt(v,t,s,i,n){const d=`${Oe}/content/users/${t}/items/${v}/addResources`,c=new FormData;c.append("file",s,i),c.append("fileName",i),c.append("f","json"),c.append("token",n);const m=await fetch(d,{method:"POST",body:c}),S=await m.json();console.log("[addResource] Upload API response:",S);const C=m.ok,a=S?.success===!0,p=S?.error?.message;if(!C||!a)throw new Error(`Failed to add resource: ${p||m.statusText}`);return S}async function It(v,t,s,i){const n=`${Oe}/content/users/${t}/items/${v}/update`,d=new URLSearchParams;d.append("typeKeywords",JSON.stringify(s)),d.append("f","json"),d.append("token",i);const c=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()});if(!c.ok)throw new Error(`Failed to update item keywords: ${c.statusText}`);return c.json()}function Ds(v){const t=v&&typeof v=="object"?v.typeKeywords:void 0,s=Array.isArray(t)?t.filter(i=>typeof i=="string"):[];for(const i of s)if(i.startsWith("smdraftresourceid:"))return i.substring(18);return null}function Bs(){const v=Ke(),t=Ke(),s=Ke(),i=Ke(),n=Os();return{root:v,nodes:{[t]:{type:"storycover",data:{type:"minimal",title:"",summary:"",byline:"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},[s]:{type:"navigation",data:{links:[]},config:{isHidden:!0}},[i]:{type:"credits",children:[]},[v]:{type:"story",data:{storyTheme:n},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[t,s,i]}},resources:{[n]:{type:"story-theme",data:{themeId:"summit",themeBaseVariableOverrides:{}}}}}}function Ke(){return`n-${Math.random().toString(36).slice(2,8)}`}function Os(){return`r-${Math.random().toString(36).slice(2,8)}`}async function Ps(v,t,s){const i=`${Oe}/content/users/${encodeURIComponent(v)}/addItem`,n=new URLSearchParams;n.append("f","json"),n.append("token",t),n.append("title",s),n.append("type","StoryMap"),n.append("typeKeywords",JSON.stringify(["StoryMaps","smdraftresourceid:draft.json"]));const d=Bs();n.append("text",JSON.stringify(d));const c=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}),m=await c.json();if(!c.ok||!m||!m.success||!m.id){const S=m&&m.error&&m.error.message||c.statusText||"addItem failed";throw new Error(`Failed to create draft story: ${S}`)}return String(m.id)}function Ws(v){return v.includes("www.arcgis.com/sharing/rest/content")||v.includes("//www.arcgis.com/sharing/rest/content")}function Us(v){const t=v.split("/resources/");if(t.length>1){const i=t[1].split("?")[0];return decodeURIComponent(i)}return v.split("/").pop()?.split("?")[0]||"image.jpg"}function _s(v,t){const s=["jpg","jpeg","png","gif","webp","bmp","tif","tiff"];let i=t;if(!i){const d=v.split(".").pop()||"";i=s.includes(d.toLowerCase())?d.toLowerCase():"jpg"}return i==="jpeg"&&(i="jpg"),i==="tiff"&&(i="tif"),`${Math.random().toString(36).substring(2,15)}.${i}`}function Ct(v){if(!v)return".jpg";const t=v.toLowerCase();return[".jpg",".jpeg",".png",".gif",".webp",".bmp",".tif",".tiff"].includes(t)?t===".jpeg"?".jpg":t===".tiff"?".tif":t:".jpg"}function zs(v,t,s){if(s){const n=/filename="?([^";]+)"?/i.exec(s);if(n){const c=n[1].toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(c)return c[0].replace(".jpeg",".jpg").replace(".tiff",".tif")}}const i=v.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(i)return i[0].replace(".jpeg",".jpg").replace(".tiff",".tif");if(t&&/^image\//i.test(t)){const n=t.split("/")[1].toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","tiff","tif"].includes(n)?"."+(n==="jpeg"?"jpg":n==="tiff"?"tif":n):".jpg"}return".bin"}async function Js(v,t){const s=t?`${v}?token=${encodeURIComponent(t)}`:v,i=await fetch(s);if(!i.ok)throw new Error(`Image fetch failed ${i.status}`);const n=i.headers.get("content-disposition")||void 0,d=i.headers.get("content-type")||void 0,c=i.url,m=await i.blob(),S=zs(c,d,n);return{blob:m,extension:S}}async function Vs(v,t,s,i,n){try{console.log("[transferImage] Starting transfer:",{imageUrl:v,filename:n,targetItemId:t});const d=Us(v);let c=".jpg",m;try{const C=await Js(v,Ws(v)?i:void 0);m=C.blob,c=Ct(C.extension)}catch(C){console.warn("[transferImage] Primary fetch failed, trying proxy:",{imageUrl:v,error:C}),m=await Hs(v);const a=d.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);c=Ct(a?a[0]:".jpg")}/^\.(jpg|png|gif|webp|bmp|tif)$/i.test(c)||(c=".jpg");let S;return n||(S=_s(d,c.replace(".",""))),console.log("[transferImage] Uploading to AGO:",{newResourceName:S,blob:m}),await Nt(t,s,m,S,i),console.log("[transferImage] Transfer successful:",{imageUrl:v,newResourceName:S}),{originalUrl:v,resourceName:S,isTransferred:!0}}catch(d){return console.error("[transferImage] Transfer failed:",{imageUrl:v,error:d}),{originalUrl:v,resourceName:v,isTransferred:!1}}}async function Hs(v){const s=/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname)?`/.netlify/functions/proxy-image?url=${encodeURIComponent(v)}`:v,i=await fetch(s);if(!i.ok)throw new Error("Failed to fetch image (proxy/direct)");return await i.blob()}function Gs(v){const t=new Set;if(v.resources){for(const s of Object.values(v.resources))if(s.type==="image"){const i=s.data?.url||s.data?.src;i&&t.add(i)}}return Array.from(t)}const qs=new Et({allErrors:!0,strict:!1,allowUnionTypes:!0});function Ks(...v){return qs.compile(...v)}const Ys="http://json-schema.org/draft-07/schema#",Xs="https://example.com/schemas/draft-story.json",Zs="StoryMaps Draft",Qs="object",ei=["root","nodes","resources"],ti={root:{type:"string",minLength:1},nodes:{type:"object",minProperties:1,additionalProperties:{type:"object",required:["type"],properties:{type:{type:"string",minLength:1},data:{type:"object",properties:{children:{type:"array",items:{type:"string"}},viewpoint:{$ref:"#/$defs/viewpoint"},extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0},config:{type:"object"},children:{type:"array",items:{oneOf:[{type:"string"},{type:"number"},{type:"object",additionalProperties:!0}]}},dependents:{type:"object"}},additionalProperties:!0}},resources:{type:"object",additionalProperties:{type:"object",required:["type"],properties:{type:{type:"string",minLength:1},data:{type:"object",properties:{initialState:{type:"object",properties:{extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},viewpoint:{$ref:"#/$defs/viewpoint"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0},extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},viewpoint:{$ref:"#/$defs/viewpoint"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0}},additionalProperties:!0}},actions:{type:"array",items:{type:"object"}}},si={spatialReference:{type:"object",properties:{wkid:{type:"integer"}},required:["wkid"],additionalProperties:!0},center:{type:"object",properties:{x:{type:"number"},y:{type:"number"},spatialReference:{$ref:"#/$defs/spatialReference"}},required:["x","y","spatialReference"],additionalProperties:!0},extent:{type:"object",properties:{xmin:{type:"number"},ymin:{type:"number"},xmax:{type:"number"},ymax:{type:"number"},spatialReference:{$ref:"#/$defs/spatialReference"}},required:["xmin","ymin","xmax","ymax","spatialReference"],additionalProperties:!0},viewpoint:{oneOf:[{$ref:"#/$defs/extent"},{$ref:"#/$defs/center"},{type:"object",properties:{targetGeometry:{type:["object","array","string"],additionalProperties:!0},scale:{type:"number"},rotation:{type:"number"},camera:{type:"object",additionalProperties:!0}},additionalProperties:!0}]},mapLayer:{type:"object",properties:{id:{type:"string"},visible:{type:"boolean"}},required:["id"],additionalProperties:!0},mapLayers:{type:"array",items:{$ref:"#/$defs/mapLayer"}}},ii=!1,ni={$schema:Ys,$id:Xs,title:Zs,type:Qs,required:ei,properties:ti,$defs:si,additionalProperties:ii};function ri(){const[v,t]=z.useState(!1),[s,i]=z.useState(!1),[n,d]=z.useState(""),c=z.useRef(!1),[m,S]=z.useState(!1),[C]=z.useState(!1),{token:a,userInfo:p}=ze(),[f,h]=z.useState(""),[w,l]=z.useState("idle"),[u,x]=z.useState(""),[r,o]=z.useState(""),[y,j]=z.useState(""),[A,N]=z.useState(()=>{try{const T=localStorage.getItem("suppressConverterMetadata");return T?String(T).toLowerCase()==="true":!1}catch{return!1}});z.useEffect(()=>{try{localStorage.setItem("suppressConverterMetadata",String(A))}catch{}globalThis.__SUPPRESS_CONVERTER_METADATA=A},[A]);const[b,k]=z.useState("Convert");z.useEffect(()=>{let T=!1;const D=(f||"").trim();if(D.length<8){k("Convert");return}return(async()=>{try{const X=await _e(D,a),Q=String(X?.title||X?.name||"").trim();let q=null;try{const me=await tt(D,a);q=Be(me)}catch{}if(!q||q.toLowerCase()==="unknown"){const me=Array.isArray(X?.typeKeywords)?X.typeKeywords:[],Ne=[String(X?.type||"").toLowerCase(),...me.map(le=>String(le).toLowerCase())].join(" "),Z=/journal/.test(Ne)?"Map Journal":/swipe/.test(Ne)?"Swipe":/tour/.test(Ne)?"Map Tour":/series/.test(Ne)?"Map Series":/cascade/.test(Ne)?"Cascade":/shortlist/.test(Ne)?"Shortlist":/crowdsource/.test(Ne)?"Crowdsource":/basic/.test(Ne)?"Basic":null;Z&&(q=Z)}const ie=q||"",ae=Q||"",Re=ie&&ae?`Convert classic ${ie}: "${ae}"`:"Convert";T||k(Re)}catch{T||k("Convert")}})(),()=>{T=!0}},[f,a]);const[E,J]=z.useState(yt());z.useEffect(()=>{const T=D=>J(D);return cs(T),J(yt()),()=>ls(T)},[]);const M=()=>{if(c.current)throw new Error("Conversion cancelled by user intervention")},[I,W]=z.useState(!1),G=z.useCallback(()=>{if(c.current)return;window.confirm("Cancel conversion in progress? This will stop further processing.")&&(c.current=!0,W(!0),S(!1))},[]),[$,V]=z.useState(null),[P,we]=z.useState(null),[L,R]=z.useState([]),O="https://www.arcgis.com",[_,B]=z.useState(O),de=z.useRef(null),pe=z.useRef(!1),[je,te]=z.useState(!1),[Y,ye]=z.useState({}),se=z.useCallback(()=>{const T=typeof p=="object"&&p?p:{},D=T.orgUrl||T.org?.url||"";try{if(typeof D=="string"&&D.length){const Q=new URL(D).hostname,q=/^(.*)\.maps\.arcgis\.com$/i.exec(Q);return q&&q[1]?`${q[1]}.maps.arcgis.com`:Q}}catch{}return"www.arcgis.com"},[p]),Se=z.useCallback((T,D)=>{const X=se(),Q=D&&D!==O?D:`https://${X}`;return T.map(q=>{const ie=q.itemId,ae=q.message||"";if(/version\s*([0-9]+(?:\.[0-9]+)?)\s*<\s*2\.0/i.test(ae)){const me=`ERROR: Item [${ie}] Unsupported web map version: You must update the web map to the latest version. You can do this by opening the map in <a href="${Q}/home/webmap/viewer.html?webmap=${ie}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a> and save it. No other changes are necessary to resolve this error.`;return{...q,level:"error",message:me}}if(/HTTP URL|http:\/\//i.test(ae)){const me=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${Q}/home/item.html?id=${ie}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,Me=`WARNING: Webmap [${ie}] uses http services.`;return{...q,message:`${Me}
${me}`}}const Re=/Map Viewer Classic\s*<\s*link\s*=\s*(https?:[^\s>]+)\s*>/i.exec(ae);if(Re){const me=Re[1],Me=ae.replace(Re[0],`<a href="${me}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a>`);return{...q,message:Me}}if(/https:\/\/<org_url>\.arcgis\.com/i.test(ae)){const me=ae.replace(/https:\/\/<org_url>\.arcgis\.com/gi,Q);return{...q,message:me}}if(/https:\/\/www\.arcgis\.com/i.test(ae)&&Q&&Q!==O){const me=ae.replace(/https:\/\/www\.arcgis\.com/gi,Q);return{...q,message:me}}return q})},[se]),ue=T=>{if(!T)return"";const D=se();return/^[a-f0-9]{32}$/i.test(T)?`https://${D}/home/item.html?id=${T}`:""},Te=z.useMemo(()=>Ks(ni),[]);z.useEffect(()=>{if(!a){B(O),de.current=null,pe.current=!1;return}de.current&&de.current!==a&&(B(O),pe.current=!1),de.current=a},[a]),z.useEffect(()=>{try{const D=`https://${se()}`;a&&D&&_!==D&&B(D)}catch{}},[a,p,_,se]),z.useEffect(()=>{!a||pe.current||(async()=>{try{const T=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(a)}`);if(!T.ok)return;const D=await T.json(),X=D?.urlKey,Q=D?.customBaseUrl;let q="";if(X&&Q)q=`https://${X}.${Q}`;else if(D?.portalHostname){const ie=D.portalHostname;q=/^https?:/i.test(ie)?ie:`https://${ie}`}q&&_!==q&&B(q)}catch{}finally{pe.current=!0}})()},[a,_]),z.useEffect(()=>{L.length&&_&&_!==O&&R(T=>T.map(D=>({...D,message:(D.message||"").replace(/https:\/\/www\.arcgis\.com/gi,_)})))},[_,L.length]);const oe=T=>/^[a-f0-9]{32}$/i.test(T.trim()),ge=z.useCallback(async()=>{if(_&&_!==O)return _;const T=se();let D=`https://${T}`;if(a&&/www\.arcgis\.com$/i.test(T))try{const X=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(a)}`);if(X.ok){const Q=await X.json(),q=Q?.urlKey,ie=Q?.customBaseUrl;if(q&&ie)D=`https://${q}.${ie}`;else if(Q?.portalHostname){const ae=Q.portalHostname;D=/^https?:/i.test(ae)?ae:`https://${ae}`}}}catch{}return D&&D!==_&&B(D),D},[_,a,se]),be=z.useCallback(()=>{t(!1),l("idle"),x(""),j(""),k("Convert"),c.current=!1,W(!1),R([]),te(!1),ye({}),V(null),P?.url&&URL.revokeObjectURL(P.url),we(null)},[P]),ce=async()=>{if(l("idle"),x(""),j(""),k("Convert"),c.current=!1,W(!1),R([]),te(!1),ye({}),P?.url&&URL.revokeObjectURL(P.url),we(null),!oe(f)){l("error"),x("Incorrect Classic Story Map item id format - please enter a 32 character hex string");return}if(!a){l("error"),x("You must be signed in to ArcGIS Online or ArcGIS Enterprise");return}try{l("fetching"),x("Getting user information...");const T=p?.username||"";x("Fetching classic story data...");const D=await tt(f,a);M();let X=null;try{X=Be(D)}catch{X=null}if(!X||X.toLowerCase()==="unknown")try{const F=await _e(f,a),U=Array.isArray(F?.typeKeywords)?F.typeKeywords:[],K=[String(F?.type||"").toLowerCase(),...U.map(ee=>String(ee).toLowerCase())].join(" "),ne=/journal/.test(K)?"Map Journal":/swipe/.test(K)?"Swipe":/tour/.test(K)?"Map Tour":/series/.test(K)?"Map Series":/cascade/.test(K)?"Cascade":/shortlist/.test(K)?"Shortlist":/crowdsource/.test(K)?"Crowdsource":/basic/.test(K)?"Basic":null;ne&&(X=ne)}catch{}V(X),X&&x(`Detected template: ${X}. Preparing resources...`);try{const F=await _e(f,a),U=String(F?.type||"").trim(),H=(X||"").toLowerCase();if(!H||H==="unknown"){l("error"),x(`Error: The item id you entered is not for a Classic Esri Story Map. It is a ${U||"non-classic ArcGIS item"}`);return}if(!ss(X)){const K=X||"unknown";l("error"),x(`Error: The item id you entered is not yet available for conversion. It is a ${K}`);return}}catch{}if(D.values?.webmap){x("Fetching classic webmap data...");const F=D.values?.webmap;D.webmapJson=await tt(F,a),M()}x("Creating new StoryMap draft...");const Q=D.values?.title||"Untitled Story",q=`(Converted) ${Q}`,ie=await Ps(T,a,q);M(),x("Converting theme...");const ae=[];D.values?.webmap&&ae.push(D.values.webmap);try{const F=Array.isArray(D.values?.webmaps)?D.values.webmaps:[];for(const U of F)if(typeof U=="string")ae.push(U);else{const H=U;H&&typeof H.id=="string"&&ae.push(H.id)}}catch{}const Re=X||$||"webmap";l("fetching"),k(`Fetching ${Re}...`);try{const F=D.values?.story?.sections||D.sections||[];for(const U of F){U?.media?.webmap?.id&&ae.push(U.media.webmap.id);const H=U?.media?.webpage?.url||"",re=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(String(H))?.[1];if(re)try{const ee=`https://www.arcgis.com/sharing/rest/content/items/${re}/data?f=json`,xe=a?`${ee}&token=${encodeURIComponent(a)}`:ee,fe=await fetch(xe);if(fe.ok){const Ie=await fe.json(),Le=Array.isArray(Ie?.values?.webmaps)?Ie.values.webmaps:[];for(const Ce of Le)if(typeof Ce=="string")ae.push(Ce);else{const Ae=Ce;Ae&&typeof Ae.id=="string"&&ae.push(Ae.id)}try{const Ce=String(re),Ae=D;Ae.__embeddedSwipes||(Ae.__embeddedSwipes={}),Ae.__embeddedSwipes[Ce]=Ie}catch{}}}catch{}const ne=Array.isArray(U?.contentActions)?U.contentActions:[];for(const ee of ne)if(ee&&ee.type==="media"&&ee.media&&ee.media.webpage&&ee.media.webpage.url){const xe=String(ee.media.webpage.url||""),Ie=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(xe)?.[1];if(Ie)try{const Le=`https://www.arcgis.com/sharing/rest/content/items/${Ie}/data?f=json`,Ce=a?`${Le}&token=${encodeURIComponent(a)}`:Le,Ae=await fetch(Ce);if(Ae.ok){const We=await Ae.json(),Ge=Array.isArray(We?.values?.webmaps)?We.values.webmaps:[];for(const Ue of Ge)if(typeof Ue=="string")ae.push(Ue);else{const Ee=Ue;Ee&&typeof Ee.id=="string"&&ae.push(Ee.id)}try{const Ue=String(Ie),Ee=D;Ee.__embeddedSwipes||(Ee.__embeddedSwipes={}),Ee.__embeddedSwipes[Ue]=We}catch{}}}catch{}}}}catch{}const me=new Set,Me=[];for(const F of ae){const U=String(F);me.has(U)||(me.add(U),Me.push(U))}let Ne=[];try{const F=await ge();if(Me.length>0)for(let U=0;U<Me.length;U++){if(c.current)throw new Error("Conversion cancelled by user intervention");const H=Me[U];x(`Fetching webmap ${H} ${U+1} of ${Me.length}...`);const{warnings:K}=await ds([H],a),re=K.map(ee=>({itemId:ee.itemId,level:ee.level,message:ee.message,details:ee&&typeof ee=="object"&&"details"in ee?ee.details:void 0})),ne=Se(re,F);ne.length&&(Ne=[...Ne,...ne],R([...Ne]))}te(!0)}catch{}const Je=!1;!c.current&&Ne.length,Ne.length>0&&te(!0),l("converting");const Z=X||$||"story";k(`Converting ${Z}: ${Q}...`),x(`Converting ${Z} story to new format...`);let le;const Ve=F=>{const U=/\(\s*\d+\s*\/\s*\d+\s*\)\s*$/.test(F.message),H=typeof F.total=="number"&&typeof F.current=="number"&&!U?`${F.message} (${F.current}/${F.total})`:F.message;switch(F.stage){case"media":l("transferring"),x(H);break;case"convert":l("converting"),x(H);break;case"finalize":l("updating"),x(H);break;case"error":l("error"),x(H);break;case"done":l("success"),x(H);break;default:x(H)}},Pe=($||X||"").toLowerCase();if(Pe==="map journal"||Pe==="mapjournal")le=new at({classicJson:D,themeId:"summit",progress:Ve,token:a}).convert().storymapJson;else if(Pe==="map tour"||Pe==="tour")le=Ze.convert({classicJson:D,themeId:"summit",progress:Ve}).storymapJson;else if(Pe==="swipe")le=(await new ve({classicJson:D,themeId:"summit",progress:Ve,token:a}).convert()).storymapJson;else throw new Error(`Unsupported template for new converters: ${$??"unknown"}`);M();try{const U=le.nodes||{},H=Object.entries(U).find(([,K])=>K&&K.type==="storycover");if(H){const[K,re]=H,ne=(re.data?.title||"").trim();if((!ne||/^(swipe|spyglass)$/i.test(ne))&&f)try{const xe=await _e(f,a),fe=String(xe?.title||"").trim();fe&&(re.data={...re.data||{},title:fe},U[K]=re,le.nodes=U,console.debug("[CoverTitle][UI] Replaced generic cover title with AGO item title:",fe))}catch{}}}catch{}try{l("transferring"),x("Transferring images to story resources...");const F=Gs(le);if(F.length){const U=async(K,re,ne,ee)=>{const xe=K;let fe=K;try{if(!(/^https?:\/\//i.test(K)||K.startsWith("//"))){const Ce=K.replace(/^\.\/?/,""),We=!/^resources\//i.test(Ce)?`resources/${Ce}`:Ce,Ge=(f||"").trim();Ge&&(fe=`https://www.arcgis.com/sharing/rest/content/items/${Ge}/${We}`)}}catch{fe=K}const Ie=await Vs(fe,re,ne,ee);return{originalUrl:xe,resourceName:Ie.resourceName,transferred:Ie.isTransferred}},H=await $s.transferBatch({urls:F,storyId:ie,username:T,token:a,progress:Ve,uploader:U});le=Es.apply(le,H)}}catch(F){console.warn("[Converter] Image transfer step failed or skipped:",F)}try{const F=le,U=F.resources&&Object.values(F.resources).find(xe=>xe.type==="converter-metadata"),H=U?.data?.classicMetadata?.mappingDecisions?.customCss?.combined;if(H){const xe=new Blob([H],{type:"text/css"}),fe=URL.createObjectURL(xe);let Ie="custom-css.css";try{const Ce=((F.nodes&&Object.values(F.nodes).find(Ae=>Ae&&Ae.type==="storycover"))?.data?.title||"").trim();if(Ce){const Ae=Ce.toLowerCase().replace(/[^a-z0-9\s-_]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");Ae&&(Ie=`${Ae}-custom.css`)}}catch{}we({css:H,url:fe,fileName:Ie})}const K=U?.data?.classicMetadata?.webmapVersionWarnings,re=U?.data?.classicMetadata?.webmapProtocolWarnings,ne=[],ee=_;if(Array.isArray(K)&&ne.push(...K),Array.isArray(re)&&ne.push(...re),ne.length){const xe=ne.map(fe=>({itemId:fe.itemId,message:fe.message.replace(/https:\/\/<org_url>\.arcgis\.com/gi,ee)}));R(fe=>{const Ie=[...fe];for(const Le of xe)Ie.some(Ce=>Ce.itemId===Le.itemId&&Ce.message===Le.message)||Ie.push({itemId:Le.itemId,level:"warning",message:Le.message});return Ie})}}catch{}try{const F=le,U=F.resources||(F.resources={}),H=(f||"").trim(),K=($||"").trim();let re=Object.entries(U).find(([,fe])=>fe&&fe.type==="converter-metadata");if(!re){const fe=`r-${Date.now()}`;U[fe]={type:"converter-metadata",data:{}},re=[fe,U[fe]]}const[ne,ee]=re,xe=ee.data||(ee.data={});H&&(xe.classicItemId=H),K&&(xe.classicType=K),delete U[ne],U[ne]=ee,F.resources=U}catch{}try{if(!A&&Array.isArray(L)&&L.length){const F=le,U=F.resources||{},H=Object.entries(U).find(([,K])=>K&&K.type==="converter-metadata");if(H){const[K,re]=H,ne=re.data||{},ee=ne.classicMetadata||{};ee.webmapChecks=L.map(xe=>({itemId:xe.itemId,level:xe.level,message:xe.message})),ne.classicMetadata=ee,re.data=ne,U[K]=re,F.resources=U}else{const K=`r-converter-metadata-${Date.now()}`,re={type:"converter-metadata",data:{classicMetadata:{webmapChecks:L.map(ne=>({itemId:ne.itemId,level:ne.level,message:ne.message}))}}};U[K]=re,F.resources=U}}}catch{}l("updating"),x("Fetching target storymap details...");const He=await _e(ie,a);M();let $e=Ds(He);if(!$e){$e="draft.json";try{const F=Array.isArray(He.typeKeywords)?He.typeKeywords:[],U=F.some(H=>/^smdraftresourceid:/.test(String(H)))?F:[...F,`smdraftresourceid:${$e}`];await It(ie,T,U,a)}catch{}}x(`Removing old draft resource (${$e})...`);try{await Fs(ie,T,$e,a)}catch{}M();try{if(!Te(le)){const U=Array.isArray(Te.errors)?Te.errors:[],H=U.length?String(U[0]?.message??JSON.stringify(U[0])):"Schema validation failed";throw new Error(`Draft JSON failed client-side schema validation: ${H}`)}}catch(F){throw F instanceof Error?F:new Error(String(F))}try{x("Validating draft JSON schema...");const F=await fetch("/.netlify/functions/validate-draft",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(le)});if(!F.ok){const U=await F.json().catch(()=>({})),H=Array.isArray(U?.errors)?U.errors:[],K=H.length?H[0]?.message||JSON.stringify(H[0]):`HTTP ${F.status}`;throw new Error(`Draft JSON failed schema validation: ${K}`)}}catch(F){throw F instanceof Error?F:new Error(String(F))}x(`Uploading new draft resource (${$e})...`);try{const U=le.nodes||{};for(const[,H]of Object.entries(U))if(H?.type==="action-button"&&H.dependents){for(const K of Object.keys(H.dependents))/^actionMedia_content_/.test(K)&&delete H.dependents[K];Object.keys(H.dependents).length===0&&delete H.dependents}}catch{}const Tt=new Blob([JSON.stringify(le)],{type:"application/json"});await Nt(ie,T,Tt,$e,a),M(),x("Updating keywords...");const ct=He.typeKeywords||[];if(!ct.includes("smconverter:online-app")){const F=[...ct,"smconverter:online-app"];await It(ie,T,F,a),M()}M(),l("success"),x("Classic "+Z+":  "+Q),j(`https://storymaps.arcgis.com/stories/${ie}/edit`),t(!0);try{const F=le,U=F.resources||{};for(const[H,K]of Object.entries(U))if(K?.type==="webmap"){const re=K.data||{},ne=re.initialState||{};for(const ee of["extent","center","viewpoint","mapLayers"])ne&&ee in ne&&!(ee in re)&&(re[ee]=ne[ee]);K.data=re,U[H]=K}F.resources=U,le=F,console.debug("[SaveGuard] Promoted initialState fields to resource data keys")}catch{}try{const F=await fetch("/.netlify/functions/save-converted",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({filename:"converted-app",storyId:ie,classicItemId:f,json:le})});if(F.ok){const U=await F.json();console.info("[LocalSave] Converted JSON saved:",U?.path||U?.fileName||"ok")}else console.warn("[LocalSave] Failed to save converted JSON locally:",F.status)}catch{console.warn("[LocalSave] Error saving converted JSON locally:",e?.message)}}catch(T){T instanceof Error&&T.message==="Conversion cancelled by user intervention"?(l("error"),x(T.message)):(l("error"),x(T instanceof Error?T.message:"An unknown error occurred")),T instanceof Error&&T.stack&&console.debug("[ConverterCatch]",T.stack),t(!1)}};return g.jsxs("div",{className:"converter-container",children:[g.jsx("h2",{children:"Classic Story Map Converter"}),g.jsxs("p",{children:["Convert Classic Esri Story Maps to ",g.jsx("a",{href:"https://storymaps.arcgis.com",target:"_blank",rel:"noopener noreferrer",children:"ArcGIS StoryMaps"})]}),g.jsxs("div",{className:"converter-instructions",children:[g.jsx("h3",{children:"Instructions:"}),g.jsxs("ol",{children:[g.jsx("li",{children:"Sign in to ArcGIS Online using the sign-in button above"}),g.jsx("li",{children:"Enter the Item ID of your Classic Story"}),g.jsx("li",{children:"Click Convert to transform your classic story into the new format"}),g.jsx("li",{children:"Click Finishing Publishing to open the converted story. Review and publish when ready"})]})]}),g.jsxs("div",{className:"converter-input-group",children:[g.jsx("label",{className:"converter-label",children:"Classic Story Item ID:"}),g.jsx("input",{type:"text",value:f,onChange:T=>h(T.target.value),placeholder:"e.g., 858c4126f0604d1a86dea06ffbdc23a3",className:"converter-input"})]}),g.jsx("div",{className:"converter-input-group",children:g.jsxs("label",{className:"converter-label",children:[g.jsx("input",{type:"checkbox",checked:!A,onChange:T=>N(!T.target.checked)})," ","Enable metadata output"," ",g.jsx("span",{role:"button","aria-label":"Metadata output info",title:"When enabled, adds a resource node to the output json recording the original classic story's parameters and other diagnostics",onClick:()=>alert("When enabled, adds a resource node to the output json recording the original classic story's parameters and other diagnostics"),className:"metadata-info-icon",children:g.jsx("span",{className:"metadata-info-fallback",children:"ℹ️"})})]})}),E>0&&g.jsx("div",{className:"converter-controls-row",children:g.jsx("button",{className:"converter-btn secondary",onClick:()=>{as(),be(),o("Cache cleared"),setTimeout(()=>o(""),2e3)},title:"Clear in-memory fetch cache",children:"Clear cached webmap/story data"})}),w!=="success"?g.jsx("button",{className:`converter-btn ${m&&["fetching","converting","transferring","updating"].includes(w)?"cancel-hover":""}`,title:w==="idle"||w==="error"?"Start conversion":m?"Cancel conversion (Esc)":"Conversion in progress",onClick:w==="idle"||w==="error"?ce:G,onMouseEnter:()=>{!C&&["fetching","converting","transferring","updating"].includes(w)&&S(!0)},onMouseLeave:()=>S(!1),disabled:v,children:w==="idle"||w==="error"?b||"Convert":m&&["fetching","converting","transferring","updating"].includes(w)?"Cancel":b||"Convert"}):g.jsxs("div",{className:"converter-message converter-message-success",children:[g.jsx("button",{className:"converter-btn secondary",onClick:()=>{y&&window.open(y,"_blank")},title:"Open in ArcGIS StoryMaps to finish publishing",children:"Click to Finish Publishing →"}),y&&g.jsxs("div",{className:"converter-help-text publishing-url-block",children:[g.jsx("strong",{children:"Publishing URL:"})," ",g.jsx("a",{href:y,target:"_blank",rel:"noopener noreferrer",children:y})]})]}),C&&w!=="idle"&&w!=="error"&&w!=="success"&&!c.current&&!I&&g.jsx("div",{className:"cancel-mobile-wrapper",children:g.jsx("button",{className:"converter-btn cancel-mobile",onClick:G,title:"Cancel conversion",children:"Cancel"})}),w!=="success"&&u&&g.jsxs("div",{className:`converter-message converter-message-${w}`,children:[g.jsx("strong",{children:w==="error"?"Error:":"Status:"})," ",u]}),!!r&&g.jsx("div",{className:"converter-toast",role:"status","aria-live":"polite",children:r}),P&&g.jsxs("div",{className:"converter-warning",children:[g.jsx("strong",{children:"Custom CSS Detected!"})," Your classic story used custom CSS settings. To recreate your custom styles you should create a new ArcGIS StoryMaps Theme ",g.jsx("a",{href:"https://storymaps.arcgis.com/themes/new",target:"_blank",rel:"noopener noreferrer",children:"here"})," with your custom colors and styles, then apply the new Theme within the ArcGIS StoryMaps Builder (under the Design tab). ",g.jsx("a",{href:P.url,download:P.fileName||"custom-css.css",children:"Click this link"})," to download a copy of your custom CSS."]}),(L.length>0||je)&&g.jsxs("div",{className:"converter-warning",children:[g.jsx("strong",{children:"Webmap Checks:"}),L.length===0?g.jsx("div",{children:"No issues detected for referenced webmaps."}):g.jsxs(g.Fragment,{children:[g.jsx("ul",{children:L.map((T,D)=>{const X=Array.isArray(T.details?.failures)?T.details.failures:[],Q=new Map;for(const Z of X){const le=`${Z.url??""}::${Z.layerTitle??""}`;Q.has(le)||Q.set(le,{layerTitle:Z.layerTitle,layerItemId:Z.layerItemId,url:Z.url,status:typeof Z.status=="number"?Z.status:void 0,error:typeof Z.error=="string"?Z.error:void 0})}const q=Array.from(Q.values()),ie=q.some(Z=>/HTTP URL/i.test(String(Z.error||""))||/^http:\/\//i.test(String(Z.url||""))),ae=q.some(Z=>/timeout/i.test(String(Z.error||""))||typeof Z.status=="number"&&Z.status===504),Re=q.some(Z=>/not\s*found|404/i.test(String(Z.error||""))||typeof Z.status=="number"&&Z.status===404);let me=_;if(!me||me===O){const Z=typeof p=="object"&&p&&(p.orgUrl||p.org?.url)||"";if(Z)try{const le=new URL(Z);me=`${le.protocol}//${le.hostname}`}catch{me=`https://${se()}`}else me=`https://${se()}`}const Me=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${me}/home/item.html?id=${T.itemId}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,Ne=`Some services did not respond (timeout). This may be temporary. Try opening the <a href="${me}/home/item.html?id=${T.itemId}" target="_blank" rel="noopener noreferrer">web map</a> and checking that the layers load, or reload later. If timeouts persist, consider replacing the layer or contacting the service owner.`,Je=`Some services returned 404 (Not Found). Open the <a href="${me}/home/item.html?id=${T.itemId}" target="_blank" rel="noopener noreferrer">web map</a> to remove broken layers, or replace with an available service.`;return g.jsxs("li",{children:[ie?g.jsxs(g.Fragment,{children:[`WARNING: Webmap [${T.itemId}] uses http services.`,T.details?.webmapTitle&&g.jsxs("div",{children:["Title: ",T.details.webmapTitle]}),g.jsx("div",{dangerouslySetInnerHTML:{__html:Me}})]}):ae?g.jsxs(g.Fragment,{children:[`WARNING: Webmap [${T.itemId}] has timeout failures.`,T.details?.webmapTitle&&g.jsxs("div",{children:["Title: ",T.details.webmapTitle]}),g.jsx("div",{dangerouslySetInnerHTML:{__html:Ne}})]}):Re?g.jsxs(g.Fragment,{children:[`WARNING: Webmap [${T.itemId}] has missing layer(s).`,T.details?.webmapTitle&&g.jsxs("div",{children:["Title: ",T.details.webmapTitle]}),g.jsx("div",{dangerouslySetInnerHTML:{__html:Je}})]}):/^\s*(ERROR|WARNING|INFO):/i.test(T.message)?g.jsx("span",{dangerouslySetInnerHTML:{__html:T.message}}):g.jsxs(g.Fragment,{children:[T.level.toUpperCase(),": [",T.itemId,"] ",g.jsx("span",{dangerouslySetInnerHTML:{__html:T.message}})]}),q.length>0&&g.jsx("div",{children:`WARNING: Webmap [${T.itemId}] has ${q.length} failing layer(s).`}),T.details?.webmapTitle&&g.jsxs("div",{children:["Title: ",T.details.webmapTitle]}),q.length>0&&g.jsxs("div",{children:[g.jsx("button",{className:"converter-details-toggle-btn",onClick:()=>ye(Z=>({...Z,[T.itemId]:!Z[T.itemId]})),children:Y[T.itemId]?"Hide details":`Show details (${q.length})`}),Y[T.itemId]&&g.jsx("ul",{children:q.map((Z,le)=>g.jsxs("li",{children:[Z.layerTitle?`Layer name: ${Z.layerTitle}`:"",Z.layerItemId?g.jsxs(g.Fragment,{children:[" ","[",g.jsx("a",{href:ue(Z.layerItemId),target:"_blank",rel:"noopener noreferrer",children:Z.layerItemId}),"]"," "]}):"",Z.error?` — Error: ${Z.error}`:"",typeof Z.status=="number"?` (status ${Z.status})`:"",Z.url?g.jsxs(g.Fragment,{children:[" ","— ",g.jsx("a",{href:Z.url,target:"_blank",rel:"noopener noreferrer",children:"Link to endpoint"})," "]}):""]},`${T.itemId}-fail-${le}`))})]})]},`${T.itemId}-${D}`)})}),g.jsxs("span",{children:["These issues won’t stop conversion, but may prevent maps from loading. Please fix with ",g.jsx("a",{href:"https://assistant.esri-ps.com/",children:"ArcGIS Assistant"})," or in ArcGIS Online."]})]})]}),!1]})}function oi(){const{token:v,userInfo:t}=ze(),[s,i]=z.useState({status:"idle"}),n=z.useMemo(()=>new URLSearchParams(window.location.search),[]),d=z.useMemo(()=>{try{const a=localStorage.getItem("pendingSaveCsvLayerParams");return a?JSON.parse(a):{}}catch{return{}}},[]),c=n.get("webmapId")??d.webmapId??"",m=n.get("csvItemId")??d.csvItemId??"";function S(a){if(!a)return null;const p=String(a.type||"").toLowerCase();if(["heatmap","simple","unique-value","class-breaks","dot-density","dictionary","pie-chart"].includes(p))return a;const h=a.symbol||a;String(h.type||h.style||"").toLowerCase();function w(u){if(!u)return null;const x=String(u.type||u.style||"").toLowerCase(),r={...u},o=y=>!y||Array.isArray(y)||typeof y=="string"?y:typeof y=="object"&&"r"in y&&"g"in y&&"b"in y?[y.r,y.g,y.b,"a"in y?y.a:255]:y;if(r.color&&(r.color=o(r.color)),r.outline&&(r.outline={...r.outline},r.outline.color&&(r.outline.color=o(r.outline.color))),x==="esripms"||x==="picturemarkersymbol"){r.type="picture-marker",!r.url&&r.imageData&&(r.url=`data:image/png;base64,${r.imageData}`),!r.width&&r.size&&(r.width=r.size),!r.height&&r.size&&(r.height=r.size);const y=["type","url","width","height","angle","xoffset","yoffset"];Object.keys(r).forEach(j=>{y.includes(j)||delete r[j]}),delete r.imageData}else if(x==="esrisms"||x==="simplemarkersymbol"){r.type="simple-marker";const y=["type","style","color","size","outline","angle","xoffset","yoffset"];Object.keys(r).forEach(j=>{y.includes(j)||delete r[j]})}else if(x==="esrisls"||x==="simplelinesymbol"){r.type="simple-line";const y=["type","style","color","width"];Object.keys(r).forEach(j=>{y.includes(j)||delete r[j]})}else if(x==="esrisfs"||x==="simplefillsymbol"){r.type="simple-fill";const y=["type","style","color","outline"];Object.keys(r).forEach(j=>{y.includes(j)||delete r[j]})}else return{type:"simple-marker",color:o(r.color)||"red",size:typeof r.size=="number"?r.size:12,outline:r.outline?{color:o(r.outline.color)||"white",width:1}:void 0};return r}const l=w(h);return l?{type:"simple",symbol:l}:a.visualVariables?{type:"simple",visualVariables:a.visualVariables}:null}function C(a,p=[]){if(!a)return null;const f=p.map(A=>A.name),h=A=>f.includes(A),w=h("TITLE")?"TITLE":h("Title")?"Title":"TITLE",l=h("DESCRIPTION")?"DESCRIPTION":h("Description")?"Description":"DESCRIPTION",u=h("IMAGE_URL")?"IMAGE_URL":h("Image_URL")?"Image_URL":"IMAGE_URL",x=h("IMAGE_LINK_URL")?"IMAGE_LINK_URL":h("Image_Link_URL")?"Image_Link_URL":"IMAGE_LINK_URL",r=a.title||`{${w}}`,o=a.description||`{${l}}`,y=Array.isArray(a.mediaInfos)?a.mediaInfos:[],j=[];return o&&j.push({type:"text",text:o}),y.forEach(A=>{if(String(A?.type).toLowerCase()==="image"&&A?.value){const N=A.value;j.push({type:"media",mediaInfos:[{type:"image",value:{sourceURL:N.sourceURL||`{${u}}`,linkURL:N.linkURL||`{${x}}`}}]})}}),{title:r,content:j}}return z.useEffect(()=>{async function a(){if(!(!v||!t)){if(!c||!m){i({status:"error",message:"Missing webmapId or csvItemId in query params."});return}try{i({status:"running",step:"Registering token"}),Wt.portalUrl="https://www.arcgis.com",Pt.registerToken({server:"https://www.arcgis.com/sharing/rest",token:v,expires:Date.now()+3600*1e3,ssl:!0,userId:t.username}),i({status:"running",step:"Loading webmap"});const p=new Bt({portalItem:{id:c}});await p.load(),await p.when(),i({status:"running",step:"Creating CSVLayer"});const f=new Ot({portalItem:{id:m}});f.visible=!0,f.title=f.title??"Converted Map Notes",f.outFields=["*"],f.url=`https://www.arcgis.com/sharing/rest/content/items/${m}/data`,await f.load(),await f.when(),i({status:"running",step:"Copying renderer/popup from Map Notes"});try{const o=`https://www.arcgis.com/sharing/rest/content/items/${c}/data?f=json&token=${encodeURIComponent(v)}`,y=await fetch(o);if(y.ok){const N=((await y.json())?.operationalLayers||[]).find(J=>String(J?.layerType||J?.type||"").toLowerCase()==="mapnotes"||String(J?.title||"").toLowerCase().includes("map notes")),k=(N?.layerDefinition||N?.featureCollection?.layers?.[0]?.layerDefinition)?.drawingInfo||N?.drawingInfo,E=N?.popupInfo;if(k?.renderer){const J=S(k.renderer);J&&(f.renderer=J)}if(E){const J=C(E,f.fields||[]);J&&(f.popupEnabled=!0,f.popupTemplate=J)}}}catch{}const w=(f.fields??[]).map(o=>o.name.toLowerCase()),l=o=>o.find(y=>w.includes(y)),u=l(["x","longitude","lon","long"]),x=l(["y","latitude","lat"]);u&&x?(f.longitudeField=u,f.latitudeField=x):(f.longitudeField=f.longitudeField??"X",f.latitudeField=f.latitudeField??"Y"),i({status:"running",step:"Adding layer to webmap"}),p.add(f),i({status:"running",step:"Saving webmap"});const r=await p.save({ignoreUnsupported:!0});if(r&&r.success){try{await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:v,webmapId:c,csvItemId:m,title:f.title||"Converted Map Notes",visible:!0,opacity:1,lonField:f.longitudeField||"x",latField:f.latitudeField||"y"})})}catch{}const o=`https://www.arcgis.com/sharing/rest/content/items/${c}/data?f=json&token=${encodeURIComponent(v)}`;let y=[],j={renderer:f.renderer,popupTemplate:f.popupTemplate,layerTitle:f.title};try{const A=p.layers.find(N=>N.portalItem?.id===m||N.title===f.title);A&&(j={renderer:A.renderer,popupTemplate:A.popupTemplate,layerTitle:A.title})}catch{}try{const A=await fetch(o);if(A.ok){const b=(await A.json())?.operationalLayers||[];y=b.map(I=>I?.title).filter(Boolean);const k=b.find(I=>String(I?.layerType||I?.type).toLowerCase()==="csv"&&(I?.itemId===m||String(I?.title||"")===String(f.title||"Converted Map Notes"))),J=k?.layerDefinition?.drawingInfo||k?.drawingInfo,M=k?.popupInfo;(J?.renderer||M)&&(j={renderer:J?.renderer,popupTemplate:M,layerTitle:k?.title||j.layerTitle}),j.allOperationalLayers=b,j.csvOperationalLayer=k}}catch{}i({status:"success",webmapId:c,verification:{titles:y},layerSummary:j})}else throw new Error("Save did not return success.")}catch(p){try{i({status:"running",step:"Fallback: REST update"});const f=await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:v,webmapId:c,csvItemId:m,title:"Converted Map Notes",visible:!0,opacity:1,lonField:"x",latField:"y"})});let h=null,w=null;try{h=await f.json()}catch{try{w=await f.text()}catch{}}if(f.ok&&h?.success){const l=`https://www.arcgis.com/sharing/rest/content/items/${c}/data?f=json&token=${encodeURIComponent(v)}`;let u=[];try{const r=await fetch(l);r.ok&&(u=((await r.json())?.operationalLayers||[]).map(y=>y?.title).filter(Boolean))}catch{}let x={};try{const r=webmap.layers?.find(o=>o.portalItem?.id===m);r&&(x={renderer:r.renderer,popupTemplate:r.popupTemplate,layerTitle:r.title})}catch{}i({status:"success",webmapId:c,verification:{titles:u},layerSummary:x})}else throw new Error(h?.message||w||"Fallback update failed")}catch(f){const h=p?.details??{},w=h.errors?JSON.stringify(h.errors):"";i({status:"error",message:`Save failed: ${p?.message??String(p)}${w?` — ${w}`:""}. Fallback failed: ${f?.message??String(f)}`,details:h})}}}}a()},[v,t,c,m]),z.useEffect(()=>{const a=n.get("webmapId"),p=n.get("csvItemId");(a||p)&&localStorage.setItem("pendingSaveCsvLayerParams",JSON.stringify({webmapId:a,csvItemId:p}))},[n]),g.jsxs("div",{className:"page",children:[g.jsx("h2",{children:"Save CSV Layer to WebMap"}),g.jsxs("p",{children:["WebMap ID: ",g.jsx("code",{children:c||"(missing)"})]}),g.jsxs("p",{children:["CSV Item ID: ",g.jsx("code",{children:m||"(missing)"})]}),s.status==="idle"&&g.jsx("p",{children:"Waiting for authentication…"}),s.status==="running"&&g.jsxs("p",{children:["Working: ",s.step]}),s.status==="success"&&g.jsxs("p",{children:["Success! Layer added and saved to WebMap ",g.jsx("code",{children:s.webmapId}),"."]}),s.status==="success"&&s.verification&&g.jsxs("div",{children:[g.jsx("p",{children:"Operational layer titles:"}),g.jsx("ul",{children:s.verification.titles.map((a,p)=>g.jsx("li",{children:g.jsx("code",{children:a})},p))})]}),s.status==="success"&&s.layerSummary&&g.jsxs("div",{children:[g.jsx("p",{children:"CSV layer summary:"}),g.jsxs("p",{children:["Layer title: ",g.jsx("code",{children:s.layerSummary.layerTitle||"(unknown)"})]}),g.jsxs("details",{children:[g.jsx("summary",{children:"Renderer"}),g.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.renderer,null,2)})]}),g.jsxs("details",{children:[g.jsx("summary",{children:"Popup Template"}),g.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.popupTemplate,null,2)})]}),g.jsxs("details",{children:[g.jsx("summary",{children:"Raw CSV operationalLayer"}),g.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.csvOperationalLayer,null,2)})]}),g.jsxs("details",{children:[g.jsx("summary",{children:"All operationalLayers"}),g.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.allOperationalLayers,null,2)})]})]}),s.status==="error"&&g.jsxs("div",{children:[g.jsxs("p",{className:"error",children:["Error: ",s.message]}),s.details&&g.jsx("pre",{className:"error-details",children:JSON.stringify(s.details,null,2)})]})]})}function ai(){const{userInfo:v,token:t}=ze(),s=new URLSearchParams(window.location.search),i=s.get("action"),n=s.get("dev")==="true";return g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"bg-image"}),g.jsxs("div",{className:"app-content",children:[g.jsx(Gt,{}),n||t&&v?i==="save-csv-layer"?g.jsx(oi,{}):g.jsx(ri,{}):g.jsx(os,{})]})]})}Ft(window);Dt.createRoot(document.getElementById("root")).render(g.jsx(z.StrictMode,{children:g.jsx(Vt,{children:g.jsx(ai,{})})}));
