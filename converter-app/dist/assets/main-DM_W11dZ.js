import{U as It,r as J,j as v,C as ls,a as Lt,b as $t,c as Rt,d as ds,e as ps,f as us,g as ms,h as Et,_ as Ot,A as hs,i as fs,k as ys}from"./vendor-BFhQbylz.js";import gs from"@arcgis/core/WebMap";import bs from"@arcgis/core/layers/CSVLayer";import vs from"@arcgis/core/identity/IdentityManager";import ws from"@arcgis/core/config";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const Dt="wJK4zhJHaHyFzyQ2",Ft="https://regal-sable-0a6dde.netlify.app/",yt="arcgis_session",Ct="arcgis_user_info";function xs(b){try{const e=b.serialize();sessionStorage.setItem(yt,e)}catch(e){console.warn("Could not serialize session:",e)}}function Ss(){const b=sessionStorage.getItem(yt);if(b)try{return It.deserialize(b)}catch{sessionStorage.removeItem(yt)}return null}function xt(b){try{sessionStorage.setItem(Ct,JSON.stringify(b))}catch(e){console.warn("Could not persist userInfo",e)}}function Is(){const b=sessionStorage.getItem(Ct);if(!b)return null;try{return JSON.parse(b)}catch{return sessionStorage.removeItem(Ct),null}}function Cs(){const b=window.location.hash.substring(1),e=new URLSearchParams(b),t=e.get("access_token")||e.get("token"),s=e.get("expires_in");return{token:t,expires:s?Date.now()+parseInt(s,10)*1e3:null}}async function Bt(b){const t=await(await fetch(`https://www.arcgis.com/sharing/rest/community/self?f=json&token=${b}`)).json();return{username:t.username,role:t.role,userLicenseTypeId:t.userLicenseTypeId}}const Xt=J.createContext({session:null,token:null,signIn:()=>{},signOut:()=>{},loading:!1,userInfo:null,setUserInfo:()=>{}}),As=({children:b})=>{const[e,t]=J.useState(Ss()),[s,i]=J.useState(!0),[o,a]=J.useState(Is()),[p]=J.useState(()=>new URLSearchParams(window.location.search).get("refactor")==="1");J.useEffect(()=>{const{token:n,expires:l}=Cs();if(!n){setTimeout(()=>i(!1),0);return}const u=new It({clientId:Dt,redirectUri:Ft,token:n,tokenExpires:l?new Date(l):new Date(Date.now()+1e3*60*60*24*14),portal:"https://www.arcgis.com/sharing/rest"});t(u),xs(u);try{if(window.location.hash&&/access_token=/.test(window.location.hash)){const f=window.location.pathname+window.location.search;window.history.replaceState({},"",f)}}catch{}Bt(n).then(f=>{const g=u.portal.replace(/\/$/,""),c=`${g}/community/users/${f.username}?f=json&token=${n}`,y=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${n}`;return Promise.all([fetch(c).then(x=>x.ok?x.json():Promise.reject(x.status)).catch(()=>null),fetch(y).then(x=>x.ok?x.json():Promise.reject(x.status)).catch(()=>null)]).then(([x,r])=>{const m=x?.thumbnail?`${g}/community/users/${f.username}/info/${x.thumbnail}?token=${n}`:void 0,d={username:f.username,role:f.role,userType:f.userLicenseTypeId,fullName:x?.fullName||f.username,thumbnailUrl:m};a(d),xt(d)}).catch(()=>{const x={username:f.username,role:f.role,userType:f.userLicenseTypeId};a(x),xt(x)})}).catch(()=>a(null))},[p]),J.useEffect(()=>{if(e&&!o&&!s){const n=e.token;Bt(n).then(l=>{const u=e.portal.replace(/\/$/,""),f=`${u}/community/users/${l.username}?f=json&token=${n}`,g=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${n}`;return Promise.all([fetch(f).then(c=>c.ok?c.json():Promise.reject(c.status)).catch(()=>null),fetch(g).then(c=>c.ok?c.json():Promise.reject(c.status)).catch(()=>null)]).then(([c,y])=>{const x=c?.thumbnail?`${u}/community/users/${l.username}/info/${c.thumbnail}?token=${n}`:void 0,r={username:l.username,role:l.role,userType:l.userLicenseTypeId,fullName:c?.fullName||l.username,thumbnailUrl:x};a(r),xt(r)})}).catch(()=>{})}},[e,o,s]),J.useEffect(()=>{e&&console.log("Session token (updated):",e.token)},[e]);const w=()=>{It.beginOAuth2({clientId:Dt,redirectUri:Ft,responseType:"token",popup:!1})},S=()=>{e&&(t(null),sessionStorage.removeItem(yt))};return v.jsx(Xt.Provider,{value:{session:e,token:e?.token??null,signIn:w,signOut:S,loading:s,userInfo:o,setUserInfo:a},children:b})},lt=()=>J.useContext(Xt),js="0.4.6",Ts={};let pt;function Xe(){return pt||(pt=(typeof globalThis<"u"&&globalThis.__ORG_BASE&&typeof globalThis.__ORG_BASE=="string"?globalThis.__ORG_BASE:void 0)||void 0||"https://www.arcgis.com",pt)}function ks(){const{userInfo:b,token:e,signIn:t,signOut:s}=lt(),[i,o]=J.useState(!1),a=J.useRef(null);J.useEffect(()=>{function u(g){i&&a.current&&!a.current.contains(g.target)&&o(!1)}function f(g){g.key==="Escape"&&o(!1)}return document.addEventListener("mousedown",u),document.addEventListener("keydown",f),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",f)}},[i]);const p=!!e&&!!b,w=b?.username?.charAt(0).toUpperCase()||"?",S=b?.username?`${Xe()}/home/user.html?user=${b.username}`:void 0,n=b?.thumbnailUrl||null,l=b?.fullName||b?.username||"";return v.jsx("header",{className:"top-nav",children:v.jsxs("div",{className:"top-nav-inner",children:[v.jsxs("div",{className:"top-nav-titles",children:[v.jsx("div",{className:"top-nav-title",children:"Classic StoryMap Converter"}),v.jsxs("div",{className:"top-nav-subtitle",children:["Alpha | v",js]})]}),v.jsx("nav",{className:"top-nav-list","aria-label":"Main navigation"}),v.jsxs("div",{className:"top-nav-actions",children:[!p&&v.jsx("button",{className:"account-btn",onClick:t,"data-testid":"sign-in-btn",children:"Sign In"}),p&&v.jsxs("div",{className:"account-control",ref:a,children:[v.jsxs("button",{type:"button",className:"account-trigger","aria-haspopup":"true","aria-label":"Account menu",onClick:()=>o(u=>!u),children:[v.jsx("svg",{className:"account-trigger-icon",width:"18",height:"18",viewBox:"0 0 24 24","aria-hidden":"true",children:v.jsx("path",{fill:"currentColor",d:"M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v2h20v-2c0-3.3-6.7-5-10-5z"})}),v.jsx("svg",{className:"account-caret",width:"12",height:"12",viewBox:"0 0 24 24","aria-hidden":"true",children:v.jsx("path",{fill:"currentColor",d:"M7 10l5 5 5-5z"})})]}),i&&v.jsxs("div",{className:"account-menu",role:"group","aria-label":"Account menu",children:[v.jsxs("div",{className:"account-menu-header",children:[n?v.jsx("img",{src:n,alt:"","aria-hidden":"true",className:"account-menu-avatar"}):v.jsx("span",{className:"account-menu-avatar fallback","aria-hidden":"true",children:w}),v.jsxs("div",{className:"account-menu-names",children:[v.jsx("div",{className:"account-full-name",children:l||b?.username||"Loadingâ€¦"}),v.jsx("div",{className:"account-username-sub",children:b?.username})]})]}),v.jsx("div",{className:"account-menu-divider"}),S&&v.jsx("a",{href:S,target:"_blank",rel:"noopener",className:"account-menu-item",children:"View Profile"}),v.jsx("button",{className:"account-menu-item",onClick:()=>{o(!1),s()},children:"Sign Out"})]})]})]})]})})}function Ns({open:b,onCancel:e,onContinue:t}){const[s,i]=J.useState(""),[o,a]=J.useState(""),[p,w]=J.useState(!1),S=J.useRef(null);J.useEffect(()=>{b&&setTimeout(()=>{w(!1),S.current?.focus()},0)},[b,w]);const n=u=>{if(!u)return!1;try{const f=new URL(u);return!!f.protocol&&!!f.host}catch{return!1}},l=()=>{const u=n(s);w(!u),u&&t(s.trim(),o.trim()||void 0)};return v.jsxs(ls,{open:b,heading:"Sign in to ArcGIS Enterprise",onCalciteDialogClose:e,children:[v.jsxs("div",{children:[v.jsxs(Lt,{children:["URL",v.jsx($t,{ref:S,required:!0,id:"enterprise_portal_url",name:"enterprise_portal_url",placeholder:"e.g. https://myportal.mydomain.com/portal",type:"text",value:s,onCalciteInputChange:u=>{const f=u?.target?.value??"";i(f)}}),v.jsx(Rt,{status:p?"invalid":void 0,children:"Enter a valid organization url"})]}),v.jsxs(ds,{layout:"inline",children:[v.jsx(ps,{slot:"tab-nav",children:v.jsx(us,{children:"OAuth Login"})}),v.jsx(ms,{style:{width:"100%",marginTop:"1rem"},children:v.jsxs(Lt,{children:["App ID",v.jsx($t,{id:"enterprise_client_id",name:"app_client_id",placeholder:"e.g. aBcDeFgHi1j2K3L4",type:"text",value:o,onCalciteInputChange:u=>{const f=u?.target?.value??"";a(f)}}),v.jsx(Rt,{status:"invalid",children:"Enter a valid registered App ID"})]})})]}),v.jsxs("details",{className:"enterprise-details",children:[v.jsx("summary",{children:"More Details"}),v.jsxs("p",{className:"enterprise-details-text",children:["In order to log in to a Portal for ArcGIS instance using a SAML-based Identity Provider, you will need to Register the Classic StoryMap Converter as an application in your Portal, and generate an AppID that can identify this app as an allowed client of the Portal. To do so, follow the instructions "," ",v.jsx("a",{href:"https://enterprise.arcgis.com/en/portal/latest/use/add-app-url.htm#REG_APP",target:"_blank",rel:"noopener",children:"here"}),", using ",v.jsx("strong",{children:"Other Application"})," as the ",v.jsx("em",{children:"Type of App"})," and",v.jsx("code",{className:"enterprise-details-code",children:"https://url-for-this-app.com/"}),"as the Redirect URI."]})]})]}),v.jsxs("div",{slot:"footer",children:[v.jsx(Et,{color:"blue",onClick:l,children:"Continue"}),v.jsx(Et,{appearance:"outline",color:"blue",onClick:e,children:"Cancel"})]})]})}const Ms="/assets/storymap-map-tour-CbGOcXZK.png",Ls="/assets/storymap-map-journal-B6_zTpqe.png",$s="/assets/storymap-series-tabbed-I93IZkLj.png",Rs="/assets/storymap-cascade-Dxb7EL3J.png",Es="/assets/storymap-shortlist-C-e80pOE.png",Os="/assets/storymap-crowdsource-CiU2l24Z.png",Ds={mapTour:!0,mapJournal:!0,mapSeries:!0,cascade:!0,shortlist:!1,crowdsource:!1,swipe:!0,basic:!1};function Fs(b){const e=(b||"").toLowerCase(),t=e==="map journal"||e==="mapjournal"?"mapJournal":e==="map tour"||e==="maptour"?"mapTour":e==="map series"||e==="series"?"mapSeries":e==="cascade"?"cascade":e==="shortlist"?"shortlist":e==="crowdsource"?"crowdsource":e==="swipe"?"swipe":e==="basic"?"basic":"";return!!(t&&Ds[t])}const Bs="/assets/storymap-swipe-DCnpLp2Y.png",Ps="/assets/storymap-basic-DyApzf39.png",_s=[{key:"mapTour",title:"Map Tour",description:"Presented a sequential, place-based narrative with geotagged photos linked to an interactive map.",image:Ms,status:"active",alt:"Map Tour Thumbnail"},{key:"mapJournal",title:"Map Journal",description:"Presented a compelling map-based narrative presented as a set of journal entries.",image:Ls,status:"active",alt:"Map Journal Thumbnail"},{key:"mapSeries",title:"Map Series",description:"Presented a series of maps via a set of tabs, bullets or expanding side panel.",image:$s,status:"active",alt:"Map Series - Tabbed Thumbnail"},{key:"cascade",title:"Cascade",description:"Combined text with maps, images, and multimedia in an engaging, full-screen scrolling experience.",image:Rs,status:"active",alt:"Cascade Thumbnail"},{key:"shortlist",title:"Shortlist",description:"Presented a set of places organized into a set of tabs based on themes.",image:Es,status:"disabled",alt:"Shortlist Thumbnail"},{key:"crowdsource",title:"Crowdsource",description:"Displayed crowdsourced photos with captions. The conversion will be view-only.",image:Os,status:"disabled",alt:"Crowdsource Thumbnail"},{key:"swipe",title:"Swipe",description:"Displayed two layers or two maps side by side for comparison.",image:Bs,status:"active",alt:"Swipe Thumbnail"},{key:"basic",title:"Basic",description:"Presented a map via a minimalist interface. Converted to an ArcGIS Instant App.",image:Ps,status:"disabled",alt:"Story Map Basic Thumbnail"}],Us=()=>{const{signIn:b}=lt(),[e,t]=J.useState(!1);return v.jsxs(v.Fragment,{children:[v.jsxs("div",{id:"splashContainer",className:"splash-container",children:[v.jsxs("div",{className:"jumbotron",children:[v.jsx("h2",{children:"Classic StoryMap Converter"}),v.jsx("p",{className:"lead",children:"Convert Classic Esri Story Maps to ArcGIS StoryMaps"}),v.jsx("div",{className:"loginButtons",children:v.jsxs("p",{children:[v.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-success login-btn",onClick:b,children:"Log in to ArcGIS Online"}),v.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-default",onClick:()=>t(!0),children:"Log in to Portal for ArcGIS"})]})})]}),v.jsx("div",{className:"row marketing marketing-row",children:_s.map(s=>{const i=s.status!=="active";return v.jsxs("div",{className:`marketing-col${i?" disabled":""}`,"data-disabled":i?"true":"false",children:[v.jsx("h4",{children:s.title}),v.jsxs("div",{className:"marketing-img-container",children:[v.jsx("img",{src:s.image,alt:s.alt,className:"marketing-img"}),i&&v.jsx("div",{className:"disabled-overlay",children:"Coming Soon"})]}),v.jsx("p",{children:s.description})]},s.key)})})]}),v.jsx(Ns,{open:e,onCancel:()=>t(!1),onContinue:(s,i)=>{t(!1),console.info("[EnterpriseSignInModal] continue",{url:s,appId:i})}})]})},nt=new Map,Tt=new Set;function Zt(){const b=nt.size;for(const e of Array.from(Tt))try{e(b)}catch{}}async function Ve(b,e,t){const s=Date.now(),i=nt.get(b);if(i){if(!i.expiresAt||i.expiresAt>s)return i.data;nt.delete(b)}const o=await fetch(b,e);if(!o.ok)throw new Error(`Fetch failed ${o.status}: ${b}`);const a=await o.json(),p=s+t;return nt.set(b,{data:a,expiresAt:p}),Zt(),a}function Ws(b){nt.clear(),Zt()}function Pt(){return nt.size}function Js(b){Tt.add(b)}function zs(b){Tt.delete(b)}async function _t(b){const e=await fetch(b);if(!e.ok)throw new Error(`Fetch failed: ${e.status} ${e.statusText}`);return e.json()}async function Vs(b,e){const t=[],s=[],i=Array.from(new Set(b.filter(a=>/^[a-f0-9]{32}$/i.test(a))));for(const a of i)try{const w=`${globalThis.__ORG_BASE||"https://www.arcgis.com"}/sharing/rest/content/items/${a}`,S=`${w}/data?f=json${e?`&token=${encodeURIComponent(e)}`:""}`,n=`${w}?f=json${e?`&token=${encodeURIComponent(e)}`:""}`,[l,u]=await Promise.all([_t(S).catch(()=>null),_t(n).catch(()=>null)]);if(!u){t.push({itemId:a,level:"error",message:"Webmap item not accessible (404 or permission). Please verify the item exists and you have access."});continue}const f=u?.title||u?.name||"",g=[],c=l&&(l.version||l.itemVersion)||u&&(u.itemVersion||u.version);if(c&&typeof c=="string"){const d=parseFloat(c);if(!Number.isNaN(d)&&d<2){const A=`${globalThis.__ORG_BASE||"https://www.arcgis.com"}/home/webmap/viewer.html?webmap=${a}`;t.push({itemId:a,level:"warning",message:`Webmap version ${c} < 2.0. Open in <a href="${A}" target="_blank" rel="noopener noreferrer">Classic Map Viewer</a> and save to upgrade.`})}}const y=l?.operationalLayers||[],x=l?.baseMap?.baseMapLayers||[],r=[];for(const d of y)d?.url&&r.push({url:d.url,title:d.title,layerItemId:d.itemId,layerTitle:d.title});for(const d of x)d?.url&&r.push({url:d.url,title:d.title});const m=d=>{try{const k=new URL(d),A=k.hostname.toLowerCase(),j=k.pathname.toLowerCase();if(A.endsWith("services.arcgisonline.com"))return/(mapserver|featureserver)/i.test(j)}catch{}return!1};for(const{url:d,title:k,layerItemId:A,layerTitle:j}of r){/^http:\/\//i.test(d)&&(g.push({url:d,error:"HTTP URL (use HTTPS)",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:d,ok:!1,errorCategory:"mixed-content",errorMessage:"HTTP URL (use HTTPS)"}),typeof window<"u"&&window.location?.protocol==="https:"&&(g.push({url:d,error:"Mixed content risk on HTTPS",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:d,ok:!1,errorCategory:"mixed-content",errorMessage:"Mixed content risk on HTTPS"})));const h=typeof window<"u"&&window.location?.hostname?/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname):!1,I=d.split("?")[0],F=`${I}${I.includes("?")?"":"?"}${I.includes("?")?"&":""}f=pjson`,L=/(FeatureServer|MapServer)\/\d+$/i.test(I)?I.replace(/\/(FeatureServer|MapServer)\/\d+$/i,"/$1"):I,E=`${L}${L.includes("?")?"":"?"}${L.includes("?")?"&":""}f=pjson`,C=B=>`/.netlify/functions/proxy-feature?url=${encodeURIComponent(B)}`,T=h?C(F):F,N=h?C(E):E,W=async B=>{for(let G=0;G<2;G++)try{const ie=await fetch(B,{method:"GET"});if(!ie.ok)return{ok:!1,resp:ie,json:null};const _=ie.headers.get("content-type")||"",me=/application\/(?:json|pjson)/i.test(_)?await ie.clone().json().catch(()=>null):null;return{ok:!0,resp:ie,json:me}}catch{if(G===1)return{ok:!1,resp:void 0,json:null};await new Promise(ie=>setTimeout(ie,150))}return{ok:!1,resp:void 0,json:null}},D=await W(T),R=await W(N),X=!!D.resp&&D.resp.ok,M=!!R.resp&&R.resp.ok,te=X&&!!D.json&&!D.json?.error,se=M&&!!R.json&&!R.json?.error;if(D.ok&&D.json){const B=D.json?.error?.message||D.json?.message||"",G=/token/i.test(B)||D.json?.error?.code===499,ie=/permission|privilege|authorized|do not have permissions|not permitted/i.test(B)||D.json?.error?.code===403;G&&g.push({url:d,status:D.resp?.status,error:"Token required",title:k,layerItemId:A,layerTitle:j}),ie&&g.push({url:d,status:D.resp?.status,error:"Permissions denied or item private",title:k,layerItemId:A,layerTitle:j});const _=typeof D.json?.type=="string"||typeof D.json?.geometryType=="string"||Array.isArray(D.json?.fields)||Array.isArray(D.json?.layers),we=!!D.json?.error;!_&&!we&&!se&&g.push({url:d,status:D.resp?.status,error:"Invalid layer definition",title:k,layerItemId:A,layerTitle:j}),we&&g.push({url:d,status:D.resp?.status,error:"Layer error JSON",title:k,layerItemId:A,layerTitle:j});const me=D.resp?.headers?.get("content-type")||"";/application\/(?:json|pjson)/i.test(me)||(g.push({url:d,status:D.resp?.status,error:"Non-JSON response",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:d,status:D.resp?.status,ok:!1,errorCategory:"non-json",errorMessage:"Non-JSON response"})),D.json||(g.push({url:d,status:D.resp?.status,error:"JSON parse failed",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:d,status:D.resp?.status,ok:!1,errorCategory:"json-error",errorMessage:"JSON parse failed"}))}if(!te&&!m(I)){const B=D.resp?.status,G=D.json?.error?D.json.error.message||"Layer error JSON":void 0;g.push({url:d,status:B,error:G||"Layer endpoint not healthy",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:d,status:B,ok:!1,errorCategory:G?"json-error":"other",errorMessage:G||"Layer endpoint not healthy"})}if(R.ok&&R.json?.error){const B=R.json?.error?.message||R.json?.message||"",G=/permission|privilege|authorized|do not have permissions|not permitted/i.test(B)||R.json?.error?.code===403;g.push({url:L,status:R.resp?.status,error:G?"Service permissions denied or item private":"Service error JSON",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:L,status:R.resp?.status,ok:!1,errorCategory:G?"permission-denied":"json-error",errorMessage:G?"Service permissions denied or item private":"Service error JSON"})}if(!X&&!m(I)&&(g.push({url:d,status:D.resp?.status,error:"Layer HTTP failure",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:d,status:D.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Layer HTTP failure"})),!M&&!m(L)&&(g.push({url:L,status:R.resp?.status,error:"Service HTTP failure",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:L,status:R.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Service HTTP failure"})),R.ok&&R.json&&!R.json.error){const B=R.json,G=typeof B.currentVersion=="number"||typeof B.currentVersion=="string",ie=typeof B.capabilities=="string"||Array.isArray(B.capabilities);(!G||!ie)&&(g.push({url:L,status:R.resp?.status,error:"Service missing capabilities/version",title:k,layerItemId:A,layerTitle:j}),s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:L,status:R.resp?.status,ok:!1,errorCategory:"other",errorMessage:"Service missing capabilities/version"}))}te&&s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:d,status:D.resp?.status,ok:!0,errorCategory:"ok"}),se&&s.push({webmapId:a,webmapTitle:f,layerTitle:j,layerItemId:A,url:L,status:R.resp?.status,ok:!0,errorCategory:"ok"})}for(const d of y)if(d?.itemId&&/^[a-f0-9]{32}$/i.test(d.itemId)){const A=`${globalThis.__ORG_BASE||"https://www.arcgis.com"}/sharing/rest/content/items/${d.itemId}?f=json${e?`&token=${encodeURIComponent(e)}`:""}`;try{const j=await fetch(A);if(j.ok){const h=await j.json();if(h.error){const I=h.error?.code,F=h.error?.message||"",L=I===403||/permission|privilege|authorized|not permitted/i.test(F);g.push({url:A,status:j.status,error:L?"Layer item private or permission denied":"Layer item error JSON",title:d.title,layerItemId:d.itemId,layerTitle:d.title})}}else{const h=j.status,I=h===404?"Layer item deleted":h===403?"Layer item private or permission denied":"Layer item not accessible";g.push({url:A,status:h,error:I,title:d.title,layerItemId:d.itemId,layerTitle:d.title})}}catch{g.push({url:A,error:"Layer item unreachable",title:d.title,layerItemId:d.itemId,layerTitle:d.title})}}g.length&&t.push({itemId:a,level:"warning",message:`Webmap ${f?'"'+f+'" ':""}has ${g.length} failing endpoint(s).`,details:{webmapTitle:f,failures:g}})}catch{t.push({itemId:a,level:"warning",message:"Failed to validate webmap. Proceeding, but please check the item manually."})}const o={};for(const a of s){const p=a.errorCategory||(a.ok?"ok":"other");o[p]=(o[p]||0)+1}return{warnings:t,endpointChecks:s,endpointCategorySummary:o}}function Qe(b){const e=b?.values||{},t=e?.settings?.template||e?.template||b?.template||"";if(typeof t=="string"&&t.trim().length>0)return t;try{if(Array.isArray(e?.entries)&&e.entries.length>0)return"Map Series";if(e?.story&&Array.isArray(e.story.sections))return"Map Journal";if(Array.isArray(e?.webmaps)||typeof e?.layout=="string")return"Swipe";if(Array.isArray(e?.media?.items)||String(e?.theme||"").toLowerCase().includes("tour"))return"Map Tour";if(String(e?.template||"").toLowerCase().includes("crowd"))return"Crowdsource";if(String(e?.template||"").toLowerCase().includes("cascade"))return"Cascade";if(String(e?.template||"").toLowerCase().includes("shortlist"))return"Shortlist";if(String(e?.template||"").toLowerCase().includes("basic"))return"Basic"}catch{}return"unknown"}function ht(){throw new Error("execSync is not available in the browser environment")}function St(){throw new Error("execFileSync is not available in the browser environment")}const Gs={};class bt{constructor(e){this.classicJson=e.classicJson,this.themeId=e.themeId,this.progress=e.progress,this.storyId=e.storyId,this.username=e.username,this.token=e.token,this.uploader=e.uploader,this.inlineUpload=e.inlineUpload}emit(e){this.progress({stage:"convert",message:e})}async convert(){this.emit("Beginning conversion"),this.extractStructure(),await this.convertContent(),this.applyTheme();const e=this.collectMedia();return{storymapJson:this.getStoryMapJson(),mediaUrls:e}}}function ke(b){if(typeof b=="number"){const e=b;if(!e||e<=0)return;const t=Math.min(Math.max(Math.round(Math.log2(5916575275e-1/e)),0),24);return{scale:e,zoom:t}}if(b&&typeof b=="object")return{scale:5e4,zoom:10}}const Ut={variables:{headerFooterBackgroundColor:"#ffffff",backgroundColor:"#ffffff",titleFontId:"avenirNext",titleColor:"#002625",titleColorDark:"#002625",titleColorLight:"#ffffff",bodyFontId:"notoSerif",bodyColor:"#304e4e",bodyColorDark:"#002625",bodyColorLight:"#ffffff",bodyMutedColor:"#3d6665",themeColor1:"#087f9b",themeColor2:"#fc3b36",themeColor3:"#126057",borderRadius:0,shape:"hexagon",colorRamps:["seq-single-blues","seq-multi-ylgn","seq-orange-red-light","seq-yellow-darkblue-bright-reversed"],basemapPrimary:"humanGeographyLight",basemapAlt:"lightGrayCanvas",basemapImagery:"worldImagery"}},Wt={variables:{headerFooterBackgroundColor:"#000000",backgroundColor:"#0e1116",titleFontId:"charterBT",titleColor:"#f3f3f3",titleColorDark:"#0E1116",titleColorLight:"#f3f3f3",bodyFontId:"arial",bodyColor:"#e6f2f2",bodyColorDark:"#0E1116",bodyColorLight:"#E6F2F2",bodyMutedColor:"#809e9d",themeColor1:"#ea5b41",themeColor2:"#4d6aff",themeColor3:"#0ec2db",borderRadius:9999,colorRamps:["seq-blue-bright-5","seq-yellow-bright-3","seq-green-bright-3","seq-red-bright-4"],basemapPrimary:"darkGrayCanvas",basemapAlt:"humanGeographyDark",basemapImagery:"worldImagery"}};function Jt(b,e){if(!b||!b.includes("font-family"))return e;let t=b;const s=/font-family:\s*'([^']+)'/.exec(b)||/font-family:\s*"([^"]+)"/.exec(b);if(s)t=s[1];else{const a=/font-family:\s*([^;]+);?/.exec(b);a&&(t=a[1].split(",")[0].trim().replace(/["']/g,""))}const i=t.toLowerCase().replace(/\s+/g,"");return{open_sansregular:"openSans",opensans:"openSans",roboto:"roboto",noto:"notoSerif",notoserif:"notoSerif",lato:"lato",sourcesanspro:"sourceSansPro",avenirnext:"avenirNext",charterbt:"charterBT",arial:"arial"}[i]||e}function Qt(b){const e=b.values||{},s=(e.settings||{}).theme||{},i=s.colors||{},o=s.fonts||{},a=(e.title||"").trim()+" (Theme)",w=(i.themeMajor||"").toLowerCase()==="black"?"obsidian":"summit",n={...(w==="obsidian"?Wt:Ut).variables},l=w==="obsidian"?Wt.variables:Ut.variables;for(const[d,k]of Object.entries(l))d in n||(n[d]=k);const u=[];let f;i.panel&&(n.backgroundColor=i.panel,u.push("backgroundColor")),i.dotNav&&(n.headerFooterBackgroundColor=i.dotNav,u.push("headerFooterBackgroundColor")),i.text&&(n.bodyColor=i.text,u.push("bodyColor"),f="text"),!n.bodyColorDark&&l.bodyColorDark&&(n.bodyColorDark=l.bodyColorDark),!n.bodyColorLight&&l.bodyColorLight&&(n.bodyColorLight=l.bodyColorLight),!n.titleColorDark&&l.titleColorDark&&(n.titleColorDark=l.titleColorDark),!n.titleColorLight&&l.titleColorLight&&(n.titleColorLight=l.titleColorLight),i.textLink&&(n.themeColor1=i.textLink,u.push("themeColor1")),!i.text&&i.textLink&&(n.bodyColor=i.textLink,u.push("bodyColor"),f="textLink"),i.softText&&(n.bodyMutedColor=i.softText,u.push("bodyMutedColor")),!n.colorRamps&&l.colorRamps&&(n.colorRamps=l.colorRamps),!n.basemapPrimary&&l.basemapPrimary&&(n.basemapPrimary=l.basemapPrimary),!n.basemapAlt&&l.basemapAlt&&(n.basemapAlt=l.basemapAlt),!n.basemapImagery&&l.basemapImagery&&(n.basemapImagery=l.basemapImagery),w==="summit"&&!n.shape&&l.shape&&(n.shape=l.shape);const g=o.sectionTitle?.value,c=o.sectionContent?.value,y=Jt(g,n.titleFontId),x=Jt(c,n.bodyFontId);y&&y!==n.titleFontId&&(n.titleFontId=y,u.push("titleFontId")),x&&x!==n.bodyFontId&&(n.bodyFontId=x,u.push("bodyFontId"));const r={title:a,baseThemeId:w,isFromOrgTheme:!1,variables:n,resources:{}},m={baseThemeId:w,colorMappings:{panelToBackgroundColor:i.panel,dotNavToHeaderFooterBackgroundColor:i.dotNav,textToBodyColor:i.text,textLinkToBodyColor:i.text?void 0:i.textLink,textLinkToThemeColor1:i.textLink,softTextToBodyMutedColor:i.softText,chosenBodyColorSource:f},fontMappings:{classicTitleFontValue:g,mappedTitleFontId:y,classicBodyFontValue:c,mappedBodyFontId:x},variableOverridesApplied:u};return{theme:r,decisions:m}}function At(b){return!!b&&typeof b=="object"}function Pe(b,e){if(At(b))return b[e]}function es(b){const e=Qe(b),t=At(b)&&At(Pe(b,"values"))?Pe(b,"values"):{},s=w=>{const S=String(w||"").toLowerCase();return S==="dark"||S==="black"?"obsidian":"summit"};if(/Map Journal|Map Series|Cascade/i.test(e))try{const{theme:w,decisions:S}=Qt(b),n=w.baseThemeId==="obsidian"?"obsidian":"summit",l={};if(Array.isArray(S?.variableOverridesApplied))for(const u of S.variableOverridesApplied)u in w.variables&&(l[u]=String(w.variables[u]));return{themeId:n,variableOverrides:l}}catch{const w=Pe(t,"settings"),S=w&&Pe(w,"theme"),n=S&&Pe(S,"colors"),l=n&&Pe(n,"themeMajor");return{themeId:s(l)}}if(/Map Tour/i.test(e)){const w=String(Pe(t,"colors")||""),S=String(w).split(";"),n=S[0]?.trim(),l=S[1]?.trim(),u="summit",f={};return n&&(f.headerFooterBackgroundColor=n),l&&(f.backgroundColor=l),{themeId:u,variableOverrides:Object.keys(f).length?f:void 0}}if(/Swipe/i.test(e)){const w=String(Pe(t,"colors")||""),S=String(w).split(";"),n=S[0]?.trim(),l=S[1]?.trim(),u=Pe(t,"settings"),f=u&&Pe(u,"theme"),g=f&&Pe(f,"colors"),c=g&&Pe(g,"themeMajor"),y=s(c),x={};return n&&(x.headerFooterBackgroundColor=n),l&&(x.backgroundColor=l),{themeId:y,variableOverrides:Object.keys(x).length?x:void 0}}const i=Pe(t,"settings"),o=i&&Pe(i,"theme"),a=o&&Pe(o,"colors"),p=a&&Pe(a,"themeMajor");return{themeId:s(p)}}function rt(b,e){const t=es(e);return{themeId:b==="auto"?t.themeId:b,variableOverrides:t.variableOverrides}}const Hs=Object.freeze(Object.defineProperty({__proto__:null,computeTheme:rt,deriveClassicTheme:es},Symbol.toStringTag,{value:"Module"})),qs="arcgis-storymaps-classic-converter",Ks="0.4.6",Ys="module",Xs={clean:"rimraf dist || rm -rf dist",dev:"vite",build:"vite build",typecheck:"tsc -b",lint:"eslint .",preview:"vite preview","netlify:dev":"netlify dev"},Zs={"@arcgis/core":"^4.30.6","@esri/arcgis-rest-auth":"^3.8.0","@esri/calcite-components":"^3.3.3","@esri/calcite-components-react":"^3.3.3","@netlify/functions":"^5.1.0",cytoscape:"^3.33.1","cytoscape-cxtmenu":"^3.5.0","cytoscape-dagre":"^2.5.0","cytoscape-fcose":"^2.2.0","cytoscape-navigator":"^2.0.2","cytoscape-panzoom":"^2.5.3","cytoscape-undo-redo":"^1.3.3",mermaid:"^11.12.2",panzoom:"^9.4.3",react:"^19.2.0","react-dom":"^19.2.0",tsx:"^4.20.6"},Qs={"@eslint/js":"^9.39.1","@netlify/vite-plugin":"^2.7.14","@types/node":"^24.10.0","@types/react":"^19.2.2","@types/react-dom":"^19.2.2","@vitejs/plugin-react":"^5.1.0",eslint:"^9.39.1","eslint-plugin-react-hooks":"^7.0.1","eslint-plugin-react-refresh":"^0.4.24",globals:"^16.5.0","image-size":"^2.0.2","ts-node":"^10.9.2",typescript:"~5.9.3","typescript-eslint":"^8.46.3",vite:"^7.2.2"},ei={name:qs,private:!0,version:Ks,type:Ys,scripts:Xs,dependencies:Zs,devDependencies:Qs};function zt(){try{const b=ei?.version;if(typeof b=="string"&&b.length)return b}catch{}try{const b=typeof import.meta<"u"?import.meta:void 0,e=b?.env?.VITE_APP_VERSION||b?.env?.APP_VERSION||"";if(typeof e=="string"&&e.length)return e}catch{}try{const b=typeof process<"u"?process:void 0,e=b?.env?.npm_package_version||b?.env?.APP_VERSION||"";if(typeof e=="string"&&e.length)return e}catch{}return"0.0.0"}class ot{constructor(e){this.themeResourceId=this.generateResourceId(),this.json={root:"",nodes:{},resources:{[this.themeResourceId]:{type:"story-theme",data:{themeId:e,themeBaseVariableOverrides:{}}}},actions:[]}}createStoryRoot(){const e=this.generateNodeId();return this.json.root=e,this.json.nodes[e]={type:"story",data:{storyTheme:this.themeResourceId},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[]},e}addNode(e,t,s,i){const o=this.generateNodeId(),a={type:e};return t&&(a.data=t),s&&(a.config=s),i&&(a.children=i),this.json.nodes[o]=a,o}applyTheme(e){const t=this.json.resources[this.themeResourceId];t&&t.type==="story-theme"&&(t.data.themeId=e.themeId,e.variableOverrides&&Object.keys(e.variableOverrides).length&&(t.data.themeBaseVariableOverrides=e.variableOverrides))}addImageResource(e,t,s){const i=this.generateResourceId();return this.json.resources[i]={type:"image",data:{src:e,provider:"uri",width:t,height:s}},i}finalizeImageResourceAsItem(e,t,s,i){const o=this.json.resources[e];!o||o.type!=="image"||(delete o.data.src,o.data.resourceId=t,o.data.provider="item-resource",s&&(o.data.width=s),i&&(o.data.height=i))}addVideoResource(e,t="uri",s){const i=s??this.generateResourceId();return this.json.resources[i]={type:"video",data:{src:e,provider:t}},i}addTextBlock(e,t,s){const i=this.generateNodeId(),a={type:"text",data:{text:t,type:s==="bullet-list"?"paragraph":s}};return this.json.nodes[i]=a,this.appendChild(e,i),i}addImageNode(e,t,s,i,o="standard"){const a=this.generateNodeId(),p={type:"image",data:{image:t,caption:s,alt:i},config:{size:o}};return this.json.nodes[a]=p,this.appendChild(e,a),a}addRichTextToRoot(e,t="paragraph",s="wide"){if(!this.json.root)return this.createRichTextNode(e,t,s);const i=this.generateNodeId();return this.json.nodes[i]={type:"text",data:{text:e,type:t,preserveHtml:!0,textAlignment:"start"},config:{size:s}},this.appendChild(this.json.root,i),i}addVideoNode(e,t){const s=this.generateNodeId(),i={type:"video",data:{src:t.src,resourceId:t.resourceId,provider:t.provider,caption:t.caption,alt:t.alt}};return this.json.nodes[s]=i,this.appendChild(e,s),s}addWebMapResource(e,t="Web Map",s,i="minimal"){const o=`r-${e}`,a={type:i,itemId:e,itemType:t};if(!this.json.resources[o])this.json.resources[o]={type:"webmap",data:a};else{const p=this.json.resources[o];p&&p.type==="webmap"&&(p.data=p.data||{},p.data.type=i,p.data.itemId=e,p.data.itemType=t,p.data.initialState&&delete p.data.initialState,this.json.resources[o]=p)}return s&&this.updateWebMapInitialState(o,s),o}addWebMapNode(e,t,s){const i=this.generateNodeId(),o={type:"webmap",data:{map:t,caption:s}};return this.json.nodes[i]=o,this.appendChild(e,i),i}updateWebMapInitialState(e,t){const s=this.json.resources[e];if(!s||s.type!=="webmap")return;s.data=s.data||{};const i={...s.data,...t};delete i.initialState,s.data=i,this.json.resources[e]=s}updateWebMapData(e,t){const s=this.json.resources[e];!s||s.type!=="webmap"||(s.data=s.data||{},s.data={...s.data,...t},s.data.initialState&&delete s.data.initialState,this.json.resources[e]=s)}addCoverNode(e,t,s){const i=this.generateNodeId();return this.json.nodes[i]={type:"storycover",data:{type:"minimal",title:e,summary:t||"",byline:s||"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},this.json.root&&this.json.nodes[this.json.root]&&this.appendChild(this.json.root,i),i}addNavigationHidden(){const e=this.generateNodeId();return this.json.nodes[e]={type:"navigation",data:{links:[]},config:{isHidden:!0}},this.json.root&&this.appendChild(this.json.root,e),e}addCreditsNode(){const e=this.generateNodeId(),t=this.generateNodeId();this.json.nodes[t]={type:"attribution",data:{content:"",attribution:""}};const s=this.generateNodeId();this.json.nodes[s]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}};const i=this.generateNodeId();return this.json.nodes[i]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}},this.json.nodes[e]={type:"credits",children:[s,i,t]},this.json.root&&this.appendChild(this.json.root,e),e}addSidecar(e="docked-panel",t="end",s="medium"){const i=this.generateNodeId(),o=this.generateNodeId(),a=this.generateNodeId();this.json.nodes[i]={type:"immersive",data:{type:"sidecar",subtype:e,narrativePanelPosition:t,narrativePanelSize:s},children:[o]},this.json.nodes[o]={type:"immersive-slide",data:{transition:"fade"},children:[a]},this.json.nodes[a]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[]};const p=this.json.nodes[this.json.root];if(p?.children){const w=p.children.findIndex(S=>this.json.nodes[S]?.type==="credits");w>-1?p.children.splice(w,0,i):p.children.push(i)}return{immersiveId:i,slideId:o,narrativeId:a}}addSection(e,t,s){const i=this.generateNodeId();if(this.json.nodes[i]={type:"slide",children:[]},this.appendChild(e,i),t&&this.addTextBlock(i,t,"h2"),s){const o=s.replace(/<[^>]+>/g,"").trim();o&&this.addTextBlock(i,o,"paragraph")}return i}appendChild(e,t){const s=this.json.nodes[e];s&&(s.children||(s.children=[]),s.children.push(t))}getJson(){for(const o of Object.values(this.json.nodes))o&&(o.type==="webmap"?(o.config?"size"in o.config||(o.config.size="standard"):o.config={size:"standard"},o.data&&"scale"in o.data&&delete o.data.scale):o.type==="text"&&o.data&&!("textAlignment"in o.data)&&(o.data.textAlignment="start"));if(this.json.root){const o=this.json.nodes[this.json.root];o?.type==="story"&&o.data&&"metaSettings"in o.data&&delete o.data.metaSettings}const e={};for(const[o,a]of Object.entries(this.json.nodes))o!==this.json.root&&(e[o]=a);this.json.root&&(e[this.json.root]=this.json.nodes[this.json.root]);const{root:t,resources:s,actions:i}=this.json;return{root:t,nodes:e,resources:s,actions:i}}updateNodeData(e,t){const s=this.json.nodes[e];s&&(s.data||(s.data={}),t(s.data,s))}updateNode(e,t){const s=this.json.nodes[e];s&&t(s)}removeNode(e){const t=this.json.nodes;if(!(!t||!t[e])){for(const s of Object.values(t))if(s?.children&&Array.isArray(s.children)){const i=s.children.indexOf(e);i>-1&&s.children.splice(i,1)}delete t[e]}}setStoryMeta(e,t,s){if(!this.json.root)return;const i=this.json.nodes[this.json.root];!i||i.type!=="story"||(i.data||(i.data={}),i.data.metaSettings={title:e,description:t||"",imageResourceId:s})}addConverterMetadata(e,t){let s="";try{const w=typeof import.meta<"u"?import.meta:void 0;w&&w.env&&typeof w.env.SUPPRESS_CONVERTER_METADATA<"u"&&(s=String(w.env.SUPPRESS_CONVERTER_METADATA))}catch{}if(!s)try{const w=typeof process<"u"?process:void 0;w&&w.env&&typeof w.env.SUPPRESS_CONVERTER_METADATA<"u"&&(s=String(w.env.SUPPRESS_CONVERTER_METADATA))}catch{}try{const w=typeof globalThis<"u"?globalThis:void 0;!s&&w&&typeof w.__SUPPRESS_CONVERTER_METADATA<"u"&&(s=String(w.__SUPPRESS_CONVERTER_METADATA))}catch{}if(String(s||"").toLowerCase()==="true")return;const o=Object.entries(this.json.resources).find(([,w])=>w?.type==="converter-metadata");if(o){const[w,S]=o,n=S.data;n.typeConvertedTo||(n.typeConvertedTo="storymap"),n.converterVersion||(n.converterVersion=zt()),e&&(n.classicType=e);const l=t.classicMetadata||{},u=n.classicMetadata=n.classicMetadata||{};if(l&&typeof l.classicTheme<"u"&&(u.classicTheme=l.classicTheme),l&&typeof l.mappingDecisions<"u"){const g=l.mappingDecisions,c=u.mappingDecisions=u.mappingDecisions||{};for(const[y,x]of Object.entries(g))c[y]=x}for(const[g,c]of Object.entries(t))g!=="classicMetadata"&&(n[g]=c);const f=l?.templateVersion;f&&!n.classicTemplateVersion&&(n.classicTemplateVersion=f),delete this.json.resources[w],this.json.resources[w]=S,this.json.resources[w]=S;return}const a=this.generateResourceId(),p={type:"converter-metadata",data:{classicType:e,...t,typeConvertedTo:t?.typeConvertedTo??"storymap",converterVersion:t?.converterVersion??zt()}};try{const S=(t.classicMetadata||{})?.templateVersion;S&&(p.data.classicTemplateVersion=S)}catch{}this.json.resources[a]=p}generateNodeId(){return`n-${Math.random().toString(36).slice(2,8)}`}generateResourceId(){return`r-${Math.random().toString(36).slice(2,8)}`}createTextNode(e,t,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"text",data:{text:e,type:t,textAlignment:"start"},config:{size:s}},i}createRichTextNode(e,t,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"text",data:{text:e,type:t,preserveHtml:!0,textAlignment:"start"},config:{size:s}},i}createImageNode(e,t,s,i="wide"){const o=this.generateNodeId();return this.json.nodes[o]={type:"image",data:{image:e,caption:t,alt:s},config:{size:i}},o}createWebMapNode(e,t){const s=this.generateNodeId();return this.json.nodes[s]={type:"webmap",data:{map:e,caption:t},config:{size:"standard"}},s}createVideoNode(e,t,s){const i=this.generateNodeId();return this.json.nodes[i]={type:"video",data:{video:e,caption:t,alt:s}},i}createVideoEmbedNode(e,t,s,i,o,a,p,w="16:9"){const S=this.generateNodeId();let n=e;return t==="youtube"&&s?n=`https://www.youtube.com/embed/${s}`:t==="vimeo"&&s&&(n=`https://player.vimeo.com/video/${s}`),this.json.nodes[S]={type:"embed",data:{url:e,embedSrc:n,embedType:"video",provider:t,videoId:s,title:o||void 0,description:a||void 0,caption:i||void 0,alt:p||"",isEmbedSupported:!0,display:"inline",aspectRatio:w}},S}createEmbedNode(e,t,s,i,o){const a=this.generateNodeId();return this.json.nodes[a]={type:"embed",data:{url:e,embedType:"link",title:s,description:i,caption:t,alt:o||"",isEmbedSupported:!0,display:"inline",embedSrc:e}},a}createSwipeNode(e,t,s="extent",i){const o=this.generateNodeId();return this.json.nodes[o]={type:"swipe",data:{contents:{0:e,1:t},viewPlacement:s,caption:i},config:{size:"full"}},o}addSlideToSidecar(e,t,s){const i=this.json.nodes[e];if(!i||i.type!=="immersive")throw new Error("addSlideToSidecar: invalid sidecarId");const o=this.generateNodeId();this.json.nodes[o]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[...t]};const a=this.generateNodeId(),p=s?[o,s]:[o];return this.json.nodes[a]={type:"immersive-slide",data:{transition:"fade"},children:p},i.children||(i.children=[]),i.children.push(a),{slideId:a,narrativeId:o}}createActionButtonNode(e,t="wide"){const s=this.generateNodeId();return this.json.nodes[s]={type:"action-button",data:{text:e},config:{size:t}},s}addActionButton(e,t,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"action-button",data:{text:t},config:{size:s}},this.appendChild(e,i),i}createButtonNode(e,t="wide",s){const i=this.generateNodeId();return this.json.nodes[i]={type:"button",data:{text:e,link:s},config:{size:t}},i}setButtonLink(e,t){const s=this.json.nodes[e];s&&s.type==="button"&&(s.data||(s.data={}),s.data.link=t)}addChild(e,t){this.appendChild(e,t)}getStoryRootId(){return this.json.root}newNodeId(){return this.generateNodeId()}createTourMapNode(e,t,s="2d"){const i=this.generateNodeId(),o={type:"name",value:"worldImagery"};if(t){const a=this.addWebMapResource(t,"Web Map",{},"minimal");o.type="resource",o.value=a}return this.json.nodes[i]={type:"tour-map",data:{geometries:e,mode:s,basemap:o}},i}createCarouselNode(e){const t=this.generateNodeId();return this.json.nodes[t]={type:"carousel",children:e.slice(0,5)},t}createTourNode(e,t,s,i="start",o="large",a="guided-tour",p="map-focused"){const w=this.generateNodeId();return this.json.nodes[w]={type:"tour",data:{type:a,subtype:p,narrativePanelPosition:i,map:t,places:e,narrativePanelSize:o,accentColor:s}},w}registerReplaceMediaAction(e,t,s){typeof s=="string"&&this.json.nodes[s]&&(this.json.actions||(this.json.actions=[]),this.json.actions.push({origin:e,trigger:"ActionButton_Apply",target:t,event:"ImmersiveSlide_ReplaceMedia",data:{media:s}}))}}function Vt(b){let e=b||"";const t=[];return e=e.replace(/style\s*=\s*"([^"]*)"/gi,(s,i)=>(t.push(String(i)),"")),e=e.replace(/style\s*=\s*'([^']*)'/gi,(s,i)=>(t.push(String(i)),"")),e=e.replace(/<\s*script[^>]*>[\s\S]*?<\s*\/\s*script\s*>/gi,"").replace(/<\s*style[^>]*>[\s\S]*?<\s*\/\s*style\s*>/gi,""),e=e.replace(/<\s*b\s*>/gi,"<strong>").replace(/<\s*\/\s*b\s*>/gi,"</strong>").replace(/<\s*i\s*>/gi,"<em>").replace(/<\s*\/\s*i\s*>/gi,"</em>"),e=e.replace(/<\s*a\s+([^>]+)>/gi,(s,i)=>{const o=/href\s*=\s*("[^"]*"|'[^']*'|[^\s>]+)/i.exec(i||""),a=o?o[1].replace(/^['"]|['"]$/g,""):"";return a?`<a href="${a}">`:"<a>"}),e=e.replace(/<\s*(strong|em|a)\s+[^>]*>/gi,(s,i)=>`<${String(i).toLowerCase()}>`),e=e.replace(/<\s*(?!strong\b|em\b|a\b)\/?\s*([a-z0-9-]+)([^>]*)>/gi,s=>""),e=e.replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),e=e.replace(/(?:\r?\n|\r){2,}/g,`
`),{sanitizedHtml:e,inlineStyles:t}}class Le extends bt{constructor(e){super(e),this.model="TWO_WEBMAPS",this.layout="swipe",this.builder=new ot(e.themeId);const t=e.classicItemId;t&&(this.options={classicItemId:t})}extractStructure(){const e=this.classicJson.values;(e.dataModel||"").toUpperCase()==="TWO_LAYERS"?this.model="TWO_LAYERS":this.model="TWO_WEBMAPS",(e.layout||"").toLowerCase().includes("spyglass")?this.layout="spyglass":this.layout="swipe",this.emit(`Swipe model=${this.model} layout=${this.layout}`)}async convert(){this.emit("Beginning conversion"),this.extractStructure(),await this.convertContent(),this.applyTheme();const e=this.collectMedia();return{storymapJson:this.getStoryMapJson(),mediaUrls:e}}async convertContent(){this.emit("SwipeConverter.convertContent used");const e=this.classicJson.values;this.builder.createStoryRoot();let t,s,i=e.title||"";this.emit(`[CoverTitle] initial from classic values.title='${(e.title||"").trim()}'`);const o=(i||"").trim().toLowerCase()==="swipe"||(i||"").trim().toLowerCase()==="spyglass";if(!i||o){const g=this.options?.classicItemId;if(this.emit(`[CoverTitle] genericOrEmpty=${!i||o}, classicItemId='${g||""}'`),g){const c=`https://www.arcgis.com/sharing/rest/content/items/${g}?f=json`;try{const y=this.token?`${c}&token=${encodeURIComponent(this.token)}`:c,x=await Ve(y,void 0,600*1e3),r=x&&typeof x.title=="string"?x.title.trim():"";this.emit(`[CoverTitle] fetched AGO item.title='${r}'`),r&&(i=r)}catch{}}else{const c=this.fetchItemTitleFallback()||"";this.emit(`[CoverTitle] Node-only fallback title='${c}'`),i=c}}i||(this.emit(`[CoverTitle] falling back to values.name='${(e.name||"").trim()}' or default 'Swipe'`),i=e.name||"Swipe"),this.emit(`[CoverTitle] final coverTitle='${i}'`),this.builder.addCoverNode(i,e.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode();try{const g=e.sidePanelDescription,y=(typeof g=="string"?g:g?String(g):"").trim();if(y){const x=/<[^>]+>/.test(y);if(this.emit(`[SwipeConverter] sidePanelDescription detected; looksHtml=${x}`),x){const{sanitizedHtml:r,inlineStyles:m}=Vt(y);if(m.length)try{this.builder.addConverterMetadata("Swipe",{classicMetadata:{mappingDecisions:{customCss:{combined:m.join(`
`)}}}})}catch{}this.builder.addRichTextToRoot(r,"paragraph","wide")}else{const r=this.builder.json.root;r?this.builder.addTextBlock(r,y,"paragraph"):this.builder.createTextNode(y,"paragraph","wide")}}}catch{}let a,p;if(this.model==="TWO_WEBMAPS"){const g=[];if(Array.isArray(e.webmaps))for(const h of e.webmaps)typeof h=="string"?g.push(h):h&&typeof h=="object"&&"id"in h&&g.push(String(h.id));else e.webmap&&g.push(String(e.webmap));const[c,y]=g,x=typeof window<"u",r=c?x?await Le.fetchWebMapInfo(c,this.token):Le.fetchWebMapInfoSync(c,this.token):void 0,m=y?x?await Le.fetchWebMapInfo(y,this.token):Le.fetchWebMapInfoSync(y,this.token):void 0,d={},k={};if(r?.extent){d.extent=r.extent;const h=ke(r.extent);if(h&&(d.viewpoint={targetGeometry:r.center??r.extent,scale:h.scale}),a&&p){const I=r?.center||{x:(r.extent.xmin+r.extent.xmax)/2,y:(r.extent.ymin+r.extent.ymax)/2,spatialReference:r.extent.spatialReference||{wkid:102100}};d.center=I}}if(Array.isArray(r?.operationalLayers))d.mapLayers=r.operationalLayers.map(h=>({id:h.id,title:h.title||h.id,visible:!!h.visibility}));else if(c){const h=`https://www.arcgis.com/sharing/rest/content/items/${c}/data?f=json`,I=this.token?`${h}&token=${encodeURIComponent(this.token)}`:h;Ve(I,void 0,600*1e3).then(F=>{const L=Array.isArray(F?.operationalLayers)?F.operationalLayers:[];L.length&&(d.mapLayers=L.map(E=>({...E})))}).catch(()=>{})}if(m?.extent){k.extent=m.extent;const h=ke(m.extent);if(h&&(k.viewpoint={targetGeometry:m.center??m.extent,scale:h.scale}),!("center"in k)){const I=m?.center||{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}};k.center=I}}if(Array.isArray(m?.operationalLayers))k.mapLayers=m.operationalLayers.map(h=>({id:h.id,title:h.title||h.id,visible:!!h.visibility}));else if(y){const h=C=>{for(let T=C.length-1;T>=0;T--)if(C[T].visible)return C[T].title},I=Array.isArray(d.mapLayers)?d.mapLayers.map(C=>({title:C.title,visible:C.visible})):[],F=Array.isArray(k.mapLayers)?k.mapLayers.map(C=>({title:C.title,visible:C.visible})):[];h(I),h(F);const L=`https://www.arcgis.com/sharing/rest/content/items/${y}/data?f=json`,E=this.token?`${L}&token=${encodeURIComponent(this.token)}`:L;Ve(E,void 0,600*1e3).then(C=>{const T=Array.isArray(C?.operationalLayers)?C.operationalLayers:[];T.length&&(k.mapLayers=T.map(N=>({...N})))}).catch(()=>{})}const A=c?this.builder.addWebMapResource(c,"Web Map",d,"default"):void 0,j=y?this.builder.addWebMapResource(y,"Web Map",k,"default"):void 0;if(A&&r){const h=r.extent?ke(r.extent):void 0;this.builder.updateWebMapData(A,{extent:r.extent,center:r.center,zoom:h?.zoom,viewpoint:d.viewpoint,mapLayers:d.mapLayers??[]});try{const I=this.builder.getJson().resources[A]?.data||{};console.info("[SwipeConverter] resA",A,"extent",I.extent,"viewpoint",I.viewpoint,"center",I.center,"zoom",I.zoom)}catch{}}if(j&&m){const h=m.extent?ke(m.extent):void 0;this.builder.updateWebMapData(j,{extent:m.extent,center:m.center,zoom:h?.zoom,viewpoint:k.viewpoint,mapLayers:k.mapLayers??[]});try{const I=this.builder.getJson().resources[j]?.data||{};console.info("[SwipeConverter] resB",j,"extent",I.extent,"viewpoint",I.viewpoint,"center",I.center,"zoom",I.zoom)}catch{}}if(A&&(a=this.builder.createWebMapNode(A,void 0)),j&&(p=this.builder.createWebMapNode(j,void 0)),j){const h=m?.center||(m?.extent?{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}}:void 0);this.builder.updateWebMapData(j,{center:h})}if(A){const h=m?.center||(m?.extent?{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}}:void 0);this.builder.updateWebMapData(A,{center:h})}if(a&&(m?.extent||r?.extent)&&this.builder.updateNodeData(a,h=>{const I=m?.extent||r?.extent;if(h.extent=I,I){const L=ke(I),E=(m?.center??m?.extent)||(r?.center??r?.extent);L&&(h.viewpoint={targetGeometry:E,scale:L.scale})}const F=Array.isArray(r?.operationalLayers)&&r.operationalLayers.some(L=>L.timeAnimation===!0);h.timeSlider=!!F,Array.isArray(r?.operationalLayers)&&r.operationalLayers.length&&(h.mapLayers=r.operationalLayers.map(L=>({id:L.id,title:L.title||L.id,visible:!!L.visibility})),h.viewPlacement="extent");try{console.info("[SwipeConverter] node",a,"extent",h.extent,"viewpoint",h.viewpoint)}catch{}}),p&&m?.extent&&this.builder.updateNodeData(p,h=>{h.extent=m.extent;const I=ke(m.extent);I&&(h.viewpoint={targetGeometry:m.center??m.extent,scale:I.scale});const F=Array.isArray(m.operationalLayers)&&m.operationalLayers.some(L=>L.timeAnimation===!0);h.timeSlider=!!F,Array.isArray(m.operationalLayers)&&m.operationalLayers.length&&(h.mapLayers=m.operationalLayers.map(L=>({id:L.id,title:L.title||L.id,visible:!!L.visibility})),h.viewPlacement="extent");try{console.info("[SwipeConverter] node",p,"extent",h.extent,"viewpoint",h.viewpoint)}catch{}}),a&&p){const h=async T=>{if(T)try{const N=`https://www.arcgis.com/sharing/rest/content/items/${T}?f=json`,W=this.token?`${N}&token=${encodeURIComponent(this.token)}`:N,D=await Ve(W,void 0,600*1e3),R=D&&typeof D.title=="string"?D.title:void 0;return R&&R.trim().length?R.trim():void 0}catch{return}},I=await h(c),F=await h(y),L=I&&F?`Left: ${I} â€” Right: ${F}`:void 0,E=this.builder.createSwipeNode(a,p,"extent",L),C=this.builder.getStoryRootId();C&&this.builder.addChild(C,E),t=E,t=E}}else{const g=String(e.webmap||"");try{const c=Array.isArray(e.layers)?e.layers:[];console.info("[SwipeConverter] classic values.layers (top-level)",c)}catch{}if(g){const c=Le.fetchWebMapInfoSync(g,this.token),y=`https://www.arcgis.com/sharing/rest/content/items/${g}/data?f=json`,x=await Ve(this.token?`${y}&token=${encodeURIComponent(this.token)}`:y,void 0,600*1e3).catch(()=>{}),r={},m=x?.initialState?.view?.extent||x?.mapOptions?.extent||x?.extent||x?.mapOptions?.mapExtent,d=x?.initialState?.view?.center||x?.mapOptions?.center||x?.center,k=c?.extent||m,A=c?.center||d;if(k){r.extent=k;const C=ke(k);C&&(r.viewpoint={targetGeometry:A??k,scale:C.scale},r.zoom=C.zoom)}const j=this.builder.addWebMapResource(g,"Web Map",r,"default"),h=this.builder.addWebMapResource(g,"Web Map",r,"default");j&&r&&this.builder.updateWebMapInitialState(j,r),h&&r&&this.builder.updateWebMapInitialState(h,r),x&&j&&this.builder.updateWebMapData(j,{...x,itemId:g,itemType:"Web Map",type:"default"}),x&&h&&this.builder.updateWebMapData(h,{...x,itemId:g,itemType:"Web Map",type:"default"}),j&&this.builder.updateWebMapData(j,{extent:r.extent,center:c?.center,viewpoint:r.viewpoint,zoom:r.zoom}),h&&this.builder.updateWebMapData(h,{extent:r.extent,center:c?.center,viewpoint:r.viewpoint,zoom:r.zoom}),a=this.builder.createWebMapNode(j,void 0),p=this.builder.createWebMapNode(h,void 0);const F=(Array.isArray(e.layers)?e.layers:[]).map(C=>{if(C&&typeof C=="object"&&"id"in C){const T=C;return{id:T.id,title:T.title||T.id}}return{id:String(C),title:String(C)}}).filter(C=>C.id);try{console.info("[SwipeConverter] parsed classicLayers (top-level)",F)}catch{}const E=(Array.isArray(x?.operationalLayers)?x.operationalLayers:c?.operationalLayers||[]).map(C=>({id:C.id,title:C.title||C.id,visible:!!C.visibility}));try{console.info("[SwipeConverter][TWO_LAYERS] sourceLayers",E.map(C=>({id:C.id,title:C.title,vis:C.visible})))}catch{}if(a&&p){const C=new Set,T=new Set;for(const M of F){const te=(M.id||"").trim(),se=(M.title||M.id||"").trim();C.add(te),C.add(se),T.add(te),T.add(se)}let N=E.map(M=>{const te=(M.id||"").trim(),se=(M.title||"").trim(),B=C.has(te)||C.has(se);return{id:M.id,title:M.title,visible:B?!1:M.visible}}),W=E.map(M=>{const te=(M.id||"").trim(),se=(M.title||"").trim(),B=T.has(te)||T.has(se);return{id:M.id,title:M.title,visible:B?!0:M.visible}});for(const M of F){const te=(M.id||"").trim(),se=(M.title||M.id||"").trim();E.some(G=>{const ie=(G.id||"").trim(),_=(G.title||"").trim();return ie===te||_===se})||(N=[{id:M.id,title:M.title||M.id,visible:!1},...N],W=[{id:M.id,title:M.title||M.id,visible:!0},...W])}try{const M=N.map(se=>({id:se.id,title:se.title,vis:se.visible})),te=W.map(se=>({id:se.id,title:se.title,vis:se.visible}));console.info("[SwipeConverter][TWO_LAYERS] leftLayers after toggles",M),console.info("[SwipeConverter][TWO_LAYERS] rightLayers after toggles",te)}catch{}this.builder.updateNodeData(a,M=>{M.mapLayers=N,r.extent&&(M.extent=r.extent),r.viewpoint&&(M.viewpoint=r.viewpoint)}),this.builder.updateNodeData(p,M=>{M.mapLayers=W,r.extent&&(M.extent=r.extent),r.viewpoint&&(M.viewpoint=r.viewpoint)}),j&&this.builder.updateWebMapInitialState(j,{mapLayers:N}),h&&this.builder.updateWebMapInitialState(h,{mapLayers:W});const D=M=>{for(let te=M.length-1;te>=0;te--)if(M[te].visible)return M[te].title};let R=D(N.map(M=>({title:M.title,visible:M.visible})));const X=D(W.map(M=>({title:M.title,visible:M.visible})));if(!R&&Array.isArray(x?.baseMap?.baseMapLayers)){const M=x.baseMap.baseMapLayers;for(let te=M.length-1;te>=0;te--)if(M[te].visibility){R=M[te].title||R;break}}s=R&&X?`Left: ${R} â€” Right: ${X}`:void 0}}}const w=(this.layout==="spyglass","extent");if(a&&p&&!t){const g=this.builder.createSwipeNode(a,p,w,s);e.legend&&this.builder.updateNodeData(g,y=>{y.legendPinned=!0,y.legend=[a]});const c=this.builder.getStoryRootId();c&&this.builder.addChild(c,g)}const S=Qe(this.classicJson),n=e,l=this.classicJson.version||e.version||e.templateVersion,u=n.templateCreation,f=n.templateLastEdit;this.builder.addConverterMetadata(S||"Swipe",{classicMetadata:{classicTheme:{layout:this.layout,model:this.model},templateVersion:l},classicTemplateCreation:u,classicTemplateLastEdit:f}),this.emit("Built swipe block")}sanitizeSidePanelHtml(e){try{const{sanitizedHtml:t,inlineStyles:s}=Vt(e);return{sanitizedHtml:t,inlineStyles:s}}catch{return{sanitizedHtml:String(e||""),inlineStyles:[]}}}applyTheme(){try{const{themeId:e,variableOverrides:t}=rt(this.themeId,this.classicJson);this.builder.applyTheme({themeId:e,variableOverrides:t}),this.emit("Applied theme from classic settings")}catch{}}collectMedia(){return[]}getStoryMapJson(){return this.builder.getJson()}static async convert(e){return new Le(e).convert()}static async buildInlineSwipeBlock(e,t,s="swipe",i){e.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlock"});try{e.emit?.("SwipeConverter.buildInlineSwipeBlock used")}catch{}const o=String(t.dataModel||"").toUpperCase();let a,p;if(o==="TWO_WEBMAPS"){const S=[];if(Array.isArray(t.webmaps))for(const m of t.webmaps)typeof m=="string"?S.push(m):m&&typeof m=="object"&&"id"in m&&S.push(String(m.id));else t.webmap&&S.push(String(t.webmap));const[n,l]=S,u={},f={},g=typeof window<"u",c=n?g?await Le.fetchWebMapInfo(n,i):Le.fetchWebMapInfoSync(n,i):void 0,y=l?g?await Le.fetchWebMapInfo(l,i):Le.fetchWebMapInfoSync(l,i):void 0;if(c?.extent){u.extent=c.extent;const m=ke(c.extent);m&&(u.viewpoint={targetGeometry:c.center??c.extent,scale:m.scale})}if(Array.isArray(c?.operationalLayers)&&(u.mapLayers=c.operationalLayers.map(m=>({id:m.id,title:m.title||m.id,visible:!!m.visibility}))),y?.extent){f.extent=y.extent;const m=ke(y.extent);m&&(f.viewpoint={targetGeometry:y.center??y.extent,scale:m.scale})}Array.isArray(y?.operationalLayers)&&(f.mapLayers=y.operationalLayers.map(m=>({id:m.id,title:m.title||m.id,visible:!!m.visibility})));const x=n?e.addWebMapResource(n,"Web Map",u,"default"):void 0,r=l?e.addWebMapResource(l,"Web Map",f,"default"):void 0;if(x&&u&&e.updateWebMapInitialState(x,u),r&&f&&e.updateWebMapInitialState(r,f),x){const m=c?.extent||y?.extent,d=m?ke(m):void 0,A=y?.center||(y?.extent?{x:(y.extent.xmin+y.extent.xmax)/2,y:(y.extent.ymin+y.extent.ymax)/2,spatialReference:y.extent.spatialReference||{wkid:102100}}:void 0);e.updateWebMapData(x,{extent:m,center:A,zoom:d?.zoom,viewpoint:u.viewpoint,mapLayers:u.mapLayers??[],itemId:n,itemType:"Web Map",type:"default"})}if(r){const m=y?.extent?ke(y.extent):void 0,k=y?.center||(y?.extent?{x:(y.extent.xmin+y.extent.xmax)/2,y:(y.extent.ymin+y.extent.ymax)/2,spatialReference:y.extent.spatialReference||{wkid:102100}}:void 0);e.updateWebMapData(r,{extent:y?.extent,center:k,zoom:m?.zoom,viewpoint:f.viewpoint,mapLayers:f.mapLayers??[],itemId:l,itemType:"Web Map",type:"default"})}if(x&&(a=e.createWebMapNode(x,void 0)),r&&(p=e.createWebMapNode(r,void 0)),x){const m=c?.extent||y?.extent,k=y?.center||(y?.extent?{x:(y.extent.xmin+y.extent.xmax)/2,y:(y.extent.ymin+y.extent.ymax)/2,spatialReference:y.extent.spatialReference||{wkid:102100}}:void 0);e.updateWebMapData(x,{extent:m,center:k})}a&&(y?.extent||c?.extent)&&e.updateNodeData(a,m=>{const d=y?.extent||c?.extent;m.extent=d;const k=ke(d),j=(y?.center||(y?.extent?{x:(y.extent.xmin+y.extent.xmax)/2,y:(y.extent.ymin+y.extent.ymax)/2,spatialReference:y.extent.spatialReference||{wkid:102100}}:void 0))??d;k&&(m.viewpoint={targetGeometry:j,scale:k.scale});const h=!!c&&Array.isArray(c.operationalLayers)&&c.operationalLayers.some(I=>I.timeAnimation===!0);m.timeSlider=!!h,c&&Array.isArray(c.operationalLayers)&&c.operationalLayers.length&&(m.mapLayers=(c?.operationalLayers||[]).map(I=>({id:I.id,title:I.title||I.id,visible:!!I.visibility})),m.viewPlacement="extent")}),p&&y?.extent&&e.updateNodeData(p,m=>{m.extent=y.extent;const d=ke(y.extent),k=y.center||{x:(y.extent.xmin+y.extent.xmax)/2,y:(y.extent.ymin+y.extent.ymax)/2,spatialReference:y.extent.spatialReference||{wkid:102100}};d&&(m.viewpoint={targetGeometry:k??y.extent,scale:d.scale});const A=Array.isArray(y.operationalLayers)&&y.operationalLayers.some(j=>j.timeAnimation===!0);m.timeSlider=!!A,Array.isArray(y.operationalLayers)&&y.operationalLayers.length&&(m.mapLayers=y.operationalLayers.map(j=>({id:j.id,title:j.title||j.id,visible:!!j.visibility})),m.viewPlacement="extent")})}else{const S=String(t.webmap||"");try{const d=Array.isArray(t.layers)?t.layers:[];console.info("[SwipeConverter] classic values.layers (inline)",d)}catch{}const n=S?Le.fetchWebMapInfoSync(S,i):void 0,l=S?`https://www.arcgis.com/sharing/rest/content/items/${S}/data?f=json`:void 0,u=l?await Ve(i?`${l}&token=${encodeURIComponent(i)}`:l,void 0,600*1e3).catch(()=>{}):void 0,f={},g=u?.initialState?.view?.extent||u?.mapOptions?.extent||u?.extent||u?.mapOptions?.mapExtent,c=u?.initialState?.view?.center||u?.mapOptions?.center||u?.center,y=n?.extent||g,x=n?.center||c;if(y){f.extent=y;const d=ke(y);d&&(f.viewpoint={targetGeometry:x??y,scale:d.scale},f.zoom=d.zoom)}const r=S?e.addWebMapResource(S,"Web Map",f,"default"):void 0,m=S?e.addWebMapResource(S,"Web Map",f,"default"):void 0;if(r&&f&&e.updateWebMapInitialState(r,f),m&&f&&e.updateWebMapInitialState(m,f),u&&r&&e.updateWebMapData(r,{...u,itemId:S,itemType:"Web Map",type:"default"}),u&&m&&e.updateWebMapData(m,{...u,itemId:S,itemType:"Web Map",type:"default"}),r&&e.updateWebMapData(r,{extent:f.extent,center:n?.center,viewpoint:f.viewpoint,zoom:f.zoom}),m&&e.updateWebMapData(m,{extent:f.extent,center:n?.center,viewpoint:f.viewpoint,zoom:f.zoom}),r&&m){a=e.createWebMapNode(r,void 0),p=e.createWebMapNode(m,void 0);const k=(Array.isArray(t.layers)?t.layers:[]).map(C=>{if(C&&typeof C=="object"&&"id"in C){const T=C;return{id:T.id,title:T.title||T.id}}return{id:String(C),title:String(C)}}).filter(C=>C.id);try{console.info("[SwipeConverter] parsed classicLayers (inline)",k)}catch{}const A=Array.isArray(u?.operationalLayers)?u.operationalLayers:n?.operationalLayers||[],j=C=>(C||"").replace(/_\d+$/,""),h=A.map(C=>({id:C.id,title:C.title||C.id,visible:!!C.visibility}));try{console.info("[SwipeConverter][INLINE TWO_LAYERS] sourceLayers",h.map(C=>({id:C.id,title:C.title,vis:C.visible})))}catch{}const I=new Set,F=new Set;for(const C of k)I.add(j(C.id)),I.add(j(C.title||C.id)),F.add(j(C.id)),F.add(j(C.title||C.id));let L=h.map(C=>{const T=j(C.id),N=j(C.title),W=I.has(T)||I.has(N);return{id:C.id,title:C.title,visible:W?!1:C.visible}}),E=h.map(C=>{const T=j(C.id),N=j(C.title),W=F.has(T)||F.has(N);return{id:C.id,title:C.title,visible:W?!0:C.visible}});for(const C of k){const T=j(C.id),N=j(C.title||C.id);h.some(D=>j(D.id)===T||j(D.title)===N)||(L=[{id:C.id,title:C.title||C.id,visible:!1},...L],E=[{id:C.id,title:C.title||C.id,visible:!0},...E])}try{const C=L.map(N=>({id:N.id,title:N.title,vis:N.visible})),T=E.map(N=>({id:N.id,title:N.title,vis:N.visible}));console.info("[SwipeConverter][INLINE TWO_LAYERS] leftLayers after toggles",C),console.info("[SwipeConverter][INLINE TWO_LAYERS] rightLayers after toggles",T)}catch{}e.updateNodeData(a,C=>{C.mapLayers=L,f.extent&&(C.extent=f.extent),f.viewpoint&&(C.viewpoint=f.viewpoint)}),e.updateNodeData(p,C=>{C.mapLayers=E,f.extent&&(C.extent=f.extent),f.viewpoint&&(C.viewpoint=f.viewpoint)})}}const w="extent";if(!a||!p)throw new Error("SwipeConverter.buildInlineSwipeBlock: missing content nodes");return e.createSwipeNode(a,p,w)}static buildInlineSwipeBlockSync(e,t,s="swipe",i){try{e.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlockSync"})}catch{}const o=String(t.dataModel||"").toUpperCase();let a,p;if(o==="TWO_WEBMAPS"){const S=[];if(Array.isArray(t.webmaps))for(const r of t.webmaps)typeof r=="string"?S.push(r):r&&typeof r=="object"&&"id"in r&&S.push(String(r.id));else t.webmap&&S.push(String(t.webmap));const[n,l]=S,u={},f={},g=n?Le.fetchWebMapInfoSync(n,i):void 0,c=l?Le.fetchWebMapInfoSync(l,i):void 0;if(g?.extent){u.extent=g.extent;const r=ke(g.extent);r&&(u.viewpoint={targetGeometry:g.center??g.extent,scale:r.scale})}if(Array.isArray(g?.operationalLayers)&&(u.mapLayers=g.operationalLayers.map(r=>({id:r.id,title:r.title||r.id,visible:!!r.visibility}))),c?.extent){f.extent=c.extent;const r=ke(c.extent);r&&(f.viewpoint={targetGeometry:c.center??c.extent,scale:r.scale})}Array.isArray(c?.operationalLayers)&&(f.mapLayers=c.operationalLayers.map(r=>({id:r.id,title:r.title||r.id,visible:!!r.visibility})));const y=n?e.addWebMapResource(n,"Web Map",u,"default"):void 0,x=l?e.addWebMapResource(l,"Web Map",f,"default"):void 0;if(y&&u&&e.updateWebMapInitialState(y,u),x&&f&&e.updateWebMapInitialState(x,f),y){const r=g?.extent||c?.extent,m=r?ke(r):void 0,d=c?.center||(c?.extent?{x:(c.extent.xmin+c.extent.xmax)/2,y:(c.extent.ymin+c.extent.ymax)/2,spatialReference:c.extent.spatialReference||{wkid:102100}}:void 0);e.updateWebMapData(y,{extent:r,center:d,zoom:m?.zoom,viewpoint:u.viewpoint,mapLayers:u.mapLayers??[],itemId:n,itemType:"Web Map",type:"default"})}if(x){const r=c?.extent?ke(c.extent):void 0,m=c?.center||(c?.extent?{x:(c.extent.xmin+c.extent.xmax)/2,y:(c.extent.ymin+c.extent.ymax)/2,spatialReference:c.extent.spatialReference||{wkid:102100}}:void 0);e.updateWebMapData(x,{extent:c?.extent,center:m,zoom:r?.zoom,viewpoint:f.viewpoint,mapLayers:f.mapLayers??[],itemId:l,itemType:"Web Map",type:"default"})}if(y&&(a=e.createWebMapNode(y,void 0)),x&&(p=e.createWebMapNode(x,void 0)),y){const r=g?.extent||c?.extent,m=c?.center||(c?.extent?{x:(c.extent.xmin+c.extent.xmax)/2,y:(c.extent.ymin+c.extent.ymax)/2,spatialReference:c.extent.spatialReference||{wkid:102100}}:void 0);e.updateWebMapData(y,{extent:r,center:m})}a&&(c?.extent||g?.extent)&&e.updateNodeData(a,r=>{const m=c?.extent||g?.extent;r.extent=m;const d=ke(m),A=(c?.center||(c?.extent?{x:(c.extent.xmin+c.extent.xmax)/2,y:(c.extent.ymin+c.extent.ymax)/2,spatialReference:c.extent.spatialReference||{wkid:102100}}:void 0))??m;d&&(r.viewpoint={targetGeometry:A,scale:d.scale});const j=Array.isArray(g?.operationalLayers)&&g.operationalLayers.some(h=>h.timeAnimation===!0);r.timeSlider=!!j,Array.isArray(g?.operationalLayers)&&g.operationalLayers.length&&(r.mapLayers=g.operationalLayers.map(h=>({id:h.id,title:h.title||h.id,visible:!!h.visibility})),r.viewPlacement="extent")}),p&&c?.extent&&e.updateNodeData(p,r=>{r.extent=c.extent;const m=ke(c.extent),d=c.center||{x:(c.extent.xmin+c.extent.xmax)/2,y:(c.extent.ymin+c.extent.ymax)/2,spatialReference:c.extent.spatialReference||{wkid:102100}};m&&(r.viewpoint={targetGeometry:d??c.extent,scale:m.scale});const k=Array.isArray(c.operationalLayers)&&c.operationalLayers.some(A=>A.timeAnimation===!0);r.timeSlider=!!k,Array.isArray(c.operationalLayers)&&c.operationalLayers.length&&(r.mapLayers=c.operationalLayers.map(A=>({id:A.id,title:A.title||A.id,visible:!!A.visibility})),r.viewPlacement="extent")})}else{const S=String(t.webmap||""),n=S?Le.fetchWebMapInfoSync(S,i):void 0,l={},u=n?.extent,f=n?.center;if(u){l.extent=u;const y=ke(u);y&&(l.viewpoint={targetGeometry:f??u,scale:y.scale},l.zoom=y.zoom)}const g=S?e.addWebMapResource(S,"Web Map",l,"default"):void 0,c=S?e.addWebMapResource(S,"Web Map",l,"default"):void 0;if(g&&l&&e.updateWebMapInitialState(g,l),c&&l&&e.updateWebMapInitialState(c,l),g&&e.updateWebMapData(g,{extent:l.extent,center:n?.center,viewpoint:l.viewpoint,zoom:l.zoom,itemId:S,itemType:"Web Map",type:"default"}),c&&e.updateWebMapData(c,{extent:l.extent,center:n?.center,viewpoint:l.viewpoint,zoom:l.zoom,itemId:S,itemType:"Web Map",type:"default"}),g&&c){a=e.createWebMapNode(g,void 0),p=e.createWebMapNode(c,void 0);const x=(Array.isArray(t.layers)?t.layers:[]).map(h=>{if(h&&typeof h=="object"&&"id"in h){const I=h;return{id:I.id,title:I.title||I.id}}return{id:String(h),title:String(h)}}).filter(h=>h.id),r=Array.isArray(n?.operationalLayers)?n.operationalLayers.map(h=>({id:h.id,title:h.title||h.id,visible:!!h.visibility})):[],m=new Set,d=new Set,k=h=>(h||"").replace(/_\d+$/,"");for(const h of x)m.add(k(h.id)),m.add(k(h.title||h.id)),d.add(k(h.id)),d.add(k(h.title||h.id));const A=r.map(h=>{const I=k(h.id),F=k(h.title),L=m.has(I)||m.has(F);return{id:h.id,title:h.title,visible:L?!1:h.visible}}),j=r.map(h=>{const I=k(h.id),F=k(h.title),L=d.has(I)||d.has(F);return{id:h.id,title:h.title,visible:L?!0:h.visible}});e.updateNodeData(a,h=>{h.mapLayers=A,l.extent&&(h.extent=l.extent),l.viewpoint&&(h.viewpoint=l.viewpoint)}),e.updateNodeData(p,h=>{h.mapLayers=j,l.extent&&(h.extent=l.extent),l.viewpoint&&(h.viewpoint=l.viewpoint)})}}const w="extent";if(!a||!p)throw new Error("SwipeConverter.buildInlineSwipeBlockSync: missing content nodes");return e.createSwipeNode(a,p,w)}static buildInlineSwipeBlockBrowserSync(e,t,s="swipe",i){try{e.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlockBrowserSync"})}catch{}const o=String(t.dataModel||"").toUpperCase();let a,p;const w=n=>{try{if(typeof window>"u")return;const l=`https://www.arcgis.com/sharing/rest/content/items/${n}/data?f=json${i?`&token=${encodeURIComponent(i)}`:""}`,u=new XMLHttpRequest;if(u.open("GET",l,!1),u.send(null),u.status>=200&&u.status<300&&u.responseText){const f=JSON.parse(u.responseText),g=d=>d?.initialState?.view?.extent||d?.mapOptions?.extent||d?.extent||d?.mapOptions?.mapExtent||void 0,c=d=>d?.initialState?.view?.center||d?.mapOptions?.center||d?.center||void 0,y=g(f),x=c(f);let r,m;if(y){const d=ke(y);d&&(r={targetGeometry:x??y,scale:d.scale},m=d.zoom)}return{extent:y,center:x,zoom:m,viewpoint:r}}}catch{}};if(o==="TWO_WEBMAPS"){const n=[];if(Array.isArray(t.webmaps))for(const r of t.webmaps)typeof r=="string"?n.push(r):r&&typeof r=="object"&&"id"in r&&n.push(String(r.id));else t.webmap&&n.push(String(t.webmap));const[l,u]=n,f=l?w(l):void 0,g=u?w(u):void 0,c=l?e.addWebMapResource(l,"Web Map",f?{extent:f.extent,center:f.center,viewpoint:f.viewpoint,zoom:f.zoom,itemId:l,itemType:"Web Map",type:"default"}:{},"default"):void 0,y=u?e.addWebMapResource(u,"Web Map",g?{extent:g.extent,center:g.center,viewpoint:g.viewpoint,zoom:g.zoom,itemId:u,itemType:"Web Map",type:"default"}:{},"default"):void 0;c&&f&&e.updateWebMapData(c,{extent:f.extent,center:f.center,viewpoint:f.viewpoint,zoom:f.zoom,itemId:l,itemType:"Web Map",type:"default"}),y&&g&&e.updateWebMapData(y,{extent:g.extent,center:g.center,viewpoint:g.viewpoint,zoom:g.zoom,itemId:u,itemType:"Web Map",type:"default"}),c&&(a=e.createWebMapNode(c,void 0)),y&&(p=e.createWebMapNode(y,void 0));const x=r=>{!r||!g||e.updateNodeData(r,m=>{const d=!!m.extent,k=!!m.viewpoint;!d&&g.extent&&(m.extent=g.extent),!k&&g.viewpoint&&(m.viewpoint=g.viewpoint),m.viewPlacement||(m.viewPlacement="extent")})};x(a),x(p)}else{const n=String(t.webmap||""),l=n?w(n):void 0,u=n?e.addWebMapResource(n,"Web Map",l?{extent:l.extent,center:l.center,viewpoint:l.viewpoint,zoom:l.zoom,itemId:n,itemType:"Web Map",type:"default"}:{},"default"):void 0,f=n?e.addWebMapResource(n,"Web Map",l?{extent:l.extent,center:l.center,viewpoint:l.viewpoint,zoom:l.zoom,itemId:n,itemType:"Web Map",type:"default"}:{},"default"):void 0;if(u&&l&&e.updateWebMapData(u,{extent:l.extent,center:l.center,viewpoint:l.viewpoint,zoom:l.zoom,itemId:n,itemType:"Web Map",type:"default"}),f&&l&&e.updateWebMapData(f,{extent:l.extent,center:l.center,viewpoint:l.viewpoint,zoom:l.zoom,itemId:n,itemType:"Web Map",type:"default"}),u&&f){a=e.createWebMapNode(u,void 0),p=e.createWebMapNode(f,void 0);const c=(Array.isArray(t.layers)?t.layers:[]).map(r=>{if(r&&typeof r=="object"&&"id"in r){const m=r;return{id:m.id,title:m.title||m.id}}return{id:String(r),title:String(r)}}).filter(r=>r.id),y=c.map(r=>({id:r.id,title:r.title||r.id,visible:!1})),x=c.map(r=>({id:r.id,title:r.title||r.id,visible:!0}));if(e.updateNodeData(a,r=>{r.mapLayers=y}),e.updateNodeData(p,r=>{r.mapLayers=x}),l){const r=m=>{m&&e.updateNodeData(m,d=>{const k=!!d.extent,A=!!d.viewpoint;!k&&l.extent&&(d.extent=l.extent),!A&&l.viewpoint&&(d.viewpoint=l.viewpoint),d.viewPlacement||(d.viewPlacement="extent")})};r(a),r(p)}}}const S="extent";if(!a||!p)throw new Error("SwipeConverter.buildInlineSwipeBlockBrowserSync: missing content nodes");return e.createSwipeNode(a,p,S)}static fetchWebMapInfoSync(e,t){try{const s=`https://www.arcgis.com/sharing/rest/content/items/${e}/data?f=json`,i=t?`${s}&token=${encodeURIComponent(t)}`:s,o=ht(`curl -sL '${i}'`,{encoding:"utf-8"}),a=JSON.parse(o),p=y=>y?.initialState?.view?.extent||y?.mapOptions?.extent||y?.extent||y?.mapOptions?.mapExtent||void 0,w=y=>y?.initialState?.view?.center||y?.mapOptions?.center||y?.center||void 0;let S=p(a),n=w(a);if(!S||typeof S!="object"&&!Array.isArray(S)){const y=`https://www.arcgis.com/sharing/rest/content/items/${e}?f=json`,x=ht(`curl -sL '${y}'`,{encoding:"utf-8"}),r=JSON.parse(x);if(Array.isArray(r.extent)&&r.extent.length===2&&Array.isArray(r.extent[0])&&Array.isArray(r.extent[1])){const[[m,d],[k,A]]=r.extent;S={xmin:m,ymin:d,xmax:k,ymax:A,spatialReference:{wkid:4326}}}if(!n&&Array.isArray(r.center)&&r.center.length>=2){const[m,d]=r.center;n={x:m,y:d,spatialReference:{wkid:4326}}}}const l=y=>y*2003750834e-2/180,u=y=>Math.log(Math.tan((90+y)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;let f;S&&S.spatialReference&&(S.spatialReference.wkid===4326||S.spatialReference.latestWkid===4326)?f={xmin:l(S.xmin),ymin:u(S.ymin),xmax:l(S.xmax),ymax:u(S.ymax),spatialReference:{wkid:102100}}:S&&typeof S=="object"&&"xmin"in S&&(f=S);let g;n&&n.spatialReference&&n.spatialReference.wkid===4326?g={x:l(n.x),y:u(n.y),spatialReference:{wkid:102100}}:n&&n.spatialReference&&(n.spatialReference.wkid===102100||n.spatialReference.latestWkid===3857)&&(g=n);const c=Array.isArray(a.operationalLayers)?a.operationalLayers.filter(y=>y&&y.id).map(y=>({id:y.id,title:y.title,visibility:y.visibility})):[];return{extent:f,center:g,operationalLayers:c}}catch{return}}static async fetchWebMapInfo(e,t){try{const s=`https://www.arcgis.com/sharing/rest/content/items/${e}/data?f=json`,i=t?`${s}&token=${encodeURIComponent(t)}`:s,o=await Ve(i,void 0,600*1e3),a=c=>c?.initialState?.view?.extent||c?.mapOptions?.extent||c?.extent||c?.mapOptions?.mapExtent||void 0,p=c=>c?.initialState?.view?.center||c?.mapOptions?.center||c?.center||void 0;let w=a(o),S=p(o);if(!w||typeof w!="object"&&!Array.isArray(w)){const c=`https://www.arcgis.com/sharing/rest/content/items/${e}?f=json`,y=await Ve(c,void 0,600*1e3);if(Array.isArray(y.extent)&&y.extent.length===2&&Array.isArray(y.extent[0])&&Array.isArray(y.extent[1])){const[[x,r],[m,d]]=y.extent;w={xmin:x,ymin:r,xmax:m,ymax:d,spatialReference:{wkid:4326}}}if(!S&&Array.isArray(y.center)&&y.center.length>=2){const[x,r]=y.center;S={x,y:r,spatialReference:{wkid:4326}}}}const n=c=>c*2003750834e-2/180,l=c=>Math.log(Math.tan((90+c)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;let u;w&&w.spatialReference&&(w.spatialReference.wkid===4326||w.spatialReference.latestWkid===4326)?u={xmin:n(w.xmin),ymin:l(w.ymin),xmax:n(w.xmax),ymax:l(w.ymax),spatialReference:{wkid:102100}}:w&&typeof w=="object"&&"xmin"in w&&(u=w);let f;S&&S.spatialReference&&S.spatialReference.wkid===4326?f={x:n(S.x),y:l(S.y),spatialReference:{wkid:102100}}:S&&S.spatialReference&&(S.spatialReference.wkid===102100||S.spatialReference.latestWkid===3857)&&(f=S);const g=Array.isArray(o?.operationalLayers)?o.operationalLayers.filter(c=>c&&c.id).map(c=>({id:c.id,title:c.title,visibility:c.visibility})):[];return{extent:u,center:f,operationalLayers:g}}catch{return}}fetchItemTitleFallback(){try{const e=this.options.classicItemId;if(!e)return;const t=`https://www.arcgis.com/sharing/rest/content/items/${e}?f=json`,s=ht(`curl -sL '${t}'`,{encoding:"utf-8"}),i=JSON.parse(s);if(i&&typeof i.title=="string"&&i.title.trim().length)return i.title.trim()}catch{}}}var ut={};class vt extends bt{constructor(e){super(e),this.sections=[],this.imageResourceMap=new Map,this.media=new Set,this.styleBlocks=[],this.videoEmbedCount=0,this.debugLogs=[],this.BUTTON_CLASS_REGEX=/^btn-(green|orange|purple|yellow|red)$/i,this.CSS_COLOR_MAP={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgreen:"#006400",darkgrey:"#A9A9A9",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",green:"#008000",greenyellow:"#ADFF2F",grey:"#808080",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgreen:"#90EE90",lightgrey:"#D3D3D3",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},this.builder=new ot(e.themeId)}shouldSuppressMetadata(){let e="";const s=(typeof import.meta<"u"?import.meta:void 0)?.env;if(s&&typeof s.SUPPRESS_CONVERTER_METADATA<"u"&&(e=String(s.SUPPRESS_CONVERTER_METADATA)),!e&&typeof globalThis<"u"){const i=globalThis;typeof i.__SUPPRESS_CONVERTER_METADATA<"u"&&(e=String(i.__SUPPRESS_CONVERTER_METADATA))}if(!e&&typeof process<"u"){const i=ut;i&&typeof i.SUPPRESS_CONVERTER_METADATA<"u"&&(e=String(i.SUPPRESS_CONVERTER_METADATA))}return String(e||"").toLowerCase()==="true"}logDebug(e,t){try{const s=t?`${e} ${JSON.stringify(t)}`:e;this.debugLogs.push(s),typeof console<"u"&&console.debug&&console.debug("[MapJournalConverter]",e,t??"")}catch{}}logWarn(e,t){try{const s=t?`${e} ${JSON.stringify(t)}`:e;this.debugLogs.push(s),typeof console<"u"&&console.warn&&console.warn("[MapJournalConverter]",e,t??"")}catch{}}flushDebugLogs(e){if(this.debugLogs.length)try{this.shouldSuppressMetadata()||this.builder.addConverterMetadata("MapJournal",{typeConvertedTo:"storymap",converterVersion:"0.0.0",classicMetadata:{}}),this.debugLogs.length=0}catch{}}extractStructure(){const e=this.classicJson.values,t=e.story&&Array.isArray(e.story.sections)?e.story.sections:[],s=Array.isArray(e.sections)?e.sections:[];this.sections=t.length?t:s,this.emit(`Extracted ${this.sections.length} section(s)`)}convertContent(){try{const T=this.classicJson.values,N=T?.story?.map?.itemId||T?.map?.itemId||T?.webmap||ut.WEBMAP_ID,W=this.token||ut.ARCGIS_TOKEN;if(N&&W){const D=`https://www.arcgis.com/sharing/rest/content/items/${N}/data?f=json&token=${encodeURIComponent(W)}`;fetch(D).then(R=>R.ok?R.json():Promise.reject(new Error(`HTTP ${R.status}`))).then(R=>{if((Array.isArray(R?.operationalLayers)?R.operationalLayers:[]).some(te=>{if(String(te?.layerType||te?.type||"").toLowerCase()==="mapnotes")return!0;const B=te?.featureCollection,G=B?.layers?.[0]?.featureSet?.features||[],ie=Array.isArray(G)&&G.some(we=>String(we?.symbol?.type).toLowerCase()==="esripms"),_=String(te?.title||"").toLowerCase();return!!B&&(ie||_.includes("map notes"))}))if(this.emit(`Webmap ${N} contains Map Notes. Converting to CSV and saving to webmap...`),typeof window<"u")fetch("/.netlify/functions/convert-mapnotes-to-csv",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webmapId:N,token:W})}).then(B=>B.ok?B.json():B.text().then(G=>Promise.reject(new Error(G)))).then(B=>{B.changed?this.emit("CSV item created and minimal layer appended via Netlify function."):this.emit("Netlify function reported no changes (no Map Notes found).")}).catch(B=>{const G=typeof B=="object"&&B&&"message"in B?String(B.message):String(B);this.emit(`CSV conversion function failed: ${G}. Continuing conversion.`)});else{const se=Gs.resolve("converter-app/scripts/mapnotes-to-csv-item-and-add-to-webmap.ts");try{St("npx",["tsx",se],{stdio:"inherit",env:{...ut,WEBMAP_ID:N,ARCGIS_TOKEN:W}}),this.emit("Map Notes â†’ CSV conversion completed. Proceeding with content conversion.")}catch(B){const G=typeof B=="object"&&B&&"message"in B?String(B.message):String(B);this.emit(`CSV conversion execution failed: ${G}. Continuing conversion.`)}}else this.emit(`Webmap ${N} has no Map Notes; skipping CSV conversion.`)}).catch(()=>{this.emit(`Failed to fetch webmap ${N} for Map Notes detection; skipping CSV conversion.`)})}}catch(T){const N=typeof T=="object"&&T&&"message"in T?String(T.message):String(T);this.emit(`Map Notes â†’ CSV pre-step failed: ${N}. Continuing conversion.`)}this.builder.createStoryRoot();const e=this.classicJson.values;this.emit("Created story root node"),this.builder.addCoverNode(e.title||"Untitled Story",e.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode(),this.emit("Added cover/navigation/credits scaffold");const t=(e.description||e.subtitle||"")+"";this.builder.setStoryMeta(e.title||"Untitled Story",t.trim()||void 0,void 0);const i=e,o=i.settings?.layout?.id||"side",a=i.settings?.layoutOptions?.layoutCfg||{},p=a.size||"medium",w=a.position||"right",S=!!i.settings?.theme&&Object.keys(i.settings.theme||{}).length>0,n=o==="float"?"floating-panel":"docked-panel";let l="medium";(p==="small"||p==="medium"||p==="large")&&(l=p);const u=w==="left"?"start":"end",{immersiveId:f,slideId:g,narrativeId:c}=this.builder.addSidecar(n,u,l);if(this.builder.removeNode(g),this.builder.removeNode(c),this.builder.updateNode(f,T=>{T.children=[]}),e.description){const T=[this.builder.createTextNode(String(e.description),"paragraph")];this.builder.addSlideToSidecar(f,T,void 0)}const y=[],x=[],r=[];for(const T of this.sections){const N=[],W=[];let D;T.title&&(D=this.builder.createTextNode(T.title,"h3"),N.push(D)),y.push(D||"");const R=(T.content||T.description||"")+"";if(R.trim())if(typeof globalThis.DOMParser<"u")try{const se=new DOMParser().parseFromString(R,"text/html");for(const B of Array.from(se.body.children))this.handleElementOrdered(B,N,W,x,r)}catch{this.parseOrderedFallback(R,N,W,x,r)}else this.parseOrderedFallback(R,N,W,x,r);let X;const M=T.media;if(M?.image?.url){const se=this.builder.addImageResource(M.image.url);X=this.builder.createImageNode(se,M.image.caption,M.image.altText,"wide"),this.media.add(M.image.url)}else if(M?.webmap?.id){const se=M.webmap.itemType==="Web Scene"?"Web Scene":"Web Map",B=M.webmap,G=M.webmap.extent?this.normalizeExtent(M.webmap.extent):void 0;let ie,_;if(G){const Z=ke(G);Z&&(ie={targetGeometry:G,scale:Z.scale},_=Z.zoom)}const we={extent:G,mapLayers:Array.isArray(M.webmap.layers)?M.webmap.layers.map(Z=>({id:Z.id,title:Z.title||Z.id,visible:Z.visibility})):void 0,overview:B.overview?{enable:!!B.overview.enable,openByDefault:!!B.overview.openByDefault}:void 0,legend:B.legend?{enable:!!B.legend.enable,openByDefault:!!B.legend.openByDefault}:void 0,geocoder:B.geocoder?{enable:!!B.geocoder.enable}:void 0,popup:B.popup||void 0,viewpoint:ie,zoom:_},me=this.builder.addWebMapResource(M.webmap.id,se,we,"default"),Me=G?{x:(G.xmin+G.xmax)/2,y:(G.ymin+G.ymax)/2,spatialReference:G.spatialReference}:void 0;let ee;try{const be=this.classicJson?.values?.webmap,xe=this.classicJson.webmapJson,Se=xe&&Array.isArray(xe.operationalLayers)?xe.operationalLayers:[];if(Se.length&&(be===M.webmap.id||be==null))ee=Se.map(ne=>({id:ne.id,title:ne.title||ne.id,visible:!!ne.visibility}));else try{const ne=`https://www.arcgis.com/sharing/rest/content/items/${M.webmap.id}/data?f=json`,Be=this.token?`${ne}&token=${encodeURIComponent(this.token)}`:ne;if(!(typeof window<"u"))try{const Ae=St("curl",["-sL",Be],{encoding:"utf-8"}),je=JSON.parse(Ae),q=Array.isArray(je?.operationalLayers)?je.operationalLayers:[];q.length&&(ee=q.map(ce=>({...ce})))}catch{}Ve(Be,void 0,600*1e3).then(Ae=>{const je=Array.isArray(Ae?.operationalLayers)?Ae.operationalLayers:[];if(je.length){this.builder.updateWebMapData(me,{mapLayers:je.map(ce=>({id:ce.id,title:ce.title||ce.id,visible:!!ce.visibility}))});const q=new Map;if(M.webmap&&Array.isArray(M.webmap.layers))for(const ce of M.webmap.layers)q.set(ce.id,!!ce.visibility);X&&q.size>0&&this.builder.updateNodeData(X,ce=>{ce.mapLayers=je.map(pe=>{const ae=String(pe.id||""),Re=q.has(ae)?q.get(ae):!!pe.visibility;return{id:ae,title:pe.title||ae,visible:Re}})})}}).catch(()=>{})}catch{}}catch{}this.builder.updateWebMapData(me,{extent:G,center:Me,mapLayers:ee??(Array.isArray(M.webmap.layers)?M.webmap.layers.map(Z=>({id:Z.id,title:Z.title||Z.id,visible:!!Z.visibility})):void 0),viewpoint:ie,zoom:_}),X=this.builder.createWebMapNode(me,T.title?`${se==="Web Scene"?"Scene":"Map"}: ${T.title}`:void 0),this.media.add(M.webmap.id),X&&this.builder.updateNodeData(X,Z=>{if(G&&(Z.extent=G),Array.isArray(ee)&&ee.length){const be=new Map;if(M.webmap&&Array.isArray(M.webmap.layers))for(const xe of M.webmap.layers)be.set(xe.id,!!xe.visibility);be.size>0&&(Z.mapLayers=ee.map(xe=>{const Se=String(xe.id||""),ne=be.has(Se)?be.get(Se):!!xe.visible;return{id:Se,title:xe.title||Se,visible:ne}}))}else M.webmap&&Array.isArray(M.webmap.layers)&&(Z.mapLayers=M.webmap.layers.map(be=>({id:be.id,title:be.title||be.id,visible:!!be.visibility})));ie&&(Z.viewpoint=ie),typeof _=="number"&&(Z.zoom=_),B.overview&&B.overview.enable&&(Z.overview={openByDefault:!!B.overview.openByDefault}),B.legend&&B.legend.enable&&(Z.legend={openByDefault:!!B.legend.openByDefault})})}else if(M?.video?.url){const se=this.detectVideoProvider(M.video.url);if(se.provider!=="unknown")X=this.builder.createVideoEmbedNode(M.video.url,se.provider,se.id,M.video.caption,M.video.caption,void 0,M.video.altText),this.videoEmbedCount++;else{const B=this.builder.addVideoResource(M.video.url,"uri");X=this.builder.createVideoNode(B,M.video.caption,M.video.altText),this.media.add(M.video.url)}}else if(M?.webpage?.url){const se=this.tryBuildSwipeNodeFromUrl(M.webpage.url);se?X=se:X=this.builder.createEmbedNode(M.webpage.url,M.webpage.caption,M.webpage.title,M.webpage.description,M.webpage.altText)}const{slideId:te}=this.builder.addSlideToSidecar(f,N,X);if(Array.isArray(T.contentActions)&&T.contentActions.length){const se=new Map(T.contentActions.map(B=>[B.id,B]));for(const B of W){const G=se.get(B.actionId);if(!G||G.type!=="media"||!G.media)continue;let ie;const _=G.media;if(_.webmap?.id){const we=_.webmap.itemType==="Web Scene"?"Web Scene":"Web Map";let me,Me;const ee=_.webmap.extent?this.normalizeExtent(_.webmap.extent):void 0,Z=_.webmap;if(ee){const he=ke(ee);he&&(me={targetGeometry:ee,scale:he.scale},Me=he.zoom)}const be={extent:ee,mapLayers:Array.isArray(_.webmap.layers)?_.webmap.layers.map(he=>({id:he.id,title:he.title||he.id,visible:he.visibility})):void 0,overview:Z.overview?{enable:!!Z.overview.enable,openByDefault:!!Z.overview.openByDefault}:void 0,legend:Z.legend?{enable:!!Z.legend.enable,openByDefault:!!Z.legend.openByDefault}:void 0,viewpoint:me,zoom:Me},xe=this.builder.addWebMapResource(_.webmap.id,we,be,"default"),Se=ee?{x:(ee.xmin+ee.xmax)/2,y:(ee.ymin+ee.ymax)/2,spatialReference:ee.spatialReference}:void 0;let ne;try{const he=this.classicJson.webmapJson,Ae=he&&Array.isArray(he.operationalLayers)?he.operationalLayers:[],q=this.classicJson?.values?.webmap;if(Ae.length&&(q===_.webmap.id||q==null))ne=Ae.map(ce=>({...ce}));else{const ce=`https://www.arcgis.com/sharing/rest/content/items/${_.webmap.id}/data?f=json`,pe=this.token?`${ce}&token=${encodeURIComponent(this.token)}`:ce;if(!(typeof window<"u"))try{const Re=St("curl",["-sL",pe],{encoding:"utf-8"}),_e=JSON.parse(Re),Ue=Array.isArray(_e?.operationalLayers)?_e.operationalLayers:[];Ue.length&&(ne=Ue.map(st=>({...st})))}catch{}Ve(pe,void 0,600*1e3).then(Re=>{const _e=Array.isArray(Re?.operationalLayers)?Re.operationalLayers:[];_e.length&&(ne=_e.map(Ue=>({...Ue})))}).catch(()=>{})}}catch{}this.builder.updateWebMapData(xe,{extent:ee,center:Se,mapLayers:ne??(Array.isArray(_.webmap.layers)?_.webmap.layers.map(he=>({id:he.id,title:he.title||he.id,visible:he.visibility})):void 0),viewpoint:me,zoom:Me});try{const he=`https://www.arcgis.com/sharing/rest/content/items/${_.webmap.id}/data?f=json`,Ae=this.token?`${he}&token=${encodeURIComponent(this.token)}`:he;Ve(Ae,void 0,600*1e3).then(je=>{const q=Array.isArray(je?.operationalLayers)?je.operationalLayers:[];if(q.length){this.builder.updateWebMapData(xe,{mapLayers:q.map(pe=>({...pe}))});const ce=new Map;if(_.webmap&&Array.isArray(_.webmap.layers))for(const pe of _.webmap.layers)ce.set(pe.id,!!pe.visibility);ie&&this.builder.updateNodeData(ie,pe=>{pe.mapLayers=q.map(ae=>{const Re=String(ae.id||""),_e=ce.has(Re)?ce.get(Re):!1;return{...ae,visible:_e}})})}}).catch(()=>{})}catch{}ie=this.builder.createWebMapNode(xe,B.text.includes("Map")||B.text.includes("Scene")?B.text:void 0);const Be=this.builder.getJson();if(ie){const he=Be.nodes[ie],Ae=he&&"data"in he?he.data:void 0;if(he&&Ae){if(Array.isArray(_.webmap.layers)){const je=new Map;for(const q of _.webmap.layers)je.set(q.id,!!q.visibility);Array.isArray(ne)&&ne.length?Ae.mapLayers=ne.map(q=>{const ce=String(q.id||""),pe=je.has(ce)?je.get(ce):!1;return{...q,visible:pe}}):Ae.mapLayers=_.webmap.layers.map(q=>({id:q.id,title:q.title||q.id,visible:q.visibility}))}ee&&(Ae.extent=ee),me&&(Ae.viewpoint=me),typeof Me=="number"&&(Ae.zoom=Me),Z.overview&&Z.overview.enable&&(Ae.overview={openByDefault:!!Z.overview.openByDefault}),Z.legend&&Z.legend.enable&&(Ae.legend={openByDefault:!!Z.legend.openByDefault})}}this.media.add(_.webmap.id)}else if(_.image?.url){const we=this.builder.addImageResource(_.image.url);ie=this.builder.createImageNode(we,_.image.caption,_.image.altText,"standard"),this.media.add(_.image.url)}else if(_.video?.url){const we=this.detectVideoProvider(_.video.url);if(we.provider!=="unknown")ie=this.builder.createVideoEmbedNode(_.video.url,we.provider,we.id,_.video.caption,_.video.caption,void 0,_.video.altText),this.videoEmbedCount++;else{const me=this.builder.addVideoResource(_.video.url,"uri");ie=this.builder.createVideoNode(me,_.video.caption,_.video.altText),this.media.add(_.video.url)}}else if(_.webpage?.url){const we=this.tryBuildSwipeNodeFromUrl(_.webpage.url);we?ie=we:ie=this.builder.createEmbedNode(_.webpage.url,_.webpage.caption,_.webpage.title,_.webpage.description,_.webpage.altText)}if(ie){this.builder.updateNode(B.buttonNodeId,ee=>{const Z=ee;Z.dependents||(Z.dependents={}),Z.dependents.actionMedia=ie;const xe=this.builder.getJson().nodes[ie];if(xe?.type==="swipe"&&xe.data&&xe.data.contents){const Se=xe.data.contents,ne=Se[0],Be=Se[1];ne&&(Z.dependents.actionMedia_content_0=ne),Be&&(Z.dependents.actionMedia_content_1=Be)}});const me=this.builder.getJson().nodes[te],Me=me&&"children"in me?me.children:void 0;Array.isArray(Me)&&(Me.includes(ie)||this.builder.addChild(te,ie));try{const ee=this.builder.getJson(),Z=ee.nodes[ie],be=X?ee.nodes[X]:void 0;if(Z?.type==="swipe"&&be&&"data"in be&&be.data){const xe=Z.data?.contents||{},Se=xe[0],ne=xe[1],Be=Se?ee.nodes[Se]:void 0,he=ne?ee.nodes[ne]:void 0,Ae=be.data||{},je=Ae.extent;let ce=Ae.viewpoint;if(!ce&&je){const ae=ke(je);ae&&(ce={targetGeometry:je,scale:ae.scale})}const pe=ae=>{ae&&this.builder.updateNodeData(ae,Re=>{const _e=!!Re.extent,Ue=!!Re.viewpoint;!_e&&je&&(Re.extent=je),!Ue&&ce&&(Re.viewpoint=ce),Re.viewPlacement||(Re.viewPlacement="extent")})};pe(Se),pe(ne)}}catch{}this.builder.registerReplaceMediaAction(B.buttonNodeId,te,ie)}}}}const m=new Map;this.sections.forEach(T=>{(T.contentActions||[]).forEach(N=>{N.type==="navigate"&&typeof N.index=="number"&&m.set(N.id,N.index)})});for(const T of x){const N=m.get(T.actionId);if(typeof N=="number"){const W=y[N];W&&this.builder.setButtonLink(T.buttonNodeId,`#ref-${W}`)}}const d=this.builder.getJson();for(const T of r){const N=m.get(T.actionId);if(typeof N!="number")continue;const W=y[N];if(!W)continue;const D=d.nodes[T.richNodeId];if(D&&D.type==="text"&&"data"in D&&D.data){const R=D.data;if(!R.preserveHtml)continue;const X=R.text,M=new RegExp(`<a([^>]*data-storymaps=["']${T.actionId}["'][^>]*)>`,"i"),te=X.replace(M,(se,B)=>/href=/.test(B)?se:`<a${B} href="#ref-${W}" target="_self">`);R.text=te}}const k=i.settings?.theme||null;if(!S&&o==="float"){const T=this.builder.getJson();for(const R of Object.values(T.nodes))if(R&&R.type==="immersive-narrative-panel"){const X=R.data||{};X.position="end",X.size="medium",R.data=X}const N={baseThemeId:"obsidian",forcedByMissingClassicTheme:!0,variableOverridesApplied:[],layoutMapping:{classicLayoutId:o,classicSize:p,classicPosition:w,mappedSubtype:n,mappedNarrativePanelSize:"medium",mappedNarrativePanelPosition:"end"}};try{const R=rt(this.themeId,this.classicJson);this.builder.applyTheme({themeId:R.themeId,variableOverrides:R.variableOverrides})}catch{this.builder.applyTheme({themeId:"obsidian",variableOverrides:{}})}N.videoEmbeds=this.videoEmbedCount;const W=Qe(this.classicJson),D=this.classicJson.values||{};this.builder.addConverterMetadata(W||"MapJournal",{classicMetadata:{classicTheme:k,mappingDecisions:N,templateVersion:this.classicJson.version||this.classicJson.values?.version||this.classicJson.values?.templateVersion},classicTemplateCreation:D.templateCreation,classicTemplateLastEdit:D.templateLastEdit}),this.emit("Applied fallback obsidian theme (no classic theme present; float layout)");return}const{theme:A,decisions:j}=Qt(this.classicJson);j.layoutMapping={classicLayoutId:o,classicSize:p,classicPosition:w,mappedSubtype:n,mappedNarrativePanelSize:l,mappedNarrativePanelPosition:u};const h={};if(Array.isArray(j.variableOverridesApplied))for(const T of j.variableOverridesApplied)A.variables&&T in A.variables&&(h[T]=String(A.variables[T]));if(this.styleBlocks.length)try{const T=this.styleBlocks.join(`

`);let N=T.split("").map(R=>R.charCodeAt(0)<32?" ":R).join("");N=N.replace(/\r/g,"").replace(/\t/g," "),N=N.replace(/\n{3,}/g,`

`);const W=T.length,D=N.length>6e3?N.slice(0,6e3)+`
/*__CSS_TRUNCATED__*/`:N;j.customCss={blockCount:this.styleBlocks.length,approxBytes:W,combined:D}}catch{}const I=rt(this.themeId,this.classicJson),F={...I.variableOverrides||{},...h};if(this.builder.applyTheme({themeId:I.themeId,variableOverrides:F}),j.videoEmbeds=this.videoEmbedCount,!this.shouldSuppressMetadata()){const T=Qe(this.classicJson),N=this.classicJson.values||{};this.builder.addConverterMetadata(T||"MapJournal",{classicMetadata:{classicTheme:k,mappingDecisions:j,templateVersion:this.classicJson.version||this.classicJson.values?.version||this.classicJson.values?.templateVersion},classicTemplateCreation:N.templateCreation,classicTemplateLastEdit:N.templateLastEdit})}const L=this.builder.getJson().nodes[f],E=L&&"children"in L?L.children:void 0,C=Array.isArray(E)?E.length:0;this.emit(`Built single sidecar with ${C} slide(s); theme overrides applied (${Object.keys(h).length})`)}applyTheme(){this.emit("applyTheme skipped (handled in convertContent)")}collectMedia(){return this.emit(`Collected ${this.media.size} media URL(s)`),Array.from(this.media)}getStoryMapJson(){return this.builder.getJson()}static async convert(e){return await new vt(e).convert()}normalizeExtent(e){if(!e)return e;const t=e.spatialReference?.wkid||e.spatialReference?.latestWkid||e.spatialReference?.wkt;if(!(t===4326||t==="WGS84"||t==="WGS 84")||[e.xmin,e.ymin,e.xmax,e.ymax].some(a=>typeof a!="number"||!isFinite(a)))return e;const i=a=>a*2003750834e-2/180,o=a=>Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;return{xmin:i(e.xmin),ymin:o(e.ymin),xmax:i(e.xmax),ymax:o(e.ymax),spatialReference:{wkid:102100,latestWkid:3857}}}extractImageEntries(e){const t=[],s=/<figure[^>]*>([\s\S]*?)<\/figure>/gi;let i;for(;(i=s.exec(e))!==null;){const p=i[1],w=/<img[^>]*>/i.exec(p)?.[0];if(!w)continue;const S=/src=["']([^"'>]+)["']/i.exec(w);if(!S)continue;const n=/alt=["']([^"'>]*)["']/i.exec(w),l=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(p),u=l?this.stripHtml(l[1]).trim():void 0,f=S[1];t.some(g=>g.src===f)||t.push({src:f,alt:n?n[1]:void 0,caption:u})}const o=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let a;for(;(a=o.exec(e))!==null;){const p=a[0],w=a[1];if(!t.some(S=>S.src===w)){const S=/alt=["']([^"'>]*)["']/i.exec(p);t.push({src:w,alt:S?S[1]:void 0})}}return t}stripHtml(e){return e.replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/\s+/g," ").trim()}normalizeButtonLabel(e){return String(e??"").replace(/\u00A0|&nbsp;/g," ").replace(/^[>â€ºÂ»\s]+/,"").trim()}extractParagraphBlocks(e){const t=[],s=/<p[^>]*>([\s\S]*?)<\/p>/gi;let i;for(;(i=s.exec(e))!==null;){const o=i[1],a=this.stripHtml(o);a&&t.push(a)}if(!t.length){const o=this.stripHtml(e);o&&t.push(o)}return t}extractActionAnchorLabel(e,t){const i=new RegExp(`<a[^>]*data-storymaps=["']${t}["'][^>]*>([\\s\\S]*?)</a>`,"i").exec(e);if(i)return this.stripHtml(i[1])}isNonEmptyHtmlSegment(e){if(!e)return!1;const t=/data-storymaps=/i.test(e),s=e.replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/gi," ").replace(/\u00A0/g," ").trim();return t||s.length>0}colorToHex(e){if(!e)return;if(e=e.trim(),e=e.replace(/!important$/i,"").trim(),/^#([0-9a-f]{3})$/i.test(e)){const o=e[1],a=e[2],p=e[3];return`#${o}${o}${a}${a}${p}${p}`.toUpperCase()}if(/^#([0-9a-f]{6})$/i.test(e))return e.toUpperCase();const t=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i.exec(e);if(t){const[o,a,p]=t.slice(1,4).map(w=>Math.max(0,Math.min(255,parseInt(w,10))));return`#${o.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}`.toUpperCase()}const s=/rgb-?(\d+)-?(\d+)-?(\d+)/i.exec(e);if(s){const[o,a,p]=s.slice(1,4).map(w=>Math.max(0,Math.min(255,parseInt(w,10))));return`#${o.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}`.toUpperCase()}const i=e.toLowerCase();if(this.CSS_COLOR_MAP[i])return this.CSS_COLOR_MAP[i].toUpperCase()}processHtmlColorsPreserveHtml(e){if(!e||!/<[^>]+style=/i.test(e))return e;try{const s=new DOMParser().parseFromString(`<wrapper>${e}</wrapper>`,"text/html").querySelector("wrapper");if(!s)return e;for(const i of Array.from(s.querySelectorAll("[style]"))){const o=i.getAttribute("style")||"",a=/color\s*:\s*([^;]+)(;?)/i.exec(o);if(!a)continue;const p=a[1].trim(),w=this.colorToHex(p);if(!w)continue;const S=`sm-text-color-${w.substring(1)}`;let n=o.replace(a[0],"").trim();n=n.replace(/;;+/g,";"),n=n.replace(/^;|;$/g,"").trim(),n?i.setAttribute("style",n):i.removeAttribute("style");const l=i.getAttribute("class");l?i.setAttribute("class",l+" "+S):i.setAttribute("class",S)}return s.innerHTML}catch{return e.replace(/(<[^>]+style=["'][^"'>]*color\s*:[^"'>]+["'][^>]*>)/gi,t=>{const s=/style=["']([^"'>]+)["']/i.exec(t);if(!s)return t;let i=s[1];const o=/color\s*:\s*([^;]+)(;?)/i.exec(i);if(!o)return t;const a=o[1].trim(),p=this.colorToHex(a);if(!p)return t;const w=`sm-text-color-${p.substring(1)}`;i=i.replace(o[0],"").trim(),i=i.replace(/;;+/g,";").replace(/^;|;$/g,"").trim();let S=t.replace(s[0],i?`style="${i}"`:"");return/class=["']/i.test(S)?S=S.replace(/class=["']([^"'>]+)["']/i,(n,l)=>`class="${l} ${w}"`):S=S.replace(/<([^\s>]+)/,(n,l)=>`<${l} class="${w}"`),S})}}handleElementOrdered(e,t,s,i,o){if(e.tagName==="STYLE"){const p=e.textContent||"";p.trim()&&this.styleBlocks.push(p.trim());return}if(e.tagName==="FIGURE"){const p=e.querySelector("img");if(p?.src){const w=this.builder.addImageResource(p.src);t.push(this.builder.createImageNode(w,e.querySelector("figcaption")?.textContent?.trim()||void 0,p.alt||void 0,"standard")),this.media.add(p.src)}return}if(e.tagName==="IMG"){if(e.getAttribute("src")){const p=e.getAttribute("src"),w=this.builder.addImageResource(p);t.push(this.builder.createImageNode(w,void 0,e.getAttribute("alt")||void 0,"standard")),this.media.add(p)}return}if(e.tagName==="P"||e.tagName==="DIV"){const p=new DOMParser().parseFromString(`<wrapper>${e.innerHTML}</wrapper>`,"text/html"),w=p.querySelector("wrapper");for(const l of Array.from(w.querySelectorAll("img[src]"))){const u=l.getAttribute("src"),f=l.getAttribute("alt")||void 0,g=this.builder.addImageResource(u),c=this.builder.createImageNode(g,void 0,f,"standard");this.media.add(u),l.replaceWith(p.createTextNode(`%%IMG:${c}%%`))}for(const l of Array.from(w.querySelectorAll("a[data-storymaps]"))){const u=l.getAttribute("data-storymaps"),f=l.getAttribute("data-storymaps-type")||"",g=(l.textContent||"View").trim(),c=this.normalizeButtonLabel(g),r=(l.getAttribute("class")||"").split(/\s+/).filter(Boolean).some(m=>this.BUTTON_CLASS_REGEX.test(m));if(f==="media"){const m=this.builder.createActionButtonNode(c,"wide");s.push({actionId:u,text:c,buttonNodeId:m}),l.replaceWith(p.createTextNode(`%%ACTION_BTN:${m}%%`))}else if(f==="navigate")if(r){const m=this.builder.createButtonNode(c,"wide");i.push({actionId:u,buttonNodeId:m}),l.replaceWith(p.createTextNode(`%%NAV_BTN:${m}%%`))}else o.push({actionId:u,richNodeId:""})}const n=w.innerHTML.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%)/);for(const l of n)if(l)if(/^%%IMG:/.test(l)){const u=l.replace(/^%%IMG:/,"").replace(/%%$/,"");t.push(u)}else if(/^%%ACTION_BTN:/.test(l)){const u=l.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,"");t.push(u)}else if(/^%%NAV_BTN:/.test(l)){const u=l.replace(/^%%NAV_BTN:/,"").replace(/%%$/,"");t.push(u)}else{if(!this.isNonEmptyHtmlSegment(l))continue;const u=this.processHtmlColorsPreserveHtml(l).replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),f=u.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(f&&f.length>1)for(const c of f){const y=c.replace(/^<p[^>]*>|<\/p>$/gi,"").trim().replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");if(!y.replace(/&nbsp;|\s+/g,"").trim())continue;const r=this.builder.createRichTextNode(y,"paragraph");if(c.includes("data-storymaps"))for(const m of o)!m.richNodeId&&c.includes(`data-storymaps="${m.actionId}"`)&&(m.richNodeId=r);t.push(r)}else{let c=u;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(u.trim())&&(c=u.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim()),c=c.replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");const x=this.builder.createRichTextNode(c,"paragraph");if(u.includes("data-storymaps"))for(const r of o)!r.richNodeId&&u.includes(`data-storymaps="${r.actionId}"`)&&(r.richNodeId=x);t.push(x)}}return}if(e.tagName==="IFRAME"){const p=e.getAttribute("src");if(p){const w=this.parseSwipeAppId(p);if(w&&typeof window>"u"){const n=this.fetchClassicSwipeDataSync(w);if(n&&n.values){const l=this.parseSwipeLayoutFromUrl(p)||(String(n.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const u=typeof window<"u",f=!!n.values;this.logDebug("iframe (DOM) -> attempting inline swipe build",{appId:w,layout:l,env:u?"browser":"node",hasValues:f});const g=Le.buildInlineSwipeBlockSync(this.builder,n.values,l,this.token);t.push(g),this.logDebug("iframe (DOM) -> inline swipe built",{swipeNodeId:g}),this.flushDebugLogs("embedded-swipe");return}catch(u){this.logWarn("iframe (DOM) -> inline swipe build failed, using embed",{appId:w,error:u?.message}),this.flushDebugLogs("embedded-swipe")}}}const S=this.detectVideoProvider(p);S.provider!=="unknown"?(t.push(this.builder.createVideoEmbedNode(p,S.provider,S.id)),this.videoEmbedCount++,this.logDebug("iframe (DOM) -> video embed",S),this.flushDebugLogs("embedded-swipe")):(t.push(this.builder.createEmbedNode(p)),this.logDebug("iframe (DOM) -> link embed",{src:p}),this.flushDebugLogs("embedded-swipe"))}return}const a=e.textContent?.trim();a&&t.push(this.builder.createTextNode(a,"paragraph"))}parseOrderedFallback(e,t,s,i,o){const a=/<style[^>]*>([\s\S]*?)<\/style>/gi;let p;for(;(p=a.exec(e))!==null;){const n=p[1].trim();n&&this.styleBlocks.push(n)}const w=/(<figure[\s\S]*?<\/figure>)|(<img[^>]*>)|(<p[\s\S]*?<\/p>)|(<div[\s\S]*?<\/div>)|(<iframe[\s\S]*?<\/iframe>)/gi;let S;for(;(S=w.exec(e))!==null;){const n=S[0],l=n.slice(0,10).toLowerCase();if(l.startsWith("<style")){const f=n.replace(/^<style[^>]*>|<\/style>$/gi,"").trim();f&&this.styleBlocks.push(f);continue}if(l.startsWith("<figure")){const f=/<img[^>]*>/i.exec(n)?.[0];if(f){const g=/src=["']([^"'>]+)["']/i.exec(f)?.[1];if(g){const c=/alt=["']([^"'>]*)["']/i.exec(f)?.[1],y=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(n)?.[1],x=this.builder.addImageResource(g);t.push(this.builder.createImageNode(x,y?this.stripHtml(y).trim():void 0,c,"standard")),this.media.add(g)}}continue}if(l.startsWith("<iframe")){const f=/src=["']([^"'>]+)["'][^>]*>/i.exec(n)?.[1];if(f){const g=this.parseSwipeAppId(f);if(g&&typeof window>"u"){const y=this.fetchClassicSwipeDataSync(g);if(y&&y.values){const x=this.parseSwipeLayoutFromUrl(f)||(String(y.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const r=typeof window<"u",m=!!y.values;this.logDebug("iframe (regex) -> attempting inline swipe build",{appId:g,layout:x,env:r?"browser":"node",hasValues:m});const d=Le.buildInlineSwipeBlockSync(this.builder,y.values,x,this.token);t.push(d);continue}catch(r){this.logWarn("iframe (regex) -> inline swipe build failed",{appId:g,error:r?.message})}}}const c=this.detectVideoProvider(f);c.provider!=="unknown"?(t.push(this.builder.createVideoEmbedNode(f,c.provider,c.id)),this.videoEmbedCount++):t.push(this.builder.createEmbedNode(f))}continue}if(l.startsWith("<p")||l.startsWith("<div")){const f=n.replace(/^<p[^>]*>|^<div[^>]*>|<\/p>$|<\/div>$/gi,"");let g=f;const c=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let y;for(;(y=c.exec(f))!==null;){const A=y[0],j=y[1],h=/alt=["']([^"'>]*)["']/i.exec(A)?.[1],I=this.builder.addImageResource(j),F=this.builder.createImageNode(I,void 0,h,"standard");this.media.add(j),g=g.replace(A,`%%IMG:${F}%%`)}const x=/<a[^>]*data-storymaps=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/a>/gi;let r;for(;(r=x.exec(f))!==null;){const A=r[0],j=r[1],h=/data-storymaps-type=["']([^"'>]+)["']/i.exec(A)?.[1]||"",I=A.replace(/<a[^>]*>|<\/a>/gi,""),F=this.stripHtml(I).trim()||"View",L=this.normalizeButtonLabel(F),C=(/class=["']([^"'>]+)["']/i.exec(A)?.[1]||"").split(/\s+/).some(T=>this.BUTTON_CLASS_REGEX.test(T));if(h==="media"){const T=this.builder.createActionButtonNode(L,"wide");s.push({actionId:j,text:L,buttonNodeId:T}),g=g.replace(A,`%%ACTION_BTN:${T}%%`)}else if(h==="navigate")if(C){const T=this.builder.createButtonNode(L,"wide");i.push({actionId:j,buttonNodeId:T}),g=g.replace(A,`%%NAV_BTN:${T}%%`)}else o.push({actionId:j,richNodeId:""})}const m=/<iframe[^>]*src=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/iframe>/gi;let d;for(;(d=m.exec(f))!==null;){const A=d[0],j=d[1];let h;const I=this.parseSwipeAppId(j);if(I&&typeof window>"u"){const F=this.fetchClassicSwipeDataSync(I);if(F&&F.values){const L=this.parseSwipeLayoutFromUrl(j)||(String(F.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{this.logDebug("iframe (regex) -> attempting inline swipe build",{appId:I,layout:L}),h=Le.buildInlineSwipeBlockSync(this.builder,F.values,L,this.token),this.logDebug("iframe (regex) -> inline swipe built",{replacementId:h}),this.flushDebugLogs("embedded-swipe")}catch{this.logWarn("iframe (regex) -> inline swipe build failed, will fallback",{appId:I}),this.flushDebugLogs("embedded-swipe")}}}if(!h){const F=this.detectVideoProvider(j);F.provider!=="unknown"?(h=this.builder.createVideoEmbedNode(j,F.provider,F.id),this.videoEmbedCount++,this.logDebug("iframe (regex) -> video embed fallback",F),this.flushDebugLogs("embedded-swipe")):(h=this.builder.createEmbedNode(j),this.logDebug("iframe (regex) -> link embed fallback",{src:j}),this.flushDebugLogs("embedded-swipe"))}g=g.replace(A,`%%IFRAME_NODE:${h}%%`)}const k=g.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%|%%IFRAME_NODE:[^%]+%%)/);for(const A of k)if(A)if(/^%%IMG:/.test(A))t.push(A.replace(/^%%IMG:/,"").replace(/%%$/,""));else if(/^%%ACTION_BTN:/.test(A))t.push(A.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,""));else if(/^%%NAV_BTN:/.test(A))t.push(A.replace(/^%%NAV_BTN:/,"").replace(/%%$/,""));else if(/^%%IFRAME_NODE:/.test(A))t.push(A.replace(/^%%IFRAME_NODE:/,"").replace(/%%$/,""));else{if(!this.isNonEmptyHtmlSegment(A))continue;const j=this.processHtmlColorsPreserveHtml(A).replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),h=j.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(h&&h.length>1)for(const F of h){const L=F.replace(/^<p[^>]*>|<\/p>$/gi,"").trim().replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");if(!L.replace(/&nbsp;|\s+/g,"").trim())continue;const C=this.builder.createRichTextNode(L,"paragraph");if(F.includes("data-storymaps"))for(const T of o)!T.richNodeId&&F.includes(`data-storymaps="${T.actionId}"`)&&(T.richNodeId=C);t.push(C)}else{let F=j;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(j.trim())&&(F=j.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim()),F=F.replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");const E=this.builder.createRichTextNode(F,"paragraph");if(j.includes("data-storymaps"))for(const C of o)!C.richNodeId&&j.includes(`data-storymaps="${C.actionId}"`)&&(C.richNodeId=E);t.push(E)}}continue}const u=this.stripHtml(n).trim();u&&t.push(this.builder.createTextNode(u,"paragraph"))}}detectVideoProvider(e){if(!e)return{provider:"unknown"};const t=/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([A-Za-z0-9_-]{6,})(?:[&#?].*)?$/i.exec(e);if(t)return{provider:"youtube",id:t[1]};const s=/(?:vimeo\.com\/(?:video\/)?)(\d+)(?:[&#?].*)?$/i.exec(e);return s?{provider:"vimeo",id:s[1]}:{provider:"unknown"}}parseSwipeAppId(e){try{const t=new URL(e,"https://example.com");return t.searchParams.get("appid")||t.searchParams.get("appId")||void 0}catch{return/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(e)?.[1]}}parseSwipeLayoutFromUrl(e){try{const s=(new URL(e,"https://example.com").searchParams.get("layout")||"").toLowerCase();return s.includes("spyglass")?"spyglass":s.includes("swipe")?"swipe":void 0}catch{return}}fetchClassicSwipeDataSync(e){try{const t=`https://www.arcgis.com/sharing/rest/content/items/${e}/data?f=json`,s=this.token?`${t}&token=${encodeURIComponent(this.token)}`:t,i=ht(`curl -sL '${s}'`,{encoding:"utf-8"});return JSON.parse(i)}catch{return}}fetchClassicSwipeDataProvided(e){try{const t=this.classicJson,s=this.classicJson.values,i=t.__embeddedSwipes||s?.__embeddedSwipes||void 0,o=i?i[e]:void 0;if(o&&typeof o=="object")return o}catch{}}tryBuildSwipeNodeFromUrl(e){const t=this.parseSwipeAppId(e);if(!t)return;const s=typeof window<"u",i=s?this.fetchClassicSwipeDataProvided(t):this.fetchClassicSwipeDataSync(t);if(s&&(!i||!i.values))try{const p=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,w=this.token?`${p}&token=${encodeURIComponent(this.token)}`:p;Ve(w,void 0,600*1e3)}catch{}if(!i||!i.values)return;const a=this.parseSwipeLayoutFromUrl(e)||(String(i.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{this.logDebug("tryBuildSwipeNodeFromUrl: attempting inline swipe build from",{url:e});const p=typeof window<"u"?Le.buildInlineSwipeBlockBrowserSync(this.builder,i.values,a,this.token):Le.buildInlineSwipeBlockSync(this.builder,i.values,a,this.token);try{const w=this.builder.getJson(),S=w.nodes[p];if(S&&S.type==="swipe"){let n=S.data?.contents||{};const l=[];for(const g of["0","1"]){const c=n[g];(!c||!w.nodes[c])&&l.push(g)}if(l.length){const g=i.values,c=String(g.dataModel||"").toUpperCase(),y={...n};if(c==="TWO_LAYERS"){const x=String(g.webmap||"");if(x){const r=this.builder.addWebMapResource(x,"Web Map",{},"default"),m=Array.isArray(g.layers)?g.layers:[],d=this.builder.createWebMapNode(r,void 0),k=this.builder.createWebMapNode(r,void 0);if(m.length>=2){const A=m[0],j=m[1];this.builder.updateNodeData(d,h=>{h.mapLayers=[{id:A.id,title:A.title||A.id,visible:!0},{id:j.id,title:j.title||j.id,visible:!1}]}),this.builder.updateNodeData(k,h=>{h.mapLayers=[{id:A.id,title:A.title||A.id,visible:!1},{id:j.id,title:j.title||j.id,visible:!0}]})}y[0]=d,y[1]=k}}else{const x=[];if(Array.isArray(g.webmaps))for(const d of g.webmaps)typeof d=="string"?x.push(d):d&&typeof d=="object"&&"id"in d&&x.push(String(d.id));else g.webmap&&x.push(String(g.webmap));const[r,m]=x;if(r){const d=this.builder.addWebMapResource(r,"Web Map",{},"default");y[0]=this.builder.createWebMapNode(d,void 0)}if(m){const d=this.builder.addWebMapResource(m,"Web Map",{},"default");y[1]=this.builder.createWebMapNode(d,void 0)}}this.builder.updateNode(p,x=>{const r=x.data||{};r.contents=y,x.data=r}),n=y,this.logDebug("swipe contents rebuilt due to missing keys",{missingKeys:l})}const u=n[0],f=n[1];if(!u||!f||!w.nodes[u]||!w.nodes[f]){try{this.builder.removeNode(p)}catch{}this.logWarn("dropping inline swipe; invalid contents",{c0:u,c1:f}),this.flushDebugLogs("embedded-swipe");return}this.logDebug("inline swipe built successfully",{swipeNodeId:p,contents:n})}}catch{}try{this.builder.addConverterMetadata("MapJournal",{typeConvertedTo:"storymap",converterVersion:"0.0.0",classicMetadata:{}})}catch{}return this.flushDebugLogs("embedded-swipe"),p}catch(p){this.logWarn("inline swipe build failed; will use embed",{url:e,error:p?.message}),this.flushDebugLogs("embedded-swipe");return}}}const ti=["name","Name","NAME","title","Title","TITLE"],si=["description","Description","DESCRIPTION","desc","Desc","DESC","desc1","Desc1","DESC1","caption","Caption","CAPTION","FULL_Caption"],ii=["pic_url","Pic_url","PIC_URL","url","Url","URL"],ni=["thumb_url","Thumb_url","THUMB_URL"],ri=["long","Long","LONG","LON","longitude","Longitude","LONGITUDE","x"],oi=["lat","Lat","LAT","latitude","Latitude","LATITUDE","y"];class at extends bt{constructor(e){super(e),this.uploaded={},this.mediaUrls=new Set,this.places=[],this.geometries={},this.builder=new ot(e.themeId)}extractStructure(){this.emit("MapTour: extractStructure (no sections list)")}async convertContent(){const e=this.classicJson.values||{},t=e.title||"Untitled Story",s=e.subtitle||"",{themeId:i,variableOverrides:o}=rt(this.themeId,this.classicJson);this.builder.createStoryRoot(),this.builder.addCoverNode(t,s),this.builder.addNavigationHidden(),this.builder.addCreditsNode(),this.builder.applyTheme({themeId:i,variableOverrides:o});const a=Array.isArray(this.classicJson._mapTourFeatures)?this.classicJson._mapTourFeatures:[];let p=Array.isArray(e.places)&&e.places.length?e.places:Gt(a);const w=this.classicJson;if(!p.length&&w.webmapJson){const d=di(w.webmapJson,e.sourceLayer);d.length&&(p=Gt(d))}const S=Array.isArray(e.order)&&e.order.length?e.order:p.map(d=>({id:d.id,visible:d.visible!==!1})),n={};p.forEach(d=>{d.id!==void 0&&(n[d.id]=d)});const l=S.map(d=>n[d.id]).filter(Boolean).map(d=>({...d,visible:S.find(k=>k.id===d.id)?.visible!==!1}));let u;for(let d=0;d<l.length;d++){const k=l[d],A=String(k.id??d),j=it(k,ii),h=it(k,ni);if(j){this.mediaUrls.add(j);const I=this.builder.addImageResource(j);this.uploaded[A]={...this.uploaded[A]||{},imageUrl:j,imageResId:I},this.inlineUpload&&this.uploader&&this.storyId&&this.username&&this.token&&this.tryInlineUpload(j,I).catch(()=>{})}if(h){this.mediaUrls.add(h);const I=this.builder.addImageResource(h);this.uploaded[A]={...this.uploaded[A]||{},thumbUrl:h,thumbResId:I},this.inlineUpload&&this.uploader&&this.storyId&&this.username&&this.token&&this.tryInlineUpload(h,I).catch(()=>{})}}for(let d=0;d<l.length;d++){const k=l[d],A=String(k.id??d),j=it(k,ti)||`Place ${d+1}`,h=it(k,si)||"",I=this.uploaded[A]?.imageResId,F=this.uploaded[A]?.thumbResId;d===0&&e.firstRecordAsIntro&&I&&(u=I);const L=[];I&&L.push(this.builder.createImageNode(I,void 0,void 0,"standard")),F&&L.push(this.builder.createImageNode(F,void 0,void 0,"standard"));const E=L.length?this.builder.createCarouselNode(L):void 0,C=this.builder.createTextNode(j,"h3","wide"),T=this.builder.createTextNode(h,"paragraph","wide"),N=this.builder.newNodeId();let W=ai(k);!W&&k.geometry&&typeof k.geometry.x=="number"&&typeof k.geometry.y=="number"&&(W=ci(k.geometry.x,k.geometry.y)),W&&(this.geometries[N]={id:N,type:"POINT_NUMBERED_TOUR",nodes:[{long:W.long,lat:W.lat}],viewpoint:{},scale:4514}),this.places.push({id:this.builder.newNodeId(),featureId:N,contents:[T],media:E,title:C,config:k.visible===!1?{isHidden:!0}:void 0})}const f=this.builder.createTourMapNode(this.geometries,e.webmap),g="#f9f794",c={"three-panel":{tourType:"guided-tour",subtype:"media-focused"},"side-panel":{tourType:"guided-tour",subtype:"media-focused"},integrated:{tourType:"guided-tour",subtype:"map-focused"}};let y,x;if(this.places.length>15)y="explorer",x="grid";else{const d=c[e.layout||"integrated"]||c.integrated;y=d.tourType,x=d.subtype}const r=e.placardPosition==="end"?"end":"start",m=this.builder.createTourNode(this.places,f,g,r,"large",y,x);this.builder.addChild(this.builder.getStoryRootId(),f),this.builder.addChild(this.builder.getStoryRootId(),m),u&&this.builder.setStoryMeta(t,s,u),this.inlineUpload&&(!this.storyId||!this.token||!this.uploader)&&this.emit("MapTour inlineUpload requested but missing storyId/token/uploader â€“ falling back to URI resources"),this.emit(`MapTour: built ${this.places.length} place(s); layout=${e.layout||"integrated"} mapped to ${y}/${x}`)}applyTheme(){this.emit("MapTour: applyTheme (handled during convertContent)")}collectMedia(){return Array.from(this.mediaUrls)}getStoryMapJson(){return this.builder.getJson()}static async convert(e){const t=Qe(e.classicJson);if(!/tour/i.test(t))throw new Error("MapTourConverter invoked for non Map Tour template");return await new at(e).convert()}async tryInlineUpload(e,t){if(!(!this.uploader||!this.storyId||!this.username||!this.token))try{const s=await this.uploader(e,this.storyId,this.username,this.token);s.transferred&&s.resourceName?(this.builder.finalizeImageResourceAsItem(t,s.resourceName),this.emit(`Inline upload success for ${e}`)):this.emit(`Inline upload skipped/not transferred for ${e}`)}catch(s){this.emit(`Inline upload error for ${e}: ${s.message}`)}}static async convertInline(e){return new at({...e,inlineUpload:!0}).convert()}}function it(b,e){for(const t of e){const s=b&&b[t];if(s!=null&&String(s).trim())return String(s).trim()}}function ai(b){const e=b||{},t=it(e,ri),s=it(e,oi),i=Number(t),o=Number(s);if(!isNaN(i)&&!isNaN(o)&&Math.abs(i)<=180&&Math.abs(o)<=90)return{long:i,lat:o}}function ci(b,e){if(Math.abs(b)<=180&&Math.abs(e)<=90)return{long:b,lat:e};const t=6378137,s=b/t*180/Math.PI;let i=e/t*180/Math.PI;if(i=180/Math.PI*(2*Math.atan(Math.exp(i*Math.PI/180))-Math.PI/2),!isNaN(s)&&!isNaN(i)&&Math.abs(s)<=180&&Math.abs(i)<=90)return{long:s,lat:i}}function li(b){const e=["__OBJECTID","objectid","id","ID","FID","fid","ObjectID","Object_Id","OBJECTID","OBJECTID_1"];for(const t of e){const s=b[t];if(s!=null&&String(s).trim())return typeof s=="number"?s:String(s).trim()}}function Gt(b){if(!Array.isArray(b)||!b.length)return[];const e=[];for(const t of b){const s=t.attributes||{},i=li(s);i!==void 0&&e.push({id:i,...s,geometry:t.geometry})}return e}function di(b,e){try{const t=b,s=Array.isArray(t.operationalLayers)?t.operationalLayers:[],i=a=>{const p=String(a?.id||""),w=String(a?.title||"").toLowerCase(),S=/map\s*tour|maptour/.test(w),n=/^maptour-layer/i.test(p);return(e?p===e||p.includes(e)||e.includes(p):!1)||n||S},o=s.filter(i);for(const a of o){const p=a.featureCollection?.layers||[];for(const w of p){const S=w.featureSet?.features;if(Array.isArray(S))return S}}}catch{}return[]}function pi(b){return`https://www.arcgis.com/sharing/rest/content/items/${b}/info/thumbnail/thumbnail.png`}function Ht(b=""){return b}function qt(){return"https://js.arcgis.com/4.30/esri/images/logo.png"}function Kt(b,e){return b}const Ze=`${Xe()}/sharing/rest`;async function ft(b,e){const t=`${Ze}/content/items/${b}/data?f=json&token=${e}`,s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch item data: ${s.statusText}`);const i=await s.json();try{const o=i.error;if(o)throw new Error(`ArcGIS error ${o.code||""}: ${o.message||"Unknown error"}`)}catch(o){if(o instanceof Error)throw o}try{const o=Object.keys(i||{}),a=typeof i?.values=="object",p=Array.isArray(i?.values?.story?.entries),w=Array.isArray(i?.values?.story?.sections);console.debug("[arcgis-client.getItemData] Top-level keys:",o,"hasValues:",a,"hasEntries:",p,"hasSections:",w)}catch{}return i}async function tt(b,e){const t=`${Ze}/content/items/${b}?f=json&token=${e}`,s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch item details: ${s.statusText}`);return s.json()}async function ts(b,e,t,s){const i=`${Ze}/content/users/${e}/items/${b}/removeResources`,o=new URLSearchParams;o.append("resource",t),o.append("f","json"),o.append("token",s);const a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()});if(!a.ok)throw new Error(`Failed to remove resource: ${a.statusText}`);return a.json()}async function ct(b,e,t,s,i){const o=`${Ze}/content/users/${e}/items/${b}/addResources`,a=new FormData;a.append("file",t,s),a.append("fileName",s),a.append("f","json"),a.append("token",i);const p=await fetch(o,{method:"POST",body:a}),w=await p.json();console.log("[addResource] Upload API response:",w);const S=p.ok,n=w?.success===!0,l=w?.error?.message;if(!S||!n)throw new Error(`Failed to add resource: ${l||p.statusText}`);return w}async function jt(b,e,t,s){const i=`${Ze}/content/users/${e}/items/${b}/update`,o=new URLSearchParams;o.append("typeKeywords",JSON.stringify(t)),o.append("f","json"),o.append("token",s);const a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()});if(!a.ok)throw new Error(`Failed to update item keywords: ${a.statusText}`);return a.json()}function ss(b){const e=b&&typeof b=="object"?b.typeKeywords:void 0,t=Array.isArray(e)?e.filter(s=>typeof s=="string"):[];for(const s of t)if(s.startsWith("smdraftresourceid:"))return s.substring(18);return null}async function kt(b){const e=`${Ze}/community/self?f=json&token=${b}`,t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch user info: ${t.statusText}`);return(await t.json()).username}function is(){const b=mt(),e=mt(),t=mt(),s=mt(),i=ui();return{root:b,nodes:{[e]:{type:"storycover",data:{type:"minimal",title:"",summary:"",byline:"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},[t]:{type:"navigation",data:{links:[]},config:{isHidden:!0}},[s]:{type:"credits",children:[]},[b]:{type:"story",data:{storyTheme:i},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[e,t,s]}},resources:{[i]:{type:"story-theme",data:{themeId:"summit",themeBaseVariableOverrides:{}}}}}}function mt(){return`n-${Math.random().toString(36).slice(2,8)}`}function ui(){return`r-${Math.random().toString(36).slice(2,8)}`}async function Nt(b,e,t){const s=`${Ze}/content/users/${encodeURIComponent(b)}/addItem`,i=new URLSearchParams;i.append("f","json"),i.append("token",e),i.append("title",t),i.append("type","StoryMap"),i.append("typeKeywords",JSON.stringify(["StoryMaps","smdraftresourceid:draft.json"]));const o=is();i.append("text",JSON.stringify(o));const a=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i.toString()}),p=await a.json();if(!a.ok||!p||!p.success||!p.id){const w=p&&p.error&&p.error.message||a.statusText||"addItem failed";throw new Error(`Failed to create draft story: ${w}`)}return String(p.id)}async function ns(b,e,t,s,i){const o=`${Ze}/content/users/${encodeURIComponent(b)}/addItem`,a=new URLSearchParams;a.append("f","json"),a.append("token",e),a.append("title",t),a.append("type","StoryMap"),a.append("typeKeywords",JSON.stringify(["StoryMaps","StoryMapCollection","smdraftresourceid:draft.json"]));const p=`n-${Math.random().toString(36).slice(2,8)}`,w=`n-${Math.random().toString(36).slice(2,8)}`,S=`n-${Math.random().toString(36).slice(2,8)}`,n=`n-${Math.random().toString(36).slice(2,8)}`,l=`r-${Math.random().toString(36).slice(2,8)}`,u=i?.themeBase??"summit",f=i?.themeOverrides??{},g=i?.byline,c=i?.layoutType??"tiles",y="compact",x=s.map(k=>({itemId:k.itemId,title:k.title,thumbnailUrl:k.thumbnailUrl})),r={root:n,nodes:{[p]:{type:"collection-cover",data:{title:t,summary:"",byline:g,type:c}},[w]:{type:"collection-nav",data:{type:y}},[S]:{type:"collection-ui",data:{items:x},children:[p,w]},[n]:{type:"collection",data:{storyTheme:l},children:[S]}},resources:{[l]:{type:"story-theme",data:{themeId:u,themeBaseVariableOverrides:f}}}};a.append("text",JSON.stringify(r));const m=await fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a.toString()}),d=await m.json();if(!m.ok||!d||!d.success||!d.id){const k=d&&d.error&&d.error.message||m.statusText||"addItem failed";throw new Error(`Failed to create collection draft: ${k}`)}return String(d.id)}async function rs(b,e,t,s){const i=`${Ze}/content/users/${encodeURIComponent(e)}/items/${encodeURIComponent(b)}/update`,o=new URLSearchParams;o.append("f","json"),o.append("token",t),o.append("thumbnailurl",s);const a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()}),p=await a.json();if(!a.ok||p.success!==!0){const w=p?.error?.message||a.statusText;throw new Error(`Failed to update item thumbnail: ${w}`)}return p}const mi=Object.freeze(Object.defineProperty({__proto__:null,addResource:ct,createBaseStorymapJson:is,createCollectionDraft:ns,createDraftStory:Nt,findDraftResourceName:ss,getItemData:ft,getItemDetails:tt,getUsername:kt,removeResource:ts,updateItemKeywords:jt,updateItemThumbnailUrl:rs},Symbol.toStringTag,{value:"Module"})),qe=class qe extends bt{constructor(e){super(e),this.builders=[],this.entryTitles=[]}extractStructure(){this.emit("MapSeries: extractStructure")}async convertContent(){const t=(this.classicJson.values||{}).story?.entries||[];if(!Array.isArray(t)||!t.length){this.emit("MapSeries: no entries found");return}for(const[s,i]of t.entries()){const o=i.title||`Entry ${s+1}`,a=i.subtitle||"",p=new ot(this.themeId);p.createStoryRoot(),p.addCoverNode(o,a),p.addNavigationHidden(),p.addCreditsNode();const w=typeof i.webmap=="string"?i.webmap:void 0,S=i.description||"",n=p.createTextNode(S,"paragraph","wide");if(!w)return;const l=p.createWebMapNode(w);p.addChild(p.getStoryRootId(),n),p.addChild(p.getStoryRootId(),l),this.builders.push(p),this.entryTitles.push(o)}}applyTheme(){}collectMedia(){return[]}getStoryMapJson(){return this.builders[0]?.getJson()}static async convertSeries(e){const{classicJson:t,themeId:s,progress:i,token:o}=e,{computeTheme:a}=await Ot(async()=>{const{computeTheme:h}=await Promise.resolve().then(()=>Hs);return{computeTheme:h}},void 0),p=a(s,t),w=p.themeId,S=t.values?.settings||{},n=S.layout||{},u=(S.layoutOptions||{}).panel||{},f=S.mapOptions||{},g=t?.values||{},c=Array.isArray(g?.story?.entries)?g.story.entries:Array.isArray(g?.story?.sections)?g.story.sections:[],y=h=>{try{const I=h?.media||h?.content||{},F=I.type||"",L=(typeof I?.webmap=="string"?I.webmap:I.webmap?.id)||(typeof h.webmap=="string"?h.webmap:"");if(F.toLowerCase()==="webmap"||L)return{kind:"webmap"};const E=(typeof I?.image=="string"?I.image:I?.image?.url)||I?.imageUrl||I?.photo,C=(typeof I?.video=="string"?I.video:I?.video?.source)||I?.videoUrl,T=I?.webpage?.url||I?.embed?.url||I?.url;if(E)return{kind:"image"};if(C)return{kind:"video"};if(T){const R=String(T).toLowerCase();return/storymaps\.(arcgis)\.com\/stories\//.test(R)?{kind:"classic"}:/appid=/.test(R)||/apps\/(MapTour|MapJournal|StoryMapJournal|swipe)/i.test(R)?{kind:"classic",template:(()=>{if(/journal|storymapjournal/.test(R))return"mapjournal";if(/tour/.test(R))return"maptour";if(/swipe|spyglass/.test(R))return"swipe";if(/series/.test(R))return"mapseries"})()}:{kind:"embed"}}const N=h.appid||h.appId;if(N&&/^[a-f0-9]{32}$/i.test(N))return{kind:"classic",template:"mapjournal"};const W=h.content?.actions?.open?.system?.appid;if(W&&/^[a-f0-9]{32}$/i.test(W))return{kind:"classic",template:"mapjournal"};if(!!(I?.webmap||I?.appid||I?.appId))return{kind:"classic",template:"mapjournal"}}catch{}return{kind:"unknown"}},x=[],r=[],m=[],d=[],k=[],A=[],j=(c||[]).map((h,I)=>{const F=h?.media||h?.content||{},L=F?.webpage?.url||F?.embed?.url||F?.url||"",E=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(String(L))?.[1]||"",C=h.appid||h.appId||"",T=h.content?.actions?.open?.system?.appid||"",N=y(h),W=N.template?`${N.kind}:${N.template}`:N.kind;return{index:I+1,title:String(h?.title||h?.headline||""),kind:W,urlApp:E,appField:C,sysApp:T,embedUrl:L}});console.log("[MapSeriesConverter] Entry count:",c.length,"Summary:",j);for(let h=0;h<c.length;h++){const I=c[h]||{},F=String(I?.title||I?.headline||`Entry ${h+1}`);r.push(F);const L=y(I),E=new ot(w);E.createStoryRoot();try{p.variableOverrides&&E.applyTheme({themeId:w,variableOverrides:p.variableOverrides})}catch{}E.addCoverNode(F,"");let C;if(L.kind==="image"){const T=I?.media||I?.content||{},N=(typeof T?.image=="string"?T.image:T?.image?.url)||T?.imageUrl||T?.photo||"",W=E.createTextNode(N?`Image: ${N}`:"Image entry","paragraph","wide");E.addChild(E.getStoryRootId(),W);try{const D=N,R=Kt(D,400),X=E.getJson(),M=`r-series-settings-${Date.now()}-${Math.random().toString(36).slice(2)}`;X.resources[M]={type:"series-settings",data:{thumbnailUrl:R}},d.push(R)}catch{}C=E.getJson()}else if(L.kind==="video"){const T=I?.media||I?.content||{},N=(typeof T?.video=="string"?T.video:T?.video?.source)||T?.videoUrl||"",W=E.createTextNode(N?`Video: ${N}`:"Video entry","paragraph","wide");E.addChild(E.getStoryRootId(),W);try{const D=Ht(),R=E.getJson(),X=`r-series-settings-${Date.now()}-${Math.random().toString(36).slice(2)}`;R.resources[X]={type:"series-settings",data:{thumbnailUrl:D}},d.push(D)}catch{}C=E.getJson()}else if(L.kind==="embed"){const T=I?.media||I?.content||{},N=T?.webpage?.url||T?.embed?.url||T?.url||"",W=E.createTextNode(N?`Embed: ${N}`:"Embed entry","paragraph","wide");E.addChild(E.getStoryRootId(),W);try{const D=Ht(),R=E.getJson(),X=`r-series-settings-${Date.now()}-${Math.random().toString(36).slice(2)}`;R.resources[X]={type:"series-settings",data:{thumbnailUrl:D}},d.push(D)}catch{}C=E.getJson()}else if(L.kind==="webmap"){const T=I?.media||I?.content||{},N=(typeof T?.webmap=="string"?T.webmap:T.webmap?.id)||(typeof I.webmap=="string"?I.webmap:""),W=String(I.description||""),D=String(u.position||"").toLowerCase(),R=D==="start"||D==="left"?"start":"end",X=String(u.size||"").toLowerCase(),M=X==="small"||X==="medium"||X==="large"?X:X==="wide"?"large":"medium",{slideId:te,narrativeId:se}=E.addSidecar("docked-panel",R,M),B=E.createTextNode(W||"Map Series entry narrative","paragraph","wide");if(!N)continue;const G=E.addWebMapResource(N,"Web Map",void 0,"minimal"),ie=E.createWebMapNode(G);E.addChild(se,B),E.updateNode(te,_=>{(_.children??(_.children=[])).push(ie)});try{E.updateNodeData(ie,_=>{const we=f.extent,me=f.viewpoint,Me=f.zoom;we&&typeof we=="object"&&(_.extent=we),me&&typeof me=="object"&&(_.viewpoint=me),typeof Me=="number"&&(_.zoom=Me)})}catch{}try{const _=typeof fetch<"u"?fetch:void 0;if(_&&typeof N=="string"&&N.length){const me=`${Xe()}/sharing/rest/content/items/${N}/data?f=json`,Me=await _(me);let ee={};Me&&Me.ok&&(ee=await Me.json());const Z=q=>q.initialState?.view?.extent||q.mapOptions?.extent||q.extent||q.mapOptions?.mapExtent||void 0,be=q=>q.initialState?.view?.center||q.mapOptions?.center||q.center||void 0,xe=Z(ee),Se=be(ee),Be=(q=>{if(!q)return q;if(Array.isArray(q)&&q.length>=2){const[ce,pe]=q;return{x:ce,y:pe,spatialReference:{wkid:4326}}}return q})(Se),he=ee.initialState?.view?.zoom??ee.mapOptions?.zoom,Ae=ee.initialState?.view?.scale||ee.view?.scale?{targetGeometry:xe,scale:ee.initialState?.view?.scale??ee.view?.scale}:void 0;let je=xe;if(!je||typeof je!="object"&&!Array.isArray(je)){const ce=`${Xe()}/sharing/rest/content/items/${N}?f=json`,pe=await _(ce);if(pe&&pe.ok){const ae=await pe.json();if(Array.isArray(ae?.extent)&&ae.extent.length===2&&Array.isArray(ae.extent[0])&&Array.isArray(ae.extent[1])){const[[Re,_e],[Ue,st]]=ae.extent;je={xmin:Re,ymin:_e,xmax:Ue,ymax:st,spatialReference:{wkid:4326}}}}}E.updateWebMapData(G,{extent:je,center:Be,zoom:typeof he=="number"?he:void 0,viewpoint:Ae});try{const q=await pi(String(N)),ce=Kt(q,400),pe=E.getJson(),ae=`r-series-settings-${Date.now()}-${Math.random().toString(36).slice(2)}`;pe.resources[ae]={type:"series-settings",data:{thumbnailUrl:ce}},d.push(ce)}catch{}E.updateNodeData(ie,q=>{const pe=E.getJson().resources[G]?.data||{},ae=q;pe.extent&&!ae.extent&&(ae.extent=pe.extent),pe.viewpoint&&!ae.viewpoint&&(ae.viewpoint=pe.viewpoint),typeof pe.zoom=="number"&&!ae.zoom&&(ae.zoom=pe.zoom)})}}catch{}try{const _=E.getJson();qe.appendConverterMetadata(_,t,void 0,h+1);const we=_.resources,me=`r-series-settings-${Date.now()}-${Math.random().toString(36).slice(2)}`,Me=we[me]?.data||{};we[me]={type:"series-settings",data:{...Me,layoutId:n?.id,panel:{position:R,size:M},mapOptions:f,defaultThumbnailUrl:qt()}}}catch{}C=E.getJson()}else if(L.kind==="classic")try{const T=await qe.fetchChildClassicJson(I,o),W=Qe(T)?.toLowerCase()||L.template||"mapjournal",D=R=>i?.({stage:"convert",message:`Entry ${h+1}: ${R.message}`,current:h+1,total:c.length});if(W==="mapjournal")C=(await vt.convert({classicJson:T,themeId:w,progress:D})).storymapJson;else if(W==="maptour")C=(await at.convert({classicJson:T,themeId:w,progress:D})).storymapJson;else if(W==="swipe")C=await new Le({classicJson:T,themeId:w,progress:D,token:o}).convert().then(X=>X.storymapJson);else if(W==="mapseries"){const R=E.createTextNode("Nested Map Series detected. Convert separately.","paragraph","wide");E.addChild(E.getStoryRootId(),R),C=E.getJson()}else{const R=E.createTextNode("Unsupported classic entry type; saved as embed.","paragraph","wide");E.addChild(E.getStoryRootId(),R);const X=I?.media?.webpage?.url||"",M=E.createTextNode(X?`Embed: ${X}`:"Embed entry","paragraph","wide");E.addChild(E.getStoryRootId(),M),C=E.getJson()}qe.appendConverterMetadata(C,t,W,h+1)}catch{const T=E.createTextNode("Failed to convert classic child entry; saved as placeholder.","paragraph","wide");E.addChild(E.getStoryRootId(),T),C=E.getJson()}else{const T=E.createTextNode(`Converted from Map Series entry ${h+1}`,"paragraph","wide");E.addChild(E.getStoryRootId(),T),C=E.getJson()}if(x.push(C),m.push(`https://storymaps.arcgis.com/stories/new?title=${encodeURIComponent(F)}`),o)try{const T=await kt(o),N=await Nt(T,o,F);k.push(N);try{const R=new Blob([JSON.stringify(C)],{type:"application/json"});await ct(N,T,R,"draft.json",o)}catch{}const W=d[d.length-1]||qt(),D=await fetch(W);if(D.ok){const R=await D.blob(),X=`thumbnails/series-entry-${h+1}.png`;await ct(N,T,R,X,o),A.push(X)}else A.push("");m[m.length-1]=`https://storymaps.arcgis.com/stories/${N}/edit`}catch{}i?.({stage:"convert",message:`Converted Map Series entry ${h+1}`,current:h+1,total:c.length})}try{if(o){const h=[];for(let I=0;I<k.length;I++){const F=k[I];typeof F=="string"&&/^[a-f0-9]{32}$/i.test(F)&&h.push(I)}if(h.length&&h.length!==k.length){const I=(W,D)=>D.map(R=>W[R]),F=I(x,h),L=I(r,h),E=I(m,h),C=I(d,h),T=I(k,h),N=I(A,h);return{storymapJsons:F,entryTitles:L,builderLinks:E,thumbnailUrls:C,draftItemIds:T,thumbnailResourcePaths:N}}}}catch{}return{storymapJsons:x,entryTitles:r,builderLinks:m,thumbnailUrls:d,draftItemIds:k,thumbnailResourcePaths:A}}static async fetchChildClassicJson(e,t){try{const{getItemData:s}=await Ot(async()=>{const{getItemData:f}=await Promise.resolve().then(()=>mi);return{getItemData:f}},void 0),i=e?.media||e?.content||{},o=i?.webpage?.url||i?.url||"",a=[],p=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(String(o))?.[1];p&&(console.debug("[MapSeriesConverter] appid from URL:",p),a.push(p));const w=e.appid||e.appId;w&&(console.debug("[MapSeriesConverter] appid from entry fields:",w),a.push(w));try{const f=e.content?.actions?.open?.system;f?.appid&&/^[a-f0-9]{32}$/i.test(f.appid)&&(console.debug("[MapSeriesConverter] appid from nested actions.open.system:",f.appid),a.push(f.appid))}catch{}const S=new Set,l=a.filter(f=>{const g=!S.has(f);return g&&S.add(f),g}).find(f=>/^[a-f0-9]{32}$/i.test(f));if(l){if(console.debug("[MapSeriesConverter] Fetching child classic JSON for appid:",l),qe.childCache[l])return console.debug("[MapSeriesConverter] Using cached child JSON for appid:",l),qe.childCache[l];const g=await s(l,t||"")||{};try{const c=g.values||{},y=Array.isArray(c.sections),x=Array.isArray(c.story?.entries);console.debug("[MapSeriesConverter] Child payload shape:",{hasSections:y,hasStoryEntries:x,keys:Object.keys(c)})}catch{}return qe.childCache[l]=g,qe.childCache[l]}return e.classicJson||e.data||{}}catch{return{}}}static appendConverterMetadata(e,t,s,i){try{const o=e.resources||{},a=`r-converter-metadata-${Date.now()}-${Math.random().toString(36).slice(2)}`,p={classicMetadata:{parentTemplate:"mapseries",childTemplate:s||"unknown",entryIndex:i,parentTitle:String(t?.values?.title||"")}};o[a]={type:"converter-metadata",data:p},e.resources=o}catch{}}};qe.childCache={};let gt=qe;class hi{static async transferBatch(e){const{urls:t,storyId:s,username:i,token:o,progress:a,uploader:p,isCancelled:w}=e,S={};for(let n=0;n<t.length;n++){if(w&&w())throw new Error("Conversion cancelled by user intervention");const l=t[n];a({stage:"media",message:`Transferring media ${n+1}/${t.length}`,current:n+1,total:t.length});try{if(w&&w())throw new Error("Conversion cancelled by user intervention");const u=await p(l,s,i,o);u.transferred&&(S[u.originalUrl]=u.resourceName)}catch{}}if(w&&w())throw new Error("Conversion cancelled by user intervention");return S}}class fi{static apply(e,t){for(const[s,i]of Object.entries(e.resources))if(i.type==="image"){const o=i,a=o.data&&typeof o.data=="object"?o.data.src:void 0;if(typeof a=="string"&&t[a]){const p=o.data||{};p.resourceId=t[String(a)],delete p.src,p.provider="item-resource",o.data=p}}for(const s of Object.values(e.nodes))if(s.type==="image"){const i=s,o=i.data&&typeof i.data=="object"?i.data.src:void 0;if(typeof o=="string"){const a=o,p=Object.entries(e.resources).find(([w,S])=>S.type==="image"&&typeof S.data.src=="string"&&S.data.src===a)?.[0];if(p){const w=i.data||{};w.image=p,delete w.src,delete w.resourceId,delete w.provider,i.data=w}}}return e}static rewriteImageUrlsToProxy(e,t){for(const s of Object.values(e.resources))if(s.type==="image"){const i=s,o=i.data||{},a=o.src,p=o.resourceId;typeof a=="string"&&!p&&(o.src=`${t}?url=${encodeURIComponent(a)}`),i.data=o}for(const s of Object.values(e.nodes))if(s.type==="image"){const i=s,o=i.data||{},a=o.src,p=o.image;typeof a=="string"&&!p&&(o.src=`${t}?url=${encodeURIComponent(a)}`),i.data=o}return e}}function yi(b){return b.includes("www.arcgis.com/sharing/rest/content")||b.includes("//www.arcgis.com/sharing/rest/content")}function gi(b){const e=b.split("/resources/");if(e.length>1){const s=e[1].split("?")[0];return decodeURIComponent(s)}return b.split("/").pop()?.split("?")[0]||"image.jpg"}function bi(b,e){const t=["jpg","jpeg","png","gif","webp","bmp","tif","tiff"];let s=e;if(!s){const o=b.split(".").pop()||"";s=t.includes(o.toLowerCase())?o.toLowerCase():"jpg"}return s==="jpeg"&&(s="jpg"),s==="tiff"&&(s="tif"),`${Math.random().toString(36).substring(2,15)}.${s}`}function Yt(b){if(!b)return".jpg";const e=b.toLowerCase();return[".jpg",".jpeg",".png",".gif",".webp",".bmp",".tif",".tiff"].includes(e)?e===".jpeg"?".jpg":e===".tiff"?".tif":e:".jpg"}function vi(b,e,t){if(t){const i=/filename="?([^";]+)"?/i.exec(t);if(i){const a=i[1].toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(a)return a[0].replace(".jpeg",".jpg").replace(".tiff",".tif")}}const s=b.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(s)return s[0].replace(".jpeg",".jpg").replace(".tiff",".tif");if(e&&/^image\//i.test(e)){const i=e.split("/")[1].toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","tiff","tif"].includes(i)?"."+(i==="jpeg"?"jpg":i==="tiff"?"tif":i):".jpg"}return".bin"}async function wi(b,e){const t=e?`${b}?token=${encodeURIComponent(e)}`:b,s=await fetch(t);if(!s.ok)throw new Error(`Image fetch failed ${s.status}`);const i=s.headers.get("content-disposition")||void 0,o=s.headers.get("content-type")||void 0,a=s.url,p=await s.blob(),w=vi(a,o,i);return{blob:p,extension:w}}async function xi(b,e,t,s,i){try{console.log("[transferImage] Starting transfer:",{imageUrl:b,filename:i,targetItemId:e});const o=gi(b);let a=".jpg",p;try{const S=await wi(b,yi(b)?s:void 0);p=S.blob,a=Yt(S.extension)}catch(S){console.warn("[transferImage] Primary fetch failed, trying proxy:",{imageUrl:b,error:S}),p=await Si(b);const n=o.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);a=Yt(n?n[0]:".jpg")}/^\.(jpg|png|gif|webp|bmp|tif)$/i.test(a)||(a=".jpg");let w;return i||(w=bi(o,a.replace(".",""))),console.log("[transferImage] Uploading to AGO:",{newResourceName:w,blob:p}),await ct(e,t,p,w,s),console.log("[transferImage] Transfer successful:",{imageUrl:b,newResourceName:w}),{originalUrl:b,resourceName:w,isTransferred:!0}}catch(o){return console.error("[transferImage] Transfer failed:",{imageUrl:b,error:o}),{originalUrl:b,resourceName:b,isTransferred:!1}}}async function Si(b){const t=/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname)?`/.netlify/functions/proxy-image?url=${encodeURIComponent(b)}`:b,s=await fetch(t);if(!s.ok)throw new Error("Failed to fetch image (proxy/direct)");return await s.blob()}function Ii(b){const e=new Set;if(b.resources){for(const t of Object.values(b.resources))if(t.type==="image"){const s=t.data?.url||t.data?.src;s&&e.add(s)}}return Array.from(e)}const Ci=new hs({allErrors:!0,strict:!1,allowUnionTypes:!0});function Ai(...b){return Ci.compile(...b)}const ji="http://json-schema.org/draft-07/schema#",Ti="https://example.com/schemas/draft-story.json",ki="StoryMaps Draft",Ni="object",Mi=["root","nodes","resources"],Li={root:{type:"string",minLength:1},nodes:{type:"object",minProperties:1,additionalProperties:{type:"object",required:["type"],properties:{type:{type:"string",minLength:1},data:{type:"object",properties:{children:{type:"array",items:{type:"string"}},viewpoint:{$ref:"#/$defs/viewpoint"},extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0},config:{type:"object"},children:{type:"array",items:{oneOf:[{type:"string"},{type:"number"},{type:"object",additionalProperties:!0}]}},dependents:{type:"object"}},additionalProperties:!0}},resources:{type:"object",additionalProperties:{type:"object",required:["type"],properties:{type:{type:"string",minLength:1},data:{type:"object",properties:{initialState:{type:"object",properties:{extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},viewpoint:{$ref:"#/$defs/viewpoint"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0},extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},viewpoint:{$ref:"#/$defs/viewpoint"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0}},additionalProperties:!0}},actions:{type:"array",items:{type:"object"}}},$i={spatialReference:{type:"object",properties:{wkid:{type:"integer"}},required:["wkid"],additionalProperties:!0},center:{type:"object",properties:{x:{type:"number"},y:{type:"number"},spatialReference:{$ref:"#/$defs/spatialReference"}},required:["x","y","spatialReference"],additionalProperties:!0},extent:{type:"object",properties:{xmin:{type:"number"},ymin:{type:"number"},xmax:{type:"number"},ymax:{type:"number"},spatialReference:{$ref:"#/$defs/spatialReference"}},required:["xmin","ymin","xmax","ymax","spatialReference"],additionalProperties:!0},viewpoint:{oneOf:[{$ref:"#/$defs/extent"},{$ref:"#/$defs/center"},{type:"object",properties:{targetGeometry:{type:["object","array","string"],additionalProperties:!0},scale:{type:"number"},rotation:{type:"number"},camera:{type:"object",additionalProperties:!0}},additionalProperties:!0}]},mapLayer:{type:"object",properties:{id:{type:"string"},visible:{type:"boolean"}},required:["id"],additionalProperties:!0},mapLayers:{type:"array",items:{$ref:"#/$defs/mapLayer"}}},Ri=!1,Ei={$schema:ji,$id:Ti,title:ki,type:Ni,required:Mi,properties:Li,$defs:$i,additionalProperties:Ri};class Oi{constructor(){this.current=null}startSession(e){const t=Date.now(),s=`sess-${t}-${Math.random().toString(36).slice(2,8)}`;return this.current={sessionId:s,itemId:e,startedAt:t,events:[]},s}onEnter(e,t){this.current&&this.current.events.push({ts:Date.now(),event:"enter",stepId:e,type:t?.type,input:t?.input,meta:t?.meta})}onExit(e,t){this.current&&this.current.events.push({ts:Date.now(),event:"exit",stepId:e,type:t?.type,output:t?.output,meta:t?.meta})}endSession(){this.current&&(this.current.endedAt=Date.now())}export(){return this.current?{...this.current,events:[...this.current.events]}:null}reset(){this.current=null}}const Oe=new Oi;function Di(){const[b,e]=J.useState(!1),[t,s]=J.useState(!1),[i,o]=J.useState(""),a=J.useRef(!1),[p,w]=J.useState(!1),[S]=J.useState(!1),{token:n,userInfo:l}=lt(),[u,f]=J.useState(""),[g,c]=J.useState("idle"),[y,x]=J.useState(""),[r,m]=J.useState(""),[d,k]=J.useState([]),A=J.useRef([]),j=J.useRef([]),[h,I]=J.useState([]),F=J.useRef([]),L=J.useRef({}),[E,C]=J.useState(!1),[T,N]=J.useState(""),[W,D]=J.useState(""),[R,X]=J.useState(()=>{try{const $=localStorage.getItem("suppressConverterMetadata");return $?String($).toLowerCase()==="true":!1}catch{return!1}});J.useEffect(()=>{try{localStorage.setItem("suppressConverterMetadata",String(R))}catch{}globalThis.__SUPPRESS_CONVERTER_METADATA=R},[R]);const[M,te]=J.useState("Convert");J.useEffect(()=>{let $=!1;const P=(u||"").trim();if(P.length<8){te("Convert");return}return(async()=>{try{const V=await tt(P,n||""),re=V,oe=String(re?.title??re?.name??"").trim();let de=null;try{const fe=await ft(P,n||""),Ne=Qe(fe);de=typeof Ne=="string"?Ne:"unknown"}catch{}if(!de||de.toLowerCase()==="unknown"){const fe=V,Ne=Array.isArray(fe?.typeKeywords)?fe.typeKeywords:[],z=[String(fe?.type??"").toLowerCase(),...Ne.map(De=>String(De).toLowerCase())].join(" "),We=/journal/.test(z)?"Map Journal":/swipe/.test(z)?"Swipe":/tour/.test(z)?"Map Tour":/series/.test(z)?"Map Series":/cascade/.test(z)?"Cascade":/shortlist/.test(z)?"Shortlist":/crowdsource/.test(z)?"Crowdsource":/basic/.test(z)?"Basic":null;We&&(de=We)}const Ie=typeof de=="string"?de:"",Fe=oe||"",Te=Ie&&Fe?`Convert classic ${Ie}: "${Fe}"`:"Convert";$||te(Te)}catch{$||te("Convert")}})(),()=>{$=!0}},[u,n]);const[se,B]=J.useState(Pt());J.useEffect(()=>{const $=P=>B(P);return Js($),B(Pt()),()=>zs($)},[]);const G=()=>{if(a.current)throw new Error("Conversion cancelled by user intervention")},[ie,_]=J.useState(!1),we=J.useCallback(()=>{if(a.current)return;window.confirm("Cancel conversion in progress? This will stop further processing.")&&(a.current=!0,_(!0),w(!1))},[]),[me,Me]=J.useState(null),[ee,Z]=J.useState(null),[be,xe]=J.useState([]),Se="https://www.arcgis.com",[ne,Be]=J.useState(Se),he=J.useRef(null),Ae=J.useRef(!1),[je,q]=J.useState(!1),[ce,pe]=J.useState({}),ae=J.useCallback(()=>{const $=typeof l=="object"&&l?l:{},P=$.orgUrl||$.org?.url||"";try{if(typeof P=="string"&&P.length){const re=new URL(P).hostname,oe=/^(.*)\.maps\.arcgis\.com$/i.exec(re);return oe&&oe[1]?`${oe[1]}.maps.arcgis.com`:re}}catch{}return"www.arcgis.com"},[l]),Re=J.useCallback(($,P)=>{const V=ae(),re=P&&P!==Se?P:`https://${V}`;return $.map(oe=>{const de=oe.itemId,Ie=oe.message||"";if(/version\s*([0-9]+(?:\.[0-9]+)?)\s*<\s*2\.0/i.test(Ie)){const Te=`ERROR: Item [${de}] Unsupported web map version: You must update the web map to the latest version. You can do this by opening the map in <a href="${re}/home/webmap/viewer.html?webmap=${de}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a> and save it. No other changes are necessary to resolve this error.`;return{...oe,level:"error",message:Te}}if(/HTTP URL|http:\/\//i.test(Ie)){const Te=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${re}/home/item.html?id=${de}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,fe=`WARNING: Webmap [${de}] uses http services.`;return{...oe,message:`${fe}
${Te}`}}const Fe=/Map Viewer Classic\s*<\s*link\s*=\s*(https?:[^\s>]+)\s*>/i.exec(Ie);if(Fe){const Te=Fe[1],fe=Ie.replace(Fe[0],`<a href="${Te}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a>`);return{...oe,message:fe}}if(/https:\/\/<org_url>\.arcgis\.com/i.test(Ie)){const Te=Ie.replace(/https:\/\/<org_url>\.arcgis\.com/gi,re);return{...oe,message:Te}}if(/https:\/\/www\.arcgis\.com/i.test(Ie)&&re&&re!==Se){const Te=Ie.replace(/https:\/\/www\.arcgis\.com/gi,re);return{...oe,message:Te}}return oe})},[ae]),_e=$=>{if(!$)return"";const P=ae();return/^[a-f0-9]{32}$/i.test($)?`https://${P}/home/item.html?id=${$}`:""},Ue=J.useMemo(()=>Ai(Ei),[]);J.useEffect(()=>{if(!n){Be(Se);try{globalThis.__ORG_BASE=Se}catch{}he.current=null,Ae.current=!1;return}if(he.current&&he.current!==n){Be(Se);try{globalThis.__ORG_BASE=Se}catch{}Ae.current=!1}he.current=n},[n]),J.useEffect(()=>{try{const P=`https://${ae()}`;if(n&&P&&ne!==P){Be(P);try{globalThis.__ORG_BASE=P}catch{}}}catch{}},[n,l,ne,ae]),J.useEffect(()=>{!n||Ae.current||(async()=>{try{const $=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(n)}`);if(!$.ok)return;const P=await $.json(),V=P?.urlKey,re=P?.customBaseUrl;let oe="";if(V&&re)oe=`https://${V}.${re}`;else if(P?.portalHostname){const de=P.portalHostname;oe=/^https?:/i.test(de)?de:`https://${de}`}if(oe&&ne!==oe){Be(oe);try{globalThis.__ORG_BASE=oe}catch{}}}catch{}finally{Ae.current=!0}})()},[n,ne]),J.useEffect(()=>{be.length&&ne&&ne!==Se&&xe($=>$.map(P=>({...P,message:(P.message||"").replace(/https:\/\/www\.arcgis\.com/gi,ne)})))},[ne,be.length]);const st=$=>/^[a-f0-9]{32}$/i.test($.trim()),os=J.useCallback(async()=>{if(ne&&ne!==Se)return ne;const $=ae();let P=`https://${$}`;if(n&&/www\.arcgis\.com$/i.test($))try{const V=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(n)}`);if(V.ok){const re=await V.json(),oe=re?.urlKey,de=re?.customBaseUrl;if(oe&&de)P=`https://${oe}.${de}`;else if(re?.portalHostname){const Ie=re.portalHostname;P=/^https?:/i.test(Ie)?Ie:`https://${Ie}`}}}catch{}if(P&&P!==ne){Be(P);try{globalThis.__ORG_BASE=P}catch{}}return P},[ne,n,ae]),as=J.useCallback(()=>{e(!1),c("idle"),x(""),N(""),te("Convert"),a.current=!1,_(!1),xe([]),q(!1),pe({}),Me(null),ee?.url&&URL.revokeObjectURL(ee.url),Z(null),k([]),A.current=[],j.current=[],I([]),F.current=[],L.current={},C(!1)},[ee]),cs=async()=>{c("idle"),x(""),N(""),te("Convert"),a.current=!1,_(!1),xe([]),q(!1),pe({}),ee?.url&&URL.revokeObjectURL(ee.url),Z(null);try{Oe.startSession(String(u||"").trim())}catch{}try{Oe.onEnter("convert-flow",{type:"convert",input:{classicItemId:u}})}catch{}if(!st(u)){c("error"),x("Incorrect Classic Story Map item id format - please enter a 32 character hex string");return}if(!n){c("error"),x("You must be signed in to ArcGIS Online or ArcGIS Enterprise");return}try{c("fetching"),x("Getting user information...");const $=l?.username||"";x("Fetching classic story data...");try{Oe.onEnter("fetch-classic",{type:"step",input:{classicItemId:u}})}catch{}const P=await ft(u,n||"");try{Oe.onExit("fetch-classic",{type:"step",output:{ok:!0}})}catch{}G();let V=null;try{Oe.onEnter("detect-template",{type:"step"})}catch{}try{V=Qe(P)}catch{V=null}if(V&&typeof V!="string"){try{console.warn("[converter] detectClassicTemplate returned non-string:",{typeof:typeof V,value:V})}catch{}V="unknown"}try{Oe.onExit("detect-template",{type:"step",output:{template:V||"unknown"}})}catch{}if(!V||V.toLowerCase()==="unknown")try{const U=await tt(u,n||""),H=Array.isArray(U?.typeKeywords)?U.typeKeywords:[],Q=[String(U?.type??"").toLowerCase(),...H.map(ge=>String(ge).toLowerCase())].join(" "),Y=/journal/.test(Q)?"Map Journal":/swipe/.test(Q)?"Swipe":/tour/.test(Q)?"Map Tour":/series/.test(Q)?"Map Series":/cascade/.test(Q)?"Cascade":/shortlist/.test(Q)?"Shortlist":/crowdsource/.test(Q)?"Crowdsource":/basic/.test(Q)?"Basic":null;Y&&(V=Y)}catch{}if(Me(typeof V=="string"?V:null),V&&x(`Detected template: ${V}. Preparing resources...`),!V||V.toLowerCase()==="unknown")try{Array.isArray(P?.values?.entries)&&P.values.entries.length>0&&(V="Map Series",Me("Map Series"),x("Detected template: Map Series. Preparing resources..."))}catch{}try{const U=await tt(u,n||""),H=String(U?.type??"").trim(),K=(V||"").toLowerCase();if(!K||K==="unknown"){try{Array.isArray(P?.values?.entries)&&P.values.entries.length>0&&(V="Map Series")}catch{}if(!V||V.toLowerCase()==="unknown"){c("error"),x(`Error: The item id you entered is not for a Classic Esri Story Map. It is a ${H||"non-classic ArcGIS item"}`);return}}if(!Fs(typeof V=="string"?V:"unknown")){const Q=String(V||"unknown");try{console.warn("[converter] classic template gated:",{runtimeTemplate:Q})}catch{}c("error"),x(`Error: The item id you entered is not yet available for conversion. It is a ${Q}`);return}}catch{}if(P.values?.webmap){x("Fetching classic webmap data...");const O=P.values?.webmap;P.webmapJson=await ft(O,n||""),G()}x("Creating new StoryMap draft...");const re=P.values?.title||"Untitled Story",oe=`(Converted) ${re}`,de=await Nt($,n,oe);G(),x("Converting theme...");const Ie=[];P.values?.webmap&&Ie.push(P.values.webmap);try{const O=Array.isArray(P.values?.webmaps)?P.values.webmaps:[];for(const U of O)if(typeof U=="string")Ie.push(U);else{const H=U;H&&typeof H.id=="string"&&Ie.push(H.id)}}catch{}const Fe=V||me||"webmap";c("fetching"),te(`Fetching ${Fe}...`);try{const O=P.values?.story?.sections||[];for(const U of O){U?.media?.webmap?.id&&Ie.push(U.media.webmap.id);const H=U?.media?.webpage?.url||"",Q=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(String(H))?.[1];if(Q)try{const Y=`https://www.arcgis.com/sharing/rest/content/items/${Q}/data?f=json`,ge=n?`${Y}&token=${encodeURIComponent(n)}`:Y,le=await fetch(ge);if(le.ok){const Ce=await le.json(),Ee=Array.isArray(Ce?.values?.webmaps)?Ce.values.webmaps:[];for(const $e of Ee)if(typeof $e=="string")Ie.push($e);else{const ve=$e;ve&&typeof ve.id=="string"&&Ie.push(ve.id)}try{const $e=String(Q),ve=P;ve.__embeddedSwipes||(ve.__embeddedSwipes={}),ve.__embeddedSwipes[$e]=Ce}catch{}}}catch{}const ue=Array.isArray(U?.contentActions)?U.contentActions:[];for(const Y of ue)if(Y&&Y.type==="media"&&Y.media&&Y.media.webpage&&Y.media.webpage.url){const ge=String(Y.media.webpage.url||""),Ce=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(ge)?.[1];if(Ce)try{const Ee=`https://www.arcgis.com/sharing/rest/content/items/${Ce}/data?f=json`,$e=n?`${Ee}&token=${encodeURIComponent(n)}`:Ee,ve=await fetch($e);if(ve.ok){const ze=await ve.json(),et=Array.isArray(ze?.values?.webmaps)?ze.values.webmaps:[];for(const Ye of et)if(typeof Ye=="string")Ie.push(Ye);else{const He=Ye;He&&typeof He.id=="string"&&Ie.push(He.id)}try{const Ye=String(Ce),He=P;He.__embeddedSwipes||(He.__embeddedSwipes={}),He.__embeddedSwipes[Ye]=ze}catch{}}}catch{}}}}catch{}const Te=new Set,fe=[];for(const O of Ie){const U=String(O);Te.has(U)||(Te.add(U),fe.push(U))}try{Oe.onEnter("validate-webmaps",{type:"step",input:{total:fe.length}})}catch{}let Ne=[];try{const O=await os();if(fe.length>0)for(let U=0;U<fe.length;U++){if(a.current)throw new Error("Conversion cancelled by user intervention");const H=fe[U];x(`Fetching webmap ${H} ${U+1} of ${fe.length}...`);const{warnings:K}=await Vs([H],n),Q=K.map(Y=>({itemId:Y.itemId,level:Y.level,message:Y.message,details:Y&&typeof Y=="object"&&"details"in Y?Y.details:void 0})),ue=Re(Q,O);ue.length&&(Ne=[...Ne,...ue],xe([...Ne]))}q(!0)}catch{}try{Oe.onExit("validate-webmaps",{type:"step",output:{warnings:(Ne||[]).length}})}catch{}const Ke=!1;!a.current&&Ne.length,Ne.length>0&&q(!0),c("converting");try{Oe.onEnter("convert-story",{type:"step",input:{template:V||me}})}catch{}const z=V||me||"story";te(`Converting ${z}: ${re}...`),x(`Converting ${z} story to new format...`);let ye={};const We=O=>{const U=/\(\s*\d+\s*\/\s*\d+\s*\)\s*$/.test(O.message),H=typeof O.total=="number"&&typeof O.current=="number"&&!U?`${O.message} (${O.current}/${O.total})`:O.message;switch(O.stage){case"media":c("transferring"),x(H);break;case"convert":c("converting"),x(H);break;case"finalize":c("updating"),x(H);break;case"error":c("error"),x(H);break;case"done":c("success"),x(H);break;default:x(H)}};if(!V||V.toLowerCase()==="unknown")if((A.current?.length||0)>0)V="Map Series";else try{(Array.isArray(P?.values?.entries)?P.values.entries:[]).length>0&&(V="Map Series")}catch{}const De=(me||V||"").toLowerCase();if(De==="map journal"||De==="mapjournal")ye=(await new vt({classicJson:P,themeId:"summit",progress:We,token:n}).convert()).storymapJson;else if(De==="map tour"||De==="tour")ye=(await at.convert({classicJson:P,themeId:"summit",progress:We})).storymapJson;else if(De==="swipe")ye=(await new Le({classicJson:P,themeId:"summit",progress:We,token:n}).convert()).storymapJson;else if(De==="map series"||De==="mapseries"){const O=await gt.convertSeries({classicJson:P,themeId:"summit",progress:We,token:n}),U=Array.isArray(O.entryTitles)?O.entryTitles:[],H=Array.isArray(O.builderLinks)?O.builderLinks:[],K=Array.isArray(O.thumbnailUrls)?O.thumbnailUrls:[],Q=Array.isArray(O.draftItemIds)?O.draftItemIds:[],ue=le=>typeof le=="string"&&/^[a-f0-9]{32}$/i.test(le),Y=Q.filter(ue);A.current=Y,j.current=K;const ge=U.map((le,Ce)=>{const Ee=Y[Ce],$e=H[Ce]||"#",ve=Ee&&Ee.length?`https://storymaps.arcgis.com/stories/${Ee}/edit`:$e;return{title:le,href:ve}}).filter(le=>le.href&&le.href!=="#");ge.length>0&&(N("Map Series conversion complete. See links below."),k(ge));try{Oe.onExit("convert-story",{type:"step",output:{mapSeries:!0,entries:(A.current||[]).length}})}catch{}return}G();try{Oe.onExit("convert-story",{type:"step",output:{ok:!0}})}catch{}try{const U=ye.nodes||{},H=Object.entries(U).find(([,K])=>K&&K.type==="storycover");if(H){const[K,Q]=H,ue=(Q.data?.title||"").trim();if((!ue||/^(swipe|spyglass)$/i.test(ue))&&u)try{const le=await tt(u,n),Ce=String(le?.title??"").trim();Ce&&(Q.data={...Q.data||{},title:Ce},U[K]=Q,ye.nodes=U,console.debug("[CoverTitle][UI] Replaced generic cover title with AGO item title:",Ce))}catch{}}}catch{}try{c("transferring"),x("Transferring images to story resources...");try{Oe.onEnter("transfer-media",{type:"step"})}catch{}const O=Ii(ye);if(O.length){const U=async(K,Q,ue,Y)=>{const ge=K;let le=K;try{if(!(/^https?:\/\//i.test(K)||K.startsWith("//"))){const $e=K.replace(/^\.\/?/,""),ze=!/^resources\//i.test($e)?`resources/${$e}`:$e,et=(u||"").trim();et&&(le=`https://www.arcgis.com/sharing/rest/content/items/${et}/${ze}`)}}catch{le=K}const Ce=await xi(le,Q,ue,Y);return{originalUrl:ge,resourceName:Ce.resourceName,transferred:Ce.isTransferred}},H=await hi.transferBatch({urls:O,storyId:de,username:$,token:n,progress:We,uploader:U});ye=fi.apply(ye,H)}}catch(O){console.warn("[Converter] Image transfer step failed or skipped:",O);try{Oe.onExit("transfer-media",{type:"step",output:{ok:!1,error:String(O?.message||O)}})}catch{}}try{Oe.onExit("transfer-media",{type:"step",output:{ok:!0}})}catch{}try{const O=ye,U=O.resources&&Object.values(O.resources).find(ge=>ge.type==="converter-metadata"),H=U?.data?.classicMetadata?.mappingDecisions?.customCss?.combined;if(H){const ge=new Blob([H],{type:"text/css"}),le=URL.createObjectURL(ge);let Ce="custom-css.css";try{const $e=((O.nodes&&Object.values(O.nodes).find(ve=>ve&&ve.type==="storycover"))?.data?.title||"").trim();if($e){const ve=$e.toLowerCase().replace(/[^a-z0-9\s-_]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");ve&&(Ce=`${ve}-custom.css`)}}catch{}Z({css:H,url:le,fileName:Ce})}const K=U?.data?.classicMetadata?.webmapVersionWarnings,Q=U?.data?.classicMetadata?.webmapProtocolWarnings,ue=[],Y=ne;if(Array.isArray(K)&&ue.push(...K),Array.isArray(Q)&&ue.push(...Q),ue.length){const ge=ue.map(le=>({itemId:le.itemId,message:le.message.replace(/https:\/\/<org_url>\.arcgis\.com/gi,Y)}));xe(le=>{const Ce=[...le];for(const Ee of ge)Ce.some($e=>$e.itemId===Ee.itemId&&$e.message===Ee.message)||Ce.push({itemId:Ee.itemId,level:"warning",message:Ee.message});return Ce})}}catch{}try{const O=ye,U=O.resources||(O.resources={}),H=(u||"").trim(),K=(me||"").trim();let Q=Object.entries(U).find(([,le])=>le&&le.type==="converter-metadata");if(!Q){const le=`r-${Date.now()}`;U[le]={type:"converter-metadata",data:{}},Q=[le,U[le]]}const[ue,Y]=Q,ge=Y.data||(Y.data={});H&&(ge.classicItemId=H),K&&(ge.classicType=K),delete U[ue],U[ue]=Y,O.resources=U}catch{}try{if(!R&&Array.isArray(be)&&be.length){const O=ye,U=O.resources||{},H=Object.entries(U).find(([,K])=>K&&K.type==="converter-metadata");if(H){const[K,Q]=H,ue=Q.data||{},Y=ue.classicMetadata||{};Y.webmapChecks=be.map(ge=>({itemId:ge.itemId,level:ge.level,message:ge.message})),ue.classicMetadata=Y,Q.data=ue,U[K]=Q,O.resources=U}else{const K=`r-converter-metadata-${Date.now()}`,Q={type:"converter-metadata",data:{classicMetadata:{webmapChecks:be.map(ue=>({itemId:ue.itemId,level:ue.level,message:ue.message}))}}};U[K]=Q,O.resources=U}}}catch{}c("updating"),x("Fetching target storymap details...");const Je=await tt(de,n||"");G();let Ge=ss(Je);if(!Ge){Ge="draft.json";try{const O=Array.isArray(Je.typeKeywords)?Je.typeKeywords:[],U=O.some(H=>/^smdraftresourceid:/.test(String(H)))?O:[...O,`smdraftresourceid:${Ge}`];await jt(de,$,U,n)}catch{}}x(`Removing old draft resource (${Ge})...`);try{await ts(de,$,Ge,n)}catch{}G();try{if(!Ue(ye)){const U=Array.isArray(Ue.errors)?Ue.errors:[],H=U.length?String(U[0]?.message??JSON.stringify(U[0])):"Schema validation failed";throw new Error(`Draft JSON failed client-side schema validation: ${H}`)}}catch(O){throw O instanceof Error?O:new Error(String(O))}try{x("Validating draft JSON schema...");const O=await fetch("/.netlify/functions/validate-draft",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(ye)});if(!O.ok){const U=await O.json().catch(()=>({})),H=Array.isArray(U?.errors)?U.errors:[],K=H.length?H[0]?.message||JSON.stringify(H[0]):`HTTP ${O.status}`;throw new Error(`Draft JSON failed schema validation: ${K}`)}}catch(O){throw O instanceof Error?O:new Error(String(O))}x(`Uploading new draft resource (${Ge})...`);try{const U=ye.nodes||{};for(const[,H]of Object.entries(U))if(H?.type==="action-button"&&H.dependents){for(const K of Object.keys(H.dependents))/^actionMedia_content_/.test(K)&&delete H.dependents[K];Object.keys(H.dependents).length===0&&delete H.dependents}}catch{}const Mt=new Blob([JSON.stringify(ye)],{type:"application/json"});await ct(de,$,Mt,Ge,n),G(),x("Updating keywords...");const wt=Je,dt=Array.isArray(wt?.typeKeywords)?wt.typeKeywords:[];if(!dt.includes("smconverter:online-app")){const O=[...dt,"smconverter:online-app"];await jt(de,$,O,n),G()}G(),c("success"),x("Classic "+z+":  "+re),N(`https://storymaps.arcgis.com/stories/${de}/edit`),e(!0);try{const O=ye,U=O.resources||{};for(const[H,K]of Object.entries(U))if(K?.type==="webmap"){const Q=K.data||{},ue=Q.initialState||{};for(const Y of["extent","center","viewpoint","mapLayers"])ue&&Y in ue&&!(Y in Q)&&(Q[Y]=ue[Y]);K.data=Q,U[H]=K}O.resources=U,ye=O,console.debug("[SaveGuard] Promoted initialState fields to resource data keys")}catch{}try{const O=String(u||"").trim(),U=new Date,H=Y=>String(Y).padStart(2,"0"),K=`${H(U.getMonth()+1)}-${H(U.getDate())}T${H(U.getHours())}${H(U.getMinutes())}`,Q=`tests/output/converted-${O?`${O}-${K}`:`converted-app-${K}`}.json`,ue=`tests/output/trace-${O?`${O}-${K}`:`converted-app-${K}`}.json`;{try{Oe.onEnter("save-outputs",{type:"step",input:{draftFile:Q}})}catch{}const Y=await fetch("/.netlify/functions/save-converted",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({filename:Q,storyId:de,classicItemId:u,json:ye})});if(Y.ok){const ge=await Y.json(),le=ge?.path||ge?.fileName||"ok";console.info("[LocalSave] Converted JSON saved:",le)}else console.warn("[LocalSave] Failed to save converted JSON locally:",Y.status);try{Oe.endSession();const ge=Oe.export();if(ge){const le=await fetch("/.netlify/functions/save-converted",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({filename:ue,storyId:de,classicItemId:u,json:ge})});if(le.ok){const Ce=await le.json().catch(()=>({})),Ee=Ce?.relPath||Ce?.path||ue;try{localStorage.setItem("lastTracePath",Ee)}catch{}}}}catch{}try{Oe.onExit("save-outputs",{type:"step",output:{ok:!0,draftFile:Q,traceFile:ue}})}catch{}}if((me||V||"").toLowerCase().includes("map series"))try{try{const Y=await gt.convertSeries({classicJson:P,themeId:"auto",progress:We,token:n}),ge=Array.isArray(Y.storymapJsons)?Y.storymapJsons:[];for(let ve=0;ve<ge.length;ve++){const ze=ge[ve],et=`tests/output/converted-${O?`${O}-${K}`:`converted-app-${K}`}-entry-${ve+1}.json`,Ye=await fetch("/.netlify/functions/save-converted",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({filename:et,storyId:de,classicItemId:u,json:ze})});if(Ye.ok){const He=await Ye.json(),Pi=He?.path||He?.fileName||`entry-${ve+1}.json`}else console.warn("[LocalSave] Failed to save Map Series entry JSON locally:",ve+1,Ye.status)}const le=P.values?.settings||{},Ce=le.layout?.id,Ee=le.layoutOptions?.panel||{},$e={type:"collection-draft",classicItemId:O,collectionType:Ce,panelDefaults:{position:Ee.position,size:Ee.size},entries:(Y.entryTitles||[]).map((ve,ze)=>({index:ze+1,title:ve}))};{const ve=await fetch("/.netlify/functions/save-converted",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({filename:`tests/output/converted-${O?`${O}-${K}`:`converted-app-${K}`}-collection.json`,storyId:de,classicItemId:u,json:$e})});if(ve.ok){const ze=await ve.json(),et=ze?.path||ze?.fileName||"collection-draft.json"}else console.warn("[LocalSave] Failed to save Map Series collection draft locally:",ve.status)}}catch(Y){console.warn("[LocalSave] Error saving Map Series entries locally:",Y)}}catch{}}catch(O){console.warn("[LocalSave] Error saving converted JSON locally:",O?.message)}}catch($){$ instanceof Error&&$.message==="Conversion cancelled by user intervention"?(c("error"),x($.message)):(c("error"),x($ instanceof Error?$.message:"An unknown error occurred")),$ instanceof Error&&$.stack&&console.debug("[ConverterCatch]",$.stack);try{Oe.onExit("convert-flow",{type:"convert",output:{error:String($ instanceof Error?$.message:$)}})}catch{}e(!1)}try{Oe.onExit("convert-flow",{type:"convert",output:{ok:!0}})}catch{}};return J.useEffect(()=>{if(!d.length)return;let $,P,V=!1;return(async()=>{try{const re={...L.current};for(const fe of(A.current||[]).filter(Ne=>typeof Ne=="string"&&/^[a-f0-9]{32}$/i.test(Ne)))typeof re[fe]!="boolean"&&(re[fe]=!1);L.current=re;const oe=(A.current||[]).filter(fe=>typeof fe=="string"&&/^[a-f0-9]{32}$/i.test(fe)).map(fe=>!!re[fe]);F.current=oe,I(oe);const de=n;if(!de)return;const Fe=(A.current||[]).slice().filter(fe=>typeof fe=="string"&&/^[a-f0-9]{32}$/i.test(fe));if(!Fe.length)return;const Te=async()=>{if(V)return;const fe=F.current.slice();for(let z=0;z<Fe.length;z++){const ye=Fe[z];if(!(!ye||fe[z]))try{const De=`${ne&&ne.length?ne:`https://${ae()}`}/sharing/rest/content/items/${encodeURIComponent(ye)}/resources?f=json&token=${encodeURIComponent(de)}`,Je=await fetch(De);if(!Je.ok)continue;const Ge=await Je.json();(Array.isArray(Ge?.resources)?Ge.resources:[]).some(dt=>String(dt?.resource||"").toLowerCase().endsWith("published_data.json"))&&(fe[z]=!0,L.current[ye]=!0)}catch{}}const Ne=(A.current||[]).filter(z=>typeof z=="string"&&/^[a-f0-9]{32}$/i.test(z)).map(z=>!!L.current[z]);F.current=Ne,I(Ne);const Ke=Ne.length>0&&Ne.every(Boolean);C(Ke),Ke&&$&&(clearInterval($),$=void 0)};V||await Te(),P=window.setTimeout(async()=>{V||($=window.setInterval(async()=>{await Te()},1e4))},1500)}catch{}})(),()=>{V=!0,P&&clearTimeout(P),$&&clearInterval($)}},[d,ae,ne,n]),v.jsxs("div",{className:"converter-container",children:[v.jsx("h2",{children:"Classic Story Map Converter"}),v.jsxs("p",{children:["Convert Classic Esri Story Maps to ",v.jsx("a",{href:"https://storymaps.arcgis.com",target:"_blank",rel:"noopener noreferrer",children:"ArcGIS StoryMaps"})]}),v.jsxs("div",{className:"converter-instructions",children:[v.jsx("h3",{children:"Instructions:"}),v.jsxs("ol",{children:[v.jsx("li",{children:"Sign in to ArcGIS Online using the sign-in button above"}),v.jsx("li",{children:"Enter the Item ID of your Classic Story"}),v.jsx("li",{children:"Click Convert to transform your classic story into the new format"}),v.jsx("li",{children:"Click Finishing Publishing to open the converted story. Review and publish when ready"})]})]}),v.jsxs("div",{className:"converter-input-group",children:[v.jsx("label",{className:"converter-label",children:"Classic Story Item ID:"}),v.jsx("input",{type:"text",value:u,onChange:$=>f($.target.value),placeholder:"e.g., 858c4126f0604d1a86dea06ffbdc23a3",className:"converter-input"})]}),v.jsx("div",{className:"converter-input-group",children:v.jsxs("label",{className:"converter-label",children:[v.jsx("input",{type:"checkbox",checked:!R,onChange:$=>X(!$.target.checked)})," ","Enable metadata output"," ",v.jsx("span",{role:"button","aria-label":"Metadata output info",title:"When enabled, adds a resource node to the output json recording the original classic story's parameters and other diagnostics",onClick:()=>alert("When enabled, adds a resource node to the output json recording the original classic story's parameters and other diagnostics"),className:"metadata-info-icon",children:v.jsx("span",{className:"metadata-info-fallback",children:"â„¹ï¸"})})]})}),se>0&&v.jsx("div",{className:"converter-controls-row",children:v.jsx("button",{className:"converter-btn secondary",onClick:()=>{Ws(),as(),m("Cache cleared"),setTimeout(()=>m(""),2e3)},title:"Clear in-memory fetch cache",children:"Clear cached data"})}),g!=="success"?v.jsx("button",{className:`converter-btn ${p&&["fetching","converting","transferring","updating"].includes(g)?"cancel-hover":""}`,title:g==="idle"||g==="error"?"Start conversion":p?"Cancel conversion (Esc)":"Conversion in progress",onClick:g==="idle"||g==="error"?cs:we,onMouseEnter:()=>{!S&&["fetching","converting","transferring","updating"].includes(g)&&w(!0)},onMouseLeave:()=>w(!1),disabled:b,children:g==="idle"||g==="error"?M||"Convert":p&&["fetching","converting","transferring","updating"].includes(g)?"Cancel":M||"Convert"}):v.jsxs("div",{className:"converter-message converter-message-success",children:[v.jsx("button",{className:"converter-btn secondary",onClick:()=>{T&&window.open(T,"_blank")},title:"Open in ArcGIS StoryMaps to finish publishing",children:"Click to Finish Publishing â†’"}),T&&v.jsxs("div",{className:"converter-help-text publishing-url-block",children:[v.jsx("strong",{children:"Publishing URL:"})," ",v.jsx("a",{href:T,target:"_blank",rel:"noopener noreferrer",children:T})]})]}),!1,S&&g!=="idle"&&g!=="error"&&g!=="success"&&!a.current&&!ie&&v.jsx("div",{className:"cancel-mobile-wrapper",children:v.jsx("button",{className:"converter-btn cancel-mobile",onClick:we,title:"Cancel conversion",children:"Cancel"})}),g!=="success"&&y&&v.jsxs("div",{className:`converter-message converter-message-${g}`,children:[v.jsx("strong",{children:g==="error"?"Error:":"Status:"})," ",y]}),!!r&&v.jsx("div",{className:"converter-toast",role:"status","aria-live":"polite",children:r}),ee&&v.jsxs("div",{className:"converter-warning",children:[v.jsx("strong",{children:"Custom CSS Detected!"})," Your classic story used custom CSS settings. To recreate your custom styles you should create a new ArcGIS StoryMaps Theme ",v.jsx("a",{href:"https://storymaps.arcgis.com/themes/new",target:"_blank",rel:"noopener noreferrer",children:"here"})," with your custom colors and styles, then apply the new Theme within the ArcGIS StoryMaps Builder (under the Design tab). ",v.jsx("a",{href:ee.url,download:ee.fileName||"custom-css.css",children:"Click this link"})," to download a copy of your custom CSS."]}),(be.length>0||je)&&v.jsxs("div",{className:"converter-warning",children:[v.jsx("strong",{children:"Webmap Checks:"}),be.length===0?v.jsx("div",{children:"No issues detected for referenced webmaps."}):v.jsxs(v.Fragment,{children:[v.jsx("ul",{children:be.map(($,P)=>{const V=Array.isArray($.details?.failures)?$.details.failures:[],re=new Map;for(const z of V){const ye=`${z.url??""}::${z.layerTitle??""}`;re.has(ye)||re.set(ye,{layerTitle:z.layerTitle,layerItemId:z.layerItemId,url:z.url,status:typeof z.status=="number"?z.status:void 0,error:typeof z.error=="string"?z.error:void 0})}const oe=Array.from(re.values()),de=oe.some(z=>/HTTP URL/i.test(String(z.error||""))||/^http:\/\//i.test(String(z.url||""))),Ie=oe.some(z=>/timeout/i.test(String(z.error||""))||typeof z.status=="number"&&z.status===504),Fe=oe.some(z=>/not\s*found|404/i.test(String(z.error||""))||typeof z.status=="number"&&z.status===404);let Te=ne;if(!Te||Te===Se){const z=typeof l=="object"&&l&&(l.orgUrl||l.org?.url)||"";if(z)try{const ye=new URL(z);Te=`${ye.protocol}//${ye.hostname}`}catch{Te=`https://${ae()}`}else Te=`https://${ae()}`}const fe=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${Te}/home/item.html?id=${$.itemId}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,Ne=`Some services did not respond (timeout). This may be temporary. Try opening the <a href="${Te}/home/item.html?id=${$.itemId}" target="_blank" rel="noopener noreferrer">web map</a> and checking that the layers load, or reload later. If timeouts persist, consider replacing the layer or contacting the service owner.`,Ke=`Some services returned 404 (Not Found). Open the <a href="${Te}/home/item.html?id=${$.itemId}" target="_blank" rel="noopener noreferrer">web map</a> to remove broken layers, or replace with an available service.`;return v.jsxs("li",{children:[de?v.jsxs(v.Fragment,{children:[`WARNING: Webmap [${$.itemId}] uses http services.`,$.details?.webmapTitle&&v.jsxs("div",{children:["Title: ",$.details.webmapTitle]}),v.jsx("div",{dangerouslySetInnerHTML:{__html:fe}})]}):Ie?v.jsxs(v.Fragment,{children:[`WARNING: Webmap [${$.itemId}] has timeout failures.`,$.details?.webmapTitle&&v.jsxs("div",{children:["Title: ",$.details.webmapTitle]}),v.jsx("div",{dangerouslySetInnerHTML:{__html:Ne}})]}):Fe?v.jsxs(v.Fragment,{children:[`WARNING: Webmap [${$.itemId}] has missing layer(s).`,$.details?.webmapTitle&&v.jsxs("div",{children:["Title: ",$.details.webmapTitle]}),v.jsx("div",{dangerouslySetInnerHTML:{__html:Ke}})]}):/^\s*(ERROR|WARNING|INFO):/i.test($.message)?v.jsx("span",{dangerouslySetInnerHTML:{__html:$.message}}):v.jsxs(v.Fragment,{children:[$.level.toUpperCase(),": [",$.itemId,"] ",v.jsx("span",{dangerouslySetInnerHTML:{__html:$.message}})]}),oe.length>0&&v.jsx("div",{children:`WARNING: Webmap [${$.itemId}] has ${oe.length} failing layer(s).`}),$.details?.webmapTitle&&v.jsxs("div",{children:["Title: ",$.details.webmapTitle]}),oe.length>0&&v.jsxs("div",{children:[v.jsx("button",{className:"converter-details-toggle-btn",onClick:()=>pe(z=>({...z,[$.itemId]:!z[$.itemId]})),children:ce[$.itemId]?"Hide details":`Show details (${oe.length})`}),ce[$.itemId]&&v.jsx("ul",{children:oe.map((z,ye)=>v.jsxs("li",{children:[z.layerTitle?`Layer name: ${z.layerTitle}`:"",z.layerItemId?v.jsxs(v.Fragment,{children:[" ","[",v.jsx("a",{href:_e(z.layerItemId),target:"_blank",rel:"noopener noreferrer",children:z.layerItemId}),"]"," "]}):"",z.error?` â€” Error: ${z.error}`:"",typeof z.status=="number"?` (status ${z.status})`:"",z.url?v.jsxs(v.Fragment,{children:[" ","â€” ",v.jsx("a",{href:z.url,target:"_blank",rel:"noopener noreferrer",children:"Link to endpoint"})," "]}):""]},`${$.itemId}-fail-${ye}`))})]})]},`${$.itemId}-${P}`)})}),v.jsxs("span",{children:["These issues wonâ€™t stop conversion, but may prevent maps from loading. Please fix with ",v.jsx("a",{href:"https://assistant.esri-ps.com/",children:"ArcGIS Assistant"})," or in ArcGIS Online."]})]})]}),d.length>0&&v.jsxs("div",{className:"mapseries-publish",children:[v.jsx("h3",{children:"Publish Map Series Entries"}),(()=>{try{if(!Array.isArray(h)||h.length!==d.length){const P=(A.current||[]).map(re=>!!L.current[re]),V=P.length===d.length?P:Array.from({length:d.length},(re,oe)=>!!P[oe]);I(V)}}catch{}return null})(),v.jsx("ul",{children:d.map(($,P)=>v.jsxs("li",{children:[v.jsxs("a",{href:$.href,target:"_blank",rel:"noopener",children:["Open Builder: ",$.title]}),v.jsxs("label",{className:"mapseries-publish-label",children:[v.jsx("input",{type:"checkbox",checked:h[P]===!0,onChange:V=>{const re=[...h];re[P]=V.currentTarget.checked,I(re);const oe=re.length>0&&re.every(Boolean);C(oe)}})," Published"]})]},P))}),st(u)&&v.jsxs(v.Fragment,{children:[v.jsx("button",{className:"mapseries-collection-publish-btn",disabled:!E,onClick:async()=>{try{m("Creating Collection...");const $=n;if(!$){m("No token available"),setTimeout(()=>m(""),2e3);return}const P=await kt($),V=await tt(u,$),re=String(V?.title||"").trim(),oe=re?`(Converted) ${re}`:"(Converted) Map Series",de=V?.typeKeywords,Fe=(Array.isArray(de)?de.filter(De=>typeof De=="string"):[]).some(De=>/accordion/i.test(De)),Te=Fe?"tab":void 0;let fe="summit",Ne={};try{fe="summit",Ne={}}catch{}const Ke=d.map((De,Je)=>({itemId:A.current?.[Je]||"",title:De.title,thumbnailUrl:j.current?.[Je]||""})),z=await ns(P,$,oe,Ke,{byline:"",themeBase:fe,themeOverrides:Ne,layoutType:Te}),ye=V?.thumbnail;if(ye){const De=`${Xe()}/sharing/rest/content/items/${u}/info/${ye}?token=${$}`;try{await rs(z,P,$,De)}catch(Je){console.warn("[CreateCollection] Thumbnail update failed:",Je)}}const We=`https://storymaps.arcgis.com/stories/${z}/edit`;D(We),m(`Collection created: ${z}`),setTimeout(()=>m(""),3e3)}catch($){console.error("[CreateCollection] Failed:",$),m("Failed to create Collection"),setTimeout(()=>m(""),3e3)}},children:"Create Collection"}),W?v.jsxs("div",{className:"converter-message converter-message-success publishing-url-block collection-publish-block",children:[v.jsx("button",{className:"converter-btn secondary",onClick:()=>{window.open(W,"_blank")},title:"Open Collection in ArcGIS StoryMaps to finish publishing",children:"Click to Finish Publishing â†’"}),v.jsxs("div",{className:"converter-help-text collection-publish-url",children:[v.jsx("strong",{children:"Publishing URL:"})," ",v.jsx("a",{href:W,target:"_blank",rel:"noopener noreferrer",children:W})]})]}):null]})]}),!1]})}function Fi(){const{token:b,userInfo:e}=lt(),[t,s]=J.useState({status:"idle"}),i=J.useMemo(()=>new URLSearchParams(window.location.search),[]),o=J.useMemo(()=>{try{const n=localStorage.getItem("pendingSaveCsvLayerParams");return n?JSON.parse(n):{}}catch{return{}}},[]),a=i.get("webmapId")??o.webmapId??"",p=i.get("csvItemId")??o.csvItemId??"";function w(n){if(!n)return null;const l=String(n.type||"").toLowerCase();if(["heatmap","simple","unique-value","class-breaks","dot-density","dictionary","pie-chart"].includes(l))return n;const f=n.symbol||n;String(f.type||f.style||"").toLowerCase();function g(y){if(!y)return null;const x=String(y.type||y.style||"").toLowerCase(),r={...y},m=d=>!d||Array.isArray(d)||typeof d=="string"?d:typeof d=="object"&&"r"in d&&"g"in d&&"b"in d?[d.r,d.g,d.b,"a"in d?d.a:255]:d;if(r.color&&(r.color=m(r.color)),r.outline&&(r.outline={...r.outline},r.outline.color&&(r.outline.color=m(r.outline.color))),x==="esripms"||x==="picturemarkersymbol"){r.type="picture-marker",!r.url&&r.imageData&&(r.url=`data:image/png;base64,${r.imageData}`),!r.width&&r.size&&(r.width=r.size),!r.height&&r.size&&(r.height=r.size);const d=["type","url","width","height","angle","xoffset","yoffset"];Object.keys(r).forEach(k=>{d.includes(k)||delete r[k]}),delete r.imageData}else if(x==="esrisms"||x==="simplemarkersymbol"){r.type="simple-marker";const d=["type","style","color","size","outline","angle","xoffset","yoffset"];Object.keys(r).forEach(k=>{d.includes(k)||delete r[k]})}else if(x==="esrisls"||x==="simplelinesymbol"){r.type="simple-line";const d=["type","style","color","width"];Object.keys(r).forEach(k=>{d.includes(k)||delete r[k]})}else if(x==="esrisfs"||x==="simplefillsymbol"){r.type="simple-fill";const d=["type","style","color","outline"];Object.keys(r).forEach(k=>{d.includes(k)||delete r[k]})}else return{type:"simple-marker",color:m(r.color)||"red",size:typeof r.size=="number"?r.size:12,outline:r.outline?{color:m(r.outline.color)||"white",width:1}:void 0};return r}const c=g(f);return c?{type:"simple",symbol:c}:n.visualVariables?{type:"simple",visualVariables:n.visualVariables}:null}function S(n,l=[]){if(!n)return null;const u=l.map(A=>A.name),f=A=>u.includes(A),g=f("TITLE")?"TITLE":f("Title")?"Title":"TITLE",c=f("DESCRIPTION")?"DESCRIPTION":f("Description")?"Description":"DESCRIPTION",y=f("IMAGE_URL")?"IMAGE_URL":f("Image_URL")?"Image_URL":"IMAGE_URL",x=f("IMAGE_LINK_URL")?"IMAGE_LINK_URL":f("Image_Link_URL")?"Image_Link_URL":"IMAGE_LINK_URL",r=n.title||`{${g}}`,m=n.description||`{${c}}`,d=Array.isArray(n.mediaInfos)?n.mediaInfos:[],k=[];return m&&k.push({type:"text",text:m}),d.forEach(A=>{if(String(A?.type).toLowerCase()==="image"&&A?.value){const j=A.value;k.push({type:"media",mediaInfos:[{type:"image",value:{sourceURL:j.sourceURL||`{${y}}`,linkURL:j.linkURL||`{${x}}`}}]})}}),{title:r,content:k}}return J.useEffect(()=>{async function n(){if(!(!b||!e)){if(!a||!p){s({status:"error",message:"Missing webmapId or csvItemId in query params."});return}try{s({status:"running",step:"Registering token"}),ws.portalUrl=Xe(),vs.registerToken({server:`${Xe()}/sharing/rest`,token:b,expires:Date.now()+3600*1e3,ssl:!0,userId:e.username}),s({status:"running",step:"Loading webmap"});const l=new gs({portalItem:{id:a}});await l.load(),await l.when(),s({status:"running",step:"Creating CSVLayer"});const u=new bs({portalItem:{id:p}});u.visible=!0,u.title=u.title??"Converted Map Notes",u.outFields=["*"],u.url=`${Xe()}/sharing/rest/content/items/${p}/data`,await u.load(),await u.when(),s({status:"running",step:"Copying renderer/popup from Map Notes"});try{const m=`${Xe()}/sharing/rest/content/items/${a}/data?f=json&token=${encodeURIComponent(b)}`,d=await fetch(m);if(d.ok){const j=((await d.json())?.operationalLayers||[]).find(L=>String(L?.layerType||L?.type||"").toLowerCase()==="mapnotes"||String(L?.title||"").toLowerCase().includes("map notes")),I=(j?.layerDefinition||j?.featureCollection?.layers?.[0]?.layerDefinition)?.drawingInfo||j?.drawingInfo,F=j?.popupInfo;if(I?.renderer){const L=w(I.renderer);L&&(u.renderer=L)}if(F){const L=S(F,u.fields||[]);L&&(u.popupEnabled=!0,u.popupTemplate=L)}}}catch{}const g=(u.fields??[]).map(m=>m.name.toLowerCase()),c=m=>m.find(d=>g.includes(d)),y=c(["x","longitude","lon","long"]),x=c(["y","latitude","lat"]);y&&x?(u.longitudeField=y,u.latitudeField=x):(u.longitudeField=u.longitudeField??"X",u.latitudeField=u.latitudeField??"Y"),s({status:"running",step:"Adding layer to webmap"}),l.add(u),s({status:"running",step:"Saving webmap"});const r=await l.save({ignoreUnsupported:!0});if(r&&r.id){try{await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:b,webmapId:a,csvItemId:p,title:u.title||"Converted Map Notes",visible:!0,opacity:1,lonField:u.longitudeField||"x",latField:u.latitudeField||"y"})})}catch{}const m=`${globalThis.__ORG_BASE||"https://www.arcgis.com"}/sharing/rest/content/items/${a}/data?f=json&token=${encodeURIComponent(b)}`;let d=[],k={renderer:u.renderer,popupTemplate:u.popupTemplate,layerTitle:u.title};try{const A=l.layers.find(j=>j.portalItem?.id===p||j.title===u.title);A&&(k={renderer:A.renderer,popupTemplate:A.popupTemplate,layerTitle:A.title})}catch{}try{const A=await fetch(m);if(A.ok){const h=(await A.json())?.operationalLayers||[];d=h.map(C=>C?.title).filter(Boolean);const I=h.find(C=>String(C?.layerType||C?.type).toLowerCase()==="csv"&&(C?.itemId===p||String(C?.title||"")===String(u.title||"Converted Map Notes"))),L=I?.layerDefinition?.drawingInfo||I?.drawingInfo,E=I?.popupInfo;(L?.renderer||E)&&(k={renderer:L?.renderer,popupTemplate:E,layerTitle:I?.title||k.layerTitle}),k.allOperationalLayers=h,k.csvOperationalLayer=I}}catch{}s({status:"success",webmapId:a,verification:{titles:d},layerSummary:k})}else throw new Error("Save did not return success.")}catch(l){try{s({status:"running",step:"Fallback: REST update"});const u=await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:b,webmapId:a,csvItemId:p,title:"Converted Map Notes",visible:!0,opacity:1,lonField:"x",latField:"y"})});let f=null,g=null;try{f=await u.json()}catch{try{g=await u.text()}catch{}}if(u.ok&&(f?.success||f?.id)){const c=`${globalThis.__ORG_BASE||"https://www.arcgis.com"}/sharing/rest/content/items/${a}/data?f=json&token=${encodeURIComponent(b)}`;let y=[];try{const r=await fetch(c);r.ok&&(y=((await r.json())?.operationalLayers||[]).map(d=>d?.title).filter(Boolean))}catch{}s({status:"success",webmapId:a,verification:{titles:y},layerSummary:{}})}else throw new Error(f?.message||g||"Fallback update failed")}catch(u){const f=l?.details??{},g=f.errors?JSON.stringify(f.errors):"";s({status:"error",message:`Save failed: ${l?.message??String(l)}${g?` â€” ${g}`:""}. Fallback failed: ${u?.message??String(u)}`,details:f})}}}}n()},[b,e,a,p]),J.useEffect(()=>{const n=i.get("webmapId"),l=i.get("csvItemId");(n||l)&&localStorage.setItem("pendingSaveCsvLayerParams",JSON.stringify({webmapId:n,csvItemId:l}))},[i]),v.jsxs("div",{className:"page",children:[v.jsx("h2",{children:"Save CSV Layer to WebMap"}),v.jsxs("p",{children:["WebMap ID: ",v.jsx("code",{children:a||"(missing)"})]}),v.jsxs("p",{children:["CSV Item ID: ",v.jsx("code",{children:p||"(missing)"})]}),t.status==="idle"&&v.jsx("p",{children:"Waiting for authenticationâ€¦"}),t.status==="running"&&v.jsxs("p",{children:["Working: ",t.step]}),t.status==="success"&&v.jsxs("p",{children:["Success! Layer added and saved to WebMap ",v.jsx("code",{children:t.webmapId}),"."]}),t.status==="success"&&t.verification&&v.jsxs("div",{children:[v.jsx("p",{children:"Operational layer titles:"}),v.jsx("ul",{children:t.verification.titles.map((n,l)=>v.jsx("li",{children:v.jsx("code",{children:n})},l))})]}),t.status==="success"&&t.layerSummary&&v.jsxs("div",{children:[v.jsx("p",{children:"CSV layer summary:"}),v.jsxs("p",{children:["Layer title: ",v.jsx("code",{children:t.layerSummary.layerTitle||"(unknown)"})]}),v.jsxs("details",{children:[v.jsx("summary",{children:"Renderer"}),v.jsx("pre",{className:"error-details",children:JSON.stringify(t.layerSummary.renderer,null,2)})]}),v.jsxs("details",{children:[v.jsx("summary",{children:"Popup Template"}),v.jsx("pre",{className:"error-details",children:JSON.stringify(t.layerSummary.popupTemplate,null,2)})]}),v.jsxs("details",{children:[v.jsx("summary",{children:"Raw CSV operationalLayer"}),v.jsx("pre",{className:"error-details",children:JSON.stringify(t.layerSummary.csvOperationalLayer,null,2)})]}),v.jsxs("details",{children:[v.jsx("summary",{children:"All operationalLayers"}),v.jsx("pre",{className:"error-details",children:JSON.stringify(t.layerSummary.allOperationalLayers,null,2)})]})]}),t.status==="error"&&v.jsxs("div",{children:[v.jsxs("p",{className:"error",children:["Error: ",t.message]}),t.details&&v.jsx("pre",{className:"error-details",children:JSON.stringify(t.details,null,2)})]})]})}function Bi(){const{userInfo:b,token:e}=lt(),t=new URLSearchParams(window.location.search),s=t.get("action"),i=t.get("dev")==="true";return v.jsxs(v.Fragment,{children:[v.jsx("div",{className:"bg-image"}),v.jsxs("div",{className:"app-content",children:[v.jsx(ks,{}),i||e&&b?s==="save-csv-layer"?v.jsx(Fi,{}):v.jsx(Di,{}):v.jsx(Us,{})]})]})}fs(window);ys.createRoot(document.getElementById("root")).render(v.jsx(J.StrictMode,{children:v.jsx(As,{children:v.jsx(Bi,{})})}));
