import{U as _e,r as E,j as d,C as yt,a as Ge,b as qe,c as Ke,d as gt,e as bt,f as wt,g as vt,h as Ye,i as It,k as St}from"./vendor-De31RcnK.js";import xt from"@arcgis/core/WebMap";import jt from"@arcgis/core/layers/CSVLayer";import Ct from"@arcgis/core/identity/IdentityManager";import Nt from"@arcgis/core/config";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function r(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=r(i);fetch(i.href,n)}})();const Xe="wJK4zhJHaHyFzyQ2",Ze="https://regal-sable-0a6dde.netlify.app/",Ee="arcgis_session",Je="arcgis_user_info";function At(f){try{const t=f.serialize();sessionStorage.setItem(Ee,t)}catch(t){console.warn("Could not serialize session:",t)}}function kt(){const f=sessionStorage.getItem(Ee);if(f)try{return _e.deserialize(f)}catch{sessionStorage.removeItem(Ee)}return null}function Ue(f){try{sessionStorage.setItem(Je,JSON.stringify(f))}catch(t){console.warn("Could not persist userInfo",t)}}function Tt(){const f=sessionStorage.getItem(Je);if(!f)return null;try{return JSON.parse(f)}catch{return sessionStorage.removeItem(Je),null}}function Lt(){const f=window.location.hash.substring(1),t=new URLSearchParams(f),r=t.get("access_token")||t.get("token"),s=t.get("expires_in");return{token:r,expires:s?Date.now()+parseInt(s,10)*1e3:null}}async function Qe(f){const r=await(await fetch(`https://www.arcgis.com/sharing/rest/community/self?f=json&token=${f}`)).json();return{username:r.username,role:r.role,userLicenseTypeId:r.userLicenseTypeId}}const lt=E.createContext({session:null,token:null,signIn:()=>{},signOut:()=>{},loading:!1,userInfo:null,setUserInfo:()=>{}}),Mt=({children:f})=>{const[t,r]=E.useState(kt()),[s,i]=E.useState(!0),[n,o]=E.useState(Tt()),[m]=E.useState(()=>new URLSearchParams(window.location.search).get("refactor")==="1");E.useEffect(()=>{const{token:a,expires:h}=Lt();if(!a){setTimeout(()=>i(!1),0);return}const u=new _e({clientId:Xe,redirectUri:Ze,token:a,tokenExpires:h?new Date(h):new Date(Date.now()+1e3*60*60*24*14),portal:"https://www.arcgis.com/sharing/rest"});r(u),At(u);try{if(window.location.hash&&/access_token=/.test(window.location.hash)){const l=window.location.pathname+window.location.search;window.history.replaceState({},"",l)}}catch{}Qe(a).then(l=>{const b=u.portal.replace(/\/$/,""),x=`${b}/community/users/${l.username}?f=json&token=${a}`,w=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${a}`;return Promise.all([fetch(x).then(j=>j.ok?j.json():Promise.reject(j.status)).catch(()=>null),fetch(w).then(j=>j.ok?j.json():Promise.reject(j.status)).catch(()=>null)]).then(([j,c])=>{const p=j?.thumbnail?`${b}/community/users/${l.username}/info/${j.thumbnail}?token=${a}`:void 0;let y;const I=c?.urlKey,g=c?.customBaseUrl;if(I&&g)y=`https://${I}.${g}`;else if(c?.portalHostname){const V=String(c.portalHostname);y=/^https?:/i.test(V)?V:`https://${V}`}const F={username:l.username,role:l.role,userType:l.userLicenseTypeId,fullName:j?.fullName||l.username,thumbnailUrl:p,orgUrl:y};o(F),Ue(F)}).catch(()=>{const j={username:l.username,role:l.role,userType:l.userLicenseTypeId};o(j),Ue(j)})}).catch(()=>o(null))},[m]),E.useEffect(()=>{if(t&&!n&&!s){const a=t.token;Qe(a).then(h=>{const u=t.portal.replace(/\/$/,""),l=`${u}/community/users/${h.username}?f=json&token=${a}`,b=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${a}`;return Promise.all([fetch(l).then(x=>x.ok?x.json():Promise.reject(x.status)).catch(()=>null),fetch(b).then(x=>x.ok?x.json():Promise.reject(x.status)).catch(()=>null)]).then(([x,w])=>{const j=x?.thumbnail?`${u}/community/users/${h.username}/info/${x.thumbnail}?token=${a}`:void 0;let c;const p=w?.urlKey,y=w?.customBaseUrl;if(p&&y)c=`https://${p}.${y}`;else if(w?.portalHostname){const g=String(w.portalHostname);c=/^https?:/i.test(g)?g:`https://${g}`}const I={username:h.username,role:h.role,userType:h.userLicenseTypeId,fullName:x?.fullName||h.username,thumbnailUrl:j,orgUrl:c};o(I),Ue(I)})}).catch(()=>{})}},[t,n,s]),E.useEffect(()=>{t&&console.log("Session token (updated):",t.token)},[t]);const v=()=>{_e.beginOAuth2({clientId:Xe,redirectUri:Ze,responseType:"token",popup:!1})},S=()=>{t&&(r(null),sessionStorage.removeItem(Ee))};return d.jsx(lt.Provider,{value:{session:t,token:t?.token??null,signIn:v,signOut:S,loading:s,userInfo:n,setUserInfo:o},children:f})},Le=()=>E.useContext(lt),$t="0.4.0-alpha.3";function Ft(){const{userInfo:f,token:t,signIn:r,signOut:s}=Le(),[i,n]=E.useState(!1),o=E.useRef(null);E.useEffect(()=>{function u(b){i&&o.current&&!o.current.contains(b.target)&&n(!1)}function l(b){b.key==="Escape"&&n(!1)}return document.addEventListener("mousedown",u),document.addEventListener("keydown",l),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",l)}},[i]);const m=!!t&&!!f,v=f?.username?.charAt(0).toUpperCase()||"?",S=f?.username?`https://www.arcgis.com/home/user.html?user=${f.username}`:void 0,a=f?.thumbnailUrl||null,h=f?.fullName||f?.username||"";return d.jsx("header",{className:"top-nav",children:d.jsxs("div",{className:"top-nav-inner",children:[d.jsxs("div",{className:"top-nav-titles",children:[d.jsx("div",{className:"top-nav-title",children:"Classic StoryMap Converter"}),d.jsxs("div",{className:"top-nav-subtitle",children:["Alpha | v",$t]})]}),d.jsx("nav",{className:"top-nav-list","aria-label":"Main navigation"}),d.jsxs("div",{className:"top-nav-actions",children:[!m&&d.jsx("button",{className:"account-btn",onClick:r,"data-testid":"sign-in-btn",children:"Sign In"}),m&&d.jsxs("div",{className:"account-control",ref:o,children:[d.jsxs("button",{type:"button",className:"account-trigger","aria-haspopup":"true","aria-label":"Account menu",onClick:()=>n(u=>!u),children:[d.jsx("svg",{className:"account-trigger-icon",width:"18",height:"18",viewBox:"0 0 24 24","aria-hidden":"true",children:d.jsx("path",{fill:"currentColor",d:"M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v2h20v-2c0-3.3-6.7-5-10-5z"})}),d.jsx("svg",{className:"account-caret",width:"12",height:"12",viewBox:"0 0 24 24","aria-hidden":"true",children:d.jsx("path",{fill:"currentColor",d:"M7 10l5 5 5-5z"})})]}),i&&d.jsxs("div",{className:"account-menu",role:"group","aria-label":"Account menu",children:[d.jsxs("div",{className:"account-menu-header",children:[a?d.jsx("img",{src:a,alt:"","aria-hidden":"true",className:"account-menu-avatar"}):d.jsx("span",{className:"account-menu-avatar fallback","aria-hidden":"true",children:v}),d.jsxs("div",{className:"account-menu-names",children:[d.jsx("div",{className:"account-full-name",children:h||f?.username||"Loading…"}),d.jsx("div",{className:"account-username-sub",children:f?.username})]})]}),d.jsx("div",{className:"account-menu-divider"}),S&&d.jsx("a",{href:S,target:"_blank",rel:"noopener",className:"account-menu-item",children:"View Profile"}),d.jsx("button",{className:"account-menu-item",onClick:()=>{n(!1),s()},children:"Sign Out"})]})]})]})]})})}function Rt({open:f,onCancel:t,onContinue:r}){const[s,i]=E.useState(""),[n,o]=E.useState(""),[m,v]=E.useState(!1),S=E.useRef(null);E.useEffect(()=>{f&&setTimeout(()=>{v(!1),S.current?.focus()},0)},[f,v]);const a=u=>{if(!u)return!1;try{const l=new URL(u);return!!l.protocol&&!!l.host}catch{return!1}},h=()=>{const u=a(s);v(!u),u&&r(s.trim(),n.trim()||void 0)};return d.jsxs(yt,{open:f,heading:"Sign in to ArcGIS Enterprise",onCalciteDialogClose:t,children:[d.jsxs("div",{children:[d.jsxs(Ge,{children:["URL",d.jsx(qe,{ref:S,required:!0,id:"enterprise_portal_url",name:"enterprise_portal_url",placeholder:"e.g. https://myportal.mydomain.com/portal",type:"text",value:s,onCalciteInputChange:u=>{const l=u?.target?.value??"";i(l)}}),d.jsx(Ke,{status:m?"invalid":void 0,children:"Enter a valid organization url"})]}),d.jsxs(gt,{layout:"inline",children:[d.jsx(bt,{slot:"tab-nav",children:d.jsx(wt,{children:"OAuth Login"})}),d.jsx(vt,{style:{width:"100%",marginTop:"1rem"},children:d.jsxs(Ge,{children:["App ID",d.jsx(qe,{id:"enterprise_client_id",name:"app_client_id",placeholder:"e.g. aBcDeFgHi1j2K3L4",type:"text",value:n,onCalciteInputChange:u=>{const l=u?.target?.value??"";o(l)}}),d.jsx(Ke,{status:"invalid",children:"Enter a valid registered App ID"})]})})]}),d.jsxs("details",{className:"enterprise-details",children:[d.jsx("summary",{children:"More Details"}),d.jsxs("p",{className:"enterprise-details-text",children:["In order to log in to a Portal for ArcGIS instance using a SAML-based Identity Provider, you will need to Register the Classic StoryMap Converter as an application in your Portal, and generate an AppID that can identify this app as an allowed client of the Portal. To do so, follow the instructions "," ",d.jsx("a",{href:"https://enterprise.arcgis.com/en/portal/latest/use/add-app-url.htm#REG_APP",target:"_blank",rel:"noopener",children:"here"}),", using ",d.jsx("strong",{children:"Other Application"})," as the ",d.jsx("em",{children:"Type of App"})," and",d.jsx("code",{className:"enterprise-details-code",children:"https://url-for-this-app.com/"}),"as the Redirect URI."]})]})]}),d.jsxs("div",{slot:"footer",children:[d.jsx(Ye,{color:"blue",onClick:h,children:"Continue"}),d.jsx(Ye,{appearance:"outline",color:"blue",onClick:t,children:"Cancel"})]})]})}const Et="/assets/storymap-map-tour-CbGOcXZK.png",Bt="/assets/storymap-map-journal-B6_zTpqe.png",Dt="/assets/storymap-series-tabbed-I93IZkLj.png",Ot="/assets/storymap-cascade-Dxb7EL3J.png",Ut="/assets/storymap-shortlist-C-e80pOE.png",Pt="/assets/storymap-crowdsource-CiU2l24Z.png",Wt="/assets/storymap-swipe-DCnpLp2Y.png",_t="/assets/storymap-basic-DyApzf39.png",Jt=[{key:"mapTour",title:"Map Tour",description:"Presented a sequential, place-based narrative with geotagged photos linked to an interactive map.",image:Et,status:"disabled",alt:"Map Tour Thumbnail"},{key:"mapJournal",title:"Map Journal",description:"Presented a compelling map-based narrative presented as a set of journal entries.",image:Bt,status:"active",alt:"Map Journal Thumbnail"},{key:"mapSeries",title:"Map Series",description:"Presented a series of maps via a set of tabs, bullets or expanding side panel.",image:Dt,status:"disabled",alt:"Map Series - Tabbed Thumbnail"},{key:"cascade",title:"Cascade",description:"Combined text with maps, images, and multimedia in an engaging, full-screen scrolling experience.",image:Ot,status:"disabled",alt:"Cascade Thumbnail"},{key:"shortlist",title:"Shortlist",description:"Presented a set of places organized into a set of tabs based on themes.",image:Ut,status:"disabled",alt:"Shortlist Thumbnail"},{key:"crowdsource",title:"Crowdsource",description:"Displayed crowdsourced photos with captions. The conversion will be view-only.",image:Pt,status:"disabled",alt:"Crowdsource Thumbnail"},{key:"swipe",title:"Swipe",description:"Displayed two layers or two maps side by side for comparison.",image:Wt,status:"active",alt:"Swipe Thumbnail"},{key:"basic",title:"Basic",description:"Presented a map via a minimalist interface. Converted to an ArcGIS Instant App.",image:_t,status:"disabled",alt:"Story Map Basic Thumbnail"}],zt=()=>{const{signIn:f}=Le(),[t,r]=E.useState(!1);return d.jsxs(d.Fragment,{children:[d.jsxs("div",{id:"splashContainer",className:"splash-container",children:[d.jsxs("div",{className:"jumbotron",children:[d.jsx("h2",{children:"Classic StoryMap Converter"}),d.jsx("p",{className:"lead",children:"Convert Classic Esri Story Maps to ArcGIS StoryMaps"}),d.jsx("div",{className:"loginButtons",children:d.jsxs("p",{children:[d.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-success login-btn",onClick:f,children:"Log in to ArcGIS Online"}),d.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-default",onClick:()=>r(!0),children:"Log in to Portal for ArcGIS"})]})})]}),d.jsx("div",{className:"row marketing marketing-row",children:Jt.map(s=>{const i=s.status!=="active";return d.jsxs("div",{className:`marketing-col${i?" disabled":""}`,"data-disabled":i?"true":"false",children:[d.jsx("h4",{children:s.title}),d.jsxs("div",{className:"marketing-img-container",children:[d.jsx("img",{src:s.image,alt:s.alt,className:"marketing-img"}),i&&d.jsx("div",{className:"disabled-overlay",children:"Coming Soon"})]}),d.jsx("p",{children:s.description})]},s.key)})})]}),d.jsx(Rt,{open:t,onCancel:()=>r(!1),onContinue:(s,i)=>{r(!1),console.info("[EnterpriseSignInModal] continue",{url:s,appId:i})}})]})},Ne=new Map,ze=new Set;function dt(){const f=Ne.size;for(const t of Array.from(ze))try{t(f)}catch{}}async function Te(f,t,r){const s=Date.now(),i=Ne.get(f);if(i){if(!i.expiresAt||i.expiresAt>s)return i.data;Ne.delete(f)}const n=await fetch(f,t);if(!n.ok)throw new Error(`Fetch failed ${n.status}: ${f}`);const o=await n.json(),m=s+r;return Ne.set(f,{data:o,expiresAt:m}),dt(),o}function Ht(f){Ne.clear(),dt()}function et(){return Ne.size}function Vt(f){ze.add(f)}function Gt(f){ze.delete(f)}async function tt(f){const t=await fetch(f);if(!t.ok)throw new Error(`Fetch failed: ${t.status} ${t.statusText}`);return t.json()}async function qt(f,t){const r=[],s=[],i=Array.from(new Set(f.filter(o=>/^[a-f0-9]{32}$/i.test(o))));for(const o of i)try{const m=`https://www.arcgis.com/sharing/rest/content/items/${o}`,v=`${m}/data?f=json${t?`&token=${encodeURIComponent(t)}`:""}`,S=`${m}?f=json${t?`&token=${encodeURIComponent(t)}`:""}`,[a,h]=await Promise.all([tt(v).catch(()=>null),tt(S).catch(()=>null)]);if(!h){r.push({itemId:o,level:"error",message:"Webmap item not accessible (404 or permission). Please verify the item exists and you have access."});continue}const u=h?.title||h?.name||"",l=[],b=a&&(a.version||a.itemVersion)||h&&(h.itemVersion||h.version);if(b&&typeof b=="string"){const p=parseFloat(b);!Number.isNaN(p)&&p<2&&r.push({itemId:o,level:"warning",message:`Webmap version ${b} < 2.0. Open in Classic Map Viewer and save to upgrade.`})}const x=a?.operationalLayers||[],w=a?.baseMap?.baseMapLayers||[],j=[];for(const p of x)p?.url&&j.push({url:p.url,title:p.title,layerItemId:p.itemId,layerTitle:p.title});for(const p of w)p?.url&&j.push({url:p.url,title:p.title});const c=p=>{try{const y=new URL(p),I=y.hostname.toLowerCase(),g=y.pathname.toLowerCase();if(I.endsWith("services.arcgisonline.com"))return/(mapserver|featureserver)/i.test(g)}catch{}return!1};for(const{url:p,title:y,layerItemId:I,layerTitle:g}of j){/^http:\/\//i.test(p)&&(l.push({url:p,error:"HTTP URL (use HTTPS)",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:p,ok:!1,errorCategory:"mixed-content",errorMessage:"HTTP URL (use HTTPS)"}),typeof window<"u"&&window.location?.protocol==="https:"&&(l.push({url:p,error:"Mixed content risk on HTTPS",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:p,ok:!1,errorCategory:"mixed-content",errorMessage:"Mixed content risk on HTTPS"})));const F=typeof window<"u"&&window.location?.hostname?/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname):!1,V=p.split("?")[0],re=`${V}${V.includes("?")?"":"?"}${V.includes("?")?"&":""}f=pjson`,P=/(FeatureServer|MapServer)\/\d+$/i.test(V)?V.replace(/\/(FeatureServer|MapServer)\/\d+$/i,"/$1"):V,oe=`${P}${P.includes("?")?"":"?"}${P.includes("?")?"&":""}f=pjson`,k=U=>`/.netlify/functions/proxy-feature?url=${encodeURIComponent(U)}`,A=F?k(re):re,q=F?k(oe):oe,le=async U=>{for(let _=0;_<2;_++)try{const N=await fetch(U,{method:"GET"});if(!N.ok)return{ok:!1,resp:N,json:null};const se=N.headers.get("content-type")||"",fe=/application\/(?:json|pjson)/i.test(se)?await N.clone().json().catch(()=>null):null;return{ok:!0,resp:N,json:fe}}catch{if(_===1)return{ok:!1,resp:void 0,json:null};await new Promise(N=>setTimeout(N,150))}return{ok:!1,resp:void 0,json:null}},T=await le(A),B=await le(q),R=!!T.resp&&T.resp.ok,ue=!!B.resp&&B.resp.ok,te=R&&!!T.json&&!T.json?.error,$=ue&&!!B.json&&!B.json?.error;if(T.ok&&T.json){const U=T.json?.error?.message||T.json?.message||"",_=/token/i.test(U)||T.json?.error?.code===499,N=/permission|privilege|authorized|do not have permissions|not permitted/i.test(U)||T.json?.error?.code===403;_&&l.push({url:p,status:T.resp?.status,error:"Token required",title:y,layerItemId:I,layerTitle:g}),N&&l.push({url:p,status:T.resp?.status,error:"Permissions denied or item private",title:y,layerItemId:I,layerTitle:g});const se=typeof T.json?.type=="string"||typeof T.json?.geometryType=="string"||Array.isArray(T.json?.fields)||Array.isArray(T.json?.layers),pe=!!T.json?.error;!se&&!pe&&!$&&l.push({url:p,status:T.resp?.status,error:"Invalid layer definition",title:y,layerItemId:I,layerTitle:g}),pe&&l.push({url:p,status:T.resp?.status,error:"Layer error JSON",title:y,layerItemId:I,layerTitle:g});const fe=T.resp?.headers?.get("content-type")||"";/application\/(?:json|pjson)/i.test(fe)||(l.push({url:p,status:T.resp?.status,error:"Non-JSON response",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:p,status:T.resp?.status,ok:!1,errorCategory:"non-json",errorMessage:"Non-JSON response"})),T.json||(l.push({url:p,status:T.resp?.status,error:"JSON parse failed",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:p,status:T.resp?.status,ok:!1,errorCategory:"json-error",errorMessage:"JSON parse failed"}))}if(!te&&!c(V)){const U=T.resp?.status,_=T.json?.error?T.json.error.message||"Layer error JSON":void 0;l.push({url:p,status:U,error:_||"Layer endpoint not healthy",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:p,status:U,ok:!1,errorCategory:_?"json-error":"other",errorMessage:_||"Layer endpoint not healthy"})}if(B.ok&&B.json?.error){const U=B.json?.error?.message||B.json?.message||"",_=/permission|privilege|authorized|do not have permissions|not permitted/i.test(U)||B.json?.error?.code===403;l.push({url:P,status:B.resp?.status,error:_?"Service permissions denied or item private":"Service error JSON",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:P,status:B.resp?.status,ok:!1,errorCategory:_?"permission-denied":"json-error",errorMessage:_?"Service permissions denied or item private":"Service error JSON"})}if(!R&&!c(V)&&(l.push({url:p,status:T.resp?.status,error:"Layer HTTP failure",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:p,status:T.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Layer HTTP failure"})),!ue&&!c(P)&&(l.push({url:P,status:B.resp?.status,error:"Service HTTP failure",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:P,status:B.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Service HTTP failure"})),B.ok&&B.json&&!B.json.error){const U=B.json,_=typeof U.currentVersion=="number"||typeof U.currentVersion=="string",N=typeof U.capabilities=="string"||Array.isArray(U.capabilities);(!_||!N)&&(l.push({url:P,status:B.resp?.status,error:"Service missing capabilities/version",title:y,layerItemId:I,layerTitle:g}),s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:P,status:B.resp?.status,ok:!1,errorCategory:"other",errorMessage:"Service missing capabilities/version"}))}te&&s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:p,status:T.resp?.status,ok:!0,errorCategory:"ok"}),$&&s.push({webmapId:o,webmapTitle:u,layerTitle:g,layerItemId:I,url:P,status:B.resp?.status,ok:!0,errorCategory:"ok"})}for(const p of x)if(p?.itemId&&/^[a-f0-9]{32}$/i.test(p.itemId)){const y=`https://www.arcgis.com/sharing/rest/content/items/${p.itemId}?f=json${t?`&token=${encodeURIComponent(t)}`:""}`;try{const I=await fetch(y);if(I.ok){const g=await I.json();if(g.error){const F=g.error?.code,V=g.error?.message||"",re=F===403||/permission|privilege|authorized|not permitted/i.test(V);l.push({url:y,status:I.status,error:re?"Layer item private or permission denied":"Layer item error JSON",title:p.title,layerItemId:p.itemId,layerTitle:p.title})}}else{const g=I.status,F=g===404?"Layer item deleted":g===403?"Layer item private or permission denied":"Layer item not accessible";l.push({url:y,status:g,error:F,title:p.title,layerItemId:p.itemId,layerTitle:p.title})}}catch{l.push({url:y,error:"Layer item unreachable",title:p.title,layerItemId:p.itemId,layerTitle:p.title})}}l.length&&r.push({itemId:o,level:"warning",message:`Webmap ${u?'"'+u+'" ':""}has ${l.length} failing endpoint(s).`,details:{webmapTitle:u,failures:l}})}catch{r.push({itemId:o,level:"warning",message:"Failed to validate webmap. Proceeding, but please check the item manually."})}const n={};for(const o of s){const m=o.errorCategory||(o.ok?"ok":"other");n[m]=(n[m]||0)+1}return{warnings:r,endpointChecks:s,endpointCategorySummary:n}}function Kt(f){const t=w=>!!w&&typeof w=="object";if(!t(f))return"unknown";const r=f.values||{},s=(w,j)=>t(w)?w[j]??void 0:void 0,i=s(r,"settings")??{};let n;const o=s(r,"templateName");typeof o=="string"&&o.trim()&&(n=o);const m=s(r,"template");typeof m=="string"&&m.trim()&&(n=m);const v=s(r,"template"),S=v&&typeof v.name=="string"?v.name:void 0;if(S&&(n=S),n)return Yt(n);if(!n&&i&&t(i)&&t(i.components))return"Crowdsource";const a=s(r,"series");if(Array.isArray(a))return"Map Series";const h=s(r,"tabs")??s(r,"tabs");if(Array.isArray(h)||h)return"Shortlist";const u=s(r,"order");if(Array.isArray(u))return"Map Tour";if(s(r,"dataModel")||s(r,"layers")||s(r,"webmaps"))return"Swipe";const l=s(r,"components");if(l&&t(l)&&l.contribute)return"Crowdsource";const b=s(r,"story"),x=b&&Array.isArray(b.sections)?b.sections:void 0;return x?x.some(w=>t(w)&&w.type==="sequence")?"Cascade":"Map Journal":"Basic"}function Yt(f){const t=f.toLowerCase();return t.includes("journal")?"Map Journal":t.includes("tour")?"Map Tour":t.includes("series")?"Map Series":t.includes("cascade")?"Cascade":t.includes("shortlist")?"Shortlist":t.includes("swipe")?"Swipe":t.includes("crowdsource")?"Crowdsource":t.includes("basic")?"Basic":f}function Re(){throw new Error("execSync is not available in the browser environment")}function Pe(){throw new Error("execFileSync is not available in the browser environment")}const Xt={};class pt{constructor(t){this.classicJson=t.classicJson,this.themeId=t.themeId,this.progress=t.progress,this.storyId=t.storyId,this.username=t.username,this.token=t.token,this.uploader=t.uploader,this.inlineUpload=t.inlineUpload}emit(t){this.progress({stage:"convert",message:t})}convert(){this.emit("Beginning conversion"),this.extractStructure(),this.convertContent(),this.applyTheme();const t=this.collectMedia();return{storymapJson:this.getStoryMapJson(),mediaUrls:t}}}function we(f){const t=Math.abs(f.ymax-f.ymin);return t<=500?{scale:500,zoom:20}:t<=1e3?{scale:1e3,zoom:19}:t<=5e3?{scale:5e3,zoom:17}:t<=1e4?{scale:1e4,zoom:16}:t<=5e4?{scale:5e4,zoom:14}:t<=1e5?{scale:1e5,zoom:13}:t<=5e5?{scale:5e5,zoom:11}:t<=1e6?{scale:1e6,zoom:10}:t<=5e6?{scale:5e6,zoom:8}:t<=1e7?{scale:1e7,zoom:7}:{scale:25e6,zoom:6}}const st={variables:{headerFooterBackgroundColor:"#ffffff",backgroundColor:"#ffffff",titleFontId:"avenirNext",titleColor:"#002625",titleColorDark:"#002625",titleColorLight:"#ffffff",bodyFontId:"notoSerif",bodyColor:"#304e4e",bodyColorDark:"#002625",bodyColorLight:"#ffffff",bodyMutedColor:"#3d6665",themeColor1:"#087f9b",themeColor2:"#fc3b36",themeColor3:"#126057",borderRadius:0,shape:"hexagon",colorRamps:["seq-single-blues","seq-multi-ylgn","seq-orange-red-light","seq-yellow-darkblue-bright-reversed"],basemapPrimary:"humanGeographyLight",basemapAlt:"lightGrayCanvas",basemapImagery:"worldImagery"}},rt={variables:{headerFooterBackgroundColor:"#000000",backgroundColor:"#0e1116",titleFontId:"charterBT",titleColor:"#f3f3f3",titleColorDark:"#0E1116",titleColorLight:"#f3f3f3",bodyFontId:"arial",bodyColor:"#e6f2f2",bodyColorDark:"#0E1116",bodyColorLight:"#E6F2F2",bodyMutedColor:"#809e9d",themeColor1:"#ea5b41",themeColor2:"#4d6aff",themeColor3:"#0ec2db",borderRadius:9999,colorRamps:["seq-blue-bright-5","seq-yellow-bright-3","seq-green-bright-3","seq-red-bright-4"],basemapPrimary:"darkGrayCanvas",basemapAlt:"humanGeographyDark",basemapImagery:"worldImagery"}};function it(f,t){if(!f||!f.includes("font-family"))return t;let r=f;const s=/font-family:\s*'([^']+)'/.exec(f)||/font-family:\s*"([^"]+)"/.exec(f);if(s)r=s[1];else{const o=/font-family:\s*([^;]+);?/.exec(f);o&&(r=o[1].split(",")[0].trim().replace(/["']/g,""))}const i=r.toLowerCase().replace(/\s+/g,"");return{open_sansregular:"openSans",opensans:"openSans",roboto:"roboto",noto:"notoSerif",notoserif:"notoSerif",lato:"lato",sourcesanspro:"sourceSansPro",avenirnext:"avenirNext",charterbt:"charterBT",arial:"arial"}[i]||t}function Zt(f){const t=f.values||{},s=(t.settings||{}).theme||{},i=s.colors||{},n=s.fonts||{},o=(t.title||"").trim()+" (Theme)",v=(i.themeMajor||"").toLowerCase()==="black"?"obsidian":"summit",a={...(v==="obsidian"?rt:st).variables},h=v==="obsidian"?rt.variables:st.variables;for(const[y,I]of Object.entries(h))y in a||(a[y]=I);const u=[];let l;i.panel&&(a.backgroundColor=i.panel,u.push("backgroundColor")),i.dotNav&&(a.headerFooterBackgroundColor=i.dotNav,u.push("headerFooterBackgroundColor")),i.text&&(a.bodyColor=i.text,u.push("bodyColor"),l="text"),!a.bodyColorDark&&h.bodyColorDark&&(a.bodyColorDark=h.bodyColorDark),!a.bodyColorLight&&h.bodyColorLight&&(a.bodyColorLight=h.bodyColorLight),!a.titleColorDark&&h.titleColorDark&&(a.titleColorDark=h.titleColorDark),!a.titleColorLight&&h.titleColorLight&&(a.titleColorLight=h.titleColorLight),i.textLink&&(a.themeColor1=i.textLink,u.push("themeColor1")),!i.text&&i.textLink&&(a.bodyColor=i.textLink,u.push("bodyColor"),l="textLink"),i.softText&&(a.bodyMutedColor=i.softText,u.push("bodyMutedColor")),!a.colorRamps&&h.colorRamps&&(a.colorRamps=h.colorRamps),!a.basemapPrimary&&h.basemapPrimary&&(a.basemapPrimary=h.basemapPrimary),!a.basemapAlt&&h.basemapAlt&&(a.basemapAlt=h.basemapAlt),!a.basemapImagery&&h.basemapImagery&&(a.basemapImagery=h.basemapImagery),v==="summit"&&!a.shape&&h.shape&&(a.shape=h.shape);const b=n.sectionTitle?.value,x=n.sectionContent?.value,w=it(b,a.titleFontId),j=it(x,a.bodyFontId);w&&w!==a.titleFontId&&(a.titleFontId=w,u.push("titleFontId")),j&&j!==a.bodyFontId&&(a.bodyFontId=j,u.push("bodyFontId"));const c={title:o,baseThemeId:v,isFromOrgTheme:!1,variables:a,resources:{}},p={baseThemeId:v,colorMappings:{panelToBackgroundColor:i.panel,dotNavToHeaderFooterBackgroundColor:i.dotNav,textToBodyColor:i.text,textLinkToBodyColor:i.text?void 0:i.textLink,textLinkToThemeColor1:i.textLink,softTextToBodyMutedColor:i.softText,chosenBodyColorSource:l},fontMappings:{classicTitleFontValue:b,mappedTitleFontId:w,classicBodyFontValue:x,mappedBodyFontId:j},variableOverridesApplied:u};return{theme:c,decisions:p}}class ut{constructor(t){this.themeResourceId=this.generateResourceId(),this.json={root:"",nodes:{},resources:{[this.themeResourceId]:{type:"story-theme",data:{themeId:t,themeBaseVariableOverrides:{}}}},actions:[]}}createStoryRoot(){const t=this.generateNodeId();return this.json.root=t,this.json.nodes[t]={type:"story",data:{storyTheme:this.themeResourceId},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[]},t}addNode(t,r,s,i){const n=this.generateNodeId(),o={type:t};return r&&(o.data=r),s&&(o.config=s),i&&(o.children=i),this.json.nodes[n]=o,n}applyTheme(t){const r=this.json.resources[this.themeResourceId];r&&r.type==="story-theme"&&(r.data.themeId=t.themeId,t.variableOverrides&&Object.keys(t.variableOverrides).length&&(r.data.themeBaseVariableOverrides=t.variableOverrides))}addImageResource(t,r,s){const i=this.generateResourceId();return this.json.resources[i]={type:"image",data:{src:t,provider:"uri",width:r,height:s}},i}finalizeImageResourceAsItem(t,r,s,i){const n=this.json.resources[t];!n||n.type!=="image"||(delete n.data.src,n.data.resourceId=r,n.data.provider="item-resource",s&&(n.data.width=s),i&&(n.data.height=i))}addVideoResource(t,r="uri",s){const i=s??this.generateResourceId();return this.json.resources[i]={type:"video",data:{src:t,provider:r}},i}addTextBlock(t,r,s){const i=this.generateNodeId(),o={type:"text",data:{text:r,type:s==="bullet-list"?"paragraph":s}};return this.json.nodes[i]=o,this.appendChild(t,i),i}addImageNode(t,r,s,i,n="standard"){const o=this.generateNodeId(),m={type:"image",data:{image:r,caption:s,alt:i},config:{size:n}};return this.json.nodes[o]=m,this.appendChild(t,o),o}addVideoNode(t,r){const s=this.generateNodeId(),i={type:"video",data:{src:r.src,resourceId:r.resourceId,provider:r.provider,caption:r.caption,alt:r.alt}};return this.json.nodes[s]=i,this.appendChild(t,s),s}addWebMapResource(t,r="Web Map",s,i="minimal"){const n=`r-${t}`,o={type:i,itemId:t,itemType:r};if(!this.json.resources[n])this.json.resources[n]={type:"webmap",data:o};else{const m=this.json.resources[n];m&&m.type==="webmap"&&(m.data=m.data||{},m.data.type=i,m.data.itemId=t,m.data.itemType=r,m.data.initialState&&delete m.data.initialState,this.json.resources[n]=m)}return n}addWebMapNode(t,r,s){const i=this.generateNodeId(),n={type:"webmap",data:{map:r,caption:s}};return this.json.nodes[i]=n,this.appendChild(t,i),i}updateWebMapInitialState(t,r){const s=this.json.resources[t];if(!s||s.type!=="webmap")return;s.data=s.data||{};const i={...s.data,...r};delete i.initialState,s.data=i,this.json.resources[t]=s}updateWebMapData(t,r){const s=this.json.resources[t];!s||s.type!=="webmap"||(s.data=s.data||{},s.data={...s.data,...r},s.data.initialState&&delete s.data.initialState,this.json.resources[t]=s)}addCoverNode(t,r,s){const i=this.generateNodeId();return this.json.nodes[i]={type:"storycover",data:{type:"minimal",title:t,summary:r||"",byline:s||"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},this.json.root&&this.json.nodes[this.json.root]&&this.appendChild(this.json.root,i),i}addNavigationHidden(){const t=this.generateNodeId();return this.json.nodes[t]={type:"navigation",data:{links:[]},config:{isHidden:!0}},this.json.root&&this.appendChild(this.json.root,t),t}addCreditsNode(){const t=this.generateNodeId(),r=this.generateNodeId();this.json.nodes[r]={type:"attribution",data:{content:"",attribution:""}};const s=this.generateNodeId();this.json.nodes[s]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}};const i=this.generateNodeId();return this.json.nodes[i]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}},this.json.nodes[t]={type:"credits",children:[s,i,r]},this.json.root&&this.appendChild(this.json.root,t),t}addSidecar(t="docked-panel",r="end",s="medium"){const i=this.generateNodeId(),n=this.generateNodeId(),o=this.generateNodeId();this.json.nodes[i]={type:"immersive",data:{type:"sidecar",subtype:t,narrativePanelPosition:r,narrativePanelSize:s},children:[n]},this.json.nodes[n]={type:"immersive-slide",data:{transition:"fade"},children:[o]},this.json.nodes[o]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[]};const m=this.json.nodes[this.json.root];if(m?.children){const v=m.children.findIndex(S=>this.json.nodes[S]?.type==="credits");v>-1?m.children.splice(v,0,i):m.children.push(i)}return{immersiveId:i,slideId:n,narrativeId:o}}addSection(t,r,s){const i=this.generateNodeId();if(this.json.nodes[i]={type:"slide",children:[]},this.appendChild(t,i),r&&this.addTextBlock(i,r,"h2"),s){const n=s.replace(/<[^>]+>/g,"").trim();n&&this.addTextBlock(i,n,"paragraph")}return i}appendChild(t,r){const s=this.json.nodes[t];s&&(s.children||(s.children=[]),s.children.push(r))}getJson(){for(const n of Object.values(this.json.nodes))n&&(n.type==="webmap"?(n.config?"size"in n.config||(n.config.size="standard"):n.config={size:"standard"},n.data&&"scale"in n.data&&delete n.data.scale):n.type==="text"&&n.data&&!("textAlignment"in n.data)&&(n.data.textAlignment="start"));if(this.json.root){const n=this.json.nodes[this.json.root];n?.type==="story"&&n.data&&"metaSettings"in n.data&&delete n.data.metaSettings}const t={};for(const[n,o]of Object.entries(this.json.nodes))n!==this.json.root&&(t[n]=o);this.json.root&&(t[this.json.root]=this.json.nodes[this.json.root]);const{root:r,resources:s,actions:i}=this.json;return{root:r,nodes:t,resources:s,actions:i}}updateNodeData(t,r){const s=this.json.nodes[t];s&&(s.data||(s.data={}),r(s.data,s))}updateNode(t,r){const s=this.json.nodes[t];s&&r(s)}removeNode(t){const r=this.json.nodes;if(!(!r||!r[t])){for(const s of Object.values(r))if(s?.children&&Array.isArray(s.children)){const i=s.children.indexOf(t);i>-1&&s.children.splice(i,1)}delete r[t]}}setStoryMeta(t,r,s){if(!this.json.root)return;const i=this.json.nodes[this.json.root];!i||i.type!=="story"||(i.data||(i.data={}),i.data.metaSettings={title:t,description:r||"",imageResourceId:s})}addConverterMetadata(t,r){const s=this.generateResourceId(),i={type:"converter-metadata",data:{type:"storymap",version:"1.0.0",classicType:t,...r}};this.json.resources[s]=i}generateNodeId(){return`n-${Math.random().toString(36).slice(2,8)}`}generateResourceId(){return`r-${Math.random().toString(36).slice(2,8)}`}createTextNode(t,r,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"text",data:{text:t,type:r,textAlignment:"start"},config:{size:s}},i}createRichTextNode(t,r,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"text",data:{text:t,type:r,preserveHtml:!0,textAlignment:"start"},config:{size:s}},i}createImageNode(t,r,s,i="wide"){const n=this.generateNodeId();return this.json.nodes[n]={type:"image",data:{image:t,caption:r,alt:s},config:{size:i}},n}createWebMapNode(t,r){const s=this.generateNodeId();return this.json.nodes[s]={type:"webmap",data:{map:t,caption:r},config:{size:"standard"}},s}createVideoNode(t,r,s){const i=this.generateNodeId();return this.json.nodes[i]={type:"video",data:{video:t,caption:r,alt:s}},i}createVideoEmbedNode(t,r,s,i,n,o,m,v="16:9"){const S=this.generateNodeId();let a=t;return r==="youtube"&&s?a=`https://www.youtube.com/embed/${s}`:r==="vimeo"&&s&&(a=`https://player.vimeo.com/video/${s}`),this.json.nodes[S]={type:"embed",data:{url:t,embedSrc:a,embedType:"video",provider:r,videoId:s,title:n||void 0,description:o||void 0,caption:i||void 0,alt:m||"",isEmbedSupported:!0,display:"inline",aspectRatio:v}},S}createEmbedNode(t,r,s,i,n){const o=this.generateNodeId();return this.json.nodes[o]={type:"embed",data:{url:t,embedType:"link",title:s,description:i,caption:r,alt:n||"",isEmbedSupported:!0,display:"inline",embedSrc:t}},o}createSwipeNode(t,r,s="extent",i){const n=this.generateNodeId();return this.json.nodes[n]={type:"swipe",data:{contents:{0:t,1:r},viewPlacement:s,caption:i},config:{size:"full"}},n}addSlideToSidecar(t,r,s){const i=this.json.nodes[t];if(!i||i.type!=="immersive")throw new Error("addSlideToSidecar: invalid sidecarId");const n=this.generateNodeId();this.json.nodes[n]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[...r]};const o=this.generateNodeId(),m=s?[n,s]:[n];return this.json.nodes[o]={type:"immersive-slide",data:{transition:"fade"},children:m},i.children||(i.children=[]),i.children.push(o),{slideId:o,narrativeId:n}}createActionButtonNode(t,r="wide"){const s=this.generateNodeId();return this.json.nodes[s]={type:"action-button",data:{text:t},config:{size:r}},s}addActionButton(t,r,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"action-button",data:{text:r},config:{size:s}},this.appendChild(t,i),i}createButtonNode(t,r="wide",s){const i=this.generateNodeId();return this.json.nodes[i]={type:"button",data:{text:t,link:s},config:{size:r}},i}setButtonLink(t,r){const s=this.json.nodes[t];s&&s.type==="button"&&(s.data||(s.data={}),s.data.link=r)}addChild(t,r){this.appendChild(t,r)}getStoryRootId(){return this.json.root}newNodeId(){return this.generateNodeId()}createTourMapNode(t,r,s="2d"){const i=this.generateNodeId(),n={type:"name",value:"worldImagery"};if(r){const o=this.addWebMapResource(r,"Web Map",{},"minimal");n.type="resource",n.value=o}return this.json.nodes[i]={type:"tour-map",data:{geometries:t,mode:s,basemap:n}},i}createCarouselNode(t){const r=this.generateNodeId();return this.json.nodes[r]={type:"carousel",children:t.slice(0,5)},r}createTourNode(t,r,s,i="start",n="large",o="guided-tour",m="map-focused"){const v=this.generateNodeId();return this.json.nodes[v]={type:"tour",data:{type:o,subtype:m,narrativePanelPosition:i,map:r,places:t,narrativePanelSize:n,accentColor:s}},v}registerReplaceMediaAction(t,r,s){this.json.actions||(this.json.actions=[]),this.json.actions.push({origin:t,trigger:"ActionButton_Apply",target:r,event:"ImmersiveSlide_ReplaceMedia",data:{media:s}})}}class be extends pt{constructor(t){super(t),this.model="TWO_WEBMAPS",this.layout="swipe",this.builder=new ut(t.themeId)}extractStructure(){const t=this.classicJson.values;(t.dataModel||"").toUpperCase()==="TWO_LAYERS"?this.model="TWO_LAYERS":this.model="TWO_WEBMAPS",(t.layout||"").toLowerCase().includes("spyglass")?this.layout="spyglass":this.layout="swipe",this.emit(`Swipe model=${this.model} layout=${this.layout}`)}convertContent(){const t=this.classicJson.values;this.builder.createStoryRoot();const r=t.title||t.name||this.fetchItemTitleFallback()||"Swipe";this.builder.addCoverNode(r,t.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode();let s,i;if(this.model==="TWO_WEBMAPS"){const a=[];if(Array.isArray(t.webmaps))for(const p of t.webmaps)typeof p=="string"?a.push(p):p&&typeof p=="object"&&"id"in p&&a.push(String(p.id));else t.webmap&&a.push(String(t.webmap));const[h,u]=a,l=h?be.fetchWebMapInfoSync(h,this.token):void 0,b=u?be.fetchWebMapInfoSync(u,this.token):void 0,x={},w={};if(l?.extent){x.extent=l.extent;const p=we(l.extent);p&&(x.viewpoint={targetGeometry:l.center??l.extent,scale:p.scale})}if(Array.isArray(l?.operationalLayers))x.mapLayers=l.operationalLayers.map(p=>({id:p.id,title:p.title||p.id,visible:!!p.visibility}));else if(idA){const p=`https://www.arcgis.com/sharing/rest/content/items/${idA}/data?f=json`,y=this.token?`${p}&token=${encodeURIComponent(this.token)}`:p;Te(y,void 0,600*1e3).then(I=>{const g=Array.isArray(I?.operationalLayers)?I.operationalLayers:[];g.length&&(x.mapLayers=g.map(F=>({...F})))}).catch(()=>{})}if(b?.extent){w.extent=b.extent;const p=we(b.extent);p&&(w.viewpoint={targetGeometry:b.center??b.extent,scale:p.scale})}if(Array.isArray(b?.operationalLayers))w.mapLayers=b.operationalLayers.map(p=>({id:p.id,title:p.title||p.id,visible:!!p.visibility}));else if(idB){const p=`https://www.arcgis.com/sharing/rest/content/items/${idB}/data?f=json`,y=this.token?`${p}&token=${encodeURIComponent(this.token)}`:p;Te(y,void 0,600*1e3).then(I=>{const g=Array.isArray(I?.operationalLayers)?I.operationalLayers:[];g.length&&(w.mapLayers=g.map(F=>({...F})))}).catch(()=>{})}const j=h?this.builder.addWebMapResource(h,"Web Map",x,"default"):void 0,c=u?this.builder.addWebMapResource(u,"Web Map",w,"default"):void 0;j&&l&&this.builder.updateWebMapData(j,{extent:l.extent,center:l.center,viewpoint:x.viewpoint,mapLayers:x.mapLayers}),c&&b&&this.builder.updateWebMapData(c,{extent:b.extent,center:b.center,viewpoint:w.viewpoint,mapLayers:w.mapLayers}),j&&(s=this.builder.createWebMapNode(j,void 0)),c&&(i=this.builder.createWebMapNode(c,void 0)),s&&l?.extent&&this.builder.updateNodeData(s,p=>{p.extent=l.extent;const y=we(l.extent);y&&(p.viewpoint={targetGeometry:l.center??l.extent,scale:y.scale});const I=Array.isArray(l.operationalLayers)&&l.operationalLayers.some(g=>g.timeAnimation===!0);p.timeSlider=!!I,Array.isArray(l.operationalLayers)&&l.operationalLayers.length&&(p.mapLayers=l.operationalLayers.map(g=>({id:g.id,title:g.title||g.id,visible:!1})),p.viewPlacement="extent")}),i&&b?.extent&&this.builder.updateNodeData(i,p=>{p.extent=b.extent;const y=we(b.extent);y&&(p.viewpoint={targetGeometry:b.center??b.extent,scale:y.scale});const I=Array.isArray(b.operationalLayers)&&b.operationalLayers.some(g=>g.timeAnimation===!0);p.timeSlider=!!I,Array.isArray(b.operationalLayers)&&b.operationalLayers.length&&(p.mapLayers=b.operationalLayers.map(g=>({id:g.id,title:g.title||g.id,visible:!1})),p.viewPlacement="extent")})}else{const a=String(t.webmap||"");if(a){const h=be.fetchWebMapInfoSync(a,this.token),u={};if(h?.extent){u.extent=h.extent;const c=we(h.extent);c&&(u.viewpoint={targetGeometry:h.center??h.extent,scale:c.scale},u.zoom=c.zoom)}const l=this.builder.addWebMapResource(a,"Web Map",u,"default"),b=this.builder.addWebMapResource(a,"Web Map",u,"default");l&&u&&this.builder.updateWebMapInitialState(l,u),b&&u&&this.builder.updateWebMapInitialState(b,u),s=this.builder.createWebMapNode(l,void 0),i=this.builder.createWebMapNode(b,void 0);const w=(Array.isArray(t.layers)?t.layers:[]).map(c=>{if(c&&typeof c=="object"&&"id"in c){const p=c;return{id:p.id,title:p.title||p.id}}return{id:String(c),title:String(c)}}).filter(c=>c.id),j=(h?.operationalLayers||[]).map(c=>({id:c.id,title:c.title||c.id,visible:!!c.visibility}));if(s&&i){const c=[...j],p=[...j];w.map(y=>y.id);for(const y of w){for(const I of[c,p]){const g=I.findIndex(F=>F.id===y.id);g>-1&&I.splice(g,1)}c.unshift({id:y.id,title:y.title||y.id,visible:!0}),p.unshift({id:y.id,title:y.title||y.id,visible:!1})}this.builder.updateNodeData(s,y=>{y.mapLayers=c}),this.builder.updateNodeData(i,y=>{y.mapLayers=p}),l&&this.builder.updateWebMapInitialState(l,{mapLayers:c}),b&&this.builder.updateWebMapInitialState(b,{mapLayers:p})}}}const n=(this.layout==="spyglass","extent");let o,m;const v=Array.isArray(t.popupTitles)?t.popupTitles:[];if(v.length>=2)[m,o]=v;else{const a=Array.isArray(t.layers)?t.layers:[];a.length>=2&&(o=a[0]?.title||a[0]?.id,m=a[1]?.title||a[1]?.id)}const S=o&&m?`Left side—${o}, Right side—${m}`:void 0;if(s&&i){const a=this.builder.createSwipeNode(s,i,n,S);t.legend&&this.builder.updateNodeData(a,u=>{u.legendPinned=!0,u.legend=[s]});const h=this.builder.getStoryRootId();h&&this.builder.addChild(h,a)}this.builder.addConverterMetadata("Swipe",{classicMetadata:{theme:{layout:this.layout,model:this.model}}}),this.emit("Built swipe block")}applyTheme(){}collectMedia(){return[]}getStoryMapJson(){return this.builder.getJson()}static convert(t){return new be(t).convert()}static buildInlineSwipeBlock(t,r,s="swipe",i){const n=String(r.dataModel||"").toUpperCase();let o,m;if(n==="TWO_WEBMAPS"){const S=[];if(Array.isArray(r.webmaps))for(const c of r.webmaps)typeof c=="string"?S.push(c):c&&typeof c=="object"&&"id"in c&&S.push(String(c.id));else r.webmap&&S.push(String(r.webmap));const[a,h]=S,u={},l={},b=a?be.fetchWebMapInfoSync(a,i):void 0,x=h?be.fetchWebMapInfoSync(h,i):void 0;if(b?.extent){u.extent=b.extent;const c=we(b.extent);c&&(u.viewpoint={targetGeometry:b.center??b.extent,scale:c.scale})}if(Array.isArray(b?.operationalLayers)&&(u.mapLayers=b.operationalLayers.map(c=>({id:c.id,title:c.title||c.id,visible:!!c.visibility}))),x?.extent){l.extent=x.extent;const c=we(x.extent);c&&(l.viewpoint={targetGeometry:x.center??x.extent,scale:c.scale})}Array.isArray(x?.operationalLayers)&&(l.mapLayers=x.operationalLayers.map(c=>({id:c.id,title:c.title||c.id,visible:!!c.visibility})));const w=a?t.addWebMapResource(a,"Web Map",u,"default"):void 0,j=h?t.addWebMapResource(h,"Web Map",l,"default"):void 0;w&&u&&t.updateWebMapInitialState(w,u),j&&l&&t.updateWebMapInitialState(j,l),w&&(o=t.createWebMapNode(w,void 0)),j&&(m=t.createWebMapNode(j,void 0)),o&&b?.extent&&t.updateNodeData(o,c=>{c.extent=b.extent;const p=we(b.extent);p&&(c.viewpoint={targetGeometry:b.center??b.extent,scale:p.scale});const y=Array.isArray(b.operationalLayers)&&b.operationalLayers.some(I=>I.timeAnimation===!0);c.timeSlider=!!y,Array.isArray(b.operationalLayers)&&b.operationalLayers.length&&(c.mapLayers=b.operationalLayers.map(I=>({id:I.id,title:I.title||I.id,visible:!1})),c.viewPlacement="extent")}),m&&x?.extent&&t.updateNodeData(m,c=>{c.extent=x.extent;const p=we(x.extent);p&&(c.viewpoint={targetGeometry:x.center??x.extent,scale:p.scale});const y=Array.isArray(x.operationalLayers)&&x.operationalLayers.some(I=>I.timeAnimation===!0);c.timeSlider=!!y,Array.isArray(x.operationalLayers)&&x.operationalLayers.length&&(c.mapLayers=x.operationalLayers.map(I=>({id:I.id,title:I.title||I.id,visible:!1})),c.viewPlacement="extent")})}else{const S=String(r.webmap||""),a=S?be.fetchWebMapInfoSync(S,i):void 0,h={};if(a?.extent){h.extent=a.extent;const b=we(a.extent);b&&(h.viewpoint={targetGeometry:a.center??a.extent,scale:b.scale},h.zoom=b.zoom)}const u=S?t.addWebMapResource(S,"Web Map",h,"default"):void 0,l=S?t.addWebMapResource(S,"Web Map",h,"default"):void 0;if(u&&h&&t.updateWebMapInitialState(u,h),l&&h&&t.updateWebMapInitialState(l,h),u&&l){o=t.createWebMapNode(u,void 0),m=t.createWebMapNode(l,void 0);const x=(Array.isArray(r.layers)?r.layers:[]).map(p=>{if(p&&typeof p=="object"&&"id"in p){const y=p;return{id:y.id,title:y.title||y.id}}return{id:String(p),title:String(p)}}).filter(p=>p.id),w=(a?.operationalLayers||[]).map(p=>({id:p.id,title:p.title||p.id,visible:!!p.visibility})),j=[...w],c=[...w];for(const p of x){for(const y of[j,c]){const I=y.findIndex(g=>g.id===p.id);I>-1&&y.splice(I,1)}j.unshift({id:p.id,title:p.title||p.id,visible:!0}),c.unshift({id:p.id,title:p.title||p.id,visible:!1})}t.updateNodeData(o,p=>{p.mapLayers=j}),t.updateNodeData(m,p=>{p.mapLayers=c})}}const v="extent";if(!o||!m)throw new Error("SwipeConverter.buildInlineSwipeBlock: missing content nodes");return t.createSwipeNode(o,m,v)}static fetchWebMapInfoSync(t,r){try{const s=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,i=r?`${s}&token=${encodeURIComponent(r)}`:s,n=Re(`curl -sL '${i}'`,{encoding:"utf-8"}),o=JSON.parse(n),m=w=>w?.initialState?.view?.extent||w?.mapOptions?.extent||w?.extent||w?.mapOptions?.mapExtent||void 0,v=w=>w?.initialState?.view?.center||w?.mapOptions?.center||w?.center||void 0;let S=m(o),a=v(o);if(!S||typeof S!="object"&&!Array.isArray(S)){const w=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,j=Re(`curl -sL '${w}'`,{encoding:"utf-8"}),c=JSON.parse(j);if(Array.isArray(c.extent)&&c.extent.length===2&&Array.isArray(c.extent[0])&&Array.isArray(c.extent[1])){const[[p,y],[I,g]]=c.extent;S={xmin:p,ymin:y,xmax:I,ymax:g,spatialReference:{wkid:4326}}}if(!a&&Array.isArray(c.center)&&c.center.length>=2){const[p,y]=c.center;a={x:p,y,spatialReference:{wkid:4326}}}}const h=w=>w*2003750834e-2/180,u=w=>Math.log(Math.tan((90+w)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;let l;S&&S.spatialReference&&(S.spatialReference.wkid===4326||S.spatialReference.latestWkid===4326)?l={xmin:h(S.xmin),ymin:u(S.ymin),xmax:h(S.xmax),ymax:u(S.ymax),spatialReference:{wkid:102100}}:S&&typeof S=="object"&&"xmin"in S&&(l=S);let b;a&&a.spatialReference&&a.spatialReference.wkid===4326?b={x:h(a.x),y:u(a.y),spatialReference:{wkid:102100}}:a&&a.spatialReference&&(a.spatialReference.wkid===102100||a.spatialReference.latestWkid===3857)&&(b=a);const x=Array.isArray(o.operationalLayers)?o.operationalLayers.filter(w=>w&&w.id).map(w=>({id:w.id,title:w.title,visibility:w.visibility})):[];return{extent:l,center:b,operationalLayers:x}}catch{return}}fetchItemTitleFallback(){try{const t=this.options.classicItemId;if(!t)return;const r=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,s=Re(`curl -sL '${r}'`,{encoding:"utf-8"}),i=JSON.parse(s);if(i&&typeof i.title=="string"&&i.title.trim().length)return i.title.trim()}catch{}}}var We={};class He extends pt{constructor(t){super(t),this.sections=[],this.imageResourceMap=new Map,this.media=new Set,this.styleBlocks=[],this.videoEmbedCount=0,this.BUTTON_CLASS_REGEX=/^btn-(green|orange|purple|yellow|red)$/i,this.CSS_COLOR_MAP={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgreen:"#006400",darkgrey:"#A9A9A9",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",green:"#008000",greenyellow:"#ADFF2F",grey:"#808080",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgreen:"#90EE90",lightgrey:"#D3D3D3",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},this.builder=new ut(t.themeId)}extractStructure(){const t=this.classicJson.values,r=t.story&&Array.isArray(t.story.sections)?t.story.sections:[],s=Array.isArray(t.sections)?t.sections:[];this.sections=r.length?r:s,this.emit(`Extracted ${this.sections.length} section(s)`)}convertContent(){try{const k=this.classicJson.values,A=k?.story?.map?.itemId||k?.map?.itemId||k?.webmap||We.WEBMAP_ID,q=this.token||We.ARCGIS_TOKEN;if(A&&q){const le=`https://www.arcgis.com/sharing/rest/content/items/${A}/data?f=json&token=${encodeURIComponent(q)}`;fetch(le).then(T=>T.ok?T.json():Promise.reject(new Error(`HTTP ${T.status}`))).then(T=>{if((Array.isArray(T?.operationalLayers)?T.operationalLayers:[]).some(ue=>{if(String(ue?.layerType||ue?.type||"").toLowerCase()==="mapnotes")return!0;const $=ue?.featureCollection,U=$?.layers?.[0]?.featureSet?.features||[],_=Array.isArray(U)&&U.some(se=>String(se?.symbol?.type).toLowerCase()==="esripms"),N=String(ue?.title||"").toLowerCase();return!!$&&(_||N.includes("map notes"))}))if(this.emit(`Webmap ${A} contains Map Notes. Converting to CSV and saving to webmap...`),typeof window<"u")fetch("/.netlify/functions/convert-mapnotes-to-csv",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webmapId:A,token:q})}).then($=>$.ok?$.json():$.text().then(U=>Promise.reject(new Error(U)))).then($=>{$.changed?this.emit("CSV item created and minimal layer appended via Netlify function."):this.emit("Netlify function reported no changes (no Map Notes found).")}).catch($=>{const U=typeof $=="object"&&$&&"message"in $?String($.message):String($);this.emit(`CSV conversion function failed: ${U}. Continuing conversion.`)});else{const te=Xt.resolve("converter-app/scripts/mapnotes-to-csv-item-and-add-to-webmap.ts");try{Pe("npx",["tsx",te],{stdio:"inherit",env:{...We,WEBMAP_ID:A,ARCGIS_TOKEN:q}}),this.emit("Map Notes → CSV conversion completed. Proceeding with content conversion.")}catch($){const U=typeof $=="object"&&$&&"message"in $?String($.message):String($);this.emit(`CSV conversion execution failed: ${U}. Continuing conversion.`)}}else this.emit(`Webmap ${A} has no Map Notes; skipping CSV conversion.`)}).catch(()=>{this.emit(`Failed to fetch webmap ${A} for Map Notes detection; skipping CSV conversion.`)})}}catch(k){const A=typeof k=="object"&&k&&"message"in k?String(k.message):String(k);this.emit(`Map Notes → CSV pre-step failed: ${A}. Continuing conversion.`)}this.builder.createStoryRoot();const t=this.classicJson.values;this.emit("Created story root node"),this.builder.addCoverNode(t.title||"Untitled Story",t.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode(),this.emit("Added cover/navigation/credits scaffold");const r=(t.description||t.subtitle||"")+"";this.builder.setStoryMeta(t.title||"Untitled Story",r.trim()||void 0,void 0);const i=t,n=i.settings?.layout?.id||"side",o=i.settings?.layoutOptions?.layoutCfg||{},m=o.size||"medium",v=o.position||"right",S=!!i.settings?.theme&&Object.keys(i.settings.theme||{}).length>0,a=n==="float"?"floating-panel":"docked-panel";let h="medium";(m==="small"||m==="medium"||m==="large")&&(h=m);const u=v==="left"?"start":"end",{immersiveId:l,slideId:b,narrativeId:x}=this.builder.addSidecar(a,u,h);if(this.builder.removeNode(b),this.builder.removeNode(x),this.builder.updateNode(l,k=>{k.children=[]}),t.description){const k=[this.builder.createTextNode(String(t.description),"paragraph")];this.builder.addSlideToSidecar(l,k,void 0)}const w=[],j=[],c=[];for(const k of this.sections){const A=[],q=[];let le;k.title&&(le=this.builder.createTextNode(k.title,"h3"),A.push(le)),w.push(le||"");const T=(k.content||k.description||"")+"";if(T.trim())if(typeof globalThis.DOMParser<"u")try{const te=new DOMParser().parseFromString(T,"text/html");for(const $ of Array.from(te.body.children))this.handleElementOrdered($,A,q,j,c)}catch{this.parseOrderedFallback(T,A,q,j,c)}else this.parseOrderedFallback(T,A,q,j,c);let B;const R=k.media;if(R?.image?.url){const te=this.builder.addImageResource(R.image.url);B=this.builder.createImageNode(te,R.image.caption,R.image.altText,"wide"),this.media.add(R.image.url)}else if(R?.webmap?.id){const te=R.webmap.itemType==="Web Scene"?"Web Scene":"Web Map",$=R.webmap,U=R.webmap.extent?this.normalizeExtent(R.webmap.extent):void 0;let _,N;if(U){const J=we(U);J&&(_={targetGeometry:U,scale:J.scale},N=J.zoom)}const se={extent:U,mapLayers:Array.isArray(R.webmap.layers)?R.webmap.layers.map(J=>({id:J.id,title:J.title||J.id,visible:J.visibility})):void 0,overview:$.overview?{enable:!!$.overview.enable,openByDefault:!!$.overview.openByDefault}:void 0,legend:$.legend?{enable:!!$.legend.enable,openByDefault:!!$.legend.openByDefault}:void 0,geocoder:$.geocoder?{enable:!!$.geocoder.enable}:void 0,popup:$.popup||void 0,viewpoint:_,zoom:N},pe=this.builder.addWebMapResource(R.webmap.id,te,se,"default"),fe=U?{x:(U.xmin+U.xmax)/2,y:(U.ymin+U.ymax)/2,spatialReference:U.spatialReference}:void 0;let ae;try{const me=this.classicJson?.values?.webmap,C=this.classicJson.webmapJson,L=C&&Array.isArray(C.operationalLayers)?C.operationalLayers:[];if(L.length&&(me===R.webmap.id||me==null))ae=L.map(z=>({id:z.id,title:z.title||z.id,visible:!!z.visibility}));else try{const z=`https://www.arcgis.com/sharing/rest/content/items/${R.webmap.id}/data?f=json`,Y=this.token?`${z}&token=${encodeURIComponent(this.token)}`:z;if(!(typeof window<"u"))try{const G=Pe("curl",["-sL",Y],{encoding:"utf-8"}),K=JSON.parse(G),X=Array.isArray(K?.operationalLayers)?K.operationalLayers:[];X.length&&(ae=X.map(W=>({...W})))}catch{}Te(Y,void 0,600*1e3).then(G=>{const K=Array.isArray(G?.operationalLayers)?G.operationalLayers:[];if(K.length){this.builder.updateWebMapData(pe,{mapLayers:K.map(W=>({id:W.id,title:W.title||W.id,visible:!!W.visibility}))});const X=new Map;if(R.webmap&&Array.isArray(R.webmap.layers))for(const W of R.webmap.layers)X.set(W.id,!!W.visibility);B&&X.size>0&&this.builder.updateNodeData(B,W=>{W.mapLayers=K.map(ie=>{const ye=String(ie.id||""),ge=X.has(ye)?X.get(ye):!!ie.visibility;return{id:ye,title:ie.title||ye,visible:ge}})})}}).catch(()=>{})}catch{}}catch{}this.builder.updateWebMapData(pe,{extent:U,center:fe,mapLayers:ae??(Array.isArray(R.webmap.layers)?R.webmap.layers.map(J=>({id:J.id,title:J.title||J.id,visible:!!J.visibility})):void 0),viewpoint:_,zoom:N}),B=this.builder.createWebMapNode(pe,k.title?`${te==="Web Scene"?"Scene":"Map"}: ${k.title}`:void 0),this.media.add(R.webmap.id),B&&this.builder.updateNodeData(B,J=>{if(U&&(J.extent=U),Array.isArray(ae)&&ae.length){const me=new Map;if(R.webmap&&Array.isArray(R.webmap.layers))for(const C of R.webmap.layers)me.set(C.id,!!C.visibility);me.size>0&&(J.mapLayers=ae.map(C=>{const L=String(C.id||""),z=me.has(L)?me.get(L):!!C.visible;return{id:L,title:C.title||L,visible:z}}))}else R.webmap&&Array.isArray(R.webmap.layers)&&(J.mapLayers=R.webmap.layers.map(me=>({id:me.id,title:me.title||me.id,visible:!!me.visibility})));_&&(J.viewpoint=_),typeof N=="number"&&(J.zoom=N),$.overview&&$.overview.enable&&(J.overview={openByDefault:!!$.overview.openByDefault}),$.legend&&$.legend.enable&&(J.legend={openByDefault:!!$.legend.openByDefault})})}else if(R?.video?.url){const te=this.detectVideoProvider(R.video.url);if(te.provider!=="unknown")B=this.builder.createVideoEmbedNode(R.video.url,te.provider,te.id,R.video.caption,R.video.caption,void 0,R.video.altText),this.videoEmbedCount++;else{const $=this.builder.addVideoResource(R.video.url,"uri");B=this.builder.createVideoNode($,R.video.caption,R.video.altText),this.media.add(R.video.url)}}else if(R?.webpage?.url){const te=this.tryBuildSwipeNodeFromUrl(R.webpage.url);te?B=te:B=this.builder.createEmbedNode(R.webpage.url,R.webpage.caption,R.webpage.title,R.webpage.description,R.webpage.altText)}const{slideId:ue}=this.builder.addSlideToSidecar(l,A,B);if(Array.isArray(k.contentActions)&&k.contentActions.length){const te=new Map(k.contentActions.map($=>[$.id,$]));for(const $ of q){const U=te.get($.actionId);if(!U||U.type!=="media"||!U.media)continue;let _;const N=U.media;if(N.webmap?.id){const se=N.webmap.itemType==="Web Scene"?"Web Scene":"Web Map";let pe,fe;const ae=N.webmap.extent?this.normalizeExtent(N.webmap.extent):void 0,J=N.webmap;if(ae){const M=we(ae);M&&(pe={targetGeometry:ae,scale:M.scale},fe=M.zoom)}const me={extent:ae,mapLayers:Array.isArray(N.webmap.layers)?N.webmap.layers.map(M=>({id:M.id,title:M.title||M.id,visible:M.visibility})):void 0,overview:J.overview?{enable:!!J.overview.enable,openByDefault:!!J.overview.openByDefault}:void 0,legend:J.legend?{enable:!!J.legend.enable,openByDefault:!!J.legend.openByDefault}:void 0,viewpoint:pe,zoom:fe},C=this.builder.addWebMapResource(N.webmap.id,se,me,"default"),L=ae?{x:(ae.xmin+ae.xmax)/2,y:(ae.ymin+ae.ymax)/2,spatialReference:ae.spatialReference}:void 0;let z;try{const M=this.classicJson.webmapJson,G=M&&Array.isArray(M.operationalLayers)?M.operationalLayers:[],X=this.classicJson?.values?.webmap;if(G.length&&(X===N.webmap.id||X==null))z=G.map(W=>({...W}));else{const W=`https://www.arcgis.com/sharing/rest/content/items/${N.webmap.id}/data?f=json`,ie=this.token?`${W}&token=${encodeURIComponent(this.token)}`:W;if(!(typeof window<"u"))try{const ge=Pe("curl",["-sL",ie],{encoding:"utf-8"}),D=JSON.parse(ge),ce=Array.isArray(D?.operationalLayers)?D.operationalLayers:[];ce.length&&(z=ce.map(ke=>({...ke})))}catch{}Te(ie,void 0,600*1e3).then(ge=>{const D=Array.isArray(ge?.operationalLayers)?ge.operationalLayers:[];D.length&&(z=D.map(ce=>({...ce})))}).catch(()=>{})}}catch{}this.builder.updateWebMapData(C,{extent:ae,center:L,mapLayers:z??(Array.isArray(N.webmap.layers)?N.webmap.layers.map(M=>({id:M.id,title:M.title||M.id,visible:M.visibility})):void 0),viewpoint:pe,zoom:fe});try{const M=`https://www.arcgis.com/sharing/rest/content/items/${N.webmap.id}/data?f=json`,G=this.token?`${M}&token=${encodeURIComponent(this.token)}`:M;Te(G,void 0,600*1e3).then(K=>{const X=Array.isArray(K?.operationalLayers)?K.operationalLayers:[];if(X.length){this.builder.updateWebMapData(C,{mapLayers:X.map(ie=>({...ie}))});const W=new Map;if(N.webmap&&Array.isArray(N.webmap.layers))for(const ie of N.webmap.layers)W.set(ie.id,!!ie.visibility);_&&this.builder.updateNodeData(_,ie=>{ie.mapLayers=X.map(ye=>{const ge=String(ye.id||""),D=W.has(ge)?W.get(ge):!1;return{...ye,visible:D}})})}}).catch(()=>{})}catch{}_=this.builder.createWebMapNode(C,$.text.includes("Map")||$.text.includes("Scene")?$.text:void 0);const Y=this.builder.getJson();if(_){const M=Y.nodes[_],G=M&&"data"in M?M.data:void 0;if(M&&G){if(Array.isArray(N.webmap.layers)){const K=new Map;for(const X of N.webmap.layers)K.set(X.id,!!X.visibility);Array.isArray(z)&&z.length?G.mapLayers=z.map(X=>{const W=String(X.id||""),ie=K.has(W)?K.get(W):!1;return{...X,visible:ie}}):G.mapLayers=N.webmap.layers.map(X=>({id:X.id,title:X.title||X.id,visible:X.visibility}))}ae&&(G.extent=ae),pe&&(G.viewpoint=pe),typeof fe=="number"&&(G.zoom=fe),J.overview&&J.overview.enable&&(G.overview={openByDefault:!!J.overview.openByDefault}),J.legend&&J.legend.enable&&(G.legend={openByDefault:!!J.legend.openByDefault})}}this.media.add(N.webmap.id)}else if(N.image?.url){const se=this.builder.addImageResource(N.image.url);_=this.builder.createImageNode(se,N.image.caption,N.image.altText,"standard"),this.media.add(N.image.url)}else if(N.video?.url){const se=this.detectVideoProvider(N.video.url);if(se.provider!=="unknown")_=this.builder.createVideoEmbedNode(N.video.url,se.provider,se.id,N.video.caption,N.video.caption,void 0,N.video.altText),this.videoEmbedCount++;else{const pe=this.builder.addVideoResource(N.video.url,"uri");_=this.builder.createVideoNode(pe,N.video.caption,N.video.altText),this.media.add(N.video.url)}}else if(N.webpage?.url){const se=this.tryBuildSwipeNodeFromUrl(N.webpage.url);se?_=se:_=this.builder.createEmbedNode(N.webpage.url,N.webpage.caption,N.webpage.title,N.webpage.description,N.webpage.altText)}if(_){this.builder.updateNode($.buttonNodeId,ae=>{const J=ae;J.dependents||(J.dependents={}),J.dependents.actionMedia=_;const C=this.builder.getJson().nodes[_];if(C?.type==="swipe"&&C.data&&C.data.contents){const L=C.data.contents,z=L[0],Y=L[1];z&&(J.dependents.actionMedia_content_0=z),Y&&(J.dependents.actionMedia_content_1=Y)}});const pe=this.builder.getJson().nodes[ue],fe=pe&&"children"in pe?pe.children:void 0;Array.isArray(fe)&&(fe.includes(_)||this.builder.addChild(ue,_)),this.builder.registerReplaceMediaAction($.buttonNodeId,ue,_)}}}}const p=new Map;this.sections.forEach(k=>{(k.contentActions||[]).forEach(A=>{A.type==="navigate"&&typeof A.index=="number"&&p.set(A.id,A.index)})});for(const k of j){const A=p.get(k.actionId);if(typeof A=="number"){const q=w[A];q&&this.builder.setButtonLink(k.buttonNodeId,`#ref-${q}`)}}const y=this.builder.getJson();for(const k of c){const A=p.get(k.actionId);if(typeof A!="number")continue;const q=w[A];if(!q)continue;const le=y.nodes[k.richNodeId];if(le?.type==="text"&&le.data){const T=le.data;if(!T.preserveHtml)continue;const B=T.text,R=new RegExp(`<a([^>]*data-storymaps=["']${k.actionId}["'][^>]*)>`,"i"),ue=B.replace(R,(te,$)=>/href=/.test($)?te:`<a${$} href="#ref-${q}" target="_self">`);T.text=ue}}const I=i.settings?.theme||null;if(!S&&n==="float"){const k=this.builder.getJson();for(const q of Object.values(k.nodes))if(q&&q.type==="immersive-narrative-panel"){const le=q.data||{};le.position="end",le.size="medium",q.data=le}const A={baseThemeId:"obsidian",forcedByMissingClassicTheme:!0,variableOverridesApplied:[],layoutMapping:{classicLayoutId:n,classicSize:m,classicPosition:v,mappedSubtype:a,mappedNarrativePanelSize:"medium",mappedNarrativePanelPosition:"end"}};this.builder.applyTheme({themeId:"obsidian",variableOverrides:{}}),A.videoEmbeds=this.videoEmbedCount,this.builder.addConverterMetadata("MapJournal",{classicMetadata:{theme:I,mappingDecisions:A}}),this.emit("Applied fallback obsidian theme (no classic theme present; float layout)");return}const{theme:g,decisions:F}=Zt(this.classicJson);F.layoutMapping={classicLayoutId:n,classicSize:m,classicPosition:v,mappedSubtype:a,mappedNarrativePanelSize:h,mappedNarrativePanelPosition:u};const V={};if(Array.isArray(F.variableOverridesApplied))for(const k of F.variableOverridesApplied)g.variables&&k in g.variables&&(V[k]=String(g.variables[k]));if(this.styleBlocks.length)try{const k=this.styleBlocks.join(`

`);let A=k.split("").map(T=>T.charCodeAt(0)<32?" ":T).join("");A=A.replace(/\r/g,"").replace(/\t/g," "),A=A.replace(/\n{3,}/g,`

`);const q=k.length,le=A.length>6e3?A.slice(0,6e3)+`
/*__CSS_TRUNCATED__*/`:A;F.customCss={blockCount:this.styleBlocks.length,approxBytes:q,combined:le}}catch{}this.builder.applyTheme({themeId:F.baseThemeId,variableOverrides:V}),F.videoEmbeds=this.videoEmbedCount,this.builder.addConverterMetadata("MapJournal",{classicMetadata:{theme:I,mappingDecisions:F}});const re=this.builder.getJson().nodes[l],P=re&&"children"in re?re.children:void 0,oe=Array.isArray(P)?P.length:0;this.emit(`Built single sidecar with ${oe} slide(s); theme overrides applied (${Object.keys(V).length})`)}applyTheme(){this.emit("applyTheme skipped (handled in convertContent)")}collectMedia(){return this.emit(`Collected ${this.media.size} media URL(s)`),Array.from(this.media)}getStoryMapJson(){return this.builder.getJson()}static convert(t){return new He(t).convert()}normalizeExtent(t){if(!t)return t;const r=t.spatialReference?.wkid||t.spatialReference?.latestWkid||t.spatialReference?.wkt;if(!(r===4326||r==="WGS84"||r==="WGS 84")||[t.xmin,t.ymin,t.xmax,t.ymax].some(o=>typeof o!="number"||!isFinite(o)))return t;const i=o=>o*2003750834e-2/180,n=o=>Math.log(Math.tan((90+o)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;return{xmin:i(t.xmin),ymin:n(t.ymin),xmax:i(t.xmax),ymax:n(t.ymax),spatialReference:{wkid:102100,latestWkid:3857}}}extractImageEntries(t){const r=[],s=/<figure[^>]*>([\s\S]*?)<\/figure>/gi;let i;for(;(i=s.exec(t))!==null;){const m=i[1],v=/<img[^>]*>/i.exec(m)?.[0];if(!v)continue;const S=/src=["']([^"'>]+)["']/i.exec(v);if(!S)continue;const a=/alt=["']([^"'>]*)["']/i.exec(v),h=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(m),u=h?this.stripHtml(h[1]).trim():void 0,l=S[1];r.some(b=>b.src===l)||r.push({src:l,alt:a?a[1]:void 0,caption:u})}const n=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let o;for(;(o=n.exec(t))!==null;){const m=o[0],v=o[1];if(!r.some(S=>S.src===v)){const S=/alt=["']([^"'>]*)["']/i.exec(m);r.push({src:v,alt:S?S[1]:void 0})}}return r}stripHtml(t){return t.replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/\s+/g," ").trim()}extractParagraphBlocks(t){const r=[],s=/<p[^>]*>([\s\S]*?)<\/p>/gi;let i;for(;(i=s.exec(t))!==null;){const n=i[1],o=this.stripHtml(n);o&&r.push(o)}if(!r.length){const n=this.stripHtml(t);n&&r.push(n)}return r}extractActionAnchorLabel(t,r){const i=new RegExp(`<a[^>]*data-storymaps=["']${r}["'][^>]*>([\\s\\S]*?)</a>`,"i").exec(t);if(i)return this.stripHtml(i[1])}isNonEmptyHtmlSegment(t){if(!t)return!1;const r=/data-storymaps=/i.test(t),s=t.replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/gi," ").replace(/\u00A0/g," ").trim();return r||s.length>0}colorToHex(t){if(!t)return;if(t=t.trim(),t=t.replace(/!important$/i,"").trim(),/^#([0-9a-f]{3})$/i.test(t)){const n=t[1],o=t[2],m=t[3];return`#${n}${n}${o}${o}${m}${m}`.toUpperCase()}if(/^#([0-9a-f]{6})$/i.test(t))return t.toUpperCase();const r=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i.exec(t);if(r){const[n,o,m]=r.slice(1,4).map(v=>Math.max(0,Math.min(255,parseInt(v,10))));return`#${n.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`.toUpperCase()}const s=/rgb-?(\d+)-?(\d+)-?(\d+)/i.exec(t);if(s){const[n,o,m]=s.slice(1,4).map(v=>Math.max(0,Math.min(255,parseInt(v,10))));return`#${n.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`.toUpperCase()}const i=t.toLowerCase();if(this.CSS_COLOR_MAP[i])return this.CSS_COLOR_MAP[i].toUpperCase()}processHtmlColorsPreserveHtml(t){if(!t||!/<[^>]+style=/i.test(t))return t;try{const s=new DOMParser().parseFromString(`<wrapper>${t}</wrapper>`,"text/html").querySelector("wrapper");if(!s)return t;for(const i of Array.from(s.querySelectorAll("[style]"))){const n=i.getAttribute("style")||"",o=/color\s*:\s*([^;]+)(;?)/i.exec(n);if(!o)continue;const m=o[1].trim(),v=this.colorToHex(m);if(!v)continue;const S=`sm-text-color-${v.substring(1)}`;let a=n.replace(o[0],"").trim();a=a.replace(/;;+/g,";"),a=a.replace(/^;|;$/g,"").trim(),a?i.setAttribute("style",a):i.removeAttribute("style");const h=i.getAttribute("class");h?i.setAttribute("class",h+" "+S):i.setAttribute("class",S)}return s.innerHTML}catch{return t.replace(/(<[^>]+style=["'][^"'>]*color\s*:[^"'>]+["'][^>]*>)/gi,r=>{const s=/style=["']([^"'>]+)["']/i.exec(r);if(!s)return r;let i=s[1];const n=/color\s*:\s*([^;]+)(;?)/i.exec(i);if(!n)return r;const o=n[1].trim(),m=this.colorToHex(o);if(!m)return r;const v=`sm-text-color-${m.substring(1)}`;i=i.replace(n[0],"").trim(),i=i.replace(/;;+/g,";").replace(/^;|;$/g,"").trim();let S=r.replace(s[0],i?`style="${i}"`:"");return/class=["']/i.test(S)?S=S.replace(/class=["']([^"'>]+)["']/i,(a,h)=>`class="${h} ${v}"`):S=S.replace(/<([^\s>]+)/,(a,h)=>`<${h} class="${v}"`),S})}}handleElementOrdered(t,r,s,i,n){if(t.tagName==="STYLE"){const m=t.textContent||"";m.trim()&&this.styleBlocks.push(m.trim());return}if(t.tagName==="FIGURE"){const m=t.querySelector("img");if(m?.src){const v=this.builder.addImageResource(m.src);r.push(this.builder.createImageNode(v,t.querySelector("figcaption")?.textContent?.trim()||void 0,m.alt||void 0,"standard")),this.media.add(m.src)}return}if(t.tagName==="IMG"){if(t.getAttribute("src")){const m=t.getAttribute("src"),v=this.builder.addImageResource(m);r.push(this.builder.createImageNode(v,void 0,t.getAttribute("alt")||void 0,"standard")),this.media.add(m)}return}if(t.tagName==="P"||t.tagName==="DIV"){const m=new DOMParser().parseFromString(`<wrapper>${t.innerHTML}</wrapper>`,"text/html"),v=m.querySelector("wrapper");for(const h of Array.from(v.querySelectorAll("img[src]"))){const u=h.getAttribute("src"),l=h.getAttribute("alt")||void 0,b=this.builder.addImageResource(u),x=this.builder.createImageNode(b,void 0,l,"standard");this.media.add(u),h.replaceWith(m.createTextNode(`%%IMG:${x}%%`))}for(const h of Array.from(v.querySelectorAll("a[data-storymaps]"))){const u=h.getAttribute("data-storymaps"),l=h.getAttribute("data-storymaps-type")||"",b=(h.textContent||"View").trim(),j=(h.getAttribute("class")||"").split(/\s+/).filter(Boolean).some(c=>this.BUTTON_CLASS_REGEX.test(c));if(l==="media"){const c=this.builder.createActionButtonNode(b,"wide");s.push({actionId:u,text:b,buttonNodeId:c}),h.replaceWith(m.createTextNode(`%%ACTION_BTN:${c}%%`))}else if(l==="navigate")if(j){const c=this.builder.createButtonNode(b,"wide");i.push({actionId:u,buttonNodeId:c}),h.replaceWith(m.createTextNode(`%%NAV_BTN:${c}%%`))}else n.push({actionId:u,richNodeId:""})}const a=v.innerHTML.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%)/);for(const h of a)if(h)if(/^%%IMG:/.test(h)){const u=h.replace(/^%%IMG:/,"").replace(/%%$/,"");r.push(u)}else if(/^%%ACTION_BTN:/.test(h)){const u=h.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,"");r.push(u)}else if(/^%%NAV_BTN:/.test(h)){const u=h.replace(/^%%NAV_BTN:/,"").replace(/%%$/,"");r.push(u)}else{if(!this.isNonEmptyHtmlSegment(h))continue;const u=this.processHtmlColorsPreserveHtml(h),l=u.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(l&&l.length>1)for(const x of l){const w=x.replace(/^<p[^>]*>|<\/p>$/gi,"").trim();if(!w.replace(/&nbsp;|\s+/g,"").trim())continue;const c=this.builder.createRichTextNode(w,"paragraph");if(x.includes("data-storymaps"))for(const p of n)!p.richNodeId&&x.includes(`data-storymaps="${p.actionId}"`)&&(p.richNodeId=c);r.push(c)}else{let x=u;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(u.trim())&&(x=u.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim());const j=this.builder.createRichTextNode(x,"paragraph");if(u.includes("data-storymaps"))for(const c of n)!c.richNodeId&&u.includes(`data-storymaps="${c.actionId}"`)&&(c.richNodeId=j);r.push(j)}}return}if(t.tagName==="IFRAME"){const m=t.getAttribute("src");if(m){const v=this.parseSwipeAppId(m);if(v&&typeof window>"u"){const a=this.fetchClassicSwipeDataSync(v);if(a&&a.values){const h=this.parseSwipeLayoutFromUrl(m)||(String(a.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const u=be.buildInlineSwipeBlock(this.builder,a.values,h,this.token);r.push(u);return}catch{}}}const S=this.detectVideoProvider(m);S.provider!=="unknown"?(r.push(this.builder.createVideoEmbedNode(m,S.provider,S.id)),this.videoEmbedCount++):r.push(this.builder.createEmbedNode(m))}return}const o=t.textContent?.trim();o&&r.push(this.builder.createTextNode(o,"paragraph"))}parseOrderedFallback(t,r,s,i,n){const o=/<style[^>]*>([\s\S]*?)<\/style>/gi;let m;for(;(m=o.exec(t))!==null;){const a=m[1].trim();a&&this.styleBlocks.push(a)}const v=/(<figure[\s\S]*?<\/figure>)|(<img[^>]*>)|(<p[\s\S]*?<\/p>)|(<div[\s\S]*?<\/div>)|(<iframe[\s\S]*?<\/iframe>)/gi;let S;for(;(S=v.exec(t))!==null;){const a=S[0],h=a.slice(0,10).toLowerCase();if(h.startsWith("<style")){const l=a.replace(/^<style[^>]*>|<\/style>$/gi,"").trim();l&&this.styleBlocks.push(l);continue}if(h.startsWith("<figure")){const l=/<img[^>]*>/i.exec(a)?.[0];if(l){const b=/src=["']([^"'>]+)["']/i.exec(l)?.[1];if(b){const x=/alt=["']([^"'>]*)["']/i.exec(l)?.[1],w=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(a)?.[1],j=this.builder.addImageResource(b);r.push(this.builder.createImageNode(j,w?this.stripHtml(w).trim():void 0,x,"standard")),this.media.add(b)}}continue}if(h.startsWith("<iframe")){const l=/src=["']([^"'>]+)["'][^>]*>/i.exec(a)?.[1];if(l){const b=this.parseSwipeAppId(l);if(b&&typeof window>"u"){const w=this.fetchClassicSwipeDataSync(b);if(w&&w.values){const j=this.parseSwipeLayoutFromUrl(l)||(String(w.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const c=be.buildInlineSwipeBlock(this.builder,w.values,j,this.token);r.push(c);continue}catch{}}}const x=this.detectVideoProvider(l);x.provider!=="unknown"?(r.push(this.builder.createVideoEmbedNode(l,x.provider,x.id)),this.videoEmbedCount++):r.push(this.builder.createEmbedNode(l))}continue}if(h.startsWith("<p")||h.startsWith("<div")){const l=a.replace(/^<p[^>]*>|^<div[^>]*>|<\/p>$|<\/div>$/gi,"");let b=l;const x=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let w;for(;(w=x.exec(l))!==null;){const g=w[0],F=w[1],V=/alt=["']([^"'>]*)["']/i.exec(g)?.[1],re=this.builder.addImageResource(F),P=this.builder.createImageNode(re,void 0,V,"standard");this.media.add(F),b=b.replace(g,`%%IMG:${P}%%`)}const j=/<a[^>]*data-storymaps=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/a>/gi;let c;for(;(c=j.exec(l))!==null;){const g=c[0],F=c[1],V=/data-storymaps-type=["']([^"'>]+)["']/i.exec(g)?.[1]||"",re=g.replace(/<a[^>]*>|<\/a>/gi,""),P=this.stripHtml(re).trim()||"View",k=(/class=["']([^"'>]+)["']/i.exec(g)?.[1]||"").split(/\s+/).some(A=>this.BUTTON_CLASS_REGEX.test(A));if(V==="media"){const A=this.builder.createActionButtonNode(P,"wide");s.push({actionId:F,text:P,buttonNodeId:A}),b=b.replace(g,`%%ACTION_BTN:${A}%%`)}else if(V==="navigate")if(k){const A=this.builder.createButtonNode(P,"wide");i.push({actionId:F,buttonNodeId:A}),b=b.replace(g,`%%NAV_BTN:${A}%%`)}else n.push({actionId:F,richNodeId:""})}const p=/<iframe[^>]*src=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/iframe>/gi;let y;for(;(y=p.exec(l))!==null;){const g=y[0],F=y[1];let V;const re=this.parseSwipeAppId(F);if(re&&typeof window>"u"){const P=this.fetchClassicSwipeDataSync(re);if(P&&P.values){const oe=this.parseSwipeLayoutFromUrl(F)||(String(P.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{V=be.buildInlineSwipeBlock(this.builder,P.values,oe,this.token)}catch{}}}if(!V){const P=this.detectVideoProvider(F);P.provider!=="unknown"?(V=this.builder.createVideoEmbedNode(F,P.provider,P.id),this.videoEmbedCount++):V=this.builder.createEmbedNode(F)}b=b.replace(g,`%%IFRAME_NODE:${V}%%`)}const I=b.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%|%%IFRAME_NODE:[^%]+%%)/);for(const g of I)if(g)if(/^%%IMG:/.test(g))r.push(g.replace(/^%%IMG:/,"").replace(/%%$/,""));else if(/^%%ACTION_BTN:/.test(g))r.push(g.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,""));else if(/^%%NAV_BTN:/.test(g))r.push(g.replace(/^%%NAV_BTN:/,"").replace(/%%$/,""));else if(/^%%IFRAME_NODE:/.test(g))r.push(g.replace(/^%%IFRAME_NODE:/,"").replace(/%%$/,""));else{if(!this.isNonEmptyHtmlSegment(g))continue;const F=this.processHtmlColorsPreserveHtml(g),V=F.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(V&&V.length>1)for(const P of V){const oe=P.replace(/^<p[^>]*>|<\/p>$/gi,"").trim();if(!oe.replace(/&nbsp;|\s+/g,"").trim())continue;const A=this.builder.createRichTextNode(oe,"paragraph");if(P.includes("data-storymaps"))for(const q of n)!q.richNodeId&&P.includes(`data-storymaps="${q.actionId}"`)&&(q.richNodeId=A);r.push(A)}else{let P=F;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(F.trim())&&(P=F.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim());const k=this.builder.createRichTextNode(P,"paragraph");if(F.includes("data-storymaps"))for(const A of n)!A.richNodeId&&F.includes(`data-storymaps="${A.actionId}"`)&&(A.richNodeId=k);r.push(k)}}continue}const u=this.stripHtml(a).trim();u&&r.push(this.builder.createTextNode(u,"paragraph"))}}detectVideoProvider(t){if(!t)return{provider:"unknown"};const r=/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([A-Za-z0-9_-]{6,})(?:[&#?].*)?$/i.exec(t);if(r)return{provider:"youtube",id:r[1]};const s=/(?:vimeo\.com\/(?:video\/)?)(\d+)(?:[&#?].*)?$/i.exec(t);return s?{provider:"vimeo",id:s[1]}:{provider:"unknown"}}parseSwipeAppId(t){try{const r=new URL(t,"https://example.com");return r.searchParams.get("appid")||r.searchParams.get("appId")||void 0}catch{return/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(t)?.[1]}}parseSwipeLayoutFromUrl(t){try{const s=(new URL(t,"https://example.com").searchParams.get("layout")||"").toLowerCase();return s.includes("spyglass")?"spyglass":s.includes("swipe")?"swipe":void 0}catch{return}}fetchClassicSwipeDataSync(t){try{const r=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,s=this.token?`${r}&token=${encodeURIComponent(this.token)}`:r,i=Re(`curl -sL '${s}'`,{encoding:"utf-8"});return JSON.parse(i)}catch{return}}fetchClassicSwipeDataProvided(t){try{const r=this.classicJson,s=this.classicJson.values,i=r.__embeddedSwipes||s?.__embeddedSwipes||void 0,n=i?i[t]:void 0;if(n&&typeof n=="object")return n}catch{}}tryBuildSwipeNodeFromUrl(t){const r=this.parseSwipeAppId(t);if(!r)return;const i=typeof window<"u"?this.fetchClassicSwipeDataProvided(r):this.fetchClassicSwipeDataSync(r);if(!i||!i.values)return;const o=this.parseSwipeLayoutFromUrl(t)||(String(i.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const m=be.buildInlineSwipeBlock(this.builder,i.values,o,this.token);try{const v=this.builder.getJson(),S=v.nodes[m];if(S&&S.type==="swipe"){const a=S.data?.contents||{},h=[];for(const u of["0","1"]){const l=a[u];(!l||!v.nodes[l])&&h.push(u)}if(h.length){const u=i.values,l=String(u.dataModel||"").toUpperCase(),b={...a};if(l==="TWO_LAYERS"){const x=String(u.webmap||"");if(x){const w=this.builder.addWebMapResource(x,"Web Map",{},"default"),j=Array.isArray(u.layers)?u.layers:[],c=this.builder.createWebMapNode(w,void 0),p=this.builder.createWebMapNode(w,void 0);if(j.length>=2){const y=j[0],I=j[1];this.builder.updateNodeData(c,g=>{g.mapLayers=[{id:y.id,title:y.title||y.id,visible:!0},{id:I.id,title:I.title||I.id,visible:!1}]}),this.builder.updateNodeData(p,g=>{g.mapLayers=[{id:y.id,title:y.title||y.id,visible:!1},{id:I.id,title:I.title||I.id,visible:!0}]})}b[0]=c,b[1]=p}}else{const x=[];if(Array.isArray(u.webmaps))for(const c of u.webmaps)typeof c=="string"?x.push(c):c&&typeof c=="object"&&"id"in c&&x.push(String(c.id));else u.webmap&&x.push(String(u.webmap));const[w,j]=x;if(w){const c=this.builder.addWebMapResource(w,"Web Map",{},"default");b[0]=this.builder.createWebMapNode(c,void 0)}if(j){const c=this.builder.addWebMapResource(j,"Web Map",{},"default");b[1]=this.builder.createWebMapNode(c,void 0)}}this.builder.updateNode(m,x=>{const w=x.data||{};w.contents=b,x.data=w})}}}catch{}return m}catch{return}}}class Qt{static async transferBatch(t){const{urls:r,storyId:s,username:i,token:n,progress:o,uploader:m,isCancelled:v}=t,S={};for(let a=0;a<r.length;a++){if(v&&v())throw new Error("Conversion cancelled by user intervention");const h=r[a];o({stage:"media",message:`Transferring media ${a+1}/${r.length}`,current:a+1,total:r.length});try{if(v&&v())throw new Error("Conversion cancelled by user intervention");const u=await m(h,s,i,n);u.transferred&&(S[u.originalUrl]=u.resourceName)}catch{}}if(v&&v())throw new Error("Conversion cancelled by user intervention");return S}}class es{static apply(t,r){for(const[s,i]of Object.entries(t.resources))if(i.type==="image"){const n=i,o=n.data&&typeof n.data=="object"?n.data.src:void 0;if(o&&r[o]){const m=n.data||{};m.resourceId=r[String(o)],delete m.src,m.provider="item-resource",n.data=m}}for(const s of Object.values(t.nodes))if(s.type==="image"){const i=s,n=i.data&&typeof i.data=="object"?i.data.src:void 0;if(typeof n=="string"){const o=n,m=Object.entries(t.resources).find(([v,S])=>S.type==="image"&&typeof S.data.src=="string"&&S.data.src===o)?.[0];if(m){const v=i.data||{};v.image=m,delete v.src,delete v.resourceId,delete v.provider,i.data=v}}}return t}static rewriteImageUrlsToProxy(t,r){for(const s of Object.values(t.resources))if(s.type==="image"){const i=s,n=i.data||{},o=n.src,m=n.resourceId;typeof o=="string"&&!m&&(n.src=`${r}?url=${encodeURIComponent(o)}`),i.data=n}for(const s of Object.values(t.nodes))if(s.type==="image"){const i=s,n=i.data||{},o=n.src,m=n.image;typeof o=="string"&&!m&&(n.src=`${r}?url=${encodeURIComponent(o)}`),i.data=n}return t}}const Ae="https://www.arcgis.com/sharing/rest";async function ot(f,t){const r=`${Ae}/content/items/${f}/data?f=json&token=${t}`,s=await fetch(r);if(!s.ok)throw new Error(`Failed to fetch item data: ${s.statusText}`);return s.json()}async function nt(f,t){const r=`${Ae}/content/items/${f}?f=json&token=${t}`,s=await fetch(r);if(!s.ok)throw new Error(`Failed to fetch item details: ${s.statusText}`);return s.json()}async function ts(f,t,r,s){const i=`${Ae}/content/users/${t}/items/${f}/removeResources`,n=new URLSearchParams;n.append("resource",r),n.append("f","json"),n.append("token",s);const o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()});if(!o.ok)throw new Error(`Failed to remove resource: ${o.statusText}`);return o.json()}async function mt(f,t,r,s,i){const n=`${Ae}/content/users/${t}/items/${f}/addResources`,o=new FormData;o.append("file",r,s),o.append("fileName",s),o.append("f","json"),o.append("token",i);const m=await fetch(n,{method:"POST",body:o}),v=await m.json();console.log("[addResource] Upload API response:",v);const S=m.ok,a=v?.success===!0,h=v?.error?.message;if(!S||!a)throw new Error(`Failed to add resource: ${h||m.statusText}`);return v}async function at(f,t,r,s){const i=`${Ae}/content/users/${t}/items/${f}/update`,n=new URLSearchParams;n.append("typeKeywords",JSON.stringify(r)),n.append("f","json"),n.append("token",s);const o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()});if(!o.ok)throw new Error(`Failed to update item keywords: ${o.statusText}`);return o.json()}function ss(f){const t=f&&typeof f=="object"?f.typeKeywords:void 0,r=Array.isArray(t)?t.filter(s=>typeof s=="string"):[];for(const s of r)if(s.startsWith("smdraftresourceid:"))return s.substring(18);return null}function rs(){const f=Fe(),t=Fe(),r=Fe(),s=Fe(),i=is();return{root:f,nodes:{[t]:{type:"storycover",data:{type:"minimal",title:"",summary:"",byline:"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},[r]:{type:"navigation",data:{links:[]},config:{isHidden:!0}},[s]:{type:"credits",children:[]},[f]:{type:"story",data:{storyTheme:i},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[t,r,s]}},resources:{[i]:{type:"story-theme",data:{themeId:"summit",themeBaseVariableOverrides:{}}}}}}function Fe(){return`n-${Math.random().toString(36).slice(2,8)}`}function is(){return`r-${Math.random().toString(36).slice(2,8)}`}async function os(f,t,r){const s=`${Ae}/content/users/${encodeURIComponent(f)}/addItem`,i=new URLSearchParams;i.append("f","json"),i.append("token",t),i.append("title",r),i.append("type","StoryMap"),i.append("typeKeywords",JSON.stringify(["StoryMaps","smdraftresourceid:draft.json"]));const n=rs();i.append("text",JSON.stringify(n));const o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i.toString()}),m=await o.json();if(!o.ok||!m||!m.success||!m.id){const v=m&&m.error&&m.error.message||o.statusText||"addItem failed";throw new Error(`Failed to create draft story: ${v}`)}return String(m.id)}function ns(f){return f.includes("www.arcgis.com/sharing/rest/content")||f.includes("//www.arcgis.com/sharing/rest/content")}function as(f){const t=f.split("/resources/");if(t.length>1){const s=t[1].split("?")[0];return decodeURIComponent(s)}return f.split("/").pop()?.split("?")[0]||"image.jpg"}function cs(f,t){const r=["jpg","jpeg","png","gif","webp","bmp","tif","tiff"];let s=t;if(!s){const n=f.split(".").pop()||"";s=r.includes(n.toLowerCase())?n.toLowerCase():"jpg"}return s==="jpeg"&&(s="jpg"),s==="tiff"&&(s="tif"),`${Math.random().toString(36).substring(2,15)}.${s}`}function ct(f){if(!f)return".jpg";const t=f.toLowerCase();return[".jpg",".jpeg",".png",".gif",".webp",".bmp",".tif",".tiff"].includes(t)?t===".jpeg"?".jpg":t===".tiff"?".tif":t:".jpg"}function ls(f,t,r){if(r){const i=/filename="?([^";]+)"?/i.exec(r);if(i){const o=i[1].toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(o)return o[0].replace(".jpeg",".jpg").replace(".tiff",".tif")}}const s=f.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(s)return s[0].replace(".jpeg",".jpg").replace(".tiff",".tif");if(t&&/^image\//i.test(t)){const i=t.split("/")[1].toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","tiff","tif"].includes(i)?"."+(i==="jpeg"?"jpg":i==="tiff"?"tif":i):".jpg"}return".bin"}async function ds(f,t){const r=t?`${f}?token=${encodeURIComponent(t)}`:f,s=await fetch(r);if(!s.ok)throw new Error(`Image fetch failed ${s.status}`);const i=s.headers.get("content-disposition")||void 0,n=s.headers.get("content-type")||void 0,o=s.url,m=await s.blob(),v=ls(o,n,i);return{blob:m,extension:v}}async function ps(f,t,r,s,i){try{console.log("[transferImage] Starting transfer:",{imageUrl:f,filename:i,targetItemId:t});const n=as(f);let o=".jpg",m;try{const S=await ds(f,ns(f)?s:void 0);m=S.blob,o=ct(S.extension)}catch(S){console.warn("[transferImage] Primary fetch failed, trying proxy:",{imageUrl:f,error:S}),m=await us(f);const a=n.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);o=ct(a?a[0]:".jpg")}/^\.(jpg|png|gif|webp|bmp|tif)$/i.test(o)||(o=".jpg");let v;return i||(v=cs(n,o.replace(".",""))),console.log("[transferImage] Uploading to AGO:",{newResourceName:v,blob:m}),await mt(t,r,m,v,s),console.log("[transferImage] Transfer successful:",{imageUrl:f,newResourceName:v}),{originalUrl:f,resourceName:v,isTransferred:!0}}catch(n){return console.error("[transferImage] Transfer failed:",{imageUrl:f,error:n}),{originalUrl:f,resourceName:f,isTransferred:!1}}}async function us(f){const r=/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname)?`/.netlify/functions/proxy-image?url=${encodeURIComponent(f)}`:f,s=await fetch(r);if(!s.ok)throw new Error("Failed to fetch image (proxy/direct)");return await s.blob()}function ms(f){const t=new Set;if(f.resources){for(const r of Object.values(f.resources))if(r.type==="image"){const s=r.data?.url||r.data?.src;s&&t.add(s)}}return Array.from(t)}function hs(){const[f,t]=E.useState(!1),r=E.useRef(!1),[s,i]=E.useState(!1),[n]=E.useState(!1),{token:o,userInfo:m}=Le(),[v,S]=E.useState(""),[a,h]=E.useState("idle"),[u,l]=E.useState(""),[b,x]=E.useState(""),[w,j]=E.useState(""),[c,p]=E.useState("Convert"),[y,I]=E.useState(et());E.useEffect(()=>{const C=L=>I(L);return Vt(C),I(et()),()=>Gt(C)},[]);const g=()=>{if(r.current)throw new Error("Conversion cancelled by user intervention")},[F,V]=E.useState(!1),re=E.useCallback(()=>{if(r.current)return;window.confirm("Cancel conversion in progress? This will stop further processing.")&&(r.current=!0,V(!0),i(!1))},[]),[P,oe]=E.useState(null),[k,A]=E.useState(null),[q,le]=E.useState([]),T="https://www.arcgis.com",[B,R]=E.useState(T),ue=E.useRef(null),te=E.useRef(!1),[$,U]=E.useState(!1),[_,N]=E.useState({}),se=E.useCallback(()=>{const C=typeof m=="object"&&m?m:{},L=C.orgUrl||C.org?.url||"";try{if(typeof L=="string"&&L.length){const Y=new URL(L).hostname,M=/^(.*)\.maps\.arcgis\.com$/i.exec(Y);return M&&M[1]?`${M[1]}.maps.arcgis.com`:Y}}catch{}return"www.arcgis.com"},[m]),pe=E.useCallback((C,L)=>{const z=se(),Y=L&&L!==T?L:`https://${z}`;return C.map(M=>{const G=M.itemId,K=M.message||"";if(/version\s*([0-9]+(?:\.[0-9]+)?)\s*<\s*2\.0/i.test(K)){const W=`ERROR: Item [${G}] Unsupported web map version: You must update the web map to the latest version. You can do this by opening the map in <a href="${Y}/home/webmap/viewer.html?webmap=${G}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a> and save it. No other changes are necessary to resolve this error.`;return{...M,level:"error",message:W}}if(/HTTP URL|http:\/\//i.test(K)){const W=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${Y}/home/item.html?id=${G}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,ie=`WARNING: Webmap [${G}] uses http services.`;return{...M,message:`${ie}
${W}`}}const X=/Map Viewer Classic\s*<\s*link\s*=\s*(https?:[^\s>]+)\s*>/i.exec(K);if(X){const W=X[1],ie=K.replace(X[0],`<a href="${W}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a>`);return{...M,message:ie}}if(/https:\/\/<org_url>\.arcgis\.com/i.test(K)){const W=K.replace(/https:\/\/<org_url>\.arcgis\.com/gi,Y);return{...M,message:W}}if(/https:\/\/www\.arcgis\.com/i.test(K)&&Y&&Y!==T){const W=K.replace(/https:\/\/www\.arcgis\.com/gi,Y);return{...M,message:W}}return M})},[se]),fe=C=>{if(!C)return"";const L=se();return/^[a-f0-9]{32}$/i.test(C)?`https://${L}/home/item.html?id=${C}`:""};E.useEffect(()=>{if(!o){R(T),ue.current=null,te.current=!1;return}ue.current&&ue.current!==o&&(R(T),te.current=!1),ue.current=o},[o]),E.useEffect(()=>{try{const L=`https://${se()}`;o&&L&&B!==L&&R(L)}catch{}},[o,m,B,se]),E.useEffect(()=>{!o||te.current||(async()=>{try{const C=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(o)}`);if(!C.ok)return;const L=await C.json(),z=L?.urlKey,Y=L?.customBaseUrl;let M="";if(z&&Y)M=`https://${z}.${Y}`;else if(L?.portalHostname){const G=L.portalHostname;M=/^https?:/i.test(G)?G:`https://${G}`}M&&B!==M&&R(M)}catch{}finally{te.current=!0}})()},[o,B]),E.useEffect(()=>{q.length&&B&&B!==T&&le(C=>C.map(L=>({...L,message:(L.message||"").replace(/https:\/\/www\.arcgis\.com/gi,B)})))},[B,q.length]);const ae=C=>/^[a-f0-9]{32}$/i.test(C.trim()),J=E.useCallback(async()=>{if(B&&B!==T)return B;const C=se();let L=`https://${C}`;if(o&&/www\.arcgis\.com$/i.test(C))try{const z=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(o)}`);if(z.ok){const Y=await z.json(),M=Y?.urlKey,G=Y?.customBaseUrl;if(M&&G)L=`https://${M}.${G}`;else if(Y?.portalHostname){const K=Y.portalHostname;L=/^https?:/i.test(K)?K:`https://${K}`}}}catch{}return L&&L!==B&&R(L),L},[B,o,se]),me=async()=>{if(h("idle"),l(""),j(""),p("Convert"),r.current=!1,V(!1),le([]),U(!1),N({}),k?.url&&URL.revokeObjectURL(k.url),A(null),!ae(v)){h("error"),l("Incorrect Classic Story Map item id format - please enter a 32 character hex string");return}if(!o){h("error"),l("You must be signed in to ArcGIS Online or ArcGIS Enterprise");return}try{h("fetching"),l("Getting user information...");const C=m?.username||"";l("Fetching classic story data...");const L=await ot(v,o);g();let z=null;try{z=Kt(L)}catch{z=null}if(!z||z.toLowerCase()==="unknown")try{const O=await nt(v,o),H=Array.isArray(O?.typeKeywords)?O.typeKeywords:[],Q=[String(O?.type||"").toLowerCase(),...H.map(ee=>String(ee).toLowerCase())].join(" "),ne=/journal/.test(Q)?"Map Journal":/swipe/.test(Q)?"Swipe":/tour/.test(Q)?"Map Tour":/series/.test(Q)?"Map Series":/cascade/.test(Q)?"Cascade":/shortlist/.test(Q)?"Shortlist":/crowdsource/.test(Q)?"Crowdsource":/basic/.test(Q)?"Basic":null;ne&&(z=ne)}catch{}if(oe(z),z&&l(`Detected template: ${z}. Preparing resources...`),L.values?.webmap){l("Fetching classic webmap data...");const O=L.values?.webmap;L.webmapJson=await ot(O,o),g()}l("Creating new StoryMap draft...");const Y=L.values?.title||"Untitled Story",M=`(Converted) ${Y}`,G=await os(C,o,M);g(),l("Converting theme...");const K=[];L.values?.webmap&&K.push(L.values.webmap);const X=z||P||"webmap";h("fetching"),p(`Fetching ${X}...`);try{const O=L.values?.story?.sections||L.sections||[];for(const H of O){H?.media?.webmap?.id&&K.push(H.media.webmap.id);const Z=H?.media?.webpage?.url||"",de=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(String(Z))?.[1];if(de)try{const ee=`https://www.arcgis.com/sharing/rest/content/items/${de}/data?f=json`,he=o?`${ee}&token=${encodeURIComponent(o)}`:ee,Ie=await fetch(he);if(Ie.ok){const ve=await Ie.json(),Se=Array.isArray(ve?.values?.webmaps)?ve.values.webmaps:[];for(const xe of Se)typeof xe=="string"&&K.push(xe);try{const xe=String(de),Ce=L;Ce.__embeddedSwipes||(Ce.__embeddedSwipes={}),Ce.__embeddedSwipes[xe]=ve}catch{}}}catch{}const ne=Array.isArray(H?.contentActions)?H.contentActions:[];for(const ee of ne)if(ee&&ee.type==="media"&&ee.media&&ee.media.webpage&&ee.media.webpage.url){const he=String(ee.media.webpage.url||""),ve=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(he)?.[1];if(ve)try{const Se=`https://www.arcgis.com/sharing/rest/content/items/${ve}/data?f=json`,xe=o?`${Se}&token=${encodeURIComponent(o)}`:Se,Ce=await fetch(xe);if(Ce.ok){const De=await Ce.json(),ft=Array.isArray(De?.values?.webmaps)?De.values.webmaps:[];for(const $e of ft)typeof $e=="string"&&K.push($e);try{const $e=String(ve),Oe=L;Oe.__embeddedSwipes||(Oe.__embeddedSwipes={}),Oe.__embeddedSwipes[$e]=De}catch{}}}catch{}}}}catch{}const W=new Set,ie=[];for(const O of K){const H=String(O);W.has(H)||(W.add(H),ie.push(H))}let ye=[];try{const O=await J();if(ie.length>0)for(let H=0;H<ie.length;H++){if(r.current)throw new Error("Conversion cancelled by user intervention");const Z=ie[H];l(`Fetching webmap ${Z} ${H+1} of ${ie.length}...`);const{warnings:Q}=await qt([Z],o),de=Q.map(ee=>({itemId:ee.itemId,level:ee.level,message:ee.message,details:ee&&typeof ee=="object"&&"details"in ee?ee.details:void 0})),ne=pe(de,O);ne.length&&(ye=[...ye,...ne],le([...ye]))}U(!0)}catch{}const ge=!1;!r.current&&ye.length,ye.length>0&&U(!0),h("converting");const D=z||P||"story";p(`Converting ${D}: ${Y}...`),l(`Converting ${D} story to new format...`);let ce;const ke=O=>{const H=/\(\s*\d+\s*\/\s*\d+\s*\)\s*$/.test(O.message),Z=typeof O.total=="number"&&typeof O.current=="number"&&!H?`${O.message} (${O.current}/${O.total})`:O.message;switch(O.stage){case"media":h("transferring"),l(Z);break;case"convert":h("converting"),l(Z);break;case"finalize":h("updating"),l(Z);break;case"error":h("error"),l(Z);break;case"done":h("success"),l(Z);break;default:l(Z)}},Be=(P||z||"").toLowerCase();if(Be==="map journal"||Be==="mapjournal")ce=new He({classicJson:L,themeId:"summit",progress:ke,token:o}).convert().storymapJson;else if(Be==="swipe")ce=new be({classicJson:L,themeId:"summit",progress:ke,token:o}).convert().storymapJson;else throw new Error(`Unsupported template for new converters: ${P??"unknown"}`);g();try{h("transferring"),l("Transferring images to story resources...");const O=ms(ce);if(O.length){const H=async(Q,de,ne,ee)=>{const he=await ps(Q,de,ne,ee);return{originalUrl:he.originalUrl,resourceName:he.resourceName,transferred:he.isTransferred}},Z=await Qt.transferBatch({urls:O,storyId:G,username:C,token:o,progress:ke,uploader:H});ce=es.apply(ce,Z)}}catch(O){console.warn("[Converter] Image transfer step failed or skipped:",O)}try{const O=ce,H=O.resources&&Object.values(O.resources).find(he=>he.type==="converter-metadata"),Z=H?.data?.classicMetadata?.mappingDecisions?.customCss?.combined;if(Z){const he=new Blob([Z],{type:"text/css"}),Ie=URL.createObjectURL(he);A({css:Z,url:Ie})}const Q=H?.data?.classicMetadata?.webmapVersionWarnings,de=H?.data?.classicMetadata?.webmapProtocolWarnings,ne=[],ee=B;if(Array.isArray(Q)&&ne.push(...Q),Array.isArray(de)&&ne.push(...de),ne.length){const he=ne.map(Ie=>({itemId:Ie.itemId,message:Ie.message.replace(/https:\/\/<org_url>\.arcgis\.com/gi,ee)}));le(Ie=>{const ve=[...Ie];for(const Se of he)ve.some(xe=>xe.itemId===Se.itemId&&xe.message===Se.message)||ve.push({itemId:Se.itemId,level:"warning",message:Se.message});return ve})}}catch{}try{if(Array.isArray(q)&&q.length){const O=ce,H=O.resources||{},Z=Object.entries(H).find(([,Q])=>Q&&Q.type==="converter-metadata");if(Z){const[Q,de]=Z,ne=de.data||{},ee=ne.classicMetadata||{};ee.webmapChecks=q.map(he=>({itemId:he.itemId,level:he.level,message:he.message})),ne.classicMetadata=ee,de.data=ne,H[Q]=de,O.resources=H}else{const Q=`r-converter-metadata-${Date.now()}`,de={type:"converter-metadata",data:{classicMetadata:{webmapChecks:q.map(ne=>({itemId:ne.itemId,level:ne.level,message:ne.message}))}}};H[Q]=de,O.resources=H}}}catch{}h("updating"),l("Fetching target storymap details...");const Me=await nt(G,o);g();let je=ss(Me);if(!je){je="draft.json";try{const O=Array.isArray(Me.typeKeywords)?Me.typeKeywords:[],H=O.some(Z=>/^smdraftresourceid:/.test(String(Z)))?O:[...O,`smdraftresourceid:${je}`];await at(G,C,H,o)}catch{}}l(`Removing old draft resource (${je})...`);try{await ts(G,C,je,o)}catch{}g(),l(`Uploading new draft resource (${je})...`);try{const H=ce.nodes||{};for(const[,Z]of Object.entries(H))if(Z?.type==="action-button"&&Z.dependents){for(const Q of Object.keys(Z.dependents))/^actionMedia_content_/.test(Q)&&delete Z.dependents[Q];Object.keys(Z.dependents).length===0&&delete Z.dependents}}catch{}const ht=new Blob([JSON.stringify(ce)],{type:"application/json"});await mt(G,C,ht,je,o),g(),l("Updating keywords...");const Ve=Me.typeKeywords||[];if(!Ve.includes("smconverter:online-app")){const O=[...Ve,"smconverter:online-app"];await at(G,C,O,o),g()}g(),h("success"),l("Classic "+D+":  "+Y),j(`https://storymaps.arcgis.com/stories/${G}/edit`),t(!0);try{const O=ce,H=O.resources||{};for(const[Z,Q]of Object.entries(H))if(Q?.type==="webmap"){const de=Q.data||{},ne=de.initialState||{};for(const ee of["extent","center","viewpoint","mapLayers"])ne&&ee in ne&&!(ee in de)&&(de[ee]=ne[ee]);Q.data=de,H[Z]=Q}O.resources=H,ce=O,console.debug("[SaveGuard] Promoted initialState fields to resource data keys")}catch{}try{const O=await fetch("/.netlify/functions/save-converted",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({filename:"converted-app",storyId:G,classicItemId:v,json:ce})});if(O.ok){const H=await O.json();console.info("[LocalSave] Converted JSON saved:",H?.path||H?.fileName||"ok")}else console.warn("[LocalSave] Failed to save converted JSON locally:",O.status)}catch{console.warn("[LocalSave] Error saving converted JSON locally:",e?.message)}}catch(C){C instanceof Error&&C.message==="Conversion cancelled by user intervention"?(h("error"),l(C.message)):(h("error"),l(C instanceof Error?C.message:"An unknown error occurred")),C instanceof Error&&C.stack&&console.debug("[ConverterCatch]",C.stack),t(!1)}};return d.jsxs("div",{className:"converter-container",children:[d.jsx("h2",{children:"Classic Story Map Converter"}),d.jsxs("p",{children:["Convert Classic Esri Story Maps to ",d.jsx("a",{href:"https://storymaps.arcgis.com",target:"_blank",rel:"noopener noreferrer",children:"ArcGIS StoryMaps"})]}),d.jsxs("div",{className:"converter-instructions",children:[d.jsx("h3",{children:"Instructions:"}),d.jsxs("ol",{children:[d.jsx("li",{children:"Sign in to ArcGIS Online using the sign-in button above."}),d.jsx("li",{children:"Enter the Item ID of your Classic Story"}),d.jsx("li",{children:"Click Convert to transform your classic story into the new format"}),d.jsx("li",{children:"Review the converted story and publish when ready"})]})]}),d.jsxs("div",{className:"converter-input-group",children:[d.jsx("label",{className:"converter-label",children:"Classic Story Item ID:"}),d.jsx("input",{type:"text",value:v,onChange:C=>S(C.target.value),placeholder:"e.g., 858c4126f0604d1a86dea06ffbdc23a3",className:"converter-input"})]}),d.jsx("div",{className:"converter-controls-row",children:d.jsx("button",{className:`converter-btn ${y>0?"secondary":"disabled"}`,onClick:()=>{y>0&&(Ht(),x("Cache cleared"),setTimeout(()=>x(""),2e3))},title:y>0?"Clear in-memory fetch cache":"Cache is empty",disabled:y===0,children:"Clear cached webmap/story data"})}),a!=="success"?d.jsx("button",{className:`converter-btn ${s&&["fetching","converting","transferring","updating"].includes(a)?"cancel-hover":""}`,title:a==="idle"||a==="error"?"Start conversion":s?"Cancel conversion (Esc)":"Conversion in progress",onClick:a==="idle"||a==="error"?me:re,onMouseEnter:()=>{!n&&["fetching","converting","transferring","updating"].includes(a)&&i(!0)},onMouseLeave:()=>i(!1),disabled:f,children:a==="idle"||a==="error"?"Convert":s&&["fetching","converting","transferring","updating"].includes(a)?"Cancel":c}):d.jsxs("div",{className:"converter-message converter-message-success",children:[d.jsx("strong",{children:"Converted "})," ",u||"Conversion complete!"]}),n&&a!=="idle"&&a!=="error"&&a!=="success"&&!r.current&&!F&&d.jsx("div",{className:"cancel-mobile-wrapper",children:d.jsx("button",{className:"converter-btn cancel-mobile",onClick:re,title:"Cancel conversion",children:"Cancel"})}),a!=="success"&&u&&d.jsxs("div",{className:`converter-message converter-message-${a}`,children:[d.jsx("strong",{children:a==="error"?"Error:":"Status:"})," ",u]}),!!b&&d.jsx("div",{className:"converter-toast",role:"status","aria-live":"polite",children:b}),k&&d.jsxs("div",{className:"converter-warning",children:[d.jsx("strong",{children:"Custom CSS Detected!"})," Your classic story used custom CSS settings. To recreate your custom styles you should create a new ArcGIS StoryMaps Theme ",d.jsx("a",{href:"https://storymaps.arcgis.com/themes/new",target:"_blank",rel:"noopener noreferrer",children:"here"})," with your custom colors and styles, then apply the new Theme within the ArcGIS StoryMaps Builder (under the Design tab). ",d.jsx("a",{href:k.url,download:"custom-css.css",children:"Click this link"})," to download a copy of your custom CSS."]}),w&&d.jsxs("div",{className:"converter-publish",children:[d.jsx("button",{className:"converter-publish-btn",onClick:()=>{window.open(w,"_blank"),h("idle"),l(""),t(!1),j("")},disabled:!f,children:"Click to Finish Publishing →"}),d.jsxs("div",{className:"converter-url-row",children:[d.jsx("span",{className:"converter-url-label",children:"Publishing URL:"})," ",d.jsx("a",{href:w,target:"_blank",rel:"noopener noreferrer",className:"converter-url-link",children:w})]})]}),(q.length>0||$)&&d.jsxs("div",{className:"converter-warning",children:[d.jsx("strong",{children:"Webmap Checks:"}),q.length===0?d.jsx("div",{children:"No issues detected for referenced webmaps."}):d.jsxs(d.Fragment,{children:[d.jsx("ul",{children:q.map((C,L)=>{const z=Array.isArray(C.details?.failures)?C.details.failures:[],Y=new Map;for(const D of z){const ce=`${D.url??""}::${D.layerTitle??""}`;Y.has(ce)||Y.set(ce,{layerTitle:D.layerTitle,layerItemId:D.layerItemId,url:D.url,status:typeof D.status=="number"?D.status:void 0,error:typeof D.error=="string"?D.error:void 0})}const M=Array.from(Y.values()),G=M.some(D=>/HTTP URL/i.test(String(D.error||""))||/^http:\/\//i.test(String(D.url||""))),K=M.some(D=>/timeout/i.test(String(D.error||""))||typeof D.status=="number"&&D.status===504),X=M.some(D=>/not\s*found|404/i.test(String(D.error||""))||typeof D.status=="number"&&D.status===404);let W=B;if(!W||W===T){const D=typeof m=="object"&&m&&(m.orgUrl||m.org?.url)||"";if(D)try{const ce=new URL(D);W=`${ce.protocol}//${ce.hostname}`}catch{W=`https://${se()}`}else W=`https://${se()}`}const ie=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${W}/home/item.html?id=${C.itemId}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,ye=`Some services did not respond (timeout). This may be temporary. Try opening the <a href="${W}/home/item.html?id=${C.itemId}" target="_blank" rel="noopener noreferrer">web map</a> and checking that the layers load, or reload later. If timeouts persist, consider replacing the layer or contacting the service owner.`,ge=`Some services returned 404 (Not Found). Open the <a href="${W}/home/item.html?id=${C.itemId}" target="_blank" rel="noopener noreferrer">web map</a> to remove broken layers, or replace with an available service.`;return d.jsxs("li",{children:[G?d.jsxs(d.Fragment,{children:[`WARNING: Webmap [${C.itemId}] uses http services.`,C.details?.webmapTitle&&d.jsxs("div",{children:["Title: ",C.details.webmapTitle]}),d.jsx("div",{dangerouslySetInnerHTML:{__html:ie}})]}):K?d.jsxs(d.Fragment,{children:[`WARNING: Webmap [${C.itemId}] has timeout failures.`,C.details?.webmapTitle&&d.jsxs("div",{children:["Title: ",C.details.webmapTitle]}),d.jsx("div",{dangerouslySetInnerHTML:{__html:ye}})]}):X?d.jsxs(d.Fragment,{children:[`WARNING: Webmap [${C.itemId}] has missing layer(s).`,C.details?.webmapTitle&&d.jsxs("div",{children:["Title: ",C.details.webmapTitle]}),d.jsx("div",{dangerouslySetInnerHTML:{__html:ge}})]}):/^\s*(ERROR|WARNING|INFO):/i.test(C.message)?d.jsx("span",{dangerouslySetInnerHTML:{__html:C.message}}):d.jsxs(d.Fragment,{children:[C.level.toUpperCase(),": [",C.itemId,"] ",d.jsx("span",{dangerouslySetInnerHTML:{__html:C.message}})]}),M.length>0&&d.jsx("div",{children:`WARNING: Webmap [${C.itemId}] has ${M.length} failing layer(s).`}),C.details?.webmapTitle&&d.jsxs("div",{children:["Title: ",C.details.webmapTitle]}),M.length>0&&d.jsxs("div",{children:[d.jsx("button",{className:"converter-details-toggle-btn",onClick:()=>N(D=>({...D,[C.itemId]:!D[C.itemId]})),children:_[C.itemId]?"Hide details":`Show details (${M.length})`}),_[C.itemId]&&d.jsx("ul",{children:M.map((D,ce)=>d.jsxs("li",{children:[D.layerTitle?`Layer name: ${D.layerTitle}`:"",D.layerItemId?d.jsxs(d.Fragment,{children:[" ","[",d.jsx("a",{href:fe(D.layerItemId),target:"_blank",rel:"noopener noreferrer",children:D.layerItemId}),"]"," "]}):"",D.error?` — Error: ${D.error}`:"",typeof D.status=="number"?` (status ${D.status})`:"",D.url?d.jsxs(d.Fragment,{children:[" ","— ",d.jsx("a",{href:D.url,target:"_blank",rel:"noopener noreferrer",children:"Link to endpoint"})," "]}):""]},`${C.itemId}-fail-${ce}`))})]})]},`${C.itemId}-${L}`)})}),d.jsxs("span",{children:["These issues won’t stop conversion, but may prevent maps from loading. Please fix with ",d.jsx("a",{href:"https://assistant.esri-ps.com/",children:"ArcGIS Assistant"})," or in ArcGIS Online."]})]})]})]})}function fs(){const{token:f,userInfo:t}=Le(),[r,s]=E.useState({status:"idle"}),i=E.useMemo(()=>new URLSearchParams(window.location.search),[]),n=E.useMemo(()=>{try{const a=localStorage.getItem("pendingSaveCsvLayerParams");return a?JSON.parse(a):{}}catch{return{}}},[]),o=i.get("webmapId")??n.webmapId??"",m=i.get("csvItemId")??n.csvItemId??"";function v(a){if(!a)return null;const h=String(a.type||"").toLowerCase();if(["heatmap","simple","unique-value","class-breaks","dot-density","dictionary","pie-chart"].includes(h))return a;const l=a.symbol||a;String(l.type||l.style||"").toLowerCase();function b(w){if(!w)return null;const j=String(w.type||w.style||"").toLowerCase(),c={...w},p=y=>!y||Array.isArray(y)||typeof y=="string"?y:typeof y=="object"&&"r"in y&&"g"in y&&"b"in y?[y.r,y.g,y.b,"a"in y?y.a:255]:y;if(c.color&&(c.color=p(c.color)),c.outline&&(c.outline={...c.outline},c.outline.color&&(c.outline.color=p(c.outline.color))),j==="esripms"||j==="picturemarkersymbol"){c.type="picture-marker",!c.url&&c.imageData&&(c.url=`data:image/png;base64,${c.imageData}`),!c.width&&c.size&&(c.width=c.size),!c.height&&c.size&&(c.height=c.size);const y=["type","url","width","height","angle","xoffset","yoffset"];Object.keys(c).forEach(I=>{y.includes(I)||delete c[I]}),delete c.imageData}else if(j==="esrisms"||j==="simplemarkersymbol"){c.type="simple-marker";const y=["type","style","color","size","outline","angle","xoffset","yoffset"];Object.keys(c).forEach(I=>{y.includes(I)||delete c[I]})}else if(j==="esrisls"||j==="simplelinesymbol"){c.type="simple-line";const y=["type","style","color","width"];Object.keys(c).forEach(I=>{y.includes(I)||delete c[I]})}else if(j==="esrisfs"||j==="simplefillsymbol"){c.type="simple-fill";const y=["type","style","color","outline"];Object.keys(c).forEach(I=>{y.includes(I)||delete c[I]})}else return{type:"simple-marker",color:p(c.color)||"red",size:typeof c.size=="number"?c.size:12,outline:c.outline?{color:p(c.outline.color)||"white",width:1}:void 0};return c}const x=b(l);return x?{type:"simple",symbol:x}:a.visualVariables?{type:"simple",visualVariables:a.visualVariables}:null}function S(a,h=[]){if(!a)return null;const u=h.map(g=>g.name),l=g=>u.includes(g),b=l("TITLE")?"TITLE":l("Title")?"Title":"TITLE",x=l("DESCRIPTION")?"DESCRIPTION":l("Description")?"Description":"DESCRIPTION",w=l("IMAGE_URL")?"IMAGE_URL":l("Image_URL")?"Image_URL":"IMAGE_URL",j=l("IMAGE_LINK_URL")?"IMAGE_LINK_URL":l("Image_Link_URL")?"Image_Link_URL":"IMAGE_LINK_URL",c=a.title||`{${b}}`,p=a.description||`{${x}}`,y=Array.isArray(a.mediaInfos)?a.mediaInfos:[],I=[];return p&&I.push({type:"text",text:p}),y.forEach(g=>{if(String(g?.type).toLowerCase()==="image"&&g?.value){const F=g.value;I.push({type:"media",mediaInfos:[{type:"image",value:{sourceURL:F.sourceURL||`{${w}}`,linkURL:F.linkURL||`{${j}}`}}]})}}),{title:c,content:I}}return E.useEffect(()=>{async function a(){if(!(!f||!t)){if(!o||!m){s({status:"error",message:"Missing webmapId or csvItemId in query params."});return}try{s({status:"running",step:"Registering token"}),Nt.portalUrl="https://www.arcgis.com",Ct.registerToken({server:"https://www.arcgis.com/sharing/rest",token:f,expires:Date.now()+3600*1e3,ssl:!0,userId:t.username}),s({status:"running",step:"Loading webmap"});const h=new xt({portalItem:{id:o}});await h.load(),await h.when(),s({status:"running",step:"Creating CSVLayer"});const u=new jt({portalItem:{id:m}});u.visible=!0,u.title=u.title??"Converted Map Notes",u.outFields=["*"],u.url=`https://www.arcgis.com/sharing/rest/content/items/${m}/data`,await u.load(),await u.when(),s({status:"running",step:"Copying renderer/popup from Map Notes"});try{const p=`https://www.arcgis.com/sharing/rest/content/items/${o}/data?f=json&token=${encodeURIComponent(f)}`,y=await fetch(p);if(y.ok){const F=((await y.json())?.operationalLayers||[]).find(oe=>String(oe?.layerType||oe?.type||"").toLowerCase()==="mapnotes"||String(oe?.title||"").toLowerCase().includes("map notes")),re=(F?.layerDefinition||F?.featureCollection?.layers?.[0]?.layerDefinition)?.drawingInfo||F?.drawingInfo,P=F?.popupInfo;if(re?.renderer){const oe=v(re.renderer);oe&&(u.renderer=oe)}if(P){const oe=S(P,u.fields||[]);oe&&(u.popupEnabled=!0,u.popupTemplate=oe)}}}catch{}const b=(u.fields??[]).map(p=>p.name.toLowerCase()),x=p=>p.find(y=>b.includes(y)),w=x(["x","longitude","lon","long"]),j=x(["y","latitude","lat"]);w&&j?(u.longitudeField=w,u.latitudeField=j):(u.longitudeField=u.longitudeField??"X",u.latitudeField=u.latitudeField??"Y"),s({status:"running",step:"Adding layer to webmap"}),h.add(u),s({status:"running",step:"Saving webmap"});const c=await h.save({ignoreUnsupported:!0});if(c&&c.success){try{await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:f,webmapId:o,csvItemId:m,title:u.title||"Converted Map Notes",visible:!0,opacity:1,lonField:u.longitudeField||"x",latField:u.latitudeField||"y"})})}catch{}const p=`https://www.arcgis.com/sharing/rest/content/items/${o}/data?f=json&token=${encodeURIComponent(f)}`;let y=[],I={renderer:u.renderer,popupTemplate:u.popupTemplate,layerTitle:u.title};try{const g=h.layers.find(F=>F.portalItem?.id===m||F.title===u.title);g&&(I={renderer:g.renderer,popupTemplate:g.popupTemplate,layerTitle:g.title})}catch{}try{const g=await fetch(p);if(g.ok){const V=(await g.json())?.operationalLayers||[];y=V.map(A=>A?.title).filter(Boolean);const re=V.find(A=>String(A?.layerType||A?.type).toLowerCase()==="csv"&&(A?.itemId===m||String(A?.title||"")===String(u.title||"Converted Map Notes"))),oe=re?.layerDefinition?.drawingInfo||re?.drawingInfo,k=re?.popupInfo;(oe?.renderer||k)&&(I={renderer:oe?.renderer,popupTemplate:k,layerTitle:re?.title||I.layerTitle}),I.allOperationalLayers=V,I.csvOperationalLayer=re}}catch{}s({status:"success",webmapId:o,verification:{titles:y},layerSummary:I})}else throw new Error("Save did not return success.")}catch(h){try{s({status:"running",step:"Fallback: REST update"});const u=await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:f,webmapId:o,csvItemId:m,title:"Converted Map Notes",visible:!0,opacity:1,lonField:"x",latField:"y"})});let l=null,b=null;try{l=await u.json()}catch{try{b=await u.text()}catch{}}if(u.ok&&l?.success){const x=`https://www.arcgis.com/sharing/rest/content/items/${o}/data?f=json&token=${encodeURIComponent(f)}`;let w=[];try{const c=await fetch(x);c.ok&&(w=((await c.json())?.operationalLayers||[]).map(y=>y?.title).filter(Boolean))}catch{}let j={};try{const c=webmap.layers?.find(p=>p.portalItem?.id===m);c&&(j={renderer:c.renderer,popupTemplate:c.popupTemplate,layerTitle:c.title})}catch{}s({status:"success",webmapId:o,verification:{titles:w},layerSummary:j})}else throw new Error(l?.message||b||"Fallback update failed")}catch(u){const l=h?.details??{},b=l.errors?JSON.stringify(l.errors):"";s({status:"error",message:`Save failed: ${h?.message??String(h)}${b?` — ${b}`:""}. Fallback failed: ${u?.message??String(u)}`,details:l})}}}}a()},[f,t,o,m]),E.useEffect(()=>{const a=i.get("webmapId"),h=i.get("csvItemId");(a||h)&&localStorage.setItem("pendingSaveCsvLayerParams",JSON.stringify({webmapId:a,csvItemId:h}))},[i]),d.jsxs("div",{className:"page",children:[d.jsx("h2",{children:"Save CSV Layer to WebMap"}),d.jsxs("p",{children:["WebMap ID: ",d.jsx("code",{children:o||"(missing)"})]}),d.jsxs("p",{children:["CSV Item ID: ",d.jsx("code",{children:m||"(missing)"})]}),r.status==="idle"&&d.jsx("p",{children:"Waiting for authentication…"}),r.status==="running"&&d.jsxs("p",{children:["Working: ",r.step]}),r.status==="success"&&d.jsxs("p",{children:["Success! Layer added and saved to WebMap ",d.jsx("code",{children:r.webmapId}),"."]}),r.status==="success"&&r.verification&&d.jsxs("div",{children:[d.jsx("p",{children:"Operational layer titles:"}),d.jsx("ul",{children:r.verification.titles.map((a,h)=>d.jsx("li",{children:d.jsx("code",{children:a})},h))})]}),r.status==="success"&&r.layerSummary&&d.jsxs("div",{children:[d.jsx("p",{children:"CSV layer summary:"}),d.jsxs("p",{children:["Layer title: ",d.jsx("code",{children:r.layerSummary.layerTitle||"(unknown)"})]}),d.jsxs("details",{children:[d.jsx("summary",{children:"Renderer"}),d.jsx("pre",{className:"error-details",children:JSON.stringify(r.layerSummary.renderer,null,2)})]}),d.jsxs("details",{children:[d.jsx("summary",{children:"Popup Template"}),d.jsx("pre",{className:"error-details",children:JSON.stringify(r.layerSummary.popupTemplate,null,2)})]}),d.jsxs("details",{children:[d.jsx("summary",{children:"Raw CSV operationalLayer"}),d.jsx("pre",{className:"error-details",children:JSON.stringify(r.layerSummary.csvOperationalLayer,null,2)})]}),d.jsxs("details",{children:[d.jsx("summary",{children:"All operationalLayers"}),d.jsx("pre",{className:"error-details",children:JSON.stringify(r.layerSummary.allOperationalLayers,null,2)})]})]}),r.status==="error"&&d.jsxs("div",{children:[d.jsxs("p",{className:"error",children:["Error: ",r.message]}),r.details&&d.jsx("pre",{className:"error-details",children:JSON.stringify(r.details,null,2)})]})]})}function ys(){const{userInfo:f,token:t}=Le(),s=new URLSearchParams(window.location.search).get("action");return d.jsxs(d.Fragment,{children:[d.jsx("div",{className:"bg-image"}),d.jsxs("div",{className:"app-content",children:[d.jsx(Ft,{}),t&&f?s==="save-csv-layer"?d.jsx(fs,{}):d.jsx(hs,{}):d.jsx(zt,{})]})]})}It(window);St.createRoot(document.getElementById("root")).render(d.jsx(E.StrictMode,{children:d.jsx(Mt,{children:d.jsx(ys,{})})}));
