import{U as Qe,r as z,j as y,C as At,a as nt,b as rt,c as ot,d as Nt,e as kt,f as Tt,g as Lt,h as at,A as Mt,i as $t,k as Rt}from"./vendor-Hq5svIfp.js";import Et from"@arcgis/core/WebMap";import Ft from"@arcgis/core/layers/CSVLayer";import Dt from"@arcgis/core/identity/IdentityManager";import Bt from"@arcgis/core/config";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const d of n)if(d.type==="childList")for(const c of d.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(n){const d={};return n.integrity&&(d.integrity=n.integrity),n.referrerPolicy&&(d.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?d.credentials="include":n.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function i(n){if(n.ep)return;n.ep=!0;const d=s(n);fetch(n.href,d)}})();const ct="wJK4zhJHaHyFzyQ2",lt="https://regal-sable-0a6dde.netlify.app/",He="arcgis_session",et="arcgis_user_info";function Ot(I){try{const t=I.serialize();sessionStorage.setItem(He,t)}catch(t){console.warn("Could not serialize session:",t)}}function Wt(){const I=sessionStorage.getItem(He);if(I)try{return Qe.deserialize(I)}catch{sessionStorage.removeItem(He)}return null}function Ye(I){try{sessionStorage.setItem(et,JSON.stringify(I))}catch(t){console.warn("Could not persist userInfo",t)}}function Pt(){const I=sessionStorage.getItem(et);if(!I)return null;try{return JSON.parse(I)}catch{return sessionStorage.removeItem(et),null}}function Ut(){const I=window.location.hash.substring(1),t=new URLSearchParams(I),s=t.get("access_token")||t.get("token"),i=t.get("expires_in");return{token:s,expires:i?Date.now()+parseInt(i,10)*1e3:null}}async function dt(I){const s=await(await fetch(`https://www.arcgis.com/sharing/rest/community/self?f=json&token=${I}`)).json();return{username:s.username,role:s.role,userLicenseTypeId:s.userLicenseTypeId}}const wt=z.createContext({session:null,token:null,signIn:()=>{},signOut:()=>{},loading:!1,userInfo:null,setUserInfo:()=>{}}),_t=({children:I})=>{const[t,s]=z.useState(Wt()),[i,n]=z.useState(!0),[d,c]=z.useState(Pt()),[f]=z.useState(()=>new URLSearchParams(window.location.search).get("refactor")==="1");z.useEffect(()=>{const{token:o,expires:p}=Ut();if(!o){setTimeout(()=>n(!1),0);return}const u=new Qe({clientId:ct,redirectUri:lt,token:o,tokenExpires:p?new Date(p):new Date(Date.now()+1e3*60*60*24*14),portal:"https://www.arcgis.com/sharing/rest"});s(u),Ot(u);try{if(window.location.hash&&/access_token=/.test(window.location.hash)){const h=window.location.pathname+window.location.search;window.history.replaceState({},"",h)}}catch{}dt(o).then(h=>{const g=u.portal.replace(/\/$/,""),l=`${g}/community/users/${h.username}?f=json&token=${o}`,m=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${o}`;return Promise.all([fetch(l).then(v=>v.ok?v.json():Promise.reject(v.status)).catch(()=>null),fetch(m).then(v=>v.ok?v.json():Promise.reject(v.status)).catch(()=>null)]).then(([v,r])=>{const a=v?.thumbnail?`${g}/community/users/${h.username}/info/${v.thumbnail}?token=${o}`:void 0;let w;const A=r?.urlKey,j=r?.customBaseUrl;if(A&&j)w=`https://${A}.${j}`;else if(r?.portalHostname){const b=String(r.portalHostname);w=/^https?:/i.test(b)?b:`https://${b}`}const k={username:h.username,role:h.role,userType:h.userLicenseTypeId,fullName:v?.fullName||h.username,thumbnailUrl:a,orgUrl:w};c(k),Ye(k)}).catch(()=>{const v={username:h.username,role:h.role,userType:h.userLicenseTypeId};c(v),Ye(v)})}).catch(()=>c(null))},[f]),z.useEffect(()=>{if(t&&!d&&!i){const o=t.token;dt(o).then(p=>{const u=t.portal.replace(/\/$/,""),h=`${u}/community/users/${p.username}?f=json&token=${o}`,g=`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${o}`;return Promise.all([fetch(h).then(l=>l.ok?l.json():Promise.reject(l.status)).catch(()=>null),fetch(g).then(l=>l.ok?l.json():Promise.reject(l.status)).catch(()=>null)]).then(([l,m])=>{const v=l?.thumbnail?`${u}/community/users/${p.username}/info/${l.thumbnail}?token=${o}`:void 0;let r;const a=m?.urlKey,w=m?.customBaseUrl;if(a&&w)r=`https://${a}.${w}`;else if(m?.portalHostname){const j=String(m.portalHostname);r=/^https?:/i.test(j)?j:`https://${j}`}const A={username:p.username,role:p.role,userType:p.userLicenseTypeId,fullName:l?.fullName||p.username,thumbnailUrl:v,orgUrl:r};c(A),Ye(A)})}).catch(()=>{})}},[t,d,i]),z.useEffect(()=>{t&&console.log("Session token (updated):",t.token)},[t]);const S=()=>{Qe.beginOAuth2({clientId:ct,redirectUri:lt,responseType:"token",popup:!1})},C=()=>{t&&(s(null),sessionStorage.removeItem(He))};return y.jsx(wt.Provider,{value:{session:t,token:t?.token??null,signIn:S,signOut:C,loading:i,userInfo:d,setUserInfo:c},children:I})},Pe=()=>z.useContext(wt),zt="0.4.5-alpha";function Jt(){const{userInfo:I,token:t,signIn:s,signOut:i}=Pe(),[n,d]=z.useState(!1),c=z.useRef(null);z.useEffect(()=>{function u(g){n&&c.current&&!c.current.contains(g.target)&&d(!1)}function h(g){g.key==="Escape"&&d(!1)}return document.addEventListener("mousedown",u),document.addEventListener("keydown",h),()=>{document.removeEventListener("mousedown",u),document.removeEventListener("keydown",h)}},[n]);const f=!!t&&!!I,S=I?.username?.charAt(0).toUpperCase()||"?",C=I?.username?`https://www.arcgis.com/home/user.html?user=${I.username}`:void 0,o=I?.thumbnailUrl||null,p=I?.fullName||I?.username||"";return y.jsx("header",{className:"top-nav",children:y.jsxs("div",{className:"top-nav-inner",children:[y.jsxs("div",{className:"top-nav-titles",children:[y.jsx("div",{className:"top-nav-title",children:"Classic StoryMap Converter"}),y.jsxs("div",{className:"top-nav-subtitle",children:["Alpha | v",zt]})]}),y.jsx("nav",{className:"top-nav-list","aria-label":"Main navigation"}),y.jsxs("div",{className:"top-nav-actions",children:[!f&&y.jsx("button",{className:"account-btn",onClick:s,"data-testid":"sign-in-btn",children:"Sign In"}),f&&y.jsxs("div",{className:"account-control",ref:c,children:[y.jsxs("button",{type:"button",className:"account-trigger","aria-haspopup":"true","aria-label":"Account menu",onClick:()=>d(u=>!u),children:[y.jsx("svg",{className:"account-trigger-icon",width:"18",height:"18",viewBox:"0 0 24 24","aria-hidden":"true",children:y.jsx("path",{fill:"currentColor",d:"M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v2h20v-2c0-3.3-6.7-5-10-5z"})}),y.jsx("svg",{className:"account-caret",width:"12",height:"12",viewBox:"0 0 24 24","aria-hidden":"true",children:y.jsx("path",{fill:"currentColor",d:"M7 10l5 5 5-5z"})})]}),n&&y.jsxs("div",{className:"account-menu",role:"group","aria-label":"Account menu",children:[y.jsxs("div",{className:"account-menu-header",children:[o?y.jsx("img",{src:o,alt:"","aria-hidden":"true",className:"account-menu-avatar"}):y.jsx("span",{className:"account-menu-avatar fallback","aria-hidden":"true",children:S}),y.jsxs("div",{className:"account-menu-names",children:[y.jsx("div",{className:"account-full-name",children:p||I?.username||"Loading…"}),y.jsx("div",{className:"account-username-sub",children:I?.username})]})]}),y.jsx("div",{className:"account-menu-divider"}),C&&y.jsx("a",{href:C,target:"_blank",rel:"noopener",className:"account-menu-item",children:"View Profile"}),y.jsx("button",{className:"account-menu-item",onClick:()=>{d(!1),i()},children:"Sign Out"})]})]})]})]})})}function Vt({open:I,onCancel:t,onContinue:s}){const[i,n]=z.useState(""),[d,c]=z.useState(""),[f,S]=z.useState(!1),C=z.useRef(null);z.useEffect(()=>{I&&setTimeout(()=>{S(!1),C.current?.focus()},0)},[I,S]);const o=u=>{if(!u)return!1;try{const h=new URL(u);return!!h.protocol&&!!h.host}catch{return!1}},p=()=>{const u=o(i);S(!u),u&&s(i.trim(),d.trim()||void 0)};return y.jsxs(At,{open:I,heading:"Sign in to ArcGIS Enterprise",onCalciteDialogClose:t,children:[y.jsxs("div",{children:[y.jsxs(nt,{children:["URL",y.jsx(rt,{ref:C,required:!0,id:"enterprise_portal_url",name:"enterprise_portal_url",placeholder:"e.g. https://myportal.mydomain.com/portal",type:"text",value:i,onCalciteInputChange:u=>{const h=u?.target?.value??"";n(h)}}),y.jsx(ot,{status:f?"invalid":void 0,children:"Enter a valid organization url"})]}),y.jsxs(Nt,{layout:"inline",children:[y.jsx(kt,{slot:"tab-nav",children:y.jsx(Tt,{children:"OAuth Login"})}),y.jsx(Lt,{style:{width:"100%",marginTop:"1rem"},children:y.jsxs(nt,{children:["App ID",y.jsx(rt,{id:"enterprise_client_id",name:"app_client_id",placeholder:"e.g. aBcDeFgHi1j2K3L4",type:"text",value:d,onCalciteInputChange:u=>{const h=u?.target?.value??"";c(h)}}),y.jsx(ot,{status:"invalid",children:"Enter a valid registered App ID"})]})})]}),y.jsxs("details",{className:"enterprise-details",children:[y.jsx("summary",{children:"More Details"}),y.jsxs("p",{className:"enterprise-details-text",children:["In order to log in to a Portal for ArcGIS instance using a SAML-based Identity Provider, you will need to Register the Classic StoryMap Converter as an application in your Portal, and generate an AppID that can identify this app as an allowed client of the Portal. To do so, follow the instructions "," ",y.jsx("a",{href:"https://enterprise.arcgis.com/en/portal/latest/use/add-app-url.htm#REG_APP",target:"_blank",rel:"noopener",children:"here"}),", using ",y.jsx("strong",{children:"Other Application"})," as the ",y.jsx("em",{children:"Type of App"})," and",y.jsx("code",{className:"enterprise-details-code",children:"https://url-for-this-app.com/"}),"as the Redirect URI."]})]})]}),y.jsxs("div",{slot:"footer",children:[y.jsx(at,{color:"blue",onClick:p,children:"Continue"}),y.jsx(at,{appearance:"outline",color:"blue",onClick:t,children:"Cancel"})]})]})}const Ht="/assets/storymap-map-tour-CbGOcXZK.png",Gt="/assets/storymap-map-journal-B6_zTpqe.png",qt="/assets/storymap-series-tabbed-I93IZkLj.png",Kt="/assets/storymap-cascade-Dxb7EL3J.png",Yt="/assets/storymap-shortlist-C-e80pOE.png",Xt="/assets/storymap-crowdsource-CiU2l24Z.png",Zt={mapTour:!1,mapJournal:!0,mapSeries:!1,cascade:!1,shortlist:!1,crowdsource:!1,swipe:!0,basic:!1};function Qt(I){const t=(I||"").toLowerCase(),s=t==="map journal"||t==="mapjournal"?"mapJournal":t==="map tour"||t==="maptour"?"mapTour":t==="map series"||t==="series"?"mapSeries":t==="cascade"?"cascade":t==="shortlist"?"shortlist":t==="crowdsource"?"crowdsource":t==="swipe"?"swipe":t==="basic"?"basic":"";return!!(s&&Zt[s])}const es="/assets/storymap-swipe-DCnpLp2Y.png",ts="/assets/storymap-basic-DyApzf39.png",ss=[{key:"mapTour",title:"Map Tour",description:"Presented a sequential, place-based narrative with geotagged photos linked to an interactive map.",image:Ht,status:"disabled",alt:"Map Tour Thumbnail"},{key:"mapJournal",title:"Map Journal",description:"Presented a compelling map-based narrative presented as a set of journal entries.",image:Gt,status:"active",alt:"Map Journal Thumbnail"},{key:"mapSeries",title:"Map Series",description:"Presented a series of maps via a set of tabs, bullets or expanding side panel.",image:qt,status:"disabled",alt:"Map Series - Tabbed Thumbnail"},{key:"cascade",title:"Cascade",description:"Combined text with maps, images, and multimedia in an engaging, full-screen scrolling experience.",image:Kt,status:"disabled",alt:"Cascade Thumbnail"},{key:"shortlist",title:"Shortlist",description:"Presented a set of places organized into a set of tabs based on themes.",image:Yt,status:"disabled",alt:"Shortlist Thumbnail"},{key:"crowdsource",title:"Crowdsource",description:"Displayed crowdsourced photos with captions. The conversion will be view-only.",image:Xt,status:"disabled",alt:"Crowdsource Thumbnail"},{key:"swipe",title:"Swipe",description:"Displayed two layers or two maps side by side for comparison.",image:es,status:"active",alt:"Swipe Thumbnail"},{key:"basic",title:"Basic",description:"Presented a map via a minimalist interface. Converted to an ArcGIS Instant App.",image:ts,status:"disabled",alt:"Story Map Basic Thumbnail"}],is=()=>{const{signIn:I}=Pe(),[t,s]=z.useState(!1);return y.jsxs(y.Fragment,{children:[y.jsxs("div",{id:"splashContainer",className:"splash-container",children:[y.jsxs("div",{className:"jumbotron",children:[y.jsx("h2",{children:"Classic StoryMap Converter"}),y.jsx("p",{className:"lead",children:"Convert Classic Esri Story Maps to ArcGIS StoryMaps"}),y.jsx("div",{className:"loginButtons",children:y.jsxs("p",{children:[y.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-success login-btn",onClick:I,children:"Log in to ArcGIS Online"}),y.jsx("button",{type:"button",className:"btn btn-lg btn-block btn-default",onClick:()=>s(!0),children:"Log in to Portal for ArcGIS"})]})})]}),y.jsx("div",{className:"row marketing marketing-row",children:ss.map(i=>{const n=i.status!=="active";return y.jsxs("div",{className:`marketing-col${n?" disabled":""}`,"data-disabled":n?"true":"false",children:[y.jsx("h4",{children:i.title}),y.jsxs("div",{className:"marketing-img-container",children:[y.jsx("img",{src:i.image,alt:i.alt,className:"marketing-img"}),n&&y.jsx("div",{className:"disabled-overlay",children:"Coming Soon"})]}),y.jsx("p",{children:i.description})]},i.key)})})]}),y.jsx(Vt,{open:t,onCancel:()=>s(!1),onContinue:(i,n)=>{s(!1),console.info("[EnterpriseSignInModal] continue",{url:i,appId:n})}})]})},Fe=new Map,tt=new Set;function vt(){const I=Fe.size;for(const t of Array.from(tt))try{t(I)}catch{}}async function Le(I,t,s){const i=Date.now(),n=Fe.get(I);if(n){if(!n.expiresAt||n.expiresAt>i)return n.data;Fe.delete(I)}const d=await fetch(I,t);if(!d.ok)throw new Error(`Fetch failed ${d.status}: ${I}`);const c=await d.json(),f=i+s;return Fe.set(I,{data:c,expiresAt:f}),vt(),c}function ns(I){Fe.clear(),vt()}function pt(){return Fe.size}function rs(I){tt.add(I)}function os(I){tt.delete(I)}async function mt(I){const t=await fetch(I);if(!t.ok)throw new Error(`Fetch failed: ${t.status} ${t.statusText}`);return t.json()}async function as(I,t){const s=[],i=[],n=Array.from(new Set(I.filter(c=>/^[a-f0-9]{32}$/i.test(c))));for(const c of n)try{const f=`https://www.arcgis.com/sharing/rest/content/items/${c}`,S=`${f}/data?f=json${t?`&token=${encodeURIComponent(t)}`:""}`,C=`${f}?f=json${t?`&token=${encodeURIComponent(t)}`:""}`,[o,p]=await Promise.all([mt(S).catch(()=>null),mt(C).catch(()=>null)]);if(!p){s.push({itemId:c,level:"error",message:"Webmap item not accessible (404 or permission). Please verify the item exists and you have access."});continue}const u=p?.title||p?.name||"",h=[],g=o&&(o.version||o.itemVersion)||p&&(p.itemVersion||p.version);if(g&&typeof g=="string"){const a=parseFloat(g);if(!Number.isNaN(a)&&a<2){const w=`https://www.arcgis.com/home/webmap/viewer.html?webmap=${c}`;s.push({itemId:c,level:"warning",message:`Webmap version ${g} < 2.0. Open in <a href="${w}" target="_blank" rel="noopener noreferrer">Classic Map Viewer</a> and save to upgrade.`})}}const l=o?.operationalLayers||[],m=o?.baseMap?.baseMapLayers||[],v=[];for(const a of l)a?.url&&v.push({url:a.url,title:a.title,layerItemId:a.itemId,layerTitle:a.title});for(const a of m)a?.url&&v.push({url:a.url,title:a.title});const r=a=>{try{const w=new URL(a),A=w.hostname.toLowerCase(),j=w.pathname.toLowerCase();if(A.endsWith("services.arcgisonline.com"))return/(mapserver|featureserver)/i.test(j)}catch{}return!1};for(const{url:a,title:w,layerItemId:A,layerTitle:j}of v){/^http:\/\//i.test(a)&&(h.push({url:a,error:"HTTP URL (use HTTPS)",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:a,ok:!1,errorCategory:"mixed-content",errorMessage:"HTTP URL (use HTTPS)"}),typeof window<"u"&&window.location?.protocol==="https:"&&(h.push({url:a,error:"Mixed content risk on HTTPS",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:a,ok:!1,errorCategory:"mixed-content",errorMessage:"Mixed content risk on HTTPS"})));const k=typeof window<"u"&&window.location?.hostname?/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname):!1,b=a.split("?")[0],L=`${b}${b.includes("?")?"":"?"}${b.includes("?")?"&":""}f=pjson`,O=/(FeatureServer|MapServer)\/\d+$/i.test(b)?b.replace(/\/(FeatureServer|MapServer)\/\d+$/i,"/$1"):b,J=`${O}${O.includes("?")?"":"?"}${O.includes("?")?"&":""}f=pjson`,T=B=>`/.netlify/functions/proxy-feature?url=${encodeURIComponent(B)}`,x=k?T(L):L,U=k?T(J):J,X=async B=>{for(let _=0;_<2;_++)try{const F=await fetch(B,{method:"GET"});if(!F.ok)return{ok:!1,resp:F,json:null};const de=F.headers.get("content-type")||"",Ie=/application\/(?:json|pjson)/i.test(de)?await F.clone().json().catch(()=>null):null;return{ok:!0,resp:F,json:Ie}}catch{if(_===1)return{ok:!1,resp:void 0,json:null};await new Promise(F=>setTimeout(F,150))}return{ok:!1,resp:void 0,json:null}},R=await X(x),V=await X(U),W=!!R.resp&&R.resp.ok,we=!!V.resp&&V.resp.ok,M=W&&!!R.json&&!R.json?.error,$=we&&!!V.json&&!V.json?.error;if(R.ok&&R.json){const B=R.json?.error?.message||R.json?.message||"",_=/token/i.test(B)||R.json?.error?.code===499,F=/permission|privilege|authorized|do not have permissions|not permitted/i.test(B)||R.json?.error?.code===403;_&&h.push({url:a,status:R.resp?.status,error:"Token required",title:w,layerItemId:A,layerTitle:j}),F&&h.push({url:a,status:R.resp?.status,error:"Permissions denied or item private",title:w,layerItemId:A,layerTitle:j});const de=typeof R.json?.type=="string"||typeof R.json?.geometryType=="string"||Array.isArray(R.json?.fields)||Array.isArray(R.json?.layers),pe=!!R.json?.error;!de&&!pe&&!$&&h.push({url:a,status:R.resp?.status,error:"Invalid layer definition",title:w,layerItemId:A,layerTitle:j}),pe&&h.push({url:a,status:R.resp?.status,error:"Layer error JSON",title:w,layerItemId:A,layerTitle:j});const Ie=R.resp?.headers?.get("content-type")||"";/application\/(?:json|pjson)/i.test(Ie)||(h.push({url:a,status:R.resp?.status,error:"Non-JSON response",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:a,status:R.resp?.status,ok:!1,errorCategory:"non-json",errorMessage:"Non-JSON response"})),R.json||(h.push({url:a,status:R.resp?.status,error:"JSON parse failed",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:a,status:R.resp?.status,ok:!1,errorCategory:"json-error",errorMessage:"JSON parse failed"}))}if(!M&&!r(b)){const B=R.resp?.status,_=R.json?.error?R.json.error.message||"Layer error JSON":void 0;h.push({url:a,status:B,error:_||"Layer endpoint not healthy",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:a,status:B,ok:!1,errorCategory:_?"json-error":"other",errorMessage:_||"Layer endpoint not healthy"})}if(V.ok&&V.json?.error){const B=V.json?.error?.message||V.json?.message||"",_=/permission|privilege|authorized|do not have permissions|not permitted/i.test(B)||V.json?.error?.code===403;h.push({url:O,status:V.resp?.status,error:_?"Service permissions denied or item private":"Service error JSON",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:O,status:V.resp?.status,ok:!1,errorCategory:_?"permission-denied":"json-error",errorMessage:_?"Service permissions denied or item private":"Service error JSON"})}if(!W&&!r(b)&&(h.push({url:a,status:R.resp?.status,error:"Layer HTTP failure",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:a,status:R.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Layer HTTP failure"})),!we&&!r(O)&&(h.push({url:O,status:V.resp?.status,error:"Service HTTP failure",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:O,status:V.resp?.status,ok:!1,errorCategory:"http-failure",errorMessage:"Service HTTP failure"})),V.ok&&V.json&&!V.json.error){const B=V.json,_=typeof B.currentVersion=="number"||typeof B.currentVersion=="string",F=typeof B.capabilities=="string"||Array.isArray(B.capabilities);(!_||!F)&&(h.push({url:O,status:V.resp?.status,error:"Service missing capabilities/version",title:w,layerItemId:A,layerTitle:j}),i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:O,status:V.resp?.status,ok:!1,errorCategory:"other",errorMessage:"Service missing capabilities/version"}))}M&&i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:a,status:R.resp?.status,ok:!0,errorCategory:"ok"}),$&&i.push({webmapId:c,webmapTitle:u,layerTitle:j,layerItemId:A,url:O,status:V.resp?.status,ok:!0,errorCategory:"ok"})}for(const a of l)if(a?.itemId&&/^[a-f0-9]{32}$/i.test(a.itemId)){const w=`https://www.arcgis.com/sharing/rest/content/items/${a.itemId}?f=json${t?`&token=${encodeURIComponent(t)}`:""}`;try{const A=await fetch(w);if(A.ok){const j=await A.json();if(j.error){const k=j.error?.code,b=j.error?.message||"",L=k===403||/permission|privilege|authorized|not permitted/i.test(b);h.push({url:w,status:A.status,error:L?"Layer item private or permission denied":"Layer item error JSON",title:a.title,layerItemId:a.itemId,layerTitle:a.title})}}else{const j=A.status,k=j===404?"Layer item deleted":j===403?"Layer item private or permission denied":"Layer item not accessible";h.push({url:w,status:j,error:k,title:a.title,layerItemId:a.itemId,layerTitle:a.title})}}catch{h.push({url:w,error:"Layer item unreachable",title:a.title,layerItemId:a.itemId,layerTitle:a.title})}}h.length&&s.push({itemId:c,level:"warning",message:`Webmap ${u?'"'+u+'" ':""}has ${h.length} failing endpoint(s).`,details:{webmapTitle:u,failures:h}})}catch{s.push({itemId:c,level:"warning",message:"Failed to validate webmap. Proceeding, but please check the item manually."})}const d={};for(const c of i){const f=c.errorCategory||(c.ok?"ok":"other");d[f]=(d[f]||0)+1}return{warnings:s,endpointChecks:i,endpointCategorySummary:d}}function We(I){const t=m=>!!m&&typeof m=="object";if(!t(I))return"unknown";const s=I.values||{},i=(m,v)=>t(m)?m[v]??void 0:void 0,n=i(s,"settings")??{},d=i(s,"story"),c=d&&Array.isArray(d.sections)?d.sections:void 0;if(c&&c.length)return"Map Journal";let f;const S=i(s,"templateName");typeof S=="string"&&S.trim()&&(f=S);const C=i(s,"template");typeof C=="string"&&C.trim()&&(f=C);const o=i(s,"template"),p=o&&typeof o.name=="string"?o.name:void 0;if(p&&(f=p),f&&/\bswipe\b/i.test(f))return"Swipe";if(f)return cs(f);if(!f&&n&&t(n)&&t(n.components))return"Crowdsource";const u=i(s,"series");if(Array.isArray(u))return"Map Series";const h=i(s,"tabs")??i(s,"tabs");if(Array.isArray(h)||h)return"Shortlist";const g=i(s,"order");if(Array.isArray(g))return"Map Tour";if(i(s,"dataModel")||i(s,"layers")||i(s,"webmaps"))return"Swipe";const l=i(s,"components");return l&&t(l)&&l.contribute?"Crowdsource":c?c.some(m=>t(m)&&m.type==="sequence")?"Cascade":"Map Journal":"Basic"}function cs(I){const t=I.toLowerCase();return t.includes("journal")?"Map Journal":t.includes("tour")?"Map Tour":t.includes("series")?"Map Series":t.includes("cascade")?"Cascade":t.includes("shortlist")?"Shortlist":t.includes("swipe")?"Swipe":t.includes("crowdsource")?"Crowdsource":t.includes("basic")?"Basic":I}function Ve(){throw new Error("execSync is not available in the browser environment")}function Xe(){throw new Error("execFileSync is not available in the browser environment")}const ls={};class xt{constructor(t){this.classicJson=t.classicJson,this.themeId=t.themeId,this.progress=t.progress,this.storyId=t.storyId,this.username=t.username,this.token=t.token,this.uploader=t.uploader,this.inlineUpload=t.inlineUpload}emit(t){this.progress({stage:"convert",message:t})}convert(){this.emit("Beginning conversion"),this.extractStructure(),this.convertContent(),this.applyTheme();const t=this.collectMedia();return{storymapJson:this.getStoryMapJson(),mediaUrls:t}}}function fe(I){const t=Math.abs(I.ymax-I.ymin);return t<=500?{scale:500,zoom:20}:t<=1e3?{scale:1e3,zoom:19}:t<=5e3?{scale:5e3,zoom:17}:t<=1e4?{scale:1e4,zoom:16}:t<=5e4?{scale:5e4,zoom:14}:t<=1e5?{scale:1e5,zoom:13}:t<=5e5?{scale:5e5,zoom:11}:t<=1e6?{scale:1e6,zoom:10}:t<=5e6?{scale:5e6,zoom:8}:t<=1e7?{scale:1e7,zoom:7}:{scale:25e6,zoom:6}}const ut={variables:{headerFooterBackgroundColor:"#ffffff",backgroundColor:"#ffffff",titleFontId:"avenirNext",titleColor:"#002625",titleColorDark:"#002625",titleColorLight:"#ffffff",bodyFontId:"notoSerif",bodyColor:"#304e4e",bodyColorDark:"#002625",bodyColorLight:"#ffffff",bodyMutedColor:"#3d6665",themeColor1:"#087f9b",themeColor2:"#fc3b36",themeColor3:"#126057",borderRadius:0,shape:"hexagon",colorRamps:["seq-single-blues","seq-multi-ylgn","seq-orange-red-light","seq-yellow-darkblue-bright-reversed"],basemapPrimary:"humanGeographyLight",basemapAlt:"lightGrayCanvas",basemapImagery:"worldImagery"}},ft={variables:{headerFooterBackgroundColor:"#000000",backgroundColor:"#0e1116",titleFontId:"charterBT",titleColor:"#f3f3f3",titleColorDark:"#0E1116",titleColorLight:"#f3f3f3",bodyFontId:"arial",bodyColor:"#e6f2f2",bodyColorDark:"#0E1116",bodyColorLight:"#E6F2F2",bodyMutedColor:"#809e9d",themeColor1:"#ea5b41",themeColor2:"#4d6aff",themeColor3:"#0ec2db",borderRadius:9999,colorRamps:["seq-blue-bright-5","seq-yellow-bright-3","seq-green-bright-3","seq-red-bright-4"],basemapPrimary:"darkGrayCanvas",basemapAlt:"humanGeographyDark",basemapImagery:"worldImagery"}};function ht(I,t){if(!I||!I.includes("font-family"))return t;let s=I;const i=/font-family:\s*'([^']+)'/.exec(I)||/font-family:\s*"([^"]+)"/.exec(I);if(i)s=i[1];else{const c=/font-family:\s*([^;]+);?/.exec(I);c&&(s=c[1].split(",")[0].trim().replace(/["']/g,""))}const n=s.toLowerCase().replace(/\s+/g,"");return{open_sansregular:"openSans",opensans:"openSans",roboto:"roboto",noto:"notoSerif",notoserif:"notoSerif",lato:"lato",sourcesanspro:"sourceSansPro",avenirnext:"avenirNext",charterbt:"charterBT",arial:"arial"}[n]||t}function ds(I){const t=I.values||{},i=(t.settings||{}).theme||{},n=i.colors||{},d=i.fonts||{},c=(t.title||"").trim()+" (Theme)",S=(n.themeMajor||"").toLowerCase()==="black"?"obsidian":"summit",o={...(S==="obsidian"?ft:ut).variables},p=S==="obsidian"?ft.variables:ut.variables;for(const[w,A]of Object.entries(p))w in o||(o[w]=A);const u=[];let h;n.panel&&(o.backgroundColor=n.panel,u.push("backgroundColor")),n.dotNav&&(o.headerFooterBackgroundColor=n.dotNav,u.push("headerFooterBackgroundColor")),n.text&&(o.bodyColor=n.text,u.push("bodyColor"),h="text"),!o.bodyColorDark&&p.bodyColorDark&&(o.bodyColorDark=p.bodyColorDark),!o.bodyColorLight&&p.bodyColorLight&&(o.bodyColorLight=p.bodyColorLight),!o.titleColorDark&&p.titleColorDark&&(o.titleColorDark=p.titleColorDark),!o.titleColorLight&&p.titleColorLight&&(o.titleColorLight=p.titleColorLight),n.textLink&&(o.themeColor1=n.textLink,u.push("themeColor1")),!n.text&&n.textLink&&(o.bodyColor=n.textLink,u.push("bodyColor"),h="textLink"),n.softText&&(o.bodyMutedColor=n.softText,u.push("bodyMutedColor")),!o.colorRamps&&p.colorRamps&&(o.colorRamps=p.colorRamps),!o.basemapPrimary&&p.basemapPrimary&&(o.basemapPrimary=p.basemapPrimary),!o.basemapAlt&&p.basemapAlt&&(o.basemapAlt=p.basemapAlt),!o.basemapImagery&&p.basemapImagery&&(o.basemapImagery=p.basemapImagery),S==="summit"&&!o.shape&&p.shape&&(o.shape=p.shape);const g=d.sectionTitle?.value,l=d.sectionContent?.value,m=ht(g,o.titleFontId),v=ht(l,o.bodyFontId);m&&m!==o.titleFontId&&(o.titleFontId=m,u.push("titleFontId")),v&&v!==o.bodyFontId&&(o.bodyFontId=v,u.push("bodyFontId"));const r={title:c,baseThemeId:S,isFromOrgTheme:!1,variables:o,resources:{}},a={baseThemeId:S,colorMappings:{panelToBackgroundColor:n.panel,dotNavToHeaderFooterBackgroundColor:n.dotNav,textToBodyColor:n.text,textLinkToBodyColor:n.text?void 0:n.textLink,textLinkToThemeColor1:n.textLink,softTextToBodyMutedColor:n.softText,chosenBodyColorSource:h},fontMappings:{classicTitleFontValue:g,mappedTitleFontId:m,classicBodyFontValue:l,mappedBodyFontId:v},variableOverridesApplied:u};return{theme:r,decisions:a}}const ps="arcgis-storymaps-classic-converter",ms="0.4.5-alpha",us="module",fs={dev:"vite",build:"vite build",typecheck:"tsc -b",lint:"eslint .",preview:"vite preview","netlify:dev":"netlify dev"},hs={"@esri/arcgis-rest-auth":"^3.8.0","@esri/calcite-components":"^3.3.3","@esri/calcite-components-react":"^3.3.3","@arcgis/core":"^4.30.6","@netlify/functions":"^5.1.0",react:"^19.2.0","react-dom":"^19.2.0",tsx:"^4.20.6"},ys={"@eslint/js":"^9.39.1","@netlify/vite-plugin":"^2.7.14","@types/node":"^24.10.0","@types/react":"^19.2.2","@types/react-dom":"^19.2.2","@vitejs/plugin-react":"^5.1.0",eslint:"^9.39.1","eslint-plugin-react-hooks":"^7.0.1","eslint-plugin-react-refresh":"^0.4.24",globals:"^16.5.0","image-size":"^2.0.2","ts-node":"^10.9.2",typescript:"~5.9.3","typescript-eslint":"^8.46.3",vite:"^7.2.2"},gs={name:ps,private:!0,version:ms,type:us,scripts:fs,dependencies:hs,devDependencies:ys};function yt(){try{const I=gs?.version;if(typeof I=="string"&&I.length)return I}catch{}try{const I=typeof import.meta<"u"?import.meta:void 0,t=I?.env?.VITE_APP_VERSION||I?.env?.APP_VERSION||"";if(typeof t=="string"&&t.length)return t}catch{}try{const I=typeof process<"u"?process:void 0,t=I?.env?.npm_package_version||I?.env?.APP_VERSION||"";if(typeof t=="string"&&t.length)return t}catch{}return"0.0.0"}class St{constructor(t){this.themeResourceId=this.generateResourceId(),this.json={root:"",nodes:{},resources:{[this.themeResourceId]:{type:"story-theme",data:{themeId:t,themeBaseVariableOverrides:{}}}},actions:[]}}createStoryRoot(){const t=this.generateNodeId();return this.json.root=t,this.json.nodes[t]={type:"story",data:{storyTheme:this.themeResourceId},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[]},t}addNode(t,s,i,n){const d=this.generateNodeId(),c={type:t};return s&&(c.data=s),i&&(c.config=i),n&&(c.children=n),this.json.nodes[d]=c,d}applyTheme(t){const s=this.json.resources[this.themeResourceId];s&&s.type==="story-theme"&&(s.data.themeId=t.themeId,t.variableOverrides&&Object.keys(t.variableOverrides).length&&(s.data.themeBaseVariableOverrides=t.variableOverrides))}addImageResource(t,s,i){const n=this.generateResourceId();return this.json.resources[n]={type:"image",data:{src:t,provider:"uri",width:s,height:i}},n}finalizeImageResourceAsItem(t,s,i,n){const d=this.json.resources[t];!d||d.type!=="image"||(delete d.data.src,d.data.resourceId=s,d.data.provider="item-resource",i&&(d.data.width=i),n&&(d.data.height=n))}addVideoResource(t,s="uri",i){const n=i??this.generateResourceId();return this.json.resources[n]={type:"video",data:{src:t,provider:s}},n}addTextBlock(t,s,i){const n=this.generateNodeId(),c={type:"text",data:{text:s,type:i==="bullet-list"?"paragraph":i}};return this.json.nodes[n]=c,this.appendChild(t,n),n}addImageNode(t,s,i,n,d="standard"){const c=this.generateNodeId(),f={type:"image",data:{image:s,caption:i,alt:n},config:{size:d}};return this.json.nodes[c]=f,this.appendChild(t,c),c}addRichTextToRoot(t,s="paragraph",i="wide"){if(!this.json.root)return this.createRichTextNode(t,s,i);const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:t,type:s,preserveHtml:!0,textAlignment:"start"},config:{size:i}},this.appendChild(this.json.root,n),n}addVideoNode(t,s){const i=this.generateNodeId(),n={type:"video",data:{src:s.src,resourceId:s.resourceId,provider:s.provider,caption:s.caption,alt:s.alt}};return this.json.nodes[i]=n,this.appendChild(t,i),i}addWebMapResource(t,s="Web Map",i,n="minimal"){const d=`r-${t}`,c={type:n,itemId:t,itemType:s};if(!this.json.resources[d])this.json.resources[d]={type:"webmap",data:c};else{const f=this.json.resources[d];f&&f.type==="webmap"&&(f.data=f.data||{},f.data.type=n,f.data.itemId=t,f.data.itemType=s,f.data.initialState&&delete f.data.initialState,this.json.resources[d]=f)}return i&&this.updateWebMapInitialState(d,i),d}addWebMapNode(t,s,i){const n=this.generateNodeId(),d={type:"webmap",data:{map:s,caption:i}};return this.json.nodes[n]=d,this.appendChild(t,n),n}updateWebMapInitialState(t,s){const i=this.json.resources[t];if(!i||i.type!=="webmap")return;i.data=i.data||{};const n={...i.data,...s};delete n.initialState,i.data=n,this.json.resources[t]=i}updateWebMapData(t,s){const i=this.json.resources[t];!i||i.type!=="webmap"||(i.data=i.data||{},i.data={...i.data,...s},i.data.initialState&&delete i.data.initialState,this.json.resources[t]=i)}addCoverNode(t,s,i){const n=this.generateNodeId();return this.json.nodes[n]={type:"storycover",data:{type:"minimal",title:t,summary:s||"",byline:i||"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},this.json.root&&this.json.nodes[this.json.root]&&this.appendChild(this.json.root,n),n}addNavigationHidden(){const t=this.generateNodeId();return this.json.nodes[t]={type:"navigation",data:{links:[]},config:{isHidden:!0}},this.json.root&&this.appendChild(this.json.root,t),t}addCreditsNode(){const t=this.generateNodeId(),s=this.generateNodeId();this.json.nodes[s]={type:"attribution",data:{content:"",attribution:""}};const i=this.generateNodeId();this.json.nodes[i]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}};const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:"",type:"paragraph",textAlignment:"start"},config:{size:"wide"}},this.json.nodes[t]={type:"credits",children:[i,n,s]},this.json.root&&this.appendChild(this.json.root,t),t}addSidecar(t="docked-panel",s="end",i="medium"){const n=this.generateNodeId(),d=this.generateNodeId(),c=this.generateNodeId();this.json.nodes[n]={type:"immersive",data:{type:"sidecar",subtype:t,narrativePanelPosition:s,narrativePanelSize:i},children:[d]},this.json.nodes[d]={type:"immersive-slide",data:{transition:"fade"},children:[c]},this.json.nodes[c]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[]};const f=this.json.nodes[this.json.root];if(f?.children){const S=f.children.findIndex(C=>this.json.nodes[C]?.type==="credits");S>-1?f.children.splice(S,0,n):f.children.push(n)}return{immersiveId:n,slideId:d,narrativeId:c}}addSection(t,s,i){const n=this.generateNodeId();if(this.json.nodes[n]={type:"slide",children:[]},this.appendChild(t,n),s&&this.addTextBlock(n,s,"h2"),i){const d=i.replace(/<[^>]+>/g,"").trim();d&&this.addTextBlock(n,d,"paragraph")}return n}appendChild(t,s){const i=this.json.nodes[t];i&&(i.children||(i.children=[]),i.children.push(s))}getJson(){for(const d of Object.values(this.json.nodes))d&&(d.type==="webmap"?(d.config?"size"in d.config||(d.config.size="standard"):d.config={size:"standard"},d.data&&"scale"in d.data&&delete d.data.scale):d.type==="text"&&d.data&&!("textAlignment"in d.data)&&(d.data.textAlignment="start"));if(this.json.root){const d=this.json.nodes[this.json.root];d?.type==="story"&&d.data&&"metaSettings"in d.data&&delete d.data.metaSettings}const t={};for(const[d,c]of Object.entries(this.json.nodes))d!==this.json.root&&(t[d]=c);this.json.root&&(t[this.json.root]=this.json.nodes[this.json.root]);const{root:s,resources:i,actions:n}=this.json;return{root:s,nodes:t,resources:i,actions:n}}updateNodeData(t,s){const i=this.json.nodes[t];i&&(i.data||(i.data={}),s(i.data,i))}updateNode(t,s){const i=this.json.nodes[t];i&&s(i)}removeNode(t){const s=this.json.nodes;if(!(!s||!s[t])){for(const i of Object.values(s))if(i?.children&&Array.isArray(i.children)){const n=i.children.indexOf(t);n>-1&&i.children.splice(n,1)}delete s[t]}}setStoryMeta(t,s,i){if(!this.json.root)return;const n=this.json.nodes[this.json.root];!n||n.type!=="story"||(n.data||(n.data={}),n.data.metaSettings={title:t,description:s||"",imageResourceId:i})}addConverterMetadata(t,s){let i="";try{const S=typeof import.meta<"u"?import.meta:void 0;S&&S.env&&typeof S.env.SUPPRESS_CONVERTER_METADATA<"u"&&(i=String(S.env.SUPPRESS_CONVERTER_METADATA))}catch{}if(!i)try{const S=typeof process<"u"?process:void 0;S&&S.env&&typeof S.env.SUPPRESS_CONVERTER_METADATA<"u"&&(i=String(S.env.SUPPRESS_CONVERTER_METADATA))}catch{}try{const S=typeof globalThis<"u"?globalThis:void 0;!i&&S&&typeof S.__SUPPRESS_CONVERTER_METADATA<"u"&&(i=String(S.__SUPPRESS_CONVERTER_METADATA))}catch{}if(String(i||"").toLowerCase()==="true")return;const d=Object.entries(this.json.resources).find(([,S])=>S?.type==="converter-metadata");if(d){const[S,C]=d,o=C.data;o.typeConvertedTo||(o.typeConvertedTo="storymap"),o.converterVersion||(o.converterVersion=yt()),t&&(o.classicType=t);const p=s.classicMetadata||{},u=o.classicMetadata=o.classicMetadata||{};if(p&&typeof p.classicTheme<"u"&&(u.classicTheme=p.classicTheme),p&&typeof p.mappingDecisions<"u"){const g=p.mappingDecisions,l=u.mappingDecisions=u.mappingDecisions||{};for(const[m,v]of Object.entries(g))l[m]=v}for(const[g,l]of Object.entries(s))g!=="classicMetadata"&&(o[g]=l);const h=p?.templateVersion;h&&!o.classicTemplateVersion&&(o.classicTemplateVersion=h),delete this.json.resources[S],this.json.resources[S]=C,this.json.resources[S]=C;return}const c=this.generateResourceId(),f={type:"converter-metadata",data:{typeConvertedTo:"storymap",converterVersion:yt(),classicType:t,...s}};try{const C=(s.classicMetadata||{})?.templateVersion;C&&(f.data.classicTemplateVersion=C)}catch{}this.json.resources[c]=f}generateNodeId(){return`n-${Math.random().toString(36).slice(2,8)}`}generateResourceId(){return`r-${Math.random().toString(36).slice(2,8)}`}createTextNode(t,s,i="wide"){const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:t,type:s,textAlignment:"start"},config:{size:i}},n}createRichTextNode(t,s,i="wide"){const n=this.generateNodeId();return this.json.nodes[n]={type:"text",data:{text:t,type:s,preserveHtml:!0,textAlignment:"start"},config:{size:i}},n}createImageNode(t,s,i,n="wide"){const d=this.generateNodeId();return this.json.nodes[d]={type:"image",data:{image:t,caption:s,alt:i},config:{size:n}},d}createWebMapNode(t,s){const i=this.generateNodeId();return this.json.nodes[i]={type:"webmap",data:{map:t,caption:s},config:{size:"standard"}},i}createVideoNode(t,s,i){const n=this.generateNodeId();return this.json.nodes[n]={type:"video",data:{video:t,caption:s,alt:i}},n}createVideoEmbedNode(t,s,i,n,d,c,f,S="16:9"){const C=this.generateNodeId();let o=t;return s==="youtube"&&i?o=`https://www.youtube.com/embed/${i}`:s==="vimeo"&&i&&(o=`https://player.vimeo.com/video/${i}`),this.json.nodes[C]={type:"embed",data:{url:t,embedSrc:o,embedType:"video",provider:s,videoId:i,title:d||void 0,description:c||void 0,caption:n||void 0,alt:f||"",isEmbedSupported:!0,display:"inline",aspectRatio:S}},C}createEmbedNode(t,s,i,n,d){const c=this.generateNodeId();return this.json.nodes[c]={type:"embed",data:{url:t,embedType:"link",title:i,description:n,caption:s,alt:d||"",isEmbedSupported:!0,display:"inline",embedSrc:t}},c}createSwipeNode(t,s,i="extent",n){const d=this.generateNodeId();return this.json.nodes[d]={type:"swipe",data:{contents:{0:t,1:s},viewPlacement:i,caption:n},config:{size:"full"}},d}addSlideToSidecar(t,s,i){const n=this.json.nodes[t];if(!n||n.type!=="immersive")throw new Error("addSlideToSidecar: invalid sidecarId");const d=this.generateNodeId();this.json.nodes[d]={type:"immersive-narrative-panel",data:{panelStyle:"themed"},children:[...s]};const c=this.generateNodeId(),f=i?[d,i]:[d];return this.json.nodes[c]={type:"immersive-slide",data:{transition:"fade"},children:f},n.children||(n.children=[]),n.children.push(c),{slideId:c,narrativeId:d}}createActionButtonNode(t,s="wide"){const i=this.generateNodeId();return this.json.nodes[i]={type:"action-button",data:{text:t},config:{size:s}},i}addActionButton(t,s,i="wide"){const n=this.generateNodeId();return this.json.nodes[n]={type:"action-button",data:{text:s},config:{size:i}},this.appendChild(t,n),n}createButtonNode(t,s="wide",i){const n=this.generateNodeId();return this.json.nodes[n]={type:"button",data:{text:t,link:i},config:{size:s}},n}setButtonLink(t,s){const i=this.json.nodes[t];i&&i.type==="button"&&(i.data||(i.data={}),i.data.link=s)}addChild(t,s){this.appendChild(t,s)}getStoryRootId(){return this.json.root}newNodeId(){return this.generateNodeId()}createTourMapNode(t,s,i="2d"){const n=this.generateNodeId(),d={type:"name",value:"worldImagery"};if(s){const c=this.addWebMapResource(s,"Web Map",{},"minimal");d.type="resource",d.value=c}return this.json.nodes[n]={type:"tour-map",data:{geometries:t,mode:i,basemap:d}},n}createCarouselNode(t){const s=this.generateNodeId();return this.json.nodes[s]={type:"carousel",children:t.slice(0,5)},s}createTourNode(t,s,i,n="start",d="large",c="guided-tour",f="map-focused"){const S=this.generateNodeId();return this.json.nodes[S]={type:"tour",data:{type:c,subtype:f,narrativePanelPosition:n,map:s,places:t,narrativePanelSize:d,accentColor:i}},S}registerReplaceMediaAction(t,s,i){typeof i=="string"&&this.json.nodes[i]&&(this.json.actions||(this.json.actions=[]),this.json.actions.push({origin:t,trigger:"ActionButton_Apply",target:s,event:"ImmersiveSlide_ReplaceMedia",data:{media:i}}))}}function bs(I){let t=I||"";const s=[];return t=t.replace(/style\s*=\s*"([^"]*)"/gi,(i,n)=>(s.push(String(n)),"")),t=t.replace(/style\s*=\s*'([^']*)'/gi,(i,n)=>(s.push(String(n)),"")),t=t.replace(/<\s*script[^>]*>[\s\S]*?<\s*\/\s*script\s*>/gi,"").replace(/<\s*style[^>]*>[\s\S]*?<\s*\/\s*style\s*>/gi,""),t=t.replace(/<\s*b\s*>/gi,"<strong>").replace(/<\s*\/\s*b\s*>/gi,"</strong>").replace(/<\s*i\s*>/gi,"<em>").replace(/<\s*\/\s*i\s*>/gi,"</em>"),t=t.replace(/<\s*a\s+([^>]+)>/gi,(i,n)=>{const d=/href\s*=\s*("[^"]*"|'[^']*'|[^\s>]+)/i.exec(n||""),c=d?d[1].replace(/^['"]|['"]$/g,""):"";return c?`<a href="${c}">`:"<a>"}),t=t.replace(/<\s*(strong|em|a)\s+[^>]*>/gi,(i,n)=>`<${String(n).toLowerCase()}>`),t=t.replace(/<\s*(?!strong\b|em\b|a\b)\/?\s*([a-z0-9-]+)([^>]*)>/gi,i=>""),t=t.replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),t=t.replace(/(?:\r?\n|\r){2,}/g,`
`),{sanitizedHtml:t,inlineStyles:s}}class xe extends xt{constructor(t){super(t),this.model="TWO_WEBMAPS",this.layout="swipe",this.builder=new St(t.themeId);const s=t.classicItemId;s&&(this.options={classicItemId:s})}extractStructure(){const t=this.classicJson.values;(t.dataModel||"").toUpperCase()==="TWO_LAYERS"?this.model="TWO_LAYERS":this.model="TWO_WEBMAPS",(t.layout||"").toLowerCase().includes("spyglass")?this.layout="spyglass":this.layout="swipe",this.emit(`Swipe model=${this.model} layout=${this.layout}`)}async convert(){this.emit("Beginning conversion"),this.extractStructure(),await this.convertContent(),this.applyTheme();const t=this.collectMedia();return{storymapJson:this.getStoryMapJson(),media:t}}async convertContent(){this.emit("SwipeConverter.convertContent used");const t=this.classicJson.values;this.builder.createStoryRoot();let s,i,n=t.title||"";this.emit(`[CoverTitle] initial from classic values.title='${(t.title||"").trim()}'`);const d=(n||"").trim().toLowerCase()==="swipe"||(n||"").trim().toLowerCase()==="spyglass";if(!n||d){const g=this.options?.classicItemId;if(this.emit(`[CoverTitle] genericOrEmpty=${!n||d}, classicItemId='${g||""}'`),g){const l=`https://www.arcgis.com/sharing/rest/content/items/${g}?f=json`;try{const m=this.token?`${l}&token=${encodeURIComponent(this.token)}`:l,v=await Le(m,void 0,600*1e3),r=v&&typeof v.title=="string"?v.title.trim():"";this.emit(`[CoverTitle] fetched AGO item.title='${r}'`),r&&(n=r)}catch{}}else{const l=this.fetchItemTitleFallback()||"";this.emit(`[CoverTitle] Node-only fallback title='${l}'`),n=l}}n||(this.emit(`[CoverTitle] falling back to values.name='${(t.name||"").trim()}' or default 'Swipe'`),n=t.name||"Swipe"),this.emit(`[CoverTitle] final coverTitle='${n}'`),this.builder.addCoverNode(n,t.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode();try{const g=t.sidePanelDescription,m=(typeof g=="string"?g:g?String(g):"").trim();if(m){const v=/<[^>]+>/.test(m);if(this.emit(`[SwipeConverter] sidePanelDescription detected; looksHtml=${v}`),v){const{sanitizedHtml:r,inlineStyles:a}=bs(m);if(a.length)try{this.builder.addConverterMetadata("Swipe",{classicMetadata:{mappingDecisions:{customCss:{combined:a.join(`
`)}}}})}catch{}this.builder.addRichTextToRoot(r,"paragraph","wide")}else{const r=this.builder.json.root;r?this.builder.addTextBlock(r,m,"paragraph"):this.builder.createTextNode(m,"paragraph","wide")}}}catch{}let c,f;if(this.model==="TWO_WEBMAPS"){const g=[];if(Array.isArray(t.webmaps))for(const b of t.webmaps)typeof b=="string"?g.push(b):b&&typeof b=="object"&&"id"in b&&g.push(String(b.id));else t.webmap&&g.push(String(t.webmap));const[l,m]=g,v=typeof window<"u",r=l?v?await xe.fetchWebMapInfo(l,this.token):xe.fetchWebMapInfoSync(l,this.token):void 0,a=m?v?await xe.fetchWebMapInfo(m,this.token):xe.fetchWebMapInfoSync(m,this.token):void 0,w={},A={};if(r?.extent){w.extent=r.extent;const b=fe(r.extent);if(b&&(w.viewpoint={targetGeometry:r.center??r.extent,scale:b.scale}),c&&f){const L=r?.center||{x:(r.extent.xmin+r.extent.xmax)/2,y:(r.extent.ymin+r.extent.ymax)/2,spatialReference:r.extent.spatialReference||{wkid:102100}};w.center=L}}if(Array.isArray(r?.operationalLayers))w.mapLayers=r.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility}));else if(l){const b=`https://www.arcgis.com/sharing/rest/content/items/${l}/data?f=json`,L=this.token?`${b}&token=${encodeURIComponent(this.token)}`:b;Le(L,void 0,600*1e3).then(O=>{const J=Array.isArray(O?.operationalLayers)?O.operationalLayers:[];J.length&&(w.mapLayers=J.map(T=>({...T})))}).catch(()=>{})}if(a?.extent){A.extent=a.extent;const b=fe(a.extent);if(b&&(A.viewpoint={targetGeometry:a.center??a.extent,scale:b.scale}),!("center"in A)){const L=a?.center||{x:(a.extent.xmin+a.extent.xmax)/2,y:(a.extent.ymin+a.extent.ymax)/2,spatialReference:a.extent.spatialReference||{wkid:102100}};A.center=L}}if(Array.isArray(a?.operationalLayers))A.mapLayers=a.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility}));else if(m){const b=T=>{for(let x=T.length-1;x>=0;x--)if(T[x].visible)return T[x].title};let L=b(leftLayers);if(b(rightLayers),!L&&Array.isArray(baseData?.baseMap?.baseMapLayers)){const T=baseData.baseMap.baseMapLayers;for(let x=T.length-1;x>=0;x--)if(T[x].visibility){L=T[x].title||L;break}}const O=`https://www.arcgis.com/sharing/rest/content/items/${m}/data?f=json`,J=this.token?`${O}&token=${encodeURIComponent(this.token)}`:O;Le(J,void 0,600*1e3).then(T=>{const x=Array.isArray(T?.operationalLayers)?T.operationalLayers:[];x.length&&(A.mapLayers=x.map(U=>({...U})))}).catch(()=>{})}const j=l?this.builder.addWebMapResource(l,"Web Map",w,"default"):void 0,k=m?this.builder.addWebMapResource(m,"Web Map",A,"default"):void 0;if(j&&r){const b=r.extent?fe(r.extent):void 0;this.builder.updateWebMapData(j,{extent:r.extent,center:r.center,zoom:b?.zoom,viewpoint:w.viewpoint,mapLayers:w.mapLayers??[],itemId:l,itemType:"Web Map",type:"default"});try{const L=this.builder.getJson().resources[j]?.data||{};console.info("[SwipeConverter] resA",j,"extent",L.extent,"viewpoint",L.viewpoint,"center",L.center,"zoom",L.zoom)}catch{}}if(k&&a){const b=a.extent?fe(a.extent):void 0;this.builder.updateWebMapData(k,{extent:a.extent,center:a.center,zoom:b?.zoom,viewpoint:A.viewpoint,mapLayers:A.mapLayers??[],itemId:m,itemType:"Web Map",type:"default"});try{const L=this.builder.getJson().resources[k]?.data||{};console.info("[SwipeConverter] resB",k,"extent",L.extent,"viewpoint",L.viewpoint,"center",L.center,"zoom",L.zoom)}catch{}}if(j&&(c=this.builder.createWebMapNode(j,void 0)),k&&(f=this.builder.createWebMapNode(k,void 0)),k){const b=a?.center||(a?.extent?{x:(a.extent.xmin+a.extent.xmax)/2,y:(a.extent.ymin+a.extent.ymax)/2,spatialReference:a.extent.spatialReference||{wkid:102100}}:void 0);this.builder.updateWebMapData(k,{center:b})}if(j){const b=a?.center||(a?.extent?{x:(a.extent.xmin+a.extent.xmax)/2,y:(a.extent.ymin+a.extent.ymax)/2,spatialReference:a.extent.spatialReference||{wkid:102100}}:void 0);this.builder.updateWebMapData(j,{center:b})}if(c&&(a?.extent||r?.extent)&&this.builder.updateNodeData(c,b=>{b.extent=a?.extent||r?.extent;const L=fe(r.extent),O=(a?.center??a?.extent)||(r.center??r.extent);L&&(b.viewpoint={targetGeometry:O,scale:L.scale});const J=Array.isArray(r.operationalLayers)&&r.operationalLayers.some(T=>T.timeAnimation===!0);b.timeSlider=!!J,Array.isArray(r.operationalLayers)&&r.operationalLayers.length&&(b.mapLayers=r.operationalLayers.map(T=>({id:T.id,title:T.title||T.id,visible:!!T.visibility})),b.viewPlacement="extent");try{console.info("[SwipeConverter] node",c,"extent",b.extent,"viewpoint",b.viewpoint)}catch{}}),f&&a?.extent&&this.builder.updateNodeData(f,b=>{b.extent=a.extent;const L=fe(a.extent);L&&(b.viewpoint={targetGeometry:a.center??a.extent,scale:L.scale});const O=Array.isArray(a.operationalLayers)&&a.operationalLayers.some(J=>J.timeAnimation===!0);b.timeSlider=!!O,Array.isArray(a.operationalLayers)&&a.operationalLayers.length&&(b.mapLayers=a.operationalLayers.map(J=>({id:J.id,title:J.title||J.id,visible:!!J.visibility})),b.viewPlacement="extent");try{console.info("[SwipeConverter] node",f,"extent",b.extent,"viewpoint",b.viewpoint)}catch{}}),c&&f){const b=async U=>{if(U)try{const X=`https://www.arcgis.com/sharing/rest/content/items/${U}?f=json`,R=this.token?`${X}&token=${encodeURIComponent(this.token)}`:X,V=await Le(R,void 0,600*1e3),W=V&&typeof V.title=="string"?V.title:void 0;return W&&W.trim().length?W.trim():void 0}catch{return}},L=await b(l),O=await b(m),J=L&&O?`Left: ${L} — Right: ${O}`:void 0,T=this.builder.createSwipeNode(c,f,"extent",J),x=this.builder.getStoryRootId();x&&this.builder.addChild(x,T),s=T,s=T}}else{const g=String(t.webmap||"");try{const l=Array.isArray(t.layers)?t.layers:[];console.info("[SwipeConverter] classic values.layers (top-level)",l)}catch{}if(g){const l=xe.fetchWebMapInfoSync(g,this.token),m=`https://www.arcgis.com/sharing/rest/content/items/${g}/data?f=json`,v=await Le(this.token?`${m}&token=${encodeURIComponent(this.token)}`:m,void 0,600*1e3).catch(()=>{}),r={},a=v?.initialState?.view?.extent||v?.mapOptions?.extent||v?.extent||v?.mapOptions?.mapExtent,w=v?.initialState?.view?.center||v?.mapOptions?.center||v?.center,A=l?.extent||a,j=l?.center||w;if(A){r.extent=A;const x=fe(A);x&&(r.viewpoint={targetGeometry:j??A,scale:x.scale},r.zoom=x.zoom)}const k=this.builder.addWebMapResource(g,"Web Map",r,"default"),b=this.builder.addWebMapResource(g,"Web Map",r,"default");k&&r&&this.builder.updateWebMapInitialState(k,r),b&&r&&this.builder.updateWebMapInitialState(b,r),v&&k&&this.builder.updateWebMapData(k,{...v,itemId:g,itemType:"Web Map",type:"default"}),v&&b&&this.builder.updateWebMapData(b,{...v,itemId:g,itemType:"Web Map",type:"default"}),k&&this.builder.updateWebMapData(k,{extent:r.extent,center:l?.center,viewpoint:r.viewpoint,zoom:r.zoom}),b&&this.builder.updateWebMapData(b,{extent:r.extent,center:l?.center,viewpoint:r.viewpoint,zoom:r.zoom}),c=this.builder.createWebMapNode(k,void 0),f=this.builder.createWebMapNode(b,void 0);const O=(Array.isArray(t.layers)?t.layers:[]).map(x=>{if(x&&typeof x=="object"&&"id"in x){const U=x;return{id:U.id,title:U.title||U.id}}return{id:String(x),title:String(x)}}).filter(x=>x.id);try{console.info("[SwipeConverter] parsed classicLayers (top-level)",O)}catch{}const T=(Array.isArray(v?.operationalLayers)?v.operationalLayers:l?.operationalLayers||[]).map(x=>({id:x.id,title:x.title||x.id,visible:!!x.visibility}));try{console.info("[SwipeConverter][TWO_LAYERS] sourceLayers",T.map(x=>({id:x.id,title:x.title,vis:x.visible})))}catch{}if(c&&f){const x=new Set,U=new Set;for(const M of O){const $=(M.id||"").trim(),B=(M.title||M.id||"").trim();x.add($),x.add(B),U.add($),U.add(B)}let X=T.map(M=>{const $=(M.id||"").trim(),B=(M.title||"").trim(),_=x.has($)||x.has(B);return{id:M.id,title:M.title,visible:_?!1:M.visible}}),R=T.map(M=>{const $=(M.id||"").trim(),B=(M.title||"").trim(),_=U.has($)||U.has(B);return{id:M.id,title:M.title,visible:_?!0:M.visible}});for(const M of O){const $=(M.id||"").trim(),B=(M.title||M.id||"").trim();T.some(F=>{const de=(F.id||"").trim(),pe=(F.title||"").trim();return de===$||pe===B})||(X=[{id:M.id,title:M.title||M.id,visible:!1},...X],R=[{id:M.id,title:M.title||M.id,visible:!0},...R])}try{const M=X.map(B=>({id:B.id,title:B.title,vis:B.visible})),$=R.map(B=>({id:B.id,title:B.title,vis:B.visible}));console.info("[SwipeConverter][TWO_LAYERS] leftLayers after toggles",M),console.info("[SwipeConverter][TWO_LAYERS] rightLayers after toggles",$)}catch{}this.builder.updateNodeData(c,M=>{M.mapLayers=X,r.extent&&(M.extent=r.extent),r.viewpoint&&(M.viewpoint=r.viewpoint)}),this.builder.updateNodeData(f,M=>{M.mapLayers=R,r.extent&&(M.extent=r.extent),r.viewpoint&&(M.viewpoint=r.viewpoint)}),k&&this.builder.updateWebMapInitialState(k,{mapLayers:X}),b&&this.builder.updateWebMapInitialState(b,{mapLayers:R});const V=M=>{for(let $=M.length-1;$>=0;$--)if(M[$].visible)return M[$].title};let W=V(X.map(M=>({title:M.title,visible:M.visible})));const we=V(R.map(M=>({title:M.title,visible:M.visible})));if(!W&&Array.isArray(v?.baseMap?.baseMapLayers)){const M=v.baseMap.baseMapLayers;for(let $=M.length-1;$>=0;$--)if(M[$].visibility){W=M[$].title||W;break}}i=W&&we?`Left: ${W} — Right: ${we}`:void 0}}}const S=(this.layout==="spyglass","extent");if(c&&f&&!s){const g=this.builder.createSwipeNode(c,f,S,i);t.legend&&this.builder.updateNodeData(g,m=>{m.legendPinned=!0,m.legend=[c]});const l=this.builder.getStoryRootId();l&&this.builder.addChild(l,g)}const C=We(this.classicJson),o=t,p=this.classicJson.version||t.version||t.templateVersion,u=o.templateCreation,h=o.templateLastEdit;this.builder.addConverterMetadata(C||"Swipe",{classicMetadata:{classicTheme:{layout:this.layout,model:this.model},templateVersion:p},classicTemplateCreation:u,classicTemplateLastEdit:h}),this.emit("Built swipe block")}sanitizeSidePanelHtml(t){}applyTheme(){}collectMedia(){return[]}getStoryMapJson(){return this.builder.getJson()}static async convert(t){return new xe(t).convert()}static async buildInlineSwipeBlock(t,s,i="swipe",n){t.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlock"});try{t.emit?.("SwipeConverter.buildInlineSwipeBlock used")}catch{}const d=String(s.dataModel||"").toUpperCase();let c,f;if(d==="TWO_WEBMAPS"){const C=[];if(Array.isArray(s.webmaps))for(const a of s.webmaps)typeof a=="string"?C.push(a):a&&typeof a=="object"&&"id"in a&&C.push(String(a.id));else s.webmap&&C.push(String(s.webmap));const[o,p]=C,u={},h={},g=typeof window<"u",l=o?g?await xe.fetchWebMapInfo(o,n):xe.fetchWebMapInfoSync(o,n):void 0,m=p?g?await xe.fetchWebMapInfo(p,n):xe.fetchWebMapInfoSync(p,n):void 0;if(l?.extent){u.extent=l.extent;const a=fe(l.extent);a&&(u.viewpoint={targetGeometry:l.center??l.extent,scale:a.scale})}if(Array.isArray(l?.operationalLayers)&&(u.mapLayers=l.operationalLayers.map(a=>({id:a.id,title:a.title||a.id,visible:!!a.visibility}))),m?.extent){h.extent=m.extent;const a=fe(m.extent);a&&(h.viewpoint={targetGeometry:m.center??m.extent,scale:a.scale})}Array.isArray(m?.operationalLayers)&&(h.mapLayers=m.operationalLayers.map(a=>({id:a.id,title:a.title||a.id,visible:!!a.visibility})));const v=o?t.addWebMapResource(o,"Web Map",u,"default"):void 0,r=p?t.addWebMapResource(p,"Web Map",h,"default"):void 0;if(v&&u&&t.updateWebMapInitialState(v,u),r&&h&&t.updateWebMapInitialState(r,h),v){const a=l?.extent||m?.extent,w=a?fe(a):void 0,j=m?.center||(m?.extent?{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(v,{extent:a,center:j,zoom:w?.zoom,viewpoint:u.viewpoint,mapLayers:u.mapLayers??[],itemId:o,itemType:"Web Map",type:"default"})}if(r){const a=m?.extent?fe(m.extent):void 0,A=m?.center||(m?.extent?{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(r,{extent:m?.extent,center:A,zoom:a?.zoom,viewpoint:h.viewpoint,mapLayers:h.mapLayers??[],itemId:p,itemType:"Web Map",type:"default"})}if(v&&(c=t.createWebMapNode(v,void 0)),r&&(f=t.createWebMapNode(r,void 0)),v){const a=l?.extent||m?.extent,A=m?.center||(m?.extent?{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(v,{extent:a,center:A})}c&&(m?.extent||l?.extent)&&t.updateNodeData(c,a=>{const w=m?.extent||l?.extent;a.extent=w;const A=fe(w),k=(m?.center||(m?.extent?{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}}:void 0))??w;A&&(a.viewpoint={targetGeometry:k,scale:A.scale});const b=Array.isArray(l.operationalLayers)&&l.operationalLayers.some(L=>L.timeAnimation===!0);a.timeSlider=!!b,Array.isArray(l.operationalLayers)&&l.operationalLayers.length&&(a.mapLayers=l.operationalLayers.map(L=>({id:L.id,title:L.title||L.id,visible:!!L.visibility})),a.viewPlacement="extent")}),f&&m?.extent&&t.updateNodeData(f,a=>{a.extent=m.extent;const w=fe(m.extent),A=m.center||{x:(m.extent.xmin+m.extent.xmax)/2,y:(m.extent.ymin+m.extent.ymax)/2,spatialReference:m.extent.spatialReference||{wkid:102100}};w&&(a.viewpoint={targetGeometry:A??m.extent,scale:w.scale});const j=Array.isArray(m.operationalLayers)&&m.operationalLayers.some(k=>k.timeAnimation===!0);a.timeSlider=!!j,Array.isArray(m.operationalLayers)&&m.operationalLayers.length&&(a.mapLayers=m.operationalLayers.map(k=>({id:k.id,title:k.title||k.id,visible:!!k.visibility})),a.viewPlacement="extent")})}else{const C=String(s.webmap||"");try{const w=Array.isArray(s.layers)?s.layers:[];console.info("[SwipeConverter] classic values.layers (inline)",w)}catch{}const o=C?xe.fetchWebMapInfoSync(C,n):void 0,p=C?`https://www.arcgis.com/sharing/rest/content/items/${C}/data?f=json`:void 0,u=p?await Le(n?`${p}&token=${encodeURIComponent(n)}`:p,void 0,600*1e3).catch(()=>{}):void 0,h={},g=u?.initialState?.view?.extent||u?.mapOptions?.extent||u?.extent||u?.mapOptions?.mapExtent,l=u?.initialState?.view?.center||u?.mapOptions?.center||u?.center,m=o?.extent||g,v=o?.center||l;if(m){h.extent=m;const w=fe(m);w&&(h.viewpoint={targetGeometry:v??m,scale:w.scale},h.zoom=w.zoom)}const r=C?t.addWebMapResource(C,"Web Map",h,"default"):void 0,a=C?t.addWebMapResource(C,"Web Map",h,"default"):void 0;if(r&&h&&t.updateWebMapInitialState(r,h),a&&h&&t.updateWebMapInitialState(a,h),u&&r&&t.updateWebMapData(r,{...u,itemId:C,itemType:"Web Map",type:"default"}),u&&a&&t.updateWebMapData(a,{...u,itemId:C,itemType:"Web Map",type:"default"}),r&&t.updateWebMapData(r,{extent:h.extent,center:o?.center,viewpoint:h.viewpoint,zoom:h.zoom}),a&&t.updateWebMapData(a,{extent:h.extent,center:o?.center,viewpoint:h.viewpoint,zoom:h.zoom}),r&&a){c=t.createWebMapNode(r,void 0),f=t.createWebMapNode(a,void 0);const A=(Array.isArray(s.layers)?s.layers:[]).map(x=>{if(x&&typeof x=="object"&&"id"in x){const U=x;return{id:U.id,title:U.title||U.id}}return{id:String(x),title:String(x)}}).filter(x=>x.id);try{console.info("[SwipeConverter] parsed classicLayers (inline)",A)}catch{}const j=Array.isArray(u?.operationalLayers)?u.operationalLayers:o?.operationalLayers||[],k=x=>(x||"").replace(/_\d+$/,""),b=j.map(x=>({id:x.id,title:x.title||x.id,visible:!!x.visibility}));try{console.info("[SwipeConverter][INLINE TWO_LAYERS] sourceLayers",b.map(x=>({id:x.id,title:x.title,vis:x.visible})))}catch{}const L=new Set,O=new Set;for(const x of A)L.add(k(x.id)),L.add(k(x.title||x.id)),O.add(k(x.id)),O.add(k(x.title||x.id));let J=b.map(x=>{const U=k(x.id),X=k(x.title),R=L.has(U)||L.has(X);return{id:x.id,title:x.title,visible:R?!1:x.visible}}),T=b.map(x=>{const U=k(x.id),X=k(x.title),R=O.has(U)||O.has(X);return{id:x.id,title:x.title,visible:R?!0:x.visible}});for(const x of A){const U=k(x.id),X=k(x.title||x.id);b.some(V=>k(V.id)===U||k(V.title)===X)||(J=[{id:x.id,title:x.title||x.id,visible:!1},...J],T=[{id:x.id,title:x.title||x.id,visible:!0},...T])}try{const x=J.map(X=>({id:X.id,title:X.title,vis:X.visible})),U=T.map(X=>({id:X.id,title:X.title,vis:X.visible}));console.info("[SwipeConverter][INLINE TWO_LAYERS] leftLayers after toggles",x),console.info("[SwipeConverter][INLINE TWO_LAYERS] rightLayers after toggles",U)}catch{}t.updateNodeData(c,x=>{x.mapLayers=J,h.extent&&(x.extent=h.extent),h.viewpoint&&(x.viewpoint=h.viewpoint)}),t.updateNodeData(f,x=>{x.mapLayers=T,h.extent&&(x.extent=h.extent),h.viewpoint&&(x.viewpoint=h.viewpoint)})}}const S="extent";if(!c||!f)throw new Error("SwipeConverter.buildInlineSwipeBlock: missing content nodes");return t.createSwipeNode(c,f,S)}static buildInlineSwipeBlockSync(t,s,i="swipe",n){try{t.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlockSync"})}catch{}const d=String(s.dataModel||"").toUpperCase();let c,f;if(d==="TWO_WEBMAPS"){const C=[];if(Array.isArray(s.webmaps))for(const r of s.webmaps)typeof r=="string"?C.push(r):r&&typeof r=="object"&&"id"in r&&C.push(String(r.id));else s.webmap&&C.push(String(s.webmap));const[o,p]=C,u={},h={},g=o?xe.fetchWebMapInfoSync(o,n):void 0,l=p?xe.fetchWebMapInfoSync(p,n):void 0;if(g?.extent){u.extent=g.extent;const r=fe(g.extent);r&&(u.viewpoint={targetGeometry:g.center??g.extent,scale:r.scale})}if(Array.isArray(g?.operationalLayers)&&(u.mapLayers=g.operationalLayers.map(r=>({id:r.id,title:r.title||r.id,visible:!!r.visibility}))),l?.extent){h.extent=l.extent;const r=fe(l.extent);r&&(h.viewpoint={targetGeometry:l.center??l.extent,scale:r.scale})}Array.isArray(l?.operationalLayers)&&(h.mapLayers=l.operationalLayers.map(r=>({id:r.id,title:r.title||r.id,visible:!!r.visibility})));const m=o?t.addWebMapResource(o,"Web Map",u,"default"):void 0,v=p?t.addWebMapResource(p,"Web Map",h,"default"):void 0;if(m&&u&&t.updateWebMapInitialState(m,u),v&&h&&t.updateWebMapInitialState(v,h),m){const r=g?.extent||l?.extent,a=r?fe(r):void 0,w=l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(m,{extent:r,center:w,zoom:a?.zoom,viewpoint:u.viewpoint,mapLayers:u.mapLayers??[],itemId:o,itemType:"Web Map",type:"default"})}if(v){const r=l?.extent?fe(l.extent):void 0,a=l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(v,{extent:l?.extent,center:a,zoom:r?.zoom,viewpoint:h.viewpoint,mapLayers:h.mapLayers??[],itemId:p,itemType:"Web Map",type:"default"})}if(m&&(c=t.createWebMapNode(m,void 0)),v&&(f=t.createWebMapNode(v,void 0)),m){const r=g?.extent||l?.extent,a=l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0);t.updateWebMapData(m,{extent:r,center:a})}c&&(l?.extent||g?.extent)&&t.updateNodeData(c,r=>{const a=l?.extent||g?.extent;r.extent=a;const w=fe(a),j=(l?.center||(l?.extent?{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}}:void 0))??a;w&&(r.viewpoint={targetGeometry:j,scale:w.scale});const k=Array.isArray(g?.operationalLayers)&&g.operationalLayers.some(b=>b.timeAnimation===!0);r.timeSlider=!!k,Array.isArray(g?.operationalLayers)&&g.operationalLayers.length&&(r.mapLayers=g.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility})),r.viewPlacement="extent")}),f&&l?.extent&&t.updateNodeData(f,r=>{r.extent=l.extent;const a=fe(l.extent),w=l.center||{x:(l.extent.xmin+l.extent.xmax)/2,y:(l.extent.ymin+l.extent.ymax)/2,spatialReference:l.extent.spatialReference||{wkid:102100}};a&&(r.viewpoint={targetGeometry:w??l.extent,scale:a.scale});const A=Array.isArray(l.operationalLayers)&&l.operationalLayers.some(j=>j.timeAnimation===!0);r.timeSlider=!!A,Array.isArray(l.operationalLayers)&&l.operationalLayers.length&&(r.mapLayers=l.operationalLayers.map(j=>({id:j.id,title:j.title||j.id,visible:!!j.visibility})),r.viewPlacement="extent")})}else{const C=String(s.webmap||""),o=C?xe.fetchWebMapInfoSync(C,n):void 0,p={},u=o?.extent,h=o?.center;if(u){p.extent=u;const m=fe(u);m&&(p.viewpoint={targetGeometry:h??u,scale:m.scale},p.zoom=m.zoom)}const g=C?t.addWebMapResource(C,"Web Map",p,"default"):void 0,l=C?t.addWebMapResource(C,"Web Map",p,"default"):void 0;if(g&&p&&t.updateWebMapInitialState(g,p),l&&p&&t.updateWebMapInitialState(l,p),g&&t.updateWebMapData(g,{extent:p.extent,center:o?.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:C,itemType:"Web Map",type:"default"}),l&&t.updateWebMapData(l,{extent:p.extent,center:o?.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:C,itemType:"Web Map",type:"default"}),g&&l){c=t.createWebMapNode(g,void 0),f=t.createWebMapNode(l,void 0);const v=(Array.isArray(s.layers)?s.layers:[]).map(b=>{if(b&&typeof b=="object"&&"id"in b){const L=b;return{id:L.id,title:L.title||L.id}}return{id:String(b),title:String(b)}}).filter(b=>b.id),r=Array.isArray(o?.operationalLayers)?o.operationalLayers.map(b=>({id:b.id,title:b.title||b.id,visible:!!b.visibility})):[],a=new Set,w=new Set,A=b=>(b||"").replace(/_\d+$/,"");for(const b of v)a.add(A(b.id)),a.add(A(b.title||b.id)),w.add(A(b.id)),w.add(A(b.title||b.id));const j=r.map(b=>{const L=A(b.id),O=A(b.title),J=a.has(L)||a.has(O);return{id:b.id,title:b.title,visible:J?!1:b.visible}}),k=r.map(b=>{const L=A(b.id),O=A(b.title),J=w.has(L)||w.has(O);return{id:b.id,title:b.title,visible:J?!0:b.visible}});t.updateNodeData(c,b=>{b.mapLayers=j,p.extent&&(b.extent=p.extent),p.viewpoint&&(b.viewpoint=p.viewpoint)}),t.updateNodeData(f,b=>{b.mapLayers=k,p.extent&&(b.extent=p.extent),p.viewpoint&&(b.viewpoint=p.viewpoint)})}}const S="extent";if(!c||!f)throw new Error("SwipeConverter.buildInlineSwipeBlockSync: missing content nodes");return t.createSwipeNode(c,f,S)}static buildInlineSwipeBlockBrowserSync(t,s,i="swipe",n){try{t.addConverterMetadata("Swipe",{path:"buildInlineSwipeBlockBrowserSync"})}catch{}const d=String(s.dataModel||"").toUpperCase();let c,f;const S=o=>{try{if(typeof window>"u")return;const p=`https://www.arcgis.com/sharing/rest/content/items/${o}/data?f=json${n?`&token=${encodeURIComponent(n)}`:""}`,u=new XMLHttpRequest;if(u.open("GET",p,!1),u.send(null),u.status>=200&&u.status<300&&u.responseText){const h=JSON.parse(u.responseText),g=w=>w?.initialState?.view?.extent||w?.mapOptions?.extent||w?.extent||w?.mapOptions?.mapExtent||void 0,l=w=>w?.initialState?.view?.center||w?.mapOptions?.center||w?.center||void 0,m=g(h),v=l(h);let r,a;if(m){const w=fe(m);w&&(r={targetGeometry:v??m,scale:w.scale},a=w.zoom)}return{extent:m,center:v,zoom:a,viewpoint:r}}}catch{}};if(d==="TWO_WEBMAPS"){const o=[];if(Array.isArray(s.webmaps))for(const r of s.webmaps)typeof r=="string"?o.push(r):r&&typeof r=="object"&&"id"in r&&o.push(String(r.id));else s.webmap&&o.push(String(s.webmap));const[p,u]=o,h=p?S(p):void 0,g=u?S(u):void 0,l=p?t.addWebMapResource(p,"Web Map",h?{extent:h.extent,center:h.center,viewpoint:h.viewpoint,zoom:h.zoom,itemId:p,itemType:"Web Map",type:"default"}:{},"default"):void 0,m=u?t.addWebMapResource(u,"Web Map",g?{extent:g.extent,center:g.center,viewpoint:g.viewpoint,zoom:g.zoom,itemId:u,itemType:"Web Map",type:"default"}:{},"default"):void 0;l&&h&&t.updateWebMapData(l,{extent:h.extent,center:h.center,viewpoint:h.viewpoint,zoom:h.zoom,itemId:p,itemType:"Web Map",type:"default"}),m&&g&&t.updateWebMapData(m,{extent:g.extent,center:g.center,viewpoint:g.viewpoint,zoom:g.zoom,itemId:u,itemType:"Web Map",type:"default"}),l&&(c=t.createWebMapNode(l,void 0)),m&&(f=t.createWebMapNode(m,void 0));const v=r=>{!r||!g||t.updateNodeData(r,a=>{const w=!!a.extent,A=!!a.viewpoint;!w&&g.extent&&(a.extent=g.extent),!A&&g.viewpoint&&(a.viewpoint=g.viewpoint),a.viewPlacement||(a.viewPlacement="extent")})};v(c),v(f)}else{const o=String(s.webmap||""),p=o?S(o):void 0,u=o?t.addWebMapResource(o,"Web Map",p?{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:o,itemType:"Web Map",type:"default"}:{},"default"):void 0,h=o?t.addWebMapResource(o,"Web Map",p?{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:o,itemType:"Web Map",type:"default"}:{},"default"):void 0;if(u&&p&&t.updateWebMapData(u,{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:o,itemType:"Web Map",type:"default"}),h&&p&&t.updateWebMapData(h,{extent:p.extent,center:p.center,viewpoint:p.viewpoint,zoom:p.zoom,itemId:o,itemType:"Web Map",type:"default"}),u&&h){c=t.createWebMapNode(u,void 0),f=t.createWebMapNode(h,void 0);const l=(Array.isArray(s.layers)?s.layers:[]).map(r=>{if(r&&typeof r=="object"&&"id"in r){const a=r;return{id:a.id,title:a.title||a.id}}return{id:String(r),title:String(r)}}).filter(r=>r.id),m=l.map(r=>({id:r.id,title:r.title||r.id,visible:!1})),v=l.map(r=>({id:r.id,title:r.title||r.id,visible:!0}));if(t.updateNodeData(c,r=>{r.mapLayers=m}),t.updateNodeData(f,r=>{r.mapLayers=v}),p){const r=a=>{a&&t.updateNodeData(a,w=>{const A=!!w.extent,j=!!w.viewpoint;!A&&p.extent&&(w.extent=p.extent),!j&&p.viewpoint&&(w.viewpoint=p.viewpoint),w.viewPlacement||(w.viewPlacement="extent")})};r(c),r(f)}}}const C="extent";if(!c||!f)throw new Error("SwipeConverter.buildInlineSwipeBlockBrowserSync: missing content nodes");return t.createSwipeNode(c,f,C)}static fetchWebMapInfoSync(t,s){try{const i=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,n=s?`${i}&token=${encodeURIComponent(s)}`:i,d=Ve(`curl -sL '${n}'`,{encoding:"utf-8"}),c=JSON.parse(d),f=m=>m?.initialState?.view?.extent||m?.mapOptions?.extent||m?.extent||m?.mapOptions?.mapExtent||void 0,S=m=>m?.initialState?.view?.center||m?.mapOptions?.center||m?.center||void 0;let C=f(c),o=S(c);if(!C||typeof C!="object"&&!Array.isArray(C)){const m=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,v=Ve(`curl -sL '${m}'`,{encoding:"utf-8"}),r=JSON.parse(v);if(Array.isArray(r.extent)&&r.extent.length===2&&Array.isArray(r.extent[0])&&Array.isArray(r.extent[1])){const[[a,w],[A,j]]=r.extent;C={xmin:a,ymin:w,xmax:A,ymax:j,spatialReference:{wkid:4326}}}if(!o&&Array.isArray(r.center)&&r.center.length>=2){const[a,w]=r.center;o={x:a,y:w,spatialReference:{wkid:4326}}}}const p=m=>m*2003750834e-2/180,u=m=>Math.log(Math.tan((90+m)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;let h;C&&C.spatialReference&&(C.spatialReference.wkid===4326||C.spatialReference.latestWkid===4326)?h={xmin:p(C.xmin),ymin:u(C.ymin),xmax:p(C.xmax),ymax:u(C.ymax),spatialReference:{wkid:102100}}:C&&typeof C=="object"&&"xmin"in C&&(h=C);let g;o&&o.spatialReference&&o.spatialReference.wkid===4326?g={x:p(o.x),y:u(o.y),spatialReference:{wkid:102100}}:o&&o.spatialReference&&(o.spatialReference.wkid===102100||o.spatialReference.latestWkid===3857)&&(g=o);const l=Array.isArray(c.operationalLayers)?c.operationalLayers.filter(m=>m&&m.id).map(m=>({id:m.id,title:m.title,visibility:m.visibility})):[];return{extent:h,center:g,operationalLayers:l}}catch{return}}static async fetchWebMapInfo(t,s){try{const i=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,n=s?`${i}&token=${encodeURIComponent(s)}`:i,d=await Le(n,void 0,600*1e3),c=l=>l?.initialState?.view?.extent||l?.mapOptions?.extent||l?.extent||l?.mapOptions?.mapExtent||void 0,f=l=>l?.initialState?.view?.center||l?.mapOptions?.center||l?.center||void 0;let S=c(d),C=f(d);if(!S||typeof S!="object"&&!Array.isArray(S)){const l=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,m=await Le(l,void 0,600*1e3);if(Array.isArray(m.extent)&&m.extent.length===2&&Array.isArray(m.extent[0])&&Array.isArray(m.extent[1])){const[[v,r],[a,w]]=m.extent;S={xmin:v,ymin:r,xmax:a,ymax:w,spatialReference:{wkid:4326}}}if(!C&&Array.isArray(m.center)&&m.center.length>=2){const[v,r]=m.center;C={x:v,y:r,spatialReference:{wkid:4326}}}}const o=l=>l*2003750834e-2/180,p=l=>Math.log(Math.tan((90+l)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;let u;S&&S.spatialReference&&(S.spatialReference.wkid===4326||S.spatialReference.latestWkid===4326)?u={xmin:o(S.xmin),ymin:p(S.ymin),xmax:o(S.xmax),ymax:p(S.ymax),spatialReference:{wkid:102100}}:S&&typeof S=="object"&&"xmin"in S&&(u=S);let h;C&&C.spatialReference&&C.spatialReference.wkid===4326?h={x:o(C.x),y:p(C.y),spatialReference:{wkid:102100}}:C&&C.spatialReference&&(C.spatialReference.wkid===102100||C.spatialReference.latestWkid===3857)&&(h=C);const g=Array.isArray(d?.operationalLayers)?d.operationalLayers.filter(l=>l&&l.id).map(l=>({id:l.id,title:l.title,visibility:l.visibility})):[];return{extent:u,center:h,operationalLayers:g}}catch{return}}fetchItemTitleFallback(){try{const t=this.options.classicItemId;if(!t)return;const s=`https://www.arcgis.com/sharing/rest/content/items/${t}?f=json`,i=Ve(`curl -sL '${s}'`,{encoding:"utf-8"}),n=JSON.parse(i);if(n&&typeof n.title=="string"&&n.title.trim().length)return n.title.trim()}catch{}}}var ze={};class st extends xt{constructor(t){super(t),this.sections=[],this.imageResourceMap=new Map,this.media=new Set,this.styleBlocks=[],this.videoEmbedCount=0,this.debugLogs=[],this.BUTTON_CLASS_REGEX=/^btn-(green|orange|purple|yellow|red)$/i,this.CSS_COLOR_MAP={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgreen:"#006400",darkgrey:"#A9A9A9",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",green:"#008000",greenyellow:"#ADFF2F",grey:"#808080",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgreen:"#90EE90",lightgrey:"#D3D3D3",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},this.builder=new St(t.themeId)}shouldSuppressMetadata(){let t="";const i=(typeof import.meta<"u"?import.meta:void 0)?.env;if(i&&typeof i.SUPPRESS_CONVERTER_METADATA<"u"&&(t=String(i.SUPPRESS_CONVERTER_METADATA)),!t&&typeof globalThis<"u"){const n=globalThis;typeof n.__SUPPRESS_CONVERTER_METADATA<"u"&&(t=String(n.__SUPPRESS_CONVERTER_METADATA))}if(!t&&typeof process<"u"){const n=ze;n&&typeof n.SUPPRESS_CONVERTER_METADATA<"u"&&(t=String(n.SUPPRESS_CONVERTER_METADATA))}return String(t||"").toLowerCase()==="true"}logDebug(t,s){try{const i=s?`${t} ${JSON.stringify(s)}`:t;this.debugLogs.push(i),typeof console<"u"&&console.debug&&console.debug("[MapJournalConverter]",t,s??"")}catch{}}logWarn(t,s){try{const i=s?`${t} ${JSON.stringify(s)}`:t;this.debugLogs.push(i),typeof console<"u"&&console.warn&&console.warn("[MapJournalConverter]",t,s??"")}catch{}}flushDebugLogs(t){if(this.debugLogs.length)try{this.shouldSuppressMetadata()||this.builder.addConverterMetadata("MapJournal",{path:t,classicMetadata:{logs:this.debugLogs.slice()}}),this.debugLogs.length=0}catch{}}extractStructure(){const t=this.classicJson.values,s=t.story&&Array.isArray(t.story.sections)?t.story.sections:[],i=Array.isArray(t.sections)?t.sections:[];this.sections=s.length?s:i,this.emit(`Extracted ${this.sections.length} section(s)`)}convertContent(){try{const T=this.classicJson.values,x=T?.story?.map?.itemId||T?.map?.itemId||T?.webmap||ze.WEBMAP_ID,U=this.token||ze.ARCGIS_TOKEN;if(x&&U){const X=`https://www.arcgis.com/sharing/rest/content/items/${x}/data?f=json&token=${encodeURIComponent(U)}`;fetch(X).then(R=>R.ok?R.json():Promise.reject(new Error(`HTTP ${R.status}`))).then(R=>{if((Array.isArray(R?.operationalLayers)?R.operationalLayers:[]).some(we=>{if(String(we?.layerType||we?.type||"").toLowerCase()==="mapnotes")return!0;const $=we?.featureCollection,B=$?.layers?.[0]?.featureSet?.features||[],_=Array.isArray(B)&&B.some(de=>String(de?.symbol?.type).toLowerCase()==="esripms"),F=String(we?.title||"").toLowerCase();return!!$&&(_||F.includes("map notes"))}))if(this.emit(`Webmap ${x} contains Map Notes. Converting to CSV and saving to webmap...`),typeof window<"u")fetch("/.netlify/functions/convert-mapnotes-to-csv",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({webmapId:x,token:U})}).then($=>$.ok?$.json():$.text().then(B=>Promise.reject(new Error(B)))).then($=>{$.changed?this.emit("CSV item created and minimal layer appended via Netlify function."):this.emit("Netlify function reported no changes (no Map Notes found).")}).catch($=>{const B=typeof $=="object"&&$&&"message"in $?String($.message):String($);this.emit(`CSV conversion function failed: ${B}. Continuing conversion.`)});else{const M=ls.resolve("converter-app/scripts/mapnotes-to-csv-item-and-add-to-webmap.ts");try{Xe("npx",["tsx",M],{stdio:"inherit",env:{...ze,WEBMAP_ID:x,ARCGIS_TOKEN:U}}),this.emit("Map Notes → CSV conversion completed. Proceeding with content conversion.")}catch($){const B=typeof $=="object"&&$&&"message"in $?String($.message):String($);this.emit(`CSV conversion execution failed: ${B}. Continuing conversion.`)}}else this.emit(`Webmap ${x} has no Map Notes; skipping CSV conversion.`)}).catch(()=>{this.emit(`Failed to fetch webmap ${x} for Map Notes detection; skipping CSV conversion.`)})}}catch(T){const x=typeof T=="object"&&T&&"message"in T?String(T.message):String(T);this.emit(`Map Notes → CSV pre-step failed: ${x}. Continuing conversion.`)}this.builder.createStoryRoot();const t=this.classicJson.values;this.emit("Created story root node"),this.builder.addCoverNode(t.title||"Untitled Story",t.subtitle),this.builder.addNavigationHidden(),this.builder.addCreditsNode(),this.emit("Added cover/navigation/credits scaffold");const s=(t.description||t.subtitle||"")+"";this.builder.setStoryMeta(t.title||"Untitled Story",s.trim()||void 0,void 0);const n=t,d=n.settings?.layout?.id||"side",c=n.settings?.layoutOptions?.layoutCfg||{},f=c.size||"medium",S=c.position||"right",C=!!n.settings?.theme&&Object.keys(n.settings.theme||{}).length>0,o=d==="float"?"floating-panel":"docked-panel";let p="medium";(f==="small"||f==="medium"||f==="large")&&(p=f);const u=S==="left"?"start":"end",{immersiveId:h,slideId:g,narrativeId:l}=this.builder.addSidecar(o,u,p);if(this.builder.removeNode(g),this.builder.removeNode(l),this.builder.updateNode(h,T=>{T.children=[]}),t.description){const T=[this.builder.createTextNode(String(t.description),"paragraph")];this.builder.addSlideToSidecar(h,T,void 0)}const m=[],v=[],r=[];for(const T of this.sections){const x=[],U=[];let X;T.title&&(X=this.builder.createTextNode(T.title,"h3"),x.push(X)),m.push(X||"");const R=(T.content||T.description||"")+"";if(R.trim())if(typeof globalThis.DOMParser<"u")try{const M=new DOMParser().parseFromString(R,"text/html");for(const $ of Array.from(M.body.children))this.handleElementOrdered($,x,U,v,r)}catch{this.parseOrderedFallback(R,x,U,v,r)}else this.parseOrderedFallback(R,x,U,v,r);let V;const W=T.media;if(W?.image?.url){const M=this.builder.addImageResource(W.image.url);V=this.builder.createImageNode(M,W.image.caption,W.image.altText,"wide"),this.media.add(W.image.url)}else if(W?.webmap?.id){const M=W.webmap.itemType==="Web Scene"?"Web Scene":"Web Map",$=W.webmap,B=W.webmap.extent?this.normalizeExtent(W.webmap.extent):void 0;let _,F;if(B){const q=fe(B);q&&(_={targetGeometry:B,scale:q.scale},F=q.zoom)}const de={extent:B,mapLayers:Array.isArray(W.webmap.layers)?W.webmap.layers.map(q=>({id:q.id,title:q.title||q.id,visible:q.visibility})):void 0,overview:$.overview?{enable:!!$.overview.enable,openByDefault:!!$.overview.openByDefault}:void 0,legend:$.legend?{enable:!!$.legend.enable,openByDefault:!!$.legend.openByDefault}:void 0,geocoder:$.geocoder?{enable:!!$.geocoder.enable}:void 0,popup:$.popup||void 0,viewpoint:_,zoom:F},pe=this.builder.addWebMapResource(W.webmap.id,M,de,"default"),Ie=B?{x:(B.xmin+B.xmax)/2,y:(B.ymin+B.ymax)/2,spatialReference:B.spatialReference}:void 0;let te;try{const he=this.classicJson?.values?.webmap,se=this.classicJson.webmapJson,Se=se&&Array.isArray(se.operationalLayers)?se.operationalLayers:[];if(Se.length&&(he===W.webmap.id||he==null))te=Se.map(me=>({id:me.id,title:me.title||me.id,visible:!!me.visibility}));else try{const me=`https://www.arcgis.com/sharing/rest/content/items/${W.webmap.id}/data?f=json`,ke=this.token?`${me}&token=${encodeURIComponent(this.token)}`:me;if(!(typeof window<"u"))try{const ye=Xe("curl",["-sL",ke],{encoding:"utf-8"}),ge=JSON.parse(ye),ce=Array.isArray(ge?.operationalLayers)?ge.operationalLayers:[];ce.length&&(te=ce.map(N=>({...N})))}catch{}Le(ke,void 0,600*1e3).then(ye=>{const ge=Array.isArray(ye?.operationalLayers)?ye.operationalLayers:[];if(ge.length){this.builder.updateWebMapData(pe,{mapLayers:ge.map(N=>({id:N.id,title:N.title||N.id,visible:!!N.visibility}))});const ce=new Map;if(W.webmap&&Array.isArray(W.webmap.layers))for(const N of W.webmap.layers)ce.set(N.id,!!N.visibility);V&&ce.size>0&&this.builder.updateNodeData(V,N=>{N.mapLayers=ge.map(D=>{const K=String(D.id||""),Z=ce.has(K)?ce.get(K):!!D.visibility;return{id:K,title:D.title||K,visible:Z}})})}}).catch(()=>{})}catch{}}catch{}this.builder.updateWebMapData(pe,{extent:B,center:Ie,mapLayers:te??(Array.isArray(W.webmap.layers)?W.webmap.layers.map(q=>({id:q.id,title:q.title||q.id,visible:!!q.visibility})):void 0),viewpoint:_,zoom:F}),V=this.builder.createWebMapNode(pe,T.title?`${M==="Web Scene"?"Scene":"Map"}: ${T.title}`:void 0),this.media.add(W.webmap.id),V&&this.builder.updateNodeData(V,q=>{if(B&&(q.extent=B),Array.isArray(te)&&te.length){const he=new Map;if(W.webmap&&Array.isArray(W.webmap.layers))for(const se of W.webmap.layers)he.set(se.id,!!se.visibility);he.size>0&&(q.mapLayers=te.map(se=>{const Se=String(se.id||""),me=he.has(Se)?he.get(Se):!!se.visible;return{id:Se,title:se.title||Se,visible:me}}))}else W.webmap&&Array.isArray(W.webmap.layers)&&(q.mapLayers=W.webmap.layers.map(he=>({id:he.id,title:he.title||he.id,visible:!!he.visibility})));_&&(q.viewpoint=_),typeof F=="number"&&(q.zoom=F),$.overview&&$.overview.enable&&(q.overview={openByDefault:!!$.overview.openByDefault}),$.legend&&$.legend.enable&&(q.legend={openByDefault:!!$.legend.openByDefault})})}else if(W?.video?.url){const M=this.detectVideoProvider(W.video.url);if(M.provider!=="unknown")V=this.builder.createVideoEmbedNode(W.video.url,M.provider,M.id,W.video.caption,W.video.caption,void 0,W.video.altText),this.videoEmbedCount++;else{const $=this.builder.addVideoResource(W.video.url,"uri");V=this.builder.createVideoNode($,W.video.caption,W.video.altText),this.media.add(W.video.url)}}else if(W?.webpage?.url){const M=this.tryBuildSwipeNodeFromUrl(W.webpage.url);M?V=M:V=this.builder.createEmbedNode(W.webpage.url,W.webpage.caption,W.webpage.title,W.webpage.description,W.webpage.altText)}const{slideId:we}=this.builder.addSlideToSidecar(h,x,V);if(Array.isArray(T.contentActions)&&T.contentActions.length){const M=new Map(T.contentActions.map($=>[$.id,$]));for(const $ of U){const B=M.get($.actionId);if(!B||B.type!=="media"||!B.media)continue;let _;const F=B.media;if(F.webmap?.id){const de=F.webmap.itemType==="Web Scene"?"Web Scene":"Web Map";let pe,Ie;const te=F.webmap.extent?this.normalizeExtent(F.webmap.extent):void 0,q=F.webmap;if(te){const oe=fe(te);oe&&(pe={targetGeometry:te,scale:oe.scale},Ie=oe.zoom)}const he={extent:te,mapLayers:Array.isArray(F.webmap.layers)?F.webmap.layers.map(oe=>({id:oe.id,title:oe.title||oe.id,visible:oe.visibility})):void 0,overview:q.overview?{enable:!!q.overview.enable,openByDefault:!!q.overview.openByDefault}:void 0,legend:q.legend?{enable:!!q.legend.enable,openByDefault:!!q.legend.openByDefault}:void 0,viewpoint:pe,zoom:Ie},se=this.builder.addWebMapResource(F.webmap.id,de,he,"default"),Se=te?{x:(te.xmin+te.xmax)/2,y:(te.ymin+te.ymax)/2,spatialReference:te.spatialReference}:void 0;let me;try{const oe=this.classicJson.webmapJson,ye=oe&&Array.isArray(oe.operationalLayers)?oe.operationalLayers:[],ce=this.classicJson?.values?.webmap;if(ye.length&&(ce===F.webmap.id||ce==null))me=ye.map(N=>({...N}));else{const N=`https://www.arcgis.com/sharing/rest/content/items/${F.webmap.id}/data?f=json`,D=this.token?`${N}&token=${encodeURIComponent(this.token)}`:N;if(!(typeof window<"u"))try{const Z=Xe("curl",["-sL",D],{encoding:"utf-8"}),G=JSON.parse(Z),ie=Array.isArray(G?.operationalLayers)?G.operationalLayers:[];ie.length&&(me=ie.map(ae=>({...ae})))}catch{}Le(D,void 0,600*1e3).then(Z=>{const G=Array.isArray(Z?.operationalLayers)?Z.operationalLayers:[];G.length&&(me=G.map(ie=>({...ie})))}).catch(()=>{})}}catch{}this.builder.updateWebMapData(se,{extent:te,center:Se,mapLayers:me??(Array.isArray(F.webmap.layers)?F.webmap.layers.map(oe=>({id:oe.id,title:oe.title||oe.id,visible:oe.visibility})):void 0),viewpoint:pe,zoom:Ie});try{const oe=`https://www.arcgis.com/sharing/rest/content/items/${F.webmap.id}/data?f=json`,ye=this.token?`${oe}&token=${encodeURIComponent(this.token)}`:oe;Le(ye,void 0,600*1e3).then(ge=>{const ce=Array.isArray(ge?.operationalLayers)?ge.operationalLayers:[];if(ce.length){this.builder.updateWebMapData(se,{mapLayers:ce.map(D=>({...D}))});const N=new Map;if(F.webmap&&Array.isArray(F.webmap.layers))for(const D of F.webmap.layers)N.set(D.id,!!D.visibility);_&&this.builder.updateNodeData(_,D=>{D.mapLayers=ce.map(K=>{const Z=String(K.id||""),G=N.has(Z)?N.get(Z):!1;return{...K,visible:G}})})}}).catch(()=>{})}catch{}_=this.builder.createWebMapNode(se,$.text.includes("Map")||$.text.includes("Scene")?$.text:void 0);const ke=this.builder.getJson();if(_){const oe=ke.nodes[_],ye=oe&&"data"in oe?oe.data:void 0;if(oe&&ye){if(Array.isArray(F.webmap.layers)){const ge=new Map;for(const ce of F.webmap.layers)ge.set(ce.id,!!ce.visibility);Array.isArray(me)&&me.length?ye.mapLayers=me.map(ce=>{const N=String(ce.id||""),D=ge.has(N)?ge.get(N):!1;return{...ce,visible:D}}):ye.mapLayers=F.webmap.layers.map(ce=>({id:ce.id,title:ce.title||ce.id,visible:ce.visibility}))}te&&(ye.extent=te),pe&&(ye.viewpoint=pe),typeof Ie=="number"&&(ye.zoom=Ie),q.overview&&q.overview.enable&&(ye.overview={openByDefault:!!q.overview.openByDefault}),q.legend&&q.legend.enable&&(ye.legend={openByDefault:!!q.legend.openByDefault})}}this.media.add(F.webmap.id)}else if(F.image?.url){const de=this.builder.addImageResource(F.image.url);_=this.builder.createImageNode(de,F.image.caption,F.image.altText,"standard"),this.media.add(F.image.url)}else if(F.video?.url){const de=this.detectVideoProvider(F.video.url);if(de.provider!=="unknown")_=this.builder.createVideoEmbedNode(F.video.url,de.provider,de.id,F.video.caption,F.video.caption,void 0,F.video.altText),this.videoEmbedCount++;else{const pe=this.builder.addVideoResource(F.video.url,"uri");_=this.builder.createVideoNode(pe,F.video.caption,F.video.altText),this.media.add(F.video.url)}}else if(F.webpage?.url){const de=this.tryBuildSwipeNodeFromUrl(F.webpage.url);de?_=de:_=this.builder.createEmbedNode(F.webpage.url,F.webpage.caption,F.webpage.title,F.webpage.description,F.webpage.altText)}if(_){this.builder.updateNode($.buttonNodeId,te=>{const q=te;q.dependents||(q.dependents={}),q.dependents.actionMedia=_;const se=this.builder.getJson().nodes[_];if(se?.type==="swipe"&&se.data&&se.data.contents){const Se=se.data.contents,me=Se[0],ke=Se[1];me&&(q.dependents.actionMedia_content_0=me),ke&&(q.dependents.actionMedia_content_1=ke)}});const pe=this.builder.getJson().nodes[we],Ie=pe&&"children"in pe?pe.children:void 0;Array.isArray(Ie)&&(Ie.includes(_)||this.builder.addChild(we,_));try{const te=this.builder.getJson(),q=te.nodes[_],he=te.nodes[V];if(q?.type==="swipe"&&he&&he.data){const se=q.data?.contents||{},Se=se[0],me=se[1],ke=Se?te.nodes[Se]:void 0,oe=me?te.nodes[me]:void 0,ye=he.data||{},ge=ye.extent;let N=ye.viewpoint;if(!N&&ge){const K=fe(ge);K&&(N={targetGeometry:ge,scale:K.scale})}const D=K=>{K&&this.builder.updateNodeData(K,Z=>{const G=!!Z.extent,ie=!!Z.viewpoint;!G&&ge&&(Z.extent=ge),!ie&&N&&(Z.viewpoint=N),Z.viewPlacement||(Z.viewPlacement="extent")})};D(Se),D(me)}}catch{}this.builder.registerReplaceMediaAction($.buttonNodeId,we,_)}}}}const a=new Map;this.sections.forEach(T=>{(T.contentActions||[]).forEach(x=>{x.type==="navigate"&&typeof x.index=="number"&&a.set(x.id,x.index)})});for(const T of v){const x=a.get(T.actionId);if(typeof x=="number"){const U=m[x];U&&this.builder.setButtonLink(T.buttonNodeId,`#ref-${U}`)}}const w=this.builder.getJson();for(const T of r){const x=a.get(T.actionId);if(typeof x!="number")continue;const U=m[x];if(!U)continue;const X=w.nodes[T.richNodeId];if(X?.type==="text"&&X.data){const R=X.data;if(!R.preserveHtml)continue;const V=R.text,W=new RegExp(`<a([^>]*data-storymaps=["']${T.actionId}["'][^>]*)>`,"i"),we=V.replace(W,(M,$)=>/href=/.test($)?M:`<a${$} href="#ref-${U}" target="_self">`);R.text=we}}const A=n.settings?.theme||null;if(!C&&d==="float"){const T=this.builder.getJson();for(const R of Object.values(T.nodes))if(R&&R.type==="immersive-narrative-panel"){const V=R.data||{};V.position="end",V.size="medium",R.data=V}const x={baseThemeId:"obsidian",forcedByMissingClassicTheme:!0,variableOverridesApplied:[],layoutMapping:{classicLayoutId:d,classicSize:f,classicPosition:S,mappedSubtype:o,mappedNarrativePanelSize:"medium",mappedNarrativePanelPosition:"end"}};this.builder.applyTheme({themeId:"obsidian",variableOverrides:{}}),x.videoEmbeds=this.videoEmbedCount;const U=We(this.classicJson),X=this.classicJson.values||{};this.builder.addConverterMetadata(U||"MapJournal",{classicMetadata:{classicTheme:A,mappingDecisions:x,templateVersion:this.classicJson.version||this.classicJson.values?.version||this.classicJson.values?.templateVersion},classicTemplateCreation:X.templateCreation,classicTemplateLastEdit:X.templateLastEdit}),this.emit("Applied fallback obsidian theme (no classic theme present; float layout)");return}const{theme:j,decisions:k}=ds(this.classicJson);k.layoutMapping={classicLayoutId:d,classicSize:f,classicPosition:S,mappedSubtype:o,mappedNarrativePanelSize:p,mappedNarrativePanelPosition:u};const b={};if(Array.isArray(k.variableOverridesApplied))for(const T of k.variableOverridesApplied)j.variables&&T in j.variables&&(b[T]=String(j.variables[T]));if(this.styleBlocks.length)try{const T=this.styleBlocks.join(`

`);let x=T.split("").map(R=>R.charCodeAt(0)<32?" ":R).join("");x=x.replace(/\r/g,"").replace(/\t/g," "),x=x.replace(/\n{3,}/g,`

`);const U=T.length,X=x.length>6e3?x.slice(0,6e3)+`
/*__CSS_TRUNCATED__*/`:x;k.customCss={blockCount:this.styleBlocks.length,approxBytes:U,combined:X}}catch{}if(this.builder.applyTheme({themeId:k.baseThemeId,variableOverrides:b}),k.videoEmbeds=this.videoEmbedCount,!this.shouldSuppressMetadata()){const T=We(this.classicJson),x=this.classicJson.values||{};this.builder.addConverterMetadata(T||"MapJournal",{classicMetadata:{classicTheme:A,mappingDecisions:k,templateVersion:this.classicJson.version||this.classicJson.values?.version||this.classicJson.values?.templateVersion},classicTemplateCreation:x.templateCreation,classicTemplateLastEdit:x.templateLastEdit})}const L=this.builder.getJson().nodes[h],O=L&&"children"in L?L.children:void 0,J=Array.isArray(O)?O.length:0;this.emit(`Built single sidecar with ${J} slide(s); theme overrides applied (${Object.keys(b).length})`)}applyTheme(){this.emit("applyTheme skipped (handled in convertContent)")}collectMedia(){return this.emit(`Collected ${this.media.size} media URL(s)`),Array.from(this.media)}getStoryMapJson(){return this.builder.getJson()}static convert(t){return new st(t).convert()}normalizeExtent(t){if(!t)return t;const s=t.spatialReference?.wkid||t.spatialReference?.latestWkid||t.spatialReference?.wkt;if(!(s===4326||s==="WGS84"||s==="WGS 84")||[t.xmin,t.ymin,t.xmax,t.ymax].some(c=>typeof c!="number"||!isFinite(c)))return t;const n=c=>c*2003750834e-2/180,d=c=>Math.log(Math.tan((90+c)*Math.PI/360))/(Math.PI/180)*2003750834e-2/180;return{xmin:n(t.xmin),ymin:d(t.ymin),xmax:n(t.xmax),ymax:d(t.ymax),spatialReference:{wkid:102100,latestWkid:3857}}}extractImageEntries(t){const s=[],i=/<figure[^>]*>([\s\S]*?)<\/figure>/gi;let n;for(;(n=i.exec(t))!==null;){const f=n[1],S=/<img[^>]*>/i.exec(f)?.[0];if(!S)continue;const C=/src=["']([^"'>]+)["']/i.exec(S);if(!C)continue;const o=/alt=["']([^"'>]*)["']/i.exec(S),p=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(f),u=p?this.stripHtml(p[1]).trim():void 0,h=C[1];s.some(g=>g.src===h)||s.push({src:h,alt:o?o[1]:void 0,caption:u})}const d=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let c;for(;(c=d.exec(t))!==null;){const f=c[0],S=c[1];if(!s.some(C=>C.src===S)){const C=/alt=["']([^"'>]*)["']/i.exec(f);s.push({src:S,alt:C?C[1]:void 0})}}return s}stripHtml(t){return t.replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/\s+/g," ").trim()}normalizeButtonLabel(t){return String(t??"").replace(/\u00A0|&nbsp;/g," ").replace(/^[>›»\s]+/,"").trim()}extractParagraphBlocks(t){const s=[],i=/<p[^>]*>([\s\S]*?)<\/p>/gi;let n;for(;(n=i.exec(t))!==null;){const d=n[1],c=this.stripHtml(d);c&&s.push(c)}if(!s.length){const d=this.stripHtml(t);d&&s.push(d)}return s}extractActionAnchorLabel(t,s){const n=new RegExp(`<a[^>]*data-storymaps=["']${s}["'][^>]*>([\\s\\S]*?)</a>`,"i").exec(t);if(n)return this.stripHtml(n[1])}isNonEmptyHtmlSegment(t){if(!t)return!1;const s=/data-storymaps=/i.test(t),i=t.replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/gi," ").replace(/\u00A0/g," ").trim();return s||i.length>0}colorToHex(t){if(!t)return;if(t=t.trim(),t=t.replace(/!important$/i,"").trim(),/^#([0-9a-f]{3})$/i.test(t)){const d=t[1],c=t[2],f=t[3];return`#${d}${d}${c}${c}${f}${f}`.toUpperCase()}if(/^#([0-9a-f]{6})$/i.test(t))return t.toUpperCase();const s=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i.exec(t);if(s){const[d,c,f]=s.slice(1,4).map(S=>Math.max(0,Math.min(255,parseInt(S,10))));return`#${d.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${f.toString(16).padStart(2,"0")}`.toUpperCase()}const i=/rgb-?(\d+)-?(\d+)-?(\d+)/i.exec(t);if(i){const[d,c,f]=i.slice(1,4).map(S=>Math.max(0,Math.min(255,parseInt(S,10))));return`#${d.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${f.toString(16).padStart(2,"0")}`.toUpperCase()}const n=t.toLowerCase();if(this.CSS_COLOR_MAP[n])return this.CSS_COLOR_MAP[n].toUpperCase()}processHtmlColorsPreserveHtml(t){if(!t||!/<[^>]+style=/i.test(t))return t;try{const i=new DOMParser().parseFromString(`<wrapper>${t}</wrapper>`,"text/html").querySelector("wrapper");if(!i)return t;for(const n of Array.from(i.querySelectorAll("[style]"))){const d=n.getAttribute("style")||"",c=/color\s*:\s*([^;]+)(;?)/i.exec(d);if(!c)continue;const f=c[1].trim(),S=this.colorToHex(f);if(!S)continue;const C=`sm-text-color-${S.substring(1)}`;let o=d.replace(c[0],"").trim();o=o.replace(/;;+/g,";"),o=o.replace(/^;|;$/g,"").trim(),o?n.setAttribute("style",o):n.removeAttribute("style");const p=n.getAttribute("class");p?n.setAttribute("class",p+" "+C):n.setAttribute("class",C)}return i.innerHTML}catch{return t.replace(/(<[^>]+style=["'][^"'>]*color\s*:[^"'>]+["'][^>]*>)/gi,s=>{const i=/style=["']([^"'>]+)["']/i.exec(s);if(!i)return s;let n=i[1];const d=/color\s*:\s*([^;]+)(;?)/i.exec(n);if(!d)return s;const c=d[1].trim(),f=this.colorToHex(c);if(!f)return s;const S=`sm-text-color-${f.substring(1)}`;n=n.replace(d[0],"").trim(),n=n.replace(/;;+/g,";").replace(/^;|;$/g,"").trim();let C=s.replace(i[0],n?`style="${n}"`:"");return/class=["']/i.test(C)?C=C.replace(/class=["']([^"'>]+)["']/i,(o,p)=>`class="${p} ${S}"`):C=C.replace(/<([^\s>]+)/,(o,p)=>`<${p} class="${S}"`),C})}}handleElementOrdered(t,s,i,n,d){if(t.tagName==="STYLE"){const f=t.textContent||"";f.trim()&&this.styleBlocks.push(f.trim());return}if(t.tagName==="FIGURE"){const f=t.querySelector("img");if(f?.src){const S=this.builder.addImageResource(f.src);s.push(this.builder.createImageNode(S,t.querySelector("figcaption")?.textContent?.trim()||void 0,f.alt||void 0,"standard")),this.media.add(f.src)}return}if(t.tagName==="IMG"){if(t.getAttribute("src")){const f=t.getAttribute("src"),S=this.builder.addImageResource(f);s.push(this.builder.createImageNode(S,void 0,t.getAttribute("alt")||void 0,"standard")),this.media.add(f)}return}if(t.tagName==="P"||t.tagName==="DIV"){const f=new DOMParser().parseFromString(`<wrapper>${t.innerHTML}</wrapper>`,"text/html"),S=f.querySelector("wrapper");for(const p of Array.from(S.querySelectorAll("img[src]"))){const u=p.getAttribute("src"),h=p.getAttribute("alt")||void 0,g=this.builder.addImageResource(u),l=this.builder.createImageNode(g,void 0,h,"standard");this.media.add(u),p.replaceWith(f.createTextNode(`%%IMG:${l}%%`))}for(const p of Array.from(S.querySelectorAll("a[data-storymaps]"))){const u=p.getAttribute("data-storymaps"),h=p.getAttribute("data-storymaps-type")||"",g=(p.textContent||"View").trim(),l=this.normalizeButtonLabel(g),r=(p.getAttribute("class")||"").split(/\s+/).filter(Boolean).some(a=>this.BUTTON_CLASS_REGEX.test(a));if(h==="media"){const a=this.builder.createActionButtonNode(l,"wide");i.push({actionId:u,text:l,buttonNodeId:a}),p.replaceWith(f.createTextNode(`%%ACTION_BTN:${a}%%`))}else if(h==="navigate")if(r){const a=this.builder.createButtonNode(l,"wide");n.push({actionId:u,buttonNodeId:a}),p.replaceWith(f.createTextNode(`%%NAV_BTN:${a}%%`))}else d.push({actionId:u,richNodeId:""})}const o=S.innerHTML.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%)/);for(const p of o)if(p)if(/^%%IMG:/.test(p)){const u=p.replace(/^%%IMG:/,"").replace(/%%$/,"");s.push(u)}else if(/^%%ACTION_BTN:/.test(p)){const u=p.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,"");s.push(u)}else if(/^%%NAV_BTN:/.test(p)){const u=p.replace(/^%%NAV_BTN:/,"").replace(/%%$/,"");s.push(u)}else{if(!this.isNonEmptyHtmlSegment(p))continue;const u=this.processHtmlColorsPreserveHtml(p).replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),h=u.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(h&&h.length>1)for(const l of h){const m=l.replace(/^<p[^>]*>|<\/p>$/gi,"").trim().replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");if(!m.replace(/&nbsp;|\s+/g,"").trim())continue;const r=this.builder.createRichTextNode(m,"paragraph");if(l.includes("data-storymaps"))for(const a of d)!a.richNodeId&&l.includes(`data-storymaps="${a.actionId}"`)&&(a.richNodeId=r);s.push(r)}else{let l=u;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(u.trim())&&(l=u.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim()),l=l.replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");const v=this.builder.createRichTextNode(l,"paragraph");if(u.includes("data-storymaps"))for(const r of d)!r.richNodeId&&u.includes(`data-storymaps="${r.actionId}"`)&&(r.richNodeId=v);s.push(v)}}return}if(t.tagName==="IFRAME"){const f=t.getAttribute("src");if(f){const S=this.parseSwipeAppId(f);if(S&&typeof window>"u"){const o=this.fetchClassicSwipeDataSync(S);if(o&&o.values){const p=this.parseSwipeLayoutFromUrl(f)||(String(o.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const u=typeof window<"u",h=!!o.values;this.logDebug("iframe (DOM) -> attempting inline swipe build",{appId:S,layout:p,env:u?"browser":"node",hasValues:h});const g=xe.buildInlineSwipeBlockSync(this.builder,o.values,p,this.token);s.push(g),this.logDebug("iframe (DOM) -> inline swipe built",{swipeNodeId:g}),this.flushDebugLogs("embedded-swipe");return}catch(u){this.logWarn("iframe (DOM) -> inline swipe build failed, using embed",{appId:S,error:u?.message}),this.flushDebugLogs("embedded-swipe")}}}const C=this.detectVideoProvider(f);C.provider!=="unknown"?(s.push(this.builder.createVideoEmbedNode(f,C.provider,C.id)),this.videoEmbedCount++,this.logDebug("iframe (DOM) -> video embed",C),this.flushDebugLogs("embedded-swipe")):(s.push(this.builder.createEmbedNode(f)),this.logDebug("iframe (DOM) -> link embed",{src:f}),this.flushDebugLogs("embedded-swipe"))}return}const c=t.textContent?.trim();c&&s.push(this.builder.createTextNode(c,"paragraph"))}parseOrderedFallback(t,s,i,n,d){const c=/<style[^>]*>([\s\S]*?)<\/style>/gi;let f;for(;(f=c.exec(t))!==null;){const o=f[1].trim();o&&this.styleBlocks.push(o)}const S=/(<figure[\s\S]*?<\/figure>)|(<img[^>]*>)|(<p[\s\S]*?<\/p>)|(<div[\s\S]*?<\/div>)|(<iframe[\s\S]*?<\/iframe>)/gi;let C;for(;(C=S.exec(t))!==null;){const o=C[0],p=o.slice(0,10).toLowerCase();if(p.startsWith("<style")){const h=o.replace(/^<style[^>]*>|<\/style>$/gi,"").trim();h&&this.styleBlocks.push(h);continue}if(p.startsWith("<figure")){const h=/<img[^>]*>/i.exec(o)?.[0];if(h){const g=/src=["']([^"'>]+)["']/i.exec(h)?.[1];if(g){const l=/alt=["']([^"'>]*)["']/i.exec(h)?.[1],m=/<figcaption[^>]*>([\s\S]*?)<\/figcaption>/i.exec(o)?.[1],v=this.builder.addImageResource(g);s.push(this.builder.createImageNode(v,m?this.stripHtml(m).trim():void 0,l,"standard")),this.media.add(g)}}continue}if(p.startsWith("<iframe")){const h=/src=["']([^"'>]+)["'][^>]*>/i.exec(o)?.[1];if(h){const g=this.parseSwipeAppId(h);if(g&&typeof window>"u"){const m=this.fetchClassicSwipeDataSync(g);if(m&&m.values){const v=this.parseSwipeLayoutFromUrl(h)||(String(m.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{const r=typeof window<"u",a=!!m.values;this.logDebug("iframe (regex) -> attempting inline swipe build",{appId:g,layout:v,env:r?"browser":"node",hasValues:a});const w=xe.buildInlineSwipeBlockSync(this.builder,m.values,v,this.token);s.push(w);continue}catch(r){this.logWarn("iframe (regex) -> inline swipe build failed",{appId:g,error:r?.message})}}}const l=this.detectVideoProvider(h);l.provider!=="unknown"?(s.push(this.builder.createVideoEmbedNode(h,l.provider,l.id)),this.videoEmbedCount++):s.push(this.builder.createEmbedNode(h))}continue}if(p.startsWith("<p")||p.startsWith("<div")){const h=o.replace(/^<p[^>]*>|^<div[^>]*>|<\/p>$|<\/div>$/gi,"");let g=h;const l=/<img[^>]*src=["']([^"'>]+)["'][^>]*>/gi;let m;for(;(m=l.exec(h))!==null;){const j=m[0],k=m[1],b=/alt=["']([^"'>]*)["']/i.exec(j)?.[1],L=this.builder.addImageResource(k),O=this.builder.createImageNode(L,void 0,b,"standard");this.media.add(k),g=g.replace(j,`%%IMG:${O}%%`)}const v=/<a[^>]*data-storymaps=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/a>/gi;let r;for(;(r=v.exec(h))!==null;){const j=r[0],k=r[1],b=/data-storymaps-type=["']([^"'>]+)["']/i.exec(j)?.[1]||"",L=j.replace(/<a[^>]*>|<\/a>/gi,""),O=this.stripHtml(L).trim()||"View",J=this.normalizeButtonLabel(O),x=(/class=["']([^"'>]+)["']/i.exec(j)?.[1]||"").split(/\s+/).some(U=>this.BUTTON_CLASS_REGEX.test(U));if(b==="media"){const U=this.builder.createActionButtonNode(J,"wide");i.push({actionId:k,text:J,buttonNodeId:U}),g=g.replace(j,`%%ACTION_BTN:${U}%%`)}else if(b==="navigate")if(x){const U=this.builder.createButtonNode(J,"wide");n.push({actionId:k,buttonNodeId:U}),g=g.replace(j,`%%NAV_BTN:${U}%%`)}else d.push({actionId:k,richNodeId:""})}const a=/<iframe[^>]*src=["']([^"'>]+)["'][^>]*>[\s\S]*?<\/iframe>/gi;let w;for(;(w=a.exec(h))!==null;){const j=w[0],k=w[1];let b;const L=this.parseSwipeAppId(k);if(L&&typeof window>"u"){const O=this.fetchClassicSwipeDataSync(L);if(O&&O.values){const J=this.parseSwipeLayoutFromUrl(k)||(String(O.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{this.logDebug("iframe (regex) -> attempting inline swipe build",{appId:L,layout:J}),b=xe.buildInlineSwipeBlockSync(this.builder,O.values,J,this.token),this.logDebug("iframe (regex) -> inline swipe built",{replacementId:b}),this.flushDebugLogs("embedded-swipe")}catch{this.logWarn("iframe (regex) -> inline swipe build failed, will fallback",{appId:L}),this.flushDebugLogs("embedded-swipe")}}}if(!b){const O=this.detectVideoProvider(k);O.provider!=="unknown"?(b=this.builder.createVideoEmbedNode(k,O.provider,O.id),this.videoEmbedCount++,this.logDebug("iframe (regex) -> video embed fallback",O),this.flushDebugLogs("embedded-swipe")):(b=this.builder.createEmbedNode(k),this.logDebug("iframe (regex) -> link embed fallback",{src:k}),this.flushDebugLogs("embedded-swipe"))}g=g.replace(j,`%%IFRAME_NODE:${b}%%`)}const A=g.split(/(%%IMG:[^%]+%%|%%ACTION_BTN:[^%]+%%|%%NAV_BTN:[^%]+%%|%%IFRAME_NODE:[^%]+%%)/);for(const j of A)if(j)if(/^%%IMG:/.test(j))s.push(j.replace(/^%%IMG:/,"").replace(/%%$/,""));else if(/^%%ACTION_BTN:/.test(j))s.push(j.replace(/^%%ACTION_BTN:/,"").replace(/%%$/,""));else if(/^%%NAV_BTN:/.test(j))s.push(j.replace(/^%%NAV_BTN:/,"").replace(/%%$/,""));else if(/^%%IFRAME_NODE:/.test(j))s.push(j.replace(/^%%IFRAME_NODE:/,"").replace(/%%$/,""));else{if(!this.isNonEmptyHtmlSegment(j))continue;const k=this.processHtmlColorsPreserveHtml(j).replace(/&nbsp;/gi," ").replace(/\u00A0/g," "),b=k.match(/<p[^>]*>[\s\S]*?<\/p>/gi);if(b&&b.length>1)for(const O of b){const J=O.replace(/^<p[^>]*>|<\/p>$/gi,"").trim().replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");if(!J.replace(/&nbsp;|\s+/g,"").trim())continue;const x=this.builder.createRichTextNode(J,"paragraph");if(O.includes("data-storymaps"))for(const U of d)!U.richNodeId&&O.includes(`data-storymaps="${U.actionId}"`)&&(U.richNodeId=x);s.push(x)}else{let O=k;/^<p[^>]*>[\s\S]*?<\/p>$/.exec(k.trim())&&(O=k.trim().replace(/^<p[^>]*>|<\/p>$/gi,"").trim()),O=O.replace(/&nbsp;/gi," ").replace(/\u00A0/g," ");const T=this.builder.createRichTextNode(O,"paragraph");if(k.includes("data-storymaps"))for(const x of d)!x.richNodeId&&k.includes(`data-storymaps="${x.actionId}"`)&&(x.richNodeId=T);s.push(T)}}continue}const u=this.stripHtml(o).trim();u&&s.push(this.builder.createTextNode(u,"paragraph"))}}detectVideoProvider(t){if(!t)return{provider:"unknown"};const s=/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([A-Za-z0-9_-]{6,})(?:[&#?].*)?$/i.exec(t);if(s)return{provider:"youtube",id:s[1]};const i=/(?:vimeo\.com\/(?:video\/)?)(\d+)(?:[&#?].*)?$/i.exec(t);return i?{provider:"vimeo",id:i[1]}:{provider:"unknown"}}parseSwipeAppId(t){try{const s=new URL(t,"https://example.com");return s.searchParams.get("appid")||s.searchParams.get("appId")||void 0}catch{return/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(t)?.[1]}}parseSwipeLayoutFromUrl(t){try{const i=(new URL(t,"https://example.com").searchParams.get("layout")||"").toLowerCase();return i.includes("spyglass")?"spyglass":i.includes("swipe")?"swipe":void 0}catch{return}}fetchClassicSwipeDataSync(t){try{const s=`https://www.arcgis.com/sharing/rest/content/items/${t}/data?f=json`,i=this.token?`${s}&token=${encodeURIComponent(this.token)}`:s,n=Ve(`curl -sL '${i}'`,{encoding:"utf-8"});return JSON.parse(n)}catch{return}}fetchClassicSwipeDataProvided(t){try{const s=this.classicJson,i=this.classicJson.values,n=s.__embeddedSwipes||i?.__embeddedSwipes||void 0,d=n?n[t]:void 0;if(d&&typeof d=="object")return d}catch{}}tryBuildSwipeNodeFromUrl(t){const s=this.parseSwipeAppId(t);if(!s)return;const i=typeof window<"u",n=i?this.fetchClassicSwipeDataProvided(s):this.fetchClassicSwipeDataSync(s);if(i&&(!n||!n.values))try{const f=`https://www.arcgis.com/sharing/rest/content/items/${s}/data?f=json`,S=this.token?`${f}&token=${encodeURIComponent(this.token)}`:f;Le(S,void 0,600*1e3)}catch{}if(!n||!n.values)return;const c=this.parseSwipeLayoutFromUrl(t)||(String(n.values.layout||"").toLowerCase().includes("spyglass")?"spyglass":"swipe");try{this.logDebug("tryBuildSwipeNodeFromUrl: attempting inline swipe build from",{url:t});const f=typeof window<"u"?xe.buildInlineSwipeBlockBrowserSync(this.builder,n.values,c,this.token):xe.buildInlineSwipeBlockSync(this.builder,n.values,c,this.token);try{const S=this.builder.getJson(),C=S.nodes[f];if(C&&C.type==="swipe"){let o=C.data?.contents||{};const p=[];for(const g of["0","1"]){const l=o[g];(!l||!S.nodes[l])&&p.push(g)}if(p.length){const g=n.values,l=String(g.dataModel||"").toUpperCase(),m={...o};if(l==="TWO_LAYERS"){const v=String(g.webmap||"");if(v){const r=this.builder.addWebMapResource(v,"Web Map",{},"default"),a=Array.isArray(g.layers)?g.layers:[],w=this.builder.createWebMapNode(r,void 0),A=this.builder.createWebMapNode(r,void 0);if(a.length>=2){const j=a[0],k=a[1];this.builder.updateNodeData(w,b=>{b.mapLayers=[{id:j.id,title:j.title||j.id,visible:!0},{id:k.id,title:k.title||k.id,visible:!1}]}),this.builder.updateNodeData(A,b=>{b.mapLayers=[{id:j.id,title:j.title||j.id,visible:!1},{id:k.id,title:k.title||k.id,visible:!0}]})}m[0]=w,m[1]=A}}else{const v=[];if(Array.isArray(g.webmaps))for(const w of g.webmaps)typeof w=="string"?v.push(w):w&&typeof w=="object"&&"id"in w&&v.push(String(w.id));else g.webmap&&v.push(String(g.webmap));const[r,a]=v;if(r){const w=this.builder.addWebMapResource(r,"Web Map",{},"default");m[0]=this.builder.createWebMapNode(w,void 0)}if(a){const w=this.builder.addWebMapResource(a,"Web Map",{},"default");m[1]=this.builder.createWebMapNode(w,void 0)}}this.builder.updateNode(f,v=>{const r=v.data||{};r.contents=m,v.data=r}),o=m,this.logDebug("swipe contents rebuilt due to missing keys",{missingKeys:p})}const u=o[0],h=o[1];if(!u||!h||!S.nodes[u]||!S.nodes[h]){try{this.builder.removeNode(f)}catch{}this.logWarn("dropping inline swipe; invalid contents",{c0:u,c1:h}),this.flushDebugLogs("embedded-swipe");return}this.logDebug("inline swipe built successfully",{swipeNodeId:f,contents:o})}}catch{}try{const S=this.options?.classicItemId,C={};S&&(C.classicItemId=S),this.builder.addConverterMetadata("MapJournal",{classicMetadata:{},...C})}catch{}return this.flushDebugLogs("embedded-swipe"),f}catch(f){this.logWarn("inline swipe build failed; will use embed",{url:t,error:f?.message}),this.flushDebugLogs("embedded-swipe");return}}}class ws{static async transferBatch(t){const{urls:s,storyId:i,username:n,token:d,progress:c,uploader:f,isCancelled:S}=t,C={};for(let o=0;o<s.length;o++){if(S&&S())throw new Error("Conversion cancelled by user intervention");const p=s[o];c({stage:"media",message:`Transferring media ${o+1}/${s.length}`,current:o+1,total:s.length});try{if(S&&S())throw new Error("Conversion cancelled by user intervention");const u=await f(p,i,n,d);u.transferred&&(C[u.originalUrl]=u.resourceName)}catch{}}if(S&&S())throw new Error("Conversion cancelled by user intervention");return C}}class vs{static apply(t,s){for(const[i,n]of Object.entries(t.resources))if(n.type==="image"){const d=n,c=d.data&&typeof d.data=="object"?d.data.src:void 0;if(c&&s[c]){const f=d.data||{};f.resourceId=s[String(c)],delete f.src,f.provider="item-resource",d.data=f}}for(const i of Object.values(t.nodes))if(i.type==="image"){const n=i,d=n.data&&typeof n.data=="object"?n.data.src:void 0;if(typeof d=="string"){const c=d,f=Object.entries(t.resources).find(([S,C])=>C.type==="image"&&typeof C.data.src=="string"&&C.data.src===c)?.[0];if(f){const S=n.data||{};S.image=f,delete S.src,delete S.resourceId,delete S.provider,n.data=S}}}return t}static rewriteImageUrlsToProxy(t,s){for(const i of Object.values(t.resources))if(i.type==="image"){const n=i,d=n.data||{},c=d.src,f=d.resourceId;typeof c=="string"&&!f&&(d.src=`${s}?url=${encodeURIComponent(c)}`),n.data=d}for(const i of Object.values(t.nodes))if(i.type==="image"){const n=i,d=n.data||{},c=d.src,f=d.image;typeof c=="string"&&!f&&(d.src=`${s}?url=${encodeURIComponent(c)}`),n.data=d}return t}}const De="https://www.arcgis.com/sharing/rest";async function Ze(I,t){const s=`${De}/content/items/${I}/data?f=json&token=${t}`,i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch item data: ${i.statusText}`);return i.json()}async function Oe(I,t){const s=`${De}/content/items/${I}?f=json&token=${t}`,i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch item details: ${i.statusText}`);return i.json()}async function xs(I,t,s,i){const n=`${De}/content/users/${t}/items/${I}/removeResources`,d=new URLSearchParams;d.append("resource",s),d.append("f","json"),d.append("token",i);const c=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()});if(!c.ok)throw new Error(`Failed to remove resource: ${c.statusText}`);return c.json()}async function It(I,t,s,i,n){const d=`${De}/content/users/${t}/items/${I}/addResources`,c=new FormData;c.append("file",s,i),c.append("fileName",i),c.append("f","json"),c.append("token",n);const f=await fetch(d,{method:"POST",body:c}),S=await f.json();console.log("[addResource] Upload API response:",S);const C=f.ok,o=S?.success===!0,p=S?.error?.message;if(!C||!o)throw new Error(`Failed to add resource: ${p||f.statusText}`);return S}async function gt(I,t,s,i){const n=`${De}/content/users/${t}/items/${I}/update`,d=new URLSearchParams;d.append("typeKeywords",JSON.stringify(s)),d.append("f","json"),d.append("token",i);const c=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d.toString()});if(!c.ok)throw new Error(`Failed to update item keywords: ${c.statusText}`);return c.json()}function Ss(I){const t=I&&typeof I=="object"?I.typeKeywords:void 0,s=Array.isArray(t)?t.filter(i=>typeof i=="string"):[];for(const i of s)if(i.startsWith("smdraftresourceid:"))return i.substring(18);return null}function Is(){const I=Je(),t=Je(),s=Je(),i=Je(),n=Cs();return{root:I,nodes:{[t]:{type:"storycover",data:{type:"minimal",title:"",summary:"",byline:"",titlePanelVerticalPosition:"top",titlePanelHorizontalPosition:"start",titlePanelStyle:"gradient"}},[s]:{type:"navigation",data:{links:[]},config:{isHidden:!0}},[i]:{type:"credits",children:[]},[I]:{type:"story",data:{storyTheme:n},config:{coverDate:"",shouldPushMetaToAGOItemDetails:!1},children:[t,s,i]}},resources:{[n]:{type:"story-theme",data:{themeId:"summit",themeBaseVariableOverrides:{}}}}}}function Je(){return`n-${Math.random().toString(36).slice(2,8)}`}function Cs(){return`r-${Math.random().toString(36).slice(2,8)}`}async function js(I,t,s){const i=`${De}/content/users/${encodeURIComponent(I)}/addItem`,n=new URLSearchParams;n.append("f","json"),n.append("token",t),n.append("title",s),n.append("type","StoryMap"),n.append("typeKeywords",JSON.stringify(["StoryMaps","smdraftresourceid:draft.json"]));const d=Is();n.append("text",JSON.stringify(d));const c=await fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}),f=await c.json();if(!c.ok||!f||!f.success||!f.id){const S=f&&f.error&&f.error.message||c.statusText||"addItem failed";throw new Error(`Failed to create draft story: ${S}`)}return String(f.id)}function As(I){return I.includes("www.arcgis.com/sharing/rest/content")||I.includes("//www.arcgis.com/sharing/rest/content")}function Ns(I){const t=I.split("/resources/");if(t.length>1){const i=t[1].split("?")[0];return decodeURIComponent(i)}return I.split("/").pop()?.split("?")[0]||"image.jpg"}function ks(I,t){const s=["jpg","jpeg","png","gif","webp","bmp","tif","tiff"];let i=t;if(!i){const d=I.split(".").pop()||"";i=s.includes(d.toLowerCase())?d.toLowerCase():"jpg"}return i==="jpeg"&&(i="jpg"),i==="tiff"&&(i="tif"),`${Math.random().toString(36).substring(2,15)}.${i}`}function bt(I){if(!I)return".jpg";const t=I.toLowerCase();return[".jpg",".jpeg",".png",".gif",".webp",".bmp",".tif",".tiff"].includes(t)?t===".jpeg"?".jpg":t===".tiff"?".tif":t:".jpg"}function Ts(I,t,s){if(s){const n=/filename="?([^";]+)"?/i.exec(s);if(n){const c=n[1].toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(c)return c[0].replace(".jpeg",".jpg").replace(".tiff",".tif")}}const i=I.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);if(i)return i[0].replace(".jpeg",".jpg").replace(".tiff",".tif");if(t&&/^image\//i.test(t)){const n=t.split("/")[1].toLowerCase();return["jpg","jpeg","png","gif","webp","bmp","tiff","tif"].includes(n)?"."+(n==="jpeg"?"jpg":n==="tiff"?"tif":n):".jpg"}return".bin"}async function Ls(I,t){const s=t?`${I}?token=${encodeURIComponent(t)}`:I,i=await fetch(s);if(!i.ok)throw new Error(`Image fetch failed ${i.status}`);const n=i.headers.get("content-disposition")||void 0,d=i.headers.get("content-type")||void 0,c=i.url,f=await i.blob(),S=Ts(c,d,n);return{blob:f,extension:S}}async function Ms(I,t,s,i,n){try{console.log("[transferImage] Starting transfer:",{imageUrl:I,filename:n,targetItemId:t});const d=Ns(I);let c=".jpg",f;try{const C=await Ls(I,As(I)?i:void 0);f=C.blob,c=bt(C.extension)}catch(C){console.warn("[transferImage] Primary fetch failed, trying proxy:",{imageUrl:I,error:C}),f=await $s(I);const o=d.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp|tif|tiff)$/);c=bt(o?o[0]:".jpg")}/^\.(jpg|png|gif|webp|bmp|tif)$/i.test(c)||(c=".jpg");let S;return n||(S=ks(d,c.replace(".",""))),console.log("[transferImage] Uploading to AGO:",{newResourceName:S,blob:f}),await It(t,s,f,S,i),console.log("[transferImage] Transfer successful:",{imageUrl:I,newResourceName:S}),{originalUrl:I,resourceName:S,isTransferred:!0}}catch(d){return console.error("[transferImage] Transfer failed:",{imageUrl:I,error:d}),{originalUrl:I,resourceName:I,isTransferred:!1}}}async function $s(I){const s=/^(localhost|127\.0\.0\.1)$/i.test(window.location.hostname)?`/.netlify/functions/proxy-image?url=${encodeURIComponent(I)}`:I,i=await fetch(s);if(!i.ok)throw new Error("Failed to fetch image (proxy/direct)");return await i.blob()}function Rs(I){const t=new Set;if(I.resources){for(const s of Object.values(I.resources))if(s.type==="image"){const i=s.data?.url||s.data?.src;i&&t.add(i)}}return Array.from(t)}const Es=new Mt({allErrors:!0,strict:!1,allowUnionTypes:!0});function Fs(...I){return Es.compile(...I)}const Ds="http://json-schema.org/draft-07/schema#",Bs="https://example.com/schemas/draft-story.json",Os="StoryMaps Draft",Ws="object",Ps=["root","nodes","resources"],Us={root:{type:"string",minLength:1},nodes:{type:"object",minProperties:1,additionalProperties:{type:"object",required:["type"],properties:{type:{type:"string",minLength:1},data:{type:"object",properties:{children:{type:"array",items:{type:"string"}},viewpoint:{$ref:"#/$defs/viewpoint"},extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0},config:{type:"object"},children:{type:"array",items:{oneOf:[{type:"string"},{type:"number"},{type:"object",additionalProperties:!0}]}},dependents:{type:"object"}},additionalProperties:!0}},resources:{type:"object",additionalProperties:{type:"object",required:["type"],properties:{type:{type:"string",minLength:1},data:{type:"object",properties:{initialState:{type:"object",properties:{extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},viewpoint:{$ref:"#/$defs/viewpoint"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0},extent:{$ref:"#/$defs/extent"},center:{$ref:"#/$defs/center"},viewpoint:{$ref:"#/$defs/viewpoint"},mapLayers:{$ref:"#/$defs/mapLayers"}},additionalProperties:!0}},additionalProperties:!0}},actions:{type:"array",items:{type:"object"}}},_s={spatialReference:{type:"object",properties:{wkid:{type:"integer"}},required:["wkid"],additionalProperties:!0},center:{type:"object",properties:{x:{type:"number"},y:{type:"number"},spatialReference:{$ref:"#/$defs/spatialReference"}},required:["x","y","spatialReference"],additionalProperties:!0},extent:{type:"object",properties:{xmin:{type:"number"},ymin:{type:"number"},xmax:{type:"number"},ymax:{type:"number"},spatialReference:{$ref:"#/$defs/spatialReference"}},required:["xmin","ymin","xmax","ymax","spatialReference"],additionalProperties:!0},viewpoint:{oneOf:[{$ref:"#/$defs/extent"},{$ref:"#/$defs/center"},{type:"object",properties:{targetGeometry:{type:["object","array","string"],additionalProperties:!0},scale:{type:"number"},rotation:{type:"number"},camera:{type:"object",additionalProperties:!0}},additionalProperties:!0}]},mapLayer:{type:"object",properties:{id:{type:"string"},visible:{type:"boolean"}},required:["id"],additionalProperties:!0},mapLayers:{type:"array",items:{$ref:"#/$defs/mapLayer"}}},zs=!1,Js={$schema:Ds,$id:Bs,title:Os,type:Ws,required:Ps,properties:Us,$defs:_s,additionalProperties:zs};function Vs(){const[I,t]=z.useState(!1),[s,i]=z.useState(!1),[n,d]=z.useState(""),c=z.useRef(!1),[f,S]=z.useState(!1),[C]=z.useState(!1),{token:o,userInfo:p}=Pe(),[u,h]=z.useState(""),[g,l]=z.useState("idle"),[m,v]=z.useState(""),[r,a]=z.useState(""),[w,A]=z.useState(""),[j,k]=z.useState(()=>{try{const N=localStorage.getItem("suppressConverterMetadata");return N?String(N).toLowerCase()==="true":!1}catch{return!1}});z.useEffect(()=>{try{localStorage.setItem("suppressConverterMetadata",String(j))}catch{}globalThis.__SUPPRESS_CONVERTER_METADATA=j},[j]);const[b,L]=z.useState("Convert");z.useEffect(()=>{let N=!1;const D=(u||"").trim();if(D.length<8){L("Convert");return}return(async()=>{try{const K=await Oe(D,o),Z=String(K?.title||K?.name||"").trim();let G=null;try{const ue=await Ze(D,o);G=We(ue)}catch{}if(!G||G.toLowerCase()==="unknown"){const ue=Array.isArray(K?.typeKeywords)?K.typeKeywords:[],Ce=[String(K?.type||"").toLowerCase(),...ue.map(le=>String(le).toLowerCase())].join(" "),Y=/journal/.test(Ce)?"Map Journal":/swipe/.test(Ce)?"Swipe":/tour/.test(Ce)?"Map Tour":/series/.test(Ce)?"Map Series":/cascade/.test(Ce)?"Cascade":/shortlist/.test(Ce)?"Shortlist":/crowdsource/.test(Ce)?"Crowdsource":/basic/.test(Ce)?"Basic":null;Y&&(G=Y)}const ie=G||"",ae=Z||"",$e=ie&&ae?`Convert classic ${ie}: "${ae}"`:"Convert";N||L($e)}catch{N||L("Convert")}})(),()=>{N=!0}},[u,o]);const[O,J]=z.useState(pt());z.useEffect(()=>{const N=D=>J(D);return rs(N),J(pt()),()=>os(N)},[]);const T=()=>{if(c.current)throw new Error("Conversion cancelled by user intervention")},[x,U]=z.useState(!1),X=z.useCallback(()=>{if(c.current)return;window.confirm("Cancel conversion in progress? This will stop further processing.")&&(c.current=!0,U(!0),S(!1))},[]),[R,V]=z.useState(null),[W,we]=z.useState(null),[M,$]=z.useState([]),B="https://www.arcgis.com",[_,F]=z.useState(B),de=z.useRef(null),pe=z.useRef(!1),[Ie,te]=z.useState(!1),[q,he]=z.useState({}),se=z.useCallback(()=>{const N=typeof p=="object"&&p?p:{},D=N.orgUrl||N.org?.url||"";try{if(typeof D=="string"&&D.length){const Z=new URL(D).hostname,G=/^(.*)\.maps\.arcgis\.com$/i.exec(Z);return G&&G[1]?`${G[1]}.maps.arcgis.com`:Z}}catch{}return"www.arcgis.com"},[p]),Se=z.useCallback((N,D)=>{const K=se(),Z=D&&D!==B?D:`https://${K}`;return N.map(G=>{const ie=G.itemId,ae=G.message||"";if(/version\s*([0-9]+(?:\.[0-9]+)?)\s*<\s*2\.0/i.test(ae)){const ue=`ERROR: Item [${ie}] Unsupported web map version: You must update the web map to the latest version. You can do this by opening the map in <a href="${Z}/home/webmap/viewer.html?webmap=${ie}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a> and save it. No other changes are necessary to resolve this error.`;return{...G,level:"error",message:ue}}if(/HTTP URL|http:\/\//i.test(ae)){const ue=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${Z}/home/item.html?id=${ie}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,Te=`WARNING: Webmap [${ie}] uses http services.`;return{...G,message:`${Te}
${ue}`}}const $e=/Map Viewer Classic\s*<\s*link\s*=\s*(https?:[^\s>]+)\s*>/i.exec(ae);if($e){const ue=$e[1],Te=ae.replace($e[0],`<a href="${ue}" target="_blank" rel="noopener noreferrer">Map Viewer Classic</a>`);return{...G,message:Te}}if(/https:\/\/<org_url>\.arcgis\.com/i.test(ae)){const ue=ae.replace(/https:\/\/<org_url>\.arcgis\.com/gi,Z);return{...G,message:ue}}if(/https:\/\/www\.arcgis\.com/i.test(ae)&&Z&&Z!==B){const ue=ae.replace(/https:\/\/www\.arcgis\.com/gi,Z);return{...G,message:ue}}return G})},[se]),me=N=>{if(!N)return"";const D=se();return/^[a-f0-9]{32}$/i.test(N)?`https://${D}/home/item.html?id=${N}`:""},ke=z.useMemo(()=>Fs(Js),[]);z.useEffect(()=>{if(!o){F(B),de.current=null,pe.current=!1;return}de.current&&de.current!==o&&(F(B),pe.current=!1),de.current=o},[o]),z.useEffect(()=>{try{const D=`https://${se()}`;o&&D&&_!==D&&F(D)}catch{}},[o,p,_,se]),z.useEffect(()=>{!o||pe.current||(async()=>{try{const N=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(o)}`);if(!N.ok)return;const D=await N.json(),K=D?.urlKey,Z=D?.customBaseUrl;let G="";if(K&&Z)G=`https://${K}.${Z}`;else if(D?.portalHostname){const ie=D.portalHostname;G=/^https?:/i.test(ie)?ie:`https://${ie}`}G&&_!==G&&F(G)}catch{}finally{pe.current=!0}})()},[o,_]),z.useEffect(()=>{M.length&&_&&_!==B&&$(N=>N.map(D=>({...D,message:(D.message||"").replace(/https:\/\/www\.arcgis\.com/gi,_)})))},[_,M.length]);const oe=N=>/^[a-f0-9]{32}$/i.test(N.trim()),ye=z.useCallback(async()=>{if(_&&_!==B)return _;const N=se();let D=`https://${N}`;if(o&&/www\.arcgis\.com$/i.test(N))try{const K=await fetch(`https://www.arcgis.com/sharing/rest/portals/self?f=json&token=${encodeURIComponent(o)}`);if(K.ok){const Z=await K.json(),G=Z?.urlKey,ie=Z?.customBaseUrl;if(G&&ie)D=`https://${G}.${ie}`;else if(Z?.portalHostname){const ae=Z.portalHostname;D=/^https?:/i.test(ae)?ae:`https://${ae}`}}}catch{}return D&&D!==_&&F(D),D},[_,o,se]),ge=z.useCallback(()=>{t(!1),l("idle"),v(""),A(""),L("Convert"),c.current=!1,U(!1),$([]),te(!1),he({}),V(null),W?.url&&URL.revokeObjectURL(W.url),we(null)},[W]),ce=async()=>{if(l("idle"),v(""),A(""),L("Convert"),c.current=!1,U(!1),$([]),te(!1),he({}),W?.url&&URL.revokeObjectURL(W.url),we(null),!oe(u)){l("error"),v("Incorrect Classic Story Map item id format - please enter a 32 character hex string");return}if(!o){l("error"),v("You must be signed in to ArcGIS Online or ArcGIS Enterprise");return}try{l("fetching"),v("Getting user information...");const N=p?.username||"";v("Fetching classic story data...");const D=await Ze(u,o);T();let K=null;try{K=We(D)}catch{K=null}if(!K||K.toLowerCase()==="unknown")try{const E=await Oe(u,o),P=Array.isArray(E?.typeKeywords)?E.typeKeywords:[],Q=[String(E?.type||"").toLowerCase(),...P.map(ee=>String(ee).toLowerCase())].join(" "),ne=/journal/.test(Q)?"Map Journal":/swipe/.test(Q)?"Swipe":/tour/.test(Q)?"Map Tour":/series/.test(Q)?"Map Series":/cascade/.test(Q)?"Cascade":/shortlist/.test(Q)?"Shortlist":/crowdsource/.test(Q)?"Crowdsource":/basic/.test(Q)?"Basic":null;ne&&(K=ne)}catch{}V(K),K&&v(`Detected template: ${K}. Preparing resources...`);try{const E=await Oe(u,o),P=String(E?.type||"").trim(),H=(K||"").toLowerCase();if(!H||H==="unknown"){l("error"),v(`Error: The item id you entered is not for a Classic Esri Story Map. It is a ${P||"non-classic ArcGIS item"}`);return}if(!Qt(K)){const Q=K||"unknown";l("error"),v(`Error: The item id you entered is not yet available for conversion. It is a ${Q}`);return}}catch{}if(D.values?.webmap){v("Fetching classic webmap data...");const E=D.values?.webmap;D.webmapJson=await Ze(E,o),T()}v("Creating new StoryMap draft...");const Z=D.values?.title||"Untitled Story",G=`(Converted) ${Z}`,ie=await js(N,o,G);T(),v("Converting theme...");const ae=[];D.values?.webmap&&ae.push(D.values.webmap);try{const E=Array.isArray(D.values?.webmaps)?D.values.webmaps:[];for(const P of E)if(typeof P=="string")ae.push(P);else{const H=P;H&&typeof H.id=="string"&&ae.push(H.id)}}catch{}const $e=K||R||"webmap";l("fetching"),L(`Fetching ${$e}...`);try{const E=D.values?.story?.sections||D.sections||[];for(const P of E){P?.media?.webmap?.id&&ae.push(P.media.webmap.id);const H=P?.media?.webpage?.url||"",re=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(String(H))?.[1];if(re)try{const ee=`https://www.arcgis.com/sharing/rest/content/items/${re}/data?f=json`,be=o?`${ee}&token=${encodeURIComponent(o)}`:ee,ve=await fetch(be);if(ve.ok){const Ae=await ve.json(),Me=Array.isArray(Ae?.values?.webmaps)?Ae.values.webmaps:[];for(const Ne of Me)if(typeof Ne=="string")ae.push(Ne);else{const je=Ne;je&&typeof je.id=="string"&&ae.push(je.id)}try{const Ne=String(re),je=D;je.__embeddedSwipes||(je.__embeddedSwipes={}),je.__embeddedSwipes[Ne]=Ae}catch{}}}catch{}const ne=Array.isArray(P?.contentActions)?P.contentActions:[];for(const ee of ne)if(ee&&ee.type==="media"&&ee.media&&ee.media.webpage&&ee.media.webpage.url){const be=String(ee.media.webpage.url||""),Ae=/[?&#](?:appid|appId)=([a-f0-9]{32})/i.exec(be)?.[1];if(Ae)try{const Me=`https://www.arcgis.com/sharing/rest/content/items/${Ae}/data?f=json`,Ne=o?`${Me}&token=${encodeURIComponent(o)}`:Me,je=await fetch(Ne);if(je.ok){const Ke=await je.json(),jt=Array.isArray(Ke?.values?.webmaps)?Ke.values.webmaps:[];for(const Be of jt)if(typeof Be=="string")ae.push(Be);else{const Ee=Be;Ee&&typeof Ee.id=="string"&&ae.push(Ee.id)}try{const Be=String(Ae),Ee=D;Ee.__embeddedSwipes||(Ee.__embeddedSwipes={}),Ee.__embeddedSwipes[Be]=Ke}catch{}}}catch{}}}}catch{}const ue=new Set,Te=[];for(const E of ae){const P=String(E);ue.has(P)||(ue.add(P),Te.push(P))}let Ce=[];try{const E=await ye();if(Te.length>0)for(let P=0;P<Te.length;P++){if(c.current)throw new Error("Conversion cancelled by user intervention");const H=Te[P];v(`Fetching webmap ${H} ${P+1} of ${Te.length}...`);const{warnings:Q}=await as([H],o),re=Q.map(ee=>({itemId:ee.itemId,level:ee.level,message:ee.message,details:ee&&typeof ee=="object"&&"details"in ee?ee.details:void 0})),ne=Se(re,E);ne.length&&(Ce=[...Ce,...ne],$([...Ce]))}te(!0)}catch{}const Ue=!1;!c.current&&Ce.length,Ce.length>0&&te(!0),l("converting");const Y=K||R||"story";L(`Converting ${Y}: ${Z}...`),v(`Converting ${Y} story to new format...`);let le;const Ge=E=>{const P=/\(\s*\d+\s*\/\s*\d+\s*\)\s*$/.test(E.message),H=typeof E.total=="number"&&typeof E.current=="number"&&!P?`${E.message} (${E.current}/${E.total})`:E.message;switch(E.stage){case"media":l("transferring"),v(H);break;case"convert":l("converting"),v(H);break;case"finalize":l("updating"),v(H);break;case"error":l("error"),v(H);break;case"done":l("success"),v(H);break;default:v(H)}},qe=(R||K||"").toLowerCase();if(qe==="map journal"||qe==="mapjournal")le=new st({classicJson:D,themeId:"summit",progress:Ge,token:o}).convert().storymapJson;else if(qe==="swipe")le=(await new xe({classicJson:D,themeId:"summit",progress:Ge,token:o}).convert()).storymapJson;else throw new Error(`Unsupported template for new converters: ${R??"unknown"}`);T();try{const P=le.nodes||{},H=Object.entries(P).find(([,Q])=>Q&&Q.type==="storycover");if(H){const[Q,re]=H,ne=(re.data?.title||"").trim();if((!ne||/^(swipe|spyglass)$/i.test(ne))&&u)try{const be=await Oe(u,o),ve=String(be?.title||"").trim();ve&&(re.data={...re.data||{},title:ve},P[Q]=re,le.nodes=P,console.debug("[CoverTitle][UI] Replaced generic cover title with AGO item title:",ve))}catch{}}}catch{}try{l("transferring"),v("Transferring images to story resources...");const E=Rs(le);if(E.length){const P=async(Q,re,ne,ee)=>{const be=await Ms(Q,re,ne,ee);return{originalUrl:be.originalUrl,resourceName:be.resourceName,transferred:be.isTransferred}},H=await ws.transferBatch({urls:E,storyId:ie,username:N,token:o,progress:Ge,uploader:P});le=vs.apply(le,H)}}catch(E){console.warn("[Converter] Image transfer step failed or skipped:",E)}try{const E=le,P=E.resources&&Object.values(E.resources).find(be=>be.type==="converter-metadata"),H=P?.data?.classicMetadata?.mappingDecisions?.customCss?.combined;if(H){const be=new Blob([H],{type:"text/css"}),ve=URL.createObjectURL(be);let Ae="custom-css.css";try{const Ne=((E.nodes&&Object.values(E.nodes).find(je=>je&&je.type==="storycover"))?.data?.title||"").trim();if(Ne){const je=Ne.toLowerCase().replace(/[^a-z0-9\s-_]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");je&&(Ae=`${je}-custom.css`)}}catch{}we({css:H,url:ve,fileName:Ae})}const Q=P?.data?.classicMetadata?.webmapVersionWarnings,re=P?.data?.classicMetadata?.webmapProtocolWarnings,ne=[],ee=_;if(Array.isArray(Q)&&ne.push(...Q),Array.isArray(re)&&ne.push(...re),ne.length){const be=ne.map(ve=>({itemId:ve.itemId,message:ve.message.replace(/https:\/\/<org_url>\.arcgis\.com/gi,ee)}));$(ve=>{const Ae=[...ve];for(const Me of be)Ae.some(Ne=>Ne.itemId===Me.itemId&&Ne.message===Me.message)||Ae.push({itemId:Me.itemId,level:"warning",message:Me.message});return Ae})}}catch{}try{const E=le,P=E.resources||(E.resources={}),H=(u||"").trim(),Q=(R||"").trim();let re=Object.entries(P).find(([,ve])=>ve&&ve.type==="converter-metadata");if(!re){const ve=`r-${Date.now()}`;P[ve]={type:"converter-metadata",data:{}},re=[ve,P[ve]]}const[ne,ee]=re,be=ee.data||(ee.data={});H&&(be.classicItemId=H),Q&&(be.classicType=Q),delete P[ne],P[ne]=ee,E.resources=P}catch{}try{if(!j&&Array.isArray(M)&&M.length){const E=le,P=E.resources||{},H=Object.entries(P).find(([,Q])=>Q&&Q.type==="converter-metadata");if(H){const[Q,re]=H,ne=re.data||{},ee=ne.classicMetadata||{};ee.webmapChecks=M.map(be=>({itemId:be.itemId,level:be.level,message:be.message})),ne.classicMetadata=ee,re.data=ne,P[Q]=re,E.resources=P}else{const Q=`r-converter-metadata-${Date.now()}`,re={type:"converter-metadata",data:{classicMetadata:{webmapChecks:M.map(ne=>({itemId:ne.itemId,level:ne.level,message:ne.message}))}}};P[Q]=re,E.resources=P}}}catch{}l("updating"),v("Fetching target storymap details...");const _e=await Oe(ie,o);T();let Re=Ss(_e);if(!Re){Re="draft.json";try{const E=Array.isArray(_e.typeKeywords)?_e.typeKeywords:[],P=E.some(H=>/^smdraftresourceid:/.test(String(H)))?E:[...E,`smdraftresourceid:${Re}`];await gt(ie,N,P,o)}catch{}}v(`Removing old draft resource (${Re})...`);try{await xs(ie,N,Re,o)}catch{}T();try{if(!ke(le)){const P=Array.isArray(ke.errors)?ke.errors:[],H=P.length?String(P[0]?.message??JSON.stringify(P[0])):"Schema validation failed";throw new Error(`Draft JSON failed client-side schema validation: ${H}`)}}catch(E){throw E instanceof Error?E:new Error(String(E))}try{v("Validating draft JSON schema...");const E=await fetch("/.netlify/functions/validate-draft",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(le)});if(!E.ok){const P=await E.json().catch(()=>({})),H=Array.isArray(P?.errors)?P.errors:[],Q=H.length?H[0]?.message||JSON.stringify(H[0]):`HTTP ${E.status}`;throw new Error(`Draft JSON failed schema validation: ${Q}`)}}catch(E){throw E instanceof Error?E:new Error(String(E))}v(`Uploading new draft resource (${Re})...`);try{const P=le.nodes||{};for(const[,H]of Object.entries(P))if(H?.type==="action-button"&&H.dependents){for(const Q of Object.keys(H.dependents))/^actionMedia_content_/.test(Q)&&delete H.dependents[Q];Object.keys(H.dependents).length===0&&delete H.dependents}}catch{}const Ct=new Blob([JSON.stringify(le)],{type:"application/json"});await It(ie,N,Ct,Re,o),T(),v("Updating keywords...");const it=_e.typeKeywords||[];if(!it.includes("smconverter:online-app")){const E=[...it,"smconverter:online-app"];await gt(ie,N,E,o),T()}T(),l("success"),v("Classic "+Y+":  "+Z),A(`https://storymaps.arcgis.com/stories/${ie}/edit`),t(!0);try{const E=le,P=E.resources||{};for(const[H,Q]of Object.entries(P))if(Q?.type==="webmap"){const re=Q.data||{},ne=re.initialState||{};for(const ee of["extent","center","viewpoint","mapLayers"])ne&&ee in ne&&!(ee in re)&&(re[ee]=ne[ee]);Q.data=re,P[H]=Q}E.resources=P,le=E,console.debug("[SaveGuard] Promoted initialState fields to resource data keys")}catch{}try{const E=await fetch("/.netlify/functions/save-converted",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({filename:"converted-app",storyId:ie,classicItemId:u,json:le})});if(E.ok){const P=await E.json();console.info("[LocalSave] Converted JSON saved:",P?.path||P?.fileName||"ok")}else console.warn("[LocalSave] Failed to save converted JSON locally:",E.status)}catch{console.warn("[LocalSave] Error saving converted JSON locally:",e?.message)}}catch(N){N instanceof Error&&N.message==="Conversion cancelled by user intervention"?(l("error"),v(N.message)):(l("error"),v(N instanceof Error?N.message:"An unknown error occurred")),N instanceof Error&&N.stack&&console.debug("[ConverterCatch]",N.stack),t(!1)}};return y.jsxs("div",{className:"converter-container",children:[y.jsx("h2",{children:"Classic Story Map Converter"}),y.jsxs("p",{children:["Convert Classic Esri Story Maps to ",y.jsx("a",{href:"https://storymaps.arcgis.com",target:"_blank",rel:"noopener noreferrer",children:"ArcGIS StoryMaps"})]}),y.jsxs("div",{className:"converter-instructions",children:[y.jsx("h3",{children:"Instructions:"}),y.jsxs("ol",{children:[y.jsx("li",{children:"Sign in to ArcGIS Online using the sign-in button above"}),y.jsx("li",{children:"Enter the Item ID of your Classic Story"}),y.jsx("li",{children:"Click Convert to transform your classic story into the new format"}),y.jsx("li",{children:"Click Finishing Publishing to open the converted story. Review and publish when ready"})]})]}),y.jsxs("div",{className:"converter-input-group",children:[y.jsx("label",{className:"converter-label",children:"Classic Story Item ID:"}),y.jsx("input",{type:"text",value:u,onChange:N=>h(N.target.value),placeholder:"e.g., 858c4126f0604d1a86dea06ffbdc23a3",className:"converter-input"})]}),y.jsx("div",{className:"converter-input-group",children:y.jsxs("label",{className:"converter-label",children:[y.jsx("input",{type:"checkbox",checked:!j,onChange:N=>k(!N.target.checked)})," ","Enable metadata output"," ",y.jsx("span",{role:"button","aria-label":"Metadata output info",title:"When enabled, adds a resource node to the output json recording the original classic story's parameters and other diagnostics",onClick:()=>alert("When enabled, adds a resource node to the output json recording the original classic story's parameters and other diagnostics"),className:"metadata-info-icon",children:y.jsx("span",{className:"metadata-info-fallback",children:"ℹ️"})})]})}),O>0&&y.jsx("div",{className:"converter-controls-row",children:y.jsx("button",{className:"converter-btn secondary",onClick:()=>{ns(),ge(),a("Cache cleared"),setTimeout(()=>a(""),2e3)},title:"Clear in-memory fetch cache",children:"Clear cached webmap/story data"})}),g!=="success"?y.jsx("button",{className:`converter-btn ${f&&["fetching","converting","transferring","updating"].includes(g)?"cancel-hover":""}`,title:g==="idle"||g==="error"?"Start conversion":f?"Cancel conversion (Esc)":"Conversion in progress",onClick:g==="idle"||g==="error"?ce:X,onMouseEnter:()=>{!C&&["fetching","converting","transferring","updating"].includes(g)&&S(!0)},onMouseLeave:()=>S(!1),disabled:I,children:g==="idle"||g==="error"?b||"Convert":f&&["fetching","converting","transferring","updating"].includes(g)?"Cancel":b||"Convert"}):y.jsxs("div",{className:"converter-message converter-message-success",children:[y.jsx("button",{className:"converter-btn secondary",onClick:()=>{w&&window.open(w,"_blank")},title:"Open in ArcGIS StoryMaps to finish publishing",children:"Click to Finish Publishing →"}),w&&y.jsxs("div",{className:"converter-help-text publishing-url-block",children:[y.jsx("strong",{children:"Publishing URL:"})," ",y.jsx("a",{href:w,target:"_blank",rel:"noopener noreferrer",children:w})]})]}),C&&g!=="idle"&&g!=="error"&&g!=="success"&&!c.current&&!x&&y.jsx("div",{className:"cancel-mobile-wrapper",children:y.jsx("button",{className:"converter-btn cancel-mobile",onClick:X,title:"Cancel conversion",children:"Cancel"})}),g!=="success"&&m&&y.jsxs("div",{className:`converter-message converter-message-${g}`,children:[y.jsx("strong",{children:g==="error"?"Error:":"Status:"})," ",m]}),!!r&&y.jsx("div",{className:"converter-toast",role:"status","aria-live":"polite",children:r}),W&&y.jsxs("div",{className:"converter-warning",children:[y.jsx("strong",{children:"Custom CSS Detected!"})," Your classic story used custom CSS settings. To recreate your custom styles you should create a new ArcGIS StoryMaps Theme ",y.jsx("a",{href:"https://storymaps.arcgis.com/themes/new",target:"_blank",rel:"noopener noreferrer",children:"here"})," with your custom colors and styles, then apply the new Theme within the ArcGIS StoryMaps Builder (under the Design tab). ",y.jsx("a",{href:W.url,download:W.fileName||"custom-css.css",children:"Click this link"})," to download a copy of your custom CSS."]}),(M.length>0||Ie)&&y.jsxs("div",{className:"converter-warning",children:[y.jsx("strong",{children:"Webmap Checks:"}),M.length===0?y.jsx("div",{children:"No issues detected for referenced webmaps."}):y.jsxs(y.Fragment,{children:[y.jsx("ul",{children:M.map((N,D)=>{const K=Array.isArray(N.details?.failures)?N.details.failures:[],Z=new Map;for(const Y of K){const le=`${Y.url??""}::${Y.layerTitle??""}`;Z.has(le)||Z.set(le,{layerTitle:Y.layerTitle,layerItemId:Y.layerItemId,url:Y.url,status:typeof Y.status=="number"?Y.status:void 0,error:typeof Y.error=="string"?Y.error:void 0})}const G=Array.from(Z.values()),ie=G.some(Y=>/HTTP URL/i.test(String(Y.error||""))||/^http:\/\//i.test(String(Y.url||""))),ae=G.some(Y=>/timeout/i.test(String(Y.error||""))||typeof Y.status=="number"&&Y.status===504),$e=G.some(Y=>/not\s*found|404/i.test(String(Y.error||""))||typeof Y.status=="number"&&Y.status===404);let ue=_;if(!ue||ue===B){const Y=typeof p=="object"&&p&&(p.orgUrl||p.org?.url)||"";if(Y)try{const le=new URL(Y);ue=`${le.protocol}//${le.hostname}`}catch{ue=`https://${se()}`}else ue=`https://${se()}`}const Te=`You must update the web map to use https service urls. You can do this by opening the web map item's <a href="${ue}/home/item.html?id=${N.itemId}#settings" target="_blank" rel="noopener noreferrer">settings page</a> scrolling down to the Web map section and clicking the "Update layers to HTTPS" button`,Ce=`Some services did not respond (timeout). This may be temporary. Try opening the <a href="${ue}/home/item.html?id=${N.itemId}" target="_blank" rel="noopener noreferrer">web map</a> and checking that the layers load, or reload later. If timeouts persist, consider replacing the layer or contacting the service owner.`,Ue=`Some services returned 404 (Not Found). Open the <a href="${ue}/home/item.html?id=${N.itemId}" target="_blank" rel="noopener noreferrer">web map</a> to remove broken layers, or replace with an available service.`;return y.jsxs("li",{children:[ie?y.jsxs(y.Fragment,{children:[`WARNING: Webmap [${N.itemId}] uses http services.`,N.details?.webmapTitle&&y.jsxs("div",{children:["Title: ",N.details.webmapTitle]}),y.jsx("div",{dangerouslySetInnerHTML:{__html:Te}})]}):ae?y.jsxs(y.Fragment,{children:[`WARNING: Webmap [${N.itemId}] has timeout failures.`,N.details?.webmapTitle&&y.jsxs("div",{children:["Title: ",N.details.webmapTitle]}),y.jsx("div",{dangerouslySetInnerHTML:{__html:Ce}})]}):$e?y.jsxs(y.Fragment,{children:[`WARNING: Webmap [${N.itemId}] has missing layer(s).`,N.details?.webmapTitle&&y.jsxs("div",{children:["Title: ",N.details.webmapTitle]}),y.jsx("div",{dangerouslySetInnerHTML:{__html:Ue}})]}):/^\s*(ERROR|WARNING|INFO):/i.test(N.message)?y.jsx("span",{dangerouslySetInnerHTML:{__html:N.message}}):y.jsxs(y.Fragment,{children:[N.level.toUpperCase(),": [",N.itemId,"] ",y.jsx("span",{dangerouslySetInnerHTML:{__html:N.message}})]}),G.length>0&&y.jsx("div",{children:`WARNING: Webmap [${N.itemId}] has ${G.length} failing layer(s).`}),N.details?.webmapTitle&&y.jsxs("div",{children:["Title: ",N.details.webmapTitle]}),G.length>0&&y.jsxs("div",{children:[y.jsx("button",{className:"converter-details-toggle-btn",onClick:()=>he(Y=>({...Y,[N.itemId]:!Y[N.itemId]})),children:q[N.itemId]?"Hide details":`Show details (${G.length})`}),q[N.itemId]&&y.jsx("ul",{children:G.map((Y,le)=>y.jsxs("li",{children:[Y.layerTitle?`Layer name: ${Y.layerTitle}`:"",Y.layerItemId?y.jsxs(y.Fragment,{children:[" ","[",y.jsx("a",{href:me(Y.layerItemId),target:"_blank",rel:"noopener noreferrer",children:Y.layerItemId}),"]"," "]}):"",Y.error?` — Error: ${Y.error}`:"",typeof Y.status=="number"?` (status ${Y.status})`:"",Y.url?y.jsxs(y.Fragment,{children:[" ","— ",y.jsx("a",{href:Y.url,target:"_blank",rel:"noopener noreferrer",children:"Link to endpoint"})," "]}):""]},`${N.itemId}-fail-${le}`))})]})]},`${N.itemId}-${D}`)})}),y.jsxs("span",{children:["These issues won’t stop conversion, but may prevent maps from loading. Please fix with ",y.jsx("a",{href:"https://assistant.esri-ps.com/",children:"ArcGIS Assistant"})," or in ArcGIS Online."]})]})]}),!1]})}function Hs(){const{token:I,userInfo:t}=Pe(),[s,i]=z.useState({status:"idle"}),n=z.useMemo(()=>new URLSearchParams(window.location.search),[]),d=z.useMemo(()=>{try{const o=localStorage.getItem("pendingSaveCsvLayerParams");return o?JSON.parse(o):{}}catch{return{}}},[]),c=n.get("webmapId")??d.webmapId??"",f=n.get("csvItemId")??d.csvItemId??"";function S(o){if(!o)return null;const p=String(o.type||"").toLowerCase();if(["heatmap","simple","unique-value","class-breaks","dot-density","dictionary","pie-chart"].includes(p))return o;const h=o.symbol||o;String(h.type||h.style||"").toLowerCase();function g(m){if(!m)return null;const v=String(m.type||m.style||"").toLowerCase(),r={...m},a=w=>!w||Array.isArray(w)||typeof w=="string"?w:typeof w=="object"&&"r"in w&&"g"in w&&"b"in w?[w.r,w.g,w.b,"a"in w?w.a:255]:w;if(r.color&&(r.color=a(r.color)),r.outline&&(r.outline={...r.outline},r.outline.color&&(r.outline.color=a(r.outline.color))),v==="esripms"||v==="picturemarkersymbol"){r.type="picture-marker",!r.url&&r.imageData&&(r.url=`data:image/png;base64,${r.imageData}`),!r.width&&r.size&&(r.width=r.size),!r.height&&r.size&&(r.height=r.size);const w=["type","url","width","height","angle","xoffset","yoffset"];Object.keys(r).forEach(A=>{w.includes(A)||delete r[A]}),delete r.imageData}else if(v==="esrisms"||v==="simplemarkersymbol"){r.type="simple-marker";const w=["type","style","color","size","outline","angle","xoffset","yoffset"];Object.keys(r).forEach(A=>{w.includes(A)||delete r[A]})}else if(v==="esrisls"||v==="simplelinesymbol"){r.type="simple-line";const w=["type","style","color","width"];Object.keys(r).forEach(A=>{w.includes(A)||delete r[A]})}else if(v==="esrisfs"||v==="simplefillsymbol"){r.type="simple-fill";const w=["type","style","color","outline"];Object.keys(r).forEach(A=>{w.includes(A)||delete r[A]})}else return{type:"simple-marker",color:a(r.color)||"red",size:typeof r.size=="number"?r.size:12,outline:r.outline?{color:a(r.outline.color)||"white",width:1}:void 0};return r}const l=g(h);return l?{type:"simple",symbol:l}:o.visualVariables?{type:"simple",visualVariables:o.visualVariables}:null}function C(o,p=[]){if(!o)return null;const u=p.map(j=>j.name),h=j=>u.includes(j),g=h("TITLE")?"TITLE":h("Title")?"Title":"TITLE",l=h("DESCRIPTION")?"DESCRIPTION":h("Description")?"Description":"DESCRIPTION",m=h("IMAGE_URL")?"IMAGE_URL":h("Image_URL")?"Image_URL":"IMAGE_URL",v=h("IMAGE_LINK_URL")?"IMAGE_LINK_URL":h("Image_Link_URL")?"Image_Link_URL":"IMAGE_LINK_URL",r=o.title||`{${g}}`,a=o.description||`{${l}}`,w=Array.isArray(o.mediaInfos)?o.mediaInfos:[],A=[];return a&&A.push({type:"text",text:a}),w.forEach(j=>{if(String(j?.type).toLowerCase()==="image"&&j?.value){const k=j.value;A.push({type:"media",mediaInfos:[{type:"image",value:{sourceURL:k.sourceURL||`{${m}}`,linkURL:k.linkURL||`{${v}}`}}]})}}),{title:r,content:A}}return z.useEffect(()=>{async function o(){if(!(!I||!t)){if(!c||!f){i({status:"error",message:"Missing webmapId or csvItemId in query params."});return}try{i({status:"running",step:"Registering token"}),Bt.portalUrl="https://www.arcgis.com",Dt.registerToken({server:"https://www.arcgis.com/sharing/rest",token:I,expires:Date.now()+3600*1e3,ssl:!0,userId:t.username}),i({status:"running",step:"Loading webmap"});const p=new Et({portalItem:{id:c}});await p.load(),await p.when(),i({status:"running",step:"Creating CSVLayer"});const u=new Ft({portalItem:{id:f}});u.visible=!0,u.title=u.title??"Converted Map Notes",u.outFields=["*"],u.url=`https://www.arcgis.com/sharing/rest/content/items/${f}/data`,await u.load(),await u.when(),i({status:"running",step:"Copying renderer/popup from Map Notes"});try{const a=`https://www.arcgis.com/sharing/rest/content/items/${c}/data?f=json&token=${encodeURIComponent(I)}`,w=await fetch(a);if(w.ok){const k=((await w.json())?.operationalLayers||[]).find(J=>String(J?.layerType||J?.type||"").toLowerCase()==="mapnotes"||String(J?.title||"").toLowerCase().includes("map notes")),L=(k?.layerDefinition||k?.featureCollection?.layers?.[0]?.layerDefinition)?.drawingInfo||k?.drawingInfo,O=k?.popupInfo;if(L?.renderer){const J=S(L.renderer);J&&(u.renderer=J)}if(O){const J=C(O,u.fields||[]);J&&(u.popupEnabled=!0,u.popupTemplate=J)}}}catch{}const g=(u.fields??[]).map(a=>a.name.toLowerCase()),l=a=>a.find(w=>g.includes(w)),m=l(["x","longitude","lon","long"]),v=l(["y","latitude","lat"]);m&&v?(u.longitudeField=m,u.latitudeField=v):(u.longitudeField=u.longitudeField??"X",u.latitudeField=u.latitudeField??"Y"),i({status:"running",step:"Adding layer to webmap"}),p.add(u),i({status:"running",step:"Saving webmap"});const r=await p.save({ignoreUnsupported:!0});if(r&&r.success){try{await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:I,webmapId:c,csvItemId:f,title:u.title||"Converted Map Notes",visible:!0,opacity:1,lonField:u.longitudeField||"x",latField:u.latitudeField||"y"})})}catch{}const a=`https://www.arcgis.com/sharing/rest/content/items/${c}/data?f=json&token=${encodeURIComponent(I)}`;let w=[],A={renderer:u.renderer,popupTemplate:u.popupTemplate,layerTitle:u.title};try{const j=p.layers.find(k=>k.portalItem?.id===f||k.title===u.title);j&&(A={renderer:j.renderer,popupTemplate:j.popupTemplate,layerTitle:j.title})}catch{}try{const j=await fetch(a);if(j.ok){const b=(await j.json())?.operationalLayers||[];w=b.map(x=>x?.title).filter(Boolean);const L=b.find(x=>String(x?.layerType||x?.type).toLowerCase()==="csv"&&(x?.itemId===f||String(x?.title||"")===String(u.title||"Converted Map Notes"))),J=L?.layerDefinition?.drawingInfo||L?.drawingInfo,T=L?.popupInfo;(J?.renderer||T)&&(A={renderer:J?.renderer,popupTemplate:T,layerTitle:L?.title||A.layerTitle}),A.allOperationalLayers=b,A.csvOperationalLayer=L}}catch{}i({status:"success",webmapId:c,verification:{titles:w},layerSummary:A})}else throw new Error("Save did not return success.")}catch(p){try{i({status:"running",step:"Fallback: REST update"});const u=await fetch("/.netlify/functions/save-csv-layer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:I,webmapId:c,csvItemId:f,title:"Converted Map Notes",visible:!0,opacity:1,lonField:"x",latField:"y"})});let h=null,g=null;try{h=await u.json()}catch{try{g=await u.text()}catch{}}if(u.ok&&h?.success){const l=`https://www.arcgis.com/sharing/rest/content/items/${c}/data?f=json&token=${encodeURIComponent(I)}`;let m=[];try{const r=await fetch(l);r.ok&&(m=((await r.json())?.operationalLayers||[]).map(w=>w?.title).filter(Boolean))}catch{}let v={};try{const r=webmap.layers?.find(a=>a.portalItem?.id===f);r&&(v={renderer:r.renderer,popupTemplate:r.popupTemplate,layerTitle:r.title})}catch{}i({status:"success",webmapId:c,verification:{titles:m},layerSummary:v})}else throw new Error(h?.message||g||"Fallback update failed")}catch(u){const h=p?.details??{},g=h.errors?JSON.stringify(h.errors):"";i({status:"error",message:`Save failed: ${p?.message??String(p)}${g?` — ${g}`:""}. Fallback failed: ${u?.message??String(u)}`,details:h})}}}}o()},[I,t,c,f]),z.useEffect(()=>{const o=n.get("webmapId"),p=n.get("csvItemId");(o||p)&&localStorage.setItem("pendingSaveCsvLayerParams",JSON.stringify({webmapId:o,csvItemId:p}))},[n]),y.jsxs("div",{className:"page",children:[y.jsx("h2",{children:"Save CSV Layer to WebMap"}),y.jsxs("p",{children:["WebMap ID: ",y.jsx("code",{children:c||"(missing)"})]}),y.jsxs("p",{children:["CSV Item ID: ",y.jsx("code",{children:f||"(missing)"})]}),s.status==="idle"&&y.jsx("p",{children:"Waiting for authentication…"}),s.status==="running"&&y.jsxs("p",{children:["Working: ",s.step]}),s.status==="success"&&y.jsxs("p",{children:["Success! Layer added and saved to WebMap ",y.jsx("code",{children:s.webmapId}),"."]}),s.status==="success"&&s.verification&&y.jsxs("div",{children:[y.jsx("p",{children:"Operational layer titles:"}),y.jsx("ul",{children:s.verification.titles.map((o,p)=>y.jsx("li",{children:y.jsx("code",{children:o})},p))})]}),s.status==="success"&&s.layerSummary&&y.jsxs("div",{children:[y.jsx("p",{children:"CSV layer summary:"}),y.jsxs("p",{children:["Layer title: ",y.jsx("code",{children:s.layerSummary.layerTitle||"(unknown)"})]}),y.jsxs("details",{children:[y.jsx("summary",{children:"Renderer"}),y.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.renderer,null,2)})]}),y.jsxs("details",{children:[y.jsx("summary",{children:"Popup Template"}),y.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.popupTemplate,null,2)})]}),y.jsxs("details",{children:[y.jsx("summary",{children:"Raw CSV operationalLayer"}),y.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.csvOperationalLayer,null,2)})]}),y.jsxs("details",{children:[y.jsx("summary",{children:"All operationalLayers"}),y.jsx("pre",{className:"error-details",children:JSON.stringify(s.layerSummary.allOperationalLayers,null,2)})]})]}),s.status==="error"&&y.jsxs("div",{children:[y.jsxs("p",{className:"error",children:["Error: ",s.message]}),s.details&&y.jsx("pre",{className:"error-details",children:JSON.stringify(s.details,null,2)})]})]})}function Gs(){const{userInfo:I,token:t}=Pe(),s=new URLSearchParams(window.location.search),i=s.get("action"),n=s.get("dev")==="true";return y.jsxs(y.Fragment,{children:[y.jsx("div",{className:"bg-image"}),y.jsxs("div",{className:"app-content",children:[y.jsx(Jt,{}),n||t&&I?i==="save-csv-layer"?y.jsx(Hs,{}):y.jsx(Vs,{}):y.jsx(is,{})]})]})}$t(window);Rt.createRoot(document.getElementById("root")).render(y.jsx(z.StrictMode,{children:y.jsx(_t,{children:y.jsx(Gs,{})})}));
